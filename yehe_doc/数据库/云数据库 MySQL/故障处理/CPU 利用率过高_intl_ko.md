
## 현상 설명
TencentDB for MySQL에 응답이 느리거나, 연결할 수 없거나, 시간 초과 현상이 발생했습니다. TencentDB for MySQL CPU 이용률이 80%를 초과하는 경우 서비스 응답이 느리거나, 시간을 초과하거나, 데이터베이스에 연결할 수 없는 등의 현상이 발생할 수 있습니다.

TencentDB for MySQL CPU 사용 현황은 [MySQL 콘솔](https://console.cloud.tencent.com/cdb)의 인스턴스 모니터링 페이지 또는 [DBbrain 콘솔](https://console.cloud.tencent.com/dbbrain/event?product=mysql)에서 확인할 수 있습니다.

## 장애 리스크
MySQL CPU 이용률이 너무 높은 상태로 장시간 유지되면 데이터베이스의 전체 성능이 크게 저하될 수 있으며, 심한 경우 인스턴스가 정지될 수도 있습니다.

HA가 인스턴스 정지를 감지하면 사용자 비즈니스의 고가용성 확보를 위해 마스터/슬레이브 전환이 트리거됩니다. 마스터/슬레이브 전환 과정에서 일시적으로 인스턴스를 사용할 수 없게 되며, 시간은 보통 60초 이내입니다. 비즈니스 피크 시간에 마스터/슬레이브 전환이 진행되면 비즈니스의 안정성과 연속성에 심각한 영향을 미칠 수 있습니다.

CPU 리소스 부족으로 인해 비즈니스에 지장이 가지 않도록 CPU 이용률이 높은 인스턴스를 사전에 최적화하거나 CPU 리소스의 업그레이드를 권장합니다. 인스턴스의 마스터/슬레이브 전환 시 몇 초의 끊김 현상이 발생할 수 있으므로, 장기간 연결을 위해 재연결 메커니즘이 가능한 애플리케이션을 구비하십시오.

## 예상 원인
MySQL은 주로 시스템 스레드와 사용자 스레드가 CPU를 점유합니다. 따라서 MySQL이 독점하는 CVM은 해당 두 스레드의 상황에 유의하면 대부분의 장애 시나리오를 해결할 수 있습니다.

### 사용자 스레드
사용자 스레드가 혼잡한 경우 대부분의 시나리오는 '슬로우 쿼리'로 인한 것이며, '슬로우 쿼리' 외에도 '방대한 컴퓨팅량', '높은 QPS' 같은 요인이 있습니다.

- **슬로우 쿼리**
order by, group by, 임시 테이블, join과 같은 장시간 컴퓨팅을 진행합니다. 해당 문제는 쿼리 효율이 낮아 단일 SQL 명령이 장시간 CPU를 점유하게 되어 발생합니다.
- **방대한 컴퓨팅량**
단순 데이터 양이 많으면 컴퓨팅량이 방대해집니다.
- **높은 QPS(Queries Per Second)**
단순 QPS 압력이 높아 CPU 시간이 점유된 경우입니다. 예를 들어, 4코어의 서버로 20k~30k의 포인트 쿼리를 지원할 때 각 SQL이 점유하는 CPU 시간은 많지 않습니다. 전체 QPS가 매우 높기 때문에 CPU 시간이 모두 점유되는 것입니다.

### 시스템 스레드
실제 환경에서 시스템 스레드에 문제가 발생하는 경우는 그리 많지 않습니다. 일반적으로 여러 개의 시스템 스레드가 동시에 모두 점유되는 경우는 매우 드물며, CVM의 가용 코어 수가 4개 이상이라면 보통 CPU 이용률이 과도하게 높아지지 않습니다. 다만, 아래 이미지와 같이 일부 bug가 있는 경우에는 영향이 있을 수 있습니다.
![](https://main.qcloudimg.com/raw/e7c078a31b983fec2990801bfabde282.png)

## 해결 방법
대부분의 장애 시나리오는 기본적으로 사용자 스레드 혼잡으로 발생합니다. 따라서 본 문서는 사용자 스레드로 인한 CPU 이용률이 과도하게 높아지는 문제에 대해 주로 소개하고 솔루션을 제공합니다.
- 슬로우 쿼리: DBbrain을 사용해 장애를 진단하고 최적화하는 것을 권장합니다. 자세한 내용은 [슬로우 쿼리](#mcx)를 참조하십시오.
- 방대한 컴퓨팅량: 처리 데이터 양이 많아 CPU 이용률이 과도하게 높아지는 경우입니다. 처리에 대한 자세한 내용은 [방대한 컴퓨팅량](#jsld)을 참조하십시오.
- 높은 QPS: 액세스 양이 너무 많아 CPU 이용률이 과도하게 높아지는 경우입니다. 처리에 대한 자세한 내용은 [높은 QPS](#gqps)을 참조하십시오.

## 처리 순서
### [슬로우 쿼리](id:mcx)
CPU 이용률이 과도하게 높아지는 이상 SQL 명령은 DBbrain을 사용해 진단 및 최적화할 수 있습니다.
- **이상 진단(권장)**: 7 * 24시간 이상 감지 진단으로, 실시간으로 최적화 권장 사항을 제공합니다. 작업에 대한 자세한 내용은 ['이상 진단' 기능으로 데이터베이스 이상 상황 진단](https://intl.cloud.tencent.com/document/product/1035/36053)을 참조하십시오.
- **슬로우 SQL 분석 **: 현재 인스턴스에 발생한 슬로우 SQL을 분석하고 슬로우 SQL에 대한 최적화 권장 사항을 제공합니다. 작업에 대한 자세한 내용은 ['슬로우 SQL 분석' 기능으로 CPU 이용률을 과도하게 높이는 SQL 진단](https://intl.cloud.tencent.com/document/product/1035/36053)을 참조하십시오.
- **감사 로그 분석**: CDB 감사 데이터(전체 SQL)를 이용해 SQL 명령을 다각도로 분석하고 최적화 권장 사항을 제공합니다. 작업에 대한 자세한 내용은 ['감사 로그 분석' 기능으로 CPU 이용률을 과도하게 높이는 SQL 진단](https://intl.cloud.tencent.com/document/product/1035/36053)을 참조하십시오.

MySQL 슬로우 쿼리 시간(long_query_time)의 기본값은 10s입니다. 성능 문제로 슬로우 쿼리가 나타나지 않으면 해당 매개변수를 1s로 입력한 뒤 작업 주기 동안 슬로우 쿼리를 다시 모니터링하여 최적화하십시오. 매개변수 조정 이후에도 작업 주기 동안 슬로우 쿼리가 나타나지 않고 CPU 이용률이 과도하게 높다면, CPU 설정을 업그레이드하여 데이터베이스 자체의 성능을 향상하는 것이 좋습니다.

### [방대한 컴퓨팅량](id:jsld)
데이터 양이 많은 경우 색인 및 계획 진행에 문제가 없어도 CPU 이용률이 과도하게 높아질 수 있으며, MySQL one-thread-per-connection 특성과 결합되면 동시 접속이 과도하게 많지 않아도 CPU 이용률이 높아질 수 있습니다.

일반적으로 이 문제는 아래와 같은 두 가지 보편적인 솔루션이 있습니다.
- 읽기/쓰기 분리: 해당 유형의 쿼리를 평소 비즈니스에 잘 사용하지 않는 읽기 전용 슬레이브 데이터베이스에 넣습니다.
- 프로그램 측에서 SQL 분할: 1개의 큰 쿼리를 여러 개의 작은 쿼리로 분할합니다.

### [높은 QPS](id:gqps)
- CPU 설정을 업그레이드하여 데이터베이스의 전체 성능을 높입니다.
- 읽기 전용 인스턴스에 마운트하여 마스터 인스턴스의 부담을 줄여 줍니다.
- 쿼리 명령을 최적화하여 실행 효율을 높여 줍니다.

