본문은 MySQL용 TencentDB 콘솔에서 읽기 전용 인스턴스 딜레이 복사를 설정하고 복사를 활성화/비활성화하는 방법을 설명합니다. 딜레이 복사(예: 읽기 전용 인스턴스와 해당 소스 인스턴스 간의 지연)를 설정하고 딜레이 동안 플래시백 위치 또는 GTID(글로벌 트랜잭션 식별자)별 재생을 선택하여 데이터를 효율적으로 롤백하고 오류를 수정할 수 있습니다.
- 딜레이 복사: RO 그룹 설정 페이지 또는 관리 페이지에서 읽기 전용 인스턴스와 원본 인스턴스 간의 딜레이 복사를 활성화 및 설정할 수 있습니다.
- 복사 활성화/비활성화: 읽기 전용 인스턴스와 해당 원본 인스턴스 간의 데이터 동기화를 수동으로 활성화/비활성화할 수 있습니다.

## 딜레이 복사 설명
- 읽기 전용 인스턴스에 대해 딜레이 복사가 활성화되면 가중치가 0으로 설정된 RO 그룹에서 제거되고 제거 경보가 트리거됩니다. 이 때 RO 그룹의 VIP 주소로 제거된 인스턴스에 접근하면 트래픽이 전달되지 않고 자체 VIP 주소만 액세스할 수 있습니다.
- RO 그룹에서 지연된 읽기 전용 인스턴스 제거가 활성화되고 읽기 전용 인스턴스에 대해 딜레이 복사가 비활성화된 경우 인스턴스의 지연 시간이 RO 그룹의 지연 임계값보다 작은 경우에만 인스턴스의 가중치가 복구되고 동시에 복구 알람이 트리거됩니다.
- 플래시백 위치로 재생하는 중에는 재시작, 설정 변경, 버전 업그레이드, 커널 버전 업그레이드를 동시에 진행할 수 없습니다.

## 딜레이 복사 활성화
>?읽기 전용 인스턴스의 ‘딜레이 복사’는 ‘비활성화’로 기본 설정됩니다. 활성화 후 딜레이 복사 시간이 표시 됩니다. 

### 읽기 전용 인스턴스의 RO 그룹 설정으로 활성화
1. [MySQL 콘솔](https://console.cloud.tencent.com/cdb/ )에 로그인한 후, 인스턴스 리스트에서 프라이머리 인스턴스 ID를 클릭하여 인스턴스 관리 페이지로 이동합니다.
2. 인스턴스 관리 페이지에서 **읽기 전용 인스턴스** 페이지를 선택하고 RO그룹 열에서 **설정**을 클릭하여 RO그룹 설정 페이지로 이동합니다. 
![](https://qcloudimg.tencent-cloud.cn/raw/87041c7addd9dcfd058b2d3f7c417625.png)
3. RO 그룹 설정 페이지에서 **인스턴스 딜레이 복사**를 활성화하고 **딜레이 복사 시간**을 설정한 다음 **확인**을 클릭합니다.
   - **딜레이 복사**: 딜레이 복사를 설정하고 지연 도중 플래시백 위치 또는 GTID(글로벌 트랜잭션 식별자)별 재생을 선택하여 데이터를 효율적으로 롤백하고 오류를 수정할 수 있습니다.
   - **딜레이 시간**: 읽기 전용 인스턴스와 프라이머리 인스턴스 간의 복사 딜레이 시간으로, 설정 범위는 1초 - 259200초입니다.
   - **인스턴스 딜레이 초과 제거**: 제거 정책 실행 여부. 제거된 인스턴스의 가중치는 0으로 자동 설정됩니다. 읽기 전용 인스턴스의 딜레이가 임계치를 초과하여 제거되면 사용자에게 알람이 발송됩니다. 읽기 전용 인스턴스 제거 알람과 알람 수신 객체 설정은 [알람 기능](https://intl.cloud.tencent.com/document/product/236/8457)을 참고 바랍니다. 
   - **딜레이 임계값**: 읽기 전용 인스턴스를 위한 딜레이 제한 초과 임계값 설정. 임계값을 초과한 읽기 전용 인스턴스는 RO그룹에서 제거됩니다.
   - **최소 보관 인스턴스 수**: 그룹 내에서 보장되어야 하는 인스턴스 하한치로, 현재 읽기 전용 인스턴스 수가 해당 하한치와 같거나 적고, 딜레이 시간이 임계값을 초과하면 현재의 읽기 전용 인스턴스는 제거되지 않습니다.
   - **읽기 가중치 할당**: RO그룹은 시스템에 의한 자동 할당과 사용자 정의 할당의 두 가지 가중치 할당 방법을 지원합니다. 가중치 값은 0 - 100 사이의 정수여야 합니다.
   - **부하 리밸런싱**:
    - 부하 리밸런싱을 비활성화하면 가중치 수정 시 신규 부하에만 적용되고, 기존 장기간 연결로 액세스했던 읽기 전용 인스턴스를 바꾸지 않아 데이터베이스가 끊기지 않습니다.
    - 부하 리밸런싱을 활성화하면 데이터베이스 연결이 몇 초간 끊어졌다 다시 연결될 수 있습니다. 새로 추가한 연결은 설정한 가중치 균형에 따라 부하됩니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/c40a92c3a6dcc083ac92f01169b259ff.png"  style="zoom:50%;">

### 읽기 전용 인스턴스 관리 페이지에서 활성화
1. [TencentDB for MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인합니다. 인스턴스 목록에서 읽기 전용 인스턴스 ID 또는 **작업** 열의 **관리**를 클릭하여 읽기 전용 인스턴스 상세 페이지에 액세스합니다.
2. 읽기 전용 인스턴스 상세 페이지의 **배포 정보** > **딜레이 복사**에서 **활성화**를 클릭합니다.
![](https://qcloudimg.tencent-cloud.cn/raw/280f08c04f692445f51b1ab4aa556f58.png)
3. 팝업 창에서 딜레이 시간 설정 후 **확인**을 클릭합니다.
>?딜레이 시간 범위: 1초 - 259200초. 
>RO 인스턴스 딜레이 시간을 수정하면 동일한 RO 그룹의 다른 RO 인스턴스도 함께 수정됩니다.
>
<img src="https://qcloudimg.tencent-cloud.cn/raw/32877ca9c8ab4bb3030bbb508c899374.png"  style="zoom:80%;">

## 딜레이 복사 수정
### 읽기 전용 인스턴스의 RO그룹 설정 페이지에서 수정
1. [TencentDB for MySQL 콘솔](https://console.cloud.tencent.com/cdb/ )에 로그인한 후, 인스턴스 리스트에서 프라이머리 인스턴스 ID를 클릭하여 인스턴스 관리 페이지로 이동합니다.
2. 인스턴스 관리 페이지에서 **읽기 전용 인스턴스** 페이지를 선택하고 RO그룹 열에서 **설정**을 클릭하여 RO그룹 설정 페이지로 이동합니다. 
3. RO그룹 설정 페이지에서 복사 **지연 시간**을 수정하고 **확인**을 클릭합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/437d781e478652416c166449b4420910.png"  style="zoom:60%;">

### 읽기 전용 인스턴스 관리 페이지에서 수정
1. [TencentDB for MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인합니다. 인스턴스 목록에서 읽기 전용 인스턴스 ID 또는 작업 열의 관리를 클릭하여 읽기 전용 인스턴스 상세 페이지에 액세스합니다.
2. 읽기 전용 인스턴스 상세 페이지의 **배포 정보** > **딜레이 복사**에서 **수정**을 클릭합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/5098762edf0e478942ad060c5bd80da5.png"  style="zoom:80%;">
3. 팝업 창에서 딜레이 시간 설정 후 **확인**을 클릭합니다.

## 딜레이 복사 비활성화
### 읽기 전용 인스턴스 RO그룹 설정으로 비활성화
1. [MySQL 콘솔](https://console.cloud.tencent.com/cdb/ )에 로그인한 후, 인스턴스 리스트에서 프라이머리 인스턴스 ID를 클릭하여 인스턴스 관리 페이지로 이동합니다.
2. 인스턴스 관리 페이지에서 **읽기 전용 인스턴스** 페이지를 선택하고 RO그룹 열에서 **설정**을 클릭하여 RO그룹 설정 페이지로 이동합니다. 
3. RO그룹 설정 페이지에서 **딜레이 복사** 비활성화를 클릭하고 **확인**을 클릭합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/9191e1c61694da2970323b59a21c59f3.png"  style="zoom:70%;">

### 읽기 전용 인스턴스 관리 페이지에서 비활성화
1. [TencentDB for MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인합니다. 인스턴스 목록에서 읽기 전용 인스턴스 ID 또는 작업 열의 관리를 클릭하여 읽기 전용 인스턴스 상세 페이지에 액세스합니다.
2. 읽기 전용 인스턴스 상세 페이지의 **배포 정보** > **딜레이 복사**에서 **비활성화**를 클릭합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/5f3a33f7b23513b8766eb62455406478.png"  style="zoom:80%;">
3. 팝업 창에서 오류가 없는지 확인한 다음 **확인**을 클릭합니다.
>?딜레이 복사를 비활성화 하면 딜레이 복사 시간이 0으로 설정됩니다. 즉 읽기 전용 인스턴스와 프라이머리 인스턴스간 데이터가 실시간 동기화로 복구됩니다.  
> 

## 데이터 복사 실행
>?읽기 전용 인스턴스의 **복사 상태**는 **정상**으로 기본 설정됩니다. 만약 사용자가 딜레이 복사를 설정하고 딜레이 복사 시간 내에 실수로 데이터를 삭제했다면, 실수로 삭제했을 때의 위치와 GTID를 통해 읽기 전용 인스턴스를 이진법 로그 파일 위치나 GTID 이전으로 복사할 수 있어 신속한 데이터 복구 기능을 사용할 수 있습니다. 
>
1. [MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인한 후, 인스턴스 리스트에서 읽기 전용 인스턴스 ID를 클릭하여 읽기 전용 인스턴스 상세 페이지로 이동합니다.
2. 읽기 전용 인스턴스 상세 페이지의 **배포 정보** > **복사 상태**에서 **활성화**를 클릭합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/29703db36415992fda7e1767a7b830e8.png"  style="zoom:80%;">
3. 팝업 창에서 **확인**을 클릭합니다.
>? 복사 실행 후, 읽기 전용 인스턴스와 프라이머리 인스턴스의 데이터 동기화가 복구됩니다. 
>
<img src="https://qcloudimg.tencent-cloud.cn/raw/ab58491f328ffe447f8790105699f13b.png"  style="zoom:80%;">
4. **배포 정보** > **작업 복사**에서 **지정 위치로 복사**를 선택할 수 있습니다. 그런 다음 데이터를 지정된 시점 또는 해당 GTID로 복원할 수 있습니다. 복원 후 읽기 전용 인스턴스의 복사는 시작 모드가 모두 복사로 전환될 때까지 비활성화됩니다.
    - 시간: 선택 가능한 시간 범위는 복사가 중단된 시점부터 프라이머리 데이터베이스 현재 시점까지의 시간입니다. 
    - GTID: binlog가 적용되지 않은 이후의 모든 로그를 선택할 수 있습니다. GTID를 선택하면 지정된 GTID에 도달할 때까지 데이터가 복제됩니다.
인스턴스 server_uuid의 길이는 36비트로 고정되며 GTID는 `server_uuid:transaction_id` 형식이어야 합니다.
>!
>- 입력한 이진법 로그 위치가 이미 읽기 전용 인스턴스 애플리케이션에 있거나 프라이머리 인스턴스의 위치보다 클 경우 복사 실행이 실패할 수 있습니다. 
>- 복사 실행 시 이진법 로그에 중단 지점이 있다면 복사 실행이 실패할 수 있습니다. 
>- 딜레이로 인해 읽기 전용 인스턴스의 복사 과정이 중단되고 이로 인한 읽기 전용 인스턴스의 디스크 공간 초과 사용을 방지하기 위해 읽기 전용 인스턴스의 디스크 용량이 5GB보다 적을 시 읽기 전용 인스턴스의 I0 스레드를 일시 중지합니다. 
> 
<img src="https://qcloudimg.tencent-cloud.cn/raw/92671ad35d5ef5acbfdf3bfbb47f967a.png"  style="zoom:85%;">
5. 지정된 위치에 복사하는 과정에서 **복사 상태** 이후 **데이터 재생**을 클릭하여 작업 세부 정보를 조회할 수 있으며 작업 세부 정보 새로 고침을 지원합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/39274c3aa8e92e6c4dfe0a242de0392e.png"  style="zoom:85%;">
6. 복사가 완료된 후 **복사 상태**의 **실행**을 클릭하면 읽기 전용 인스턴스를 계속 복사할 수 있습니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/b27f75181ebae1e8c9b833762ba9388d.png"  style="zoom:85%;">


## 데이터 복사 중지
>?
>- 딜레이 복사 기능을 활성화해야만 복사 중단 기능을 사용할 수 있으며, 그렇지 않을 경우 **중단** 버튼은 사용 불가한 상태가 됩니다.
>- 복사를 중단하면 동시에 IO/SQL 스레드도 중단됩니다. 
>
1. [TencentDB for MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인하고 인스턴스 목록에서 읽기 전용 인스턴스 ID를 클릭하여 읽기 전용 인스턴스 상세 페이지로 들어갑니다.
2. 읽기 전용 인스턴스 상세 페이지의 **배포 정보** > **복사 상태**에서 **중지**를 클릭합니다.
<img src="https://main.qcloudimg.com/raw/8921d228b70bf42ca5120d6fcf44e92c.png"  style="zoom:85%;">
3. 팝업 창에서 오류가 없는지 확인한 다음 **확인**을 클릭합니다.

## FAQ
#### GTID는 어떻게 획득하나요?
flush log 명령어를 통해 binlog 파일을 획득하여 실수했을 때의 위치와 GTID를 지정하는 것을 권장합니다.

#### 딜레이 시간은 어떻게 확인하나요?
[콘솔](https://console.cloud.tencent.com/cdb)의 인스턴스 상세 페이지를 통해 읽기 전용 인스턴스와 프라이머리 인스턴스의 딜레이 시간을 확인할 수 있습니다.
![](https://main.qcloudimg.com/raw/0b975dfca0c575735b94445f11e30d67.png)

####지정 위치로 복사하는 작업의 정보를 어디서 확인할 수 있나요?
[콘솔](https://console.cloud.tencent.com/mysql/task)의 작업 리스트 페이지에서 작업의 진도와 세부 사항을 확인할 수 있습니다. 


