ここでは、MySQLコンソールを介して読み取り専用インスタンス遅延レプリケーションの設定と、レプリケーションの起動/停止の方法についてご紹介します。遅延レプリケーション（読み取り専用インスタンスとマスターインスタンス間の遅延）を設定し、遅延中に指定した時間またはGTID（Global Transaction ID）までのリカバリを起動するように選択することで、効率的なデータのロールバックと障害の高速なバックトレースを実現できます。
- 遅延レプリケーション：ユーザーは読み取り専用インスタンスROグループ設定または読み取り専用インスタンス管理ページで、読み取り専用インスタンスとマスターインスタンス間の遅延レプリケーション時間を有効化して設定できます。
- レプリケーションの起動/停止：読み取り専用インスタンスとマスターインスタンス間のデータ同期を手動で起動または停止できるようにサポートします。

## 遅延レプリケーションの説明
- 読み取り専用インスタンスが遅延レプリケーションを有効化した後、読み取り専用インスタンスは読み取り専用グループから削除され、重みは0に設定されます。同時に、読み取り専用インスタンスが削除されるアラームがトリガーされます。 このとき、読み取り専用グループのVIPアドレスを使用してアクセスすると、トラフィックは削除された読み取り専用インスタンスに転送されず、読み取り専用インスタンスのVIPアドレスでしかアクセスできなくなります。
- 読み取り専用グループで遅延排除機能が有効化された状態で、読み取り専用インスタンスが遅延レプリケーションをオフにした後、読み取り専用インスタンスの遅延時間が読み取り専用グループの遅延しきい値よりも小さい場合に限り、読み取り専用インスタンスの重みが回復し、重みが回復すると同時に、読み取り専用インスタンスの削除回復のアラームがトリガーされます。
- データの指定した位置でのレプリケーションを起動している間は、再起動、設定の変更、バージョンアップ、カーネルマイナーバージョンのバージョンアップの操作を同時に行うことができません。

## 遅延レプリケーションの有効化
>?読み取り専用インスタンス「遅延レプリケーション」はデフォルトでは「無効状態」で、有効化すると遅延レプリケーションの時間が表示されます。

### 読み取り専用インスタンスROグループ設定で有効化
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb/ )にログインし、インスタンスリストでマスターインスタンスIDをクリックして、インスタンス管理ページに進みます。
2. インスタンス管理ページで、**読み取り専用インスタンス**ページを選択し、ROグループリストで**設定**をクリックし、ROグループ設定ページに進みます。
![](https://qcloudimg.tencent-cloud.cn/raw/87041c7addd9dcfd058b2d3f7c417625.png)
3. ROグループ設定ページで、設定するROグループ情報内で**インスタンス遅延レプリケーション**、**遅延時間の設定**を有効化し、**OK**をクリックします。
   - **インスタンス遅延レプリケーション**：遅延レプリケーションを設定し、遅延中に指定された時間またはGTID（グローバルトランザクション識別子）へのリカバリの開始を選択することで、データの効率的なロールバックと障害の高速バックトラッキングを実現できます。
   - **遅延時間**：読み取り専用インスタンスとマスターインスタンス間の遅延レプリケーション時間です。設定可能範囲：1秒～259200秒。
   - **インスタンスの遅延・超過の排除**：排除ポリシーを起動するかどうかです。排除されたインスタンスの重みは自動的に0に設定されます。読み取り専用インスタンスの遅延がしきい値を超えて排除されると、ユーザーにアラートが出されます。読み取り専用インスタンス排除アラートと受信対象の設定については、[アラート機能](https://intl.cloud.tencent.com/document/product/236/8457)をご参照ください。
   - **遅延しきい値**：読み取り専用インスタンスに設定する遅延・超過しきい値。しきい値を超えた読み取り専用インスタンスはROグループから排除されます。
   - **最小保留インスタンス数**：グループ内で保証する必要のあるインスタンスの下限数。既存の読み取り専用インスタンス数がこの下限以下であり、かつ遅延時間がしきい値を超えた場合、既存の読み取り専用インスタンスはいずれも排除されません。
   - **読み取りの重みの割り当て**：ROグループはシステムによる重みの自動割り当てと重みのカスタマイズの2種類の重み設定方式をサポートします。重みの入力範囲は0～100で、整数である必要があります。
   - **リロードバランシング**：
    - リロードバランシングを停止した時は、重みを修正した時に追加の負荷に対してのみ反映され、元の長時間接続がアクセスする読み取り専用インスタンスは変更されず、データベースの瞬断を引き起こすことがありません。
    - リロードバランシングを有効化した時は、データベースが数秒間瞬断されることにより、すべての接続が切断されます。新規の接続は設定された重みに従い負荷のバランスをとります。
<img src="https://qcloudimg.tencent-cloud.cn/raw/c40a92c3a6dcc083ac92f01169b259ff.png"  style="zoom:50%;">

### 読み取り専用インスタンス管理ページで有効化
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストの読み取り専用インスタンスIDまたは**操作**列の**管理**をクリックし、読み取り専用インスタンス詳細ページに進みます。
2. 読み取り専用インスタンス詳細ページの**デプロイ情報** > **遅延レプリケーション**で**有効化**をクリックします。
![](https://qcloudimg.tencent-cloud.cn/raw/280f08c04f692445f51b1ab4aa556f58.png)
3. ポップアップしたダイアログボックスで、遅延時間を設定した後、**OK**をクリックします。
>?遅延時間の範囲値：1秒～259200秒。
>ROインスタンスの遅延時間を変更すると、それが属するROグループ内の他のROインスタンスが同期的に変更されます。
>
<img src="https://qcloudimg.tencent-cloud.cn/raw/32877ca9c8ab4bb3030bbb508c899374.png"  style="zoom:80%;">

## 遅延レプリケーションの変更
### 読み取り専用インスタンスROグループ設定で変更
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb/ )にログインし、インスタンスリストでマスターインスタンスIDをクリックして、インスタンス管理ページに進みます。
2. インスタンス管理ページで、**読み取り専用インスタンス**ページを選択し、ROグループリストで**設定**をクリックし、ROグループ設定ページに進みます。
3. ROグループ設定ページで**遅延時間**を変更し、**OK**をクリックします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/437d781e478652416c166449b4420910.png"  style="zoom:60%;">

### 読み取り専用インスタンス管理ページで変更
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、読み取り専用インスタンスリストで読み取り専用インスタンスIDをクリックして読み取り専用インスタンス詳細ページに進みます。
2. 読み取り専用インスタンス詳細ページの**デプロイ情報** > **遅延レプリケーション**で**変更**をクリックします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/5098762edf0e478942ad060c5bd80da5.png"  style="zoom:80%;">
3. ポップアップしたダイアログボックスで、遅延時間を設定した後、**OK**をクリックします。

## 遅延レプリケーションの無効化
### 読み取り専用インスタンスROグループ設定で無効化
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb/ )にログインし、インスタンスリストでマスターインスタンスIDをクリックして、インスタンス管理ページに進みます。
2. インスタンス管理ページで、**読み取り専用インスタンス**ページを選択し、ROグループリストで**設定**をクリックし、ROグループ設定ページに進みます。
3. ROグループ設定ページで**遅延レプリケーション**をクリックして無効化し、**OK**をクリックします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/9191e1c61694da2970323b59a21c59f3.png"  style="zoom:70%;">

### 読み取り専用インスタンス管理ページで無効化
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、読み取り専用インスタンスリストで読み取り専用インスタンスIDをクリックして読み取り専用インスタンス詳細ページに進みます。
2. 読み取り専用インスタンス詳細ページの**デプロイ情報** > **遅延レプリケーション**で**無効化**をクリックします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/5f3a33f7b23513b8766eb62455406478.png"  style="zoom:80%;">
3. ポップアップしたダイアログボックスで、誤りがないことを確認し、**OK**をクリックします。
>?遅延レプリケーションを無効化すると、遅延レプリケーション時間が0秒になり、読み取り専用インスタンスとマスターインスタンスの間でデータのリアルタイム同期が復旧されます。 
> 

## データレプリケーションの起動
>?読み取り専用インスタンス**レプリケーションのステータス**はデフォルトでは**正常**です。ユーザーが遅延レプリケーションを設定し、かつ遅延レプリケーションの時間帯に誤ってデータを削除した場合、誤った操作をした時の位置とGTIDによって、読み取り専用インスタンスはバイナリーログファイルの位置またはGTID以前までレプリケーションすることができ、すばやいデータ復旧の機能を実現します。
>
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、読み取り専用インスタンスリストで読み取り専用インスタンスIDをクリックして読み取り専用インスタンス詳細ページに進みます。
2. 読み取り専用インスタンス詳細ページ下部の**デプロイ情報** > **レプリケーションのステータス**で、**起動**をクリックします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/29703db36415992fda7e1767a7b830e8.png"  style="zoom:80%;">
3. ポップアップしたダイアログボックスで、**OK**をクリックします。
>? レプリケーションが起動すると、読み取り専用インスタンスのマスターインスタンス間とのデータ同期が復旧されます。
>
<img src="https://qcloudimg.tencent-cloud.cn/raw/ab58491f328ffe447f8790105699f13b.png"  style="zoom:80%;">
4. **デプロイ情報** > **レプリケーション操作**で** **指定位置へのレプリケーション**を選択する方法でも、具体的なタイムポイントと対応するGTIDへの起動をサポートします。具体的なタイムポイントまたは対応するGTIDへ復旧後、読み取り専用インスタンスは通常の起動方式に切り替わるまでその後のレプリケーションを停止し、切り替え後にレプリケーションを継続します。
    - 時間：選択できる時間範囲は、レプリケーションを停止した時間からマスターデータベースの現在時刻までの時間帯です。
    - GTID：選択できる範囲は読み取り専用インスタンスの適用が終わっていないバイナリーログ以降のすべてのログです。起動方式にGTIDを選択すると、具体的なトランザクション以前まで正確にレプリケーションを停止することができます。
インスタンスのserver_uuidの長さは規定されています。いずれも36ビットとし、GTIDのフォーマットは`server_uuid:transaction_id`である必要があります。
>!
>- 入力されたバイナリーログの位置がすでに読み取り専用インスタンスで適用、またはマスターインスタンスのポイントよりも大きい場合は、レプリケーションの起動に失敗する恐れがあります。
>- レプリケーション起動時に、バイナリーログに中断が存在する場合は、レプリケーションの起動に失敗する恐れがあります。
>- 遅延した読み取り専用インスタンスがレプリケーションプロセスを停止し、読み取り専用インスタンスのディスク容量の超過を招くことを避けるため、読み取り専用インスタンスのディスク容量が5GB未満の場合は、読み取り専用インスタンスのIOスレッドを一時停止します。
> 
<img src="https://qcloudimg.tencent-cloud.cn/raw/92671ad35d5ef5acbfdf3bfbb47f967a.png"  style="zoom:85%;">
5. 指定位置までレプリケーションするプロセスで、**レプリケーションのステータス**の後ろの**データリプレイ中**をクリックするとタスク詳細を照会でき、タスク詳細の更新をサポートします。
<img src="https://qcloudimg.tencent-cloud.cn/raw/39274c3aa8e92e6c4dfe0a242de0392e.png"  style="zoom:85%;">
6. レプリケーション完了後、**レプリケーションのステータス**の後で**起動**をクリックすると、読み取り専用インスタンスはレプリケーションを引き続きすぐに実行できます。
<img src="https://qcloudimg.tencent-cloud.cn/raw/b27f75181ebae1e8c9b833762ba9388d.png"  style="zoom:85%;">


## データレプリケーションの停止
>?
>- 遅延レプリケーション機能が有効な場合にのみ、レプリケーション停止機能の操作が認められ、そうでなければ**停止**ボタンは使用できない状態となります。
>- レプリケーションの停止と同時にIO/SQLスレッドも停止されます。
>
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、読み取り専用インスタンスリストで読み取り専用インスタンスIDをクリックして読み取り専用インスタンス詳細ページに進みます。
2. 読み取り専用インスタンス詳細ページ下部の**デプロイ情報** > **レプリケーションのステータス**で、**停止**をクリックします。
<img src="https://main.qcloudimg.com/raw/8921d228b70bf42ca5120d6fcf44e92c.png"  style="zoom:85%;">
3. ポップアップしたダイアログボックスで、誤りがないことを確認し、**OK**をクリックします。

## よくあるご質問
#### どのようにGTIDを取得しますか。
flush logコマンドを実行してbinlogファイルを取得し、誤操作時の位置とGTIDを特定することをお勧めします。

#### どのように遅延時間を確認しますか。
[コンソール](https://console.cloud.tencent.com/cdb) のインスタンス詳細ページで、読み取り専用インスタンスとマスターインスタンスの遅延時間を確認できます。
![](https://main.qcloudimg.com/raw/0b975dfca0c575735b94445f11e30d67.png)

#### どのように指定位置へのレプリケーション起動のタスク情報を確認しますか。
[コンソール](https://console.cloud.tencent.com/cdb) のタスクリストページで、タスクの進捗状況と詳細を確認できます。
![](https://main.qcloudimg.com/raw/f3c0cb3ed4d9488c66fc02cbd96b770d.png)

