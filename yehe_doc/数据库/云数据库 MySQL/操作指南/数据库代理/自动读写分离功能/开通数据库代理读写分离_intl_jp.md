[データベースプロキシ読み取り/書き込み分離](https://intl.cloud.tencent.com/document/product/236/42050) 機能により、アプリケーションにデータベースプロキシのアドレスを設定すると、書き込みリクエストを自動的にマスターインスタンスへ転送し、読み取りリクエストを自動的に個々の読み取り専用インスタンスへ転送することができます。

ここでは、TencentDB for MySQLの読み取り/書き込み分離機能を有効/無効にする方法をご紹介します。

##  前提条件
- インスタンスはマスターインスタンスであること。
- インスタンスに対して、［データベースプロキシのアクティブ化］(https://intl.cloud.tencent.com/document/product/236/42052)が完了していること。
- インスタンスに対して、 [読み取り専用インスタンスの作成](https://intl.cloud.tencent.com/document/product/236/7270)が完了していること。

## 読み取り/書き込み分離のアクティブ化
1. [MySQL コンソール](https://console.cloud.tencent.com/cdb)にログインします。
2. 上側でリージョンを選択し、インスタンスIDまたは**操作**列の**管理**をクリックすると、インスタンス管理画面が表示されます。
3. インスタンス管理画面の**データベースプロキシ**で、**読み取り/書き込み分離**を選択し、**今すぐ有効にする**をクリックします。
![](https://main.qcloudimg.com/raw/b07508f045b727ca63c294b707159474.png)
4. 表示されたダイアログボックスで、設定を選択して、**OK**をクリックします。
>!
>- 状態が実行中のマスターインスタンスと読み取り専用インスタンスのみ、データベースプロキシに追加することができます。
>- 現在、クロスリージョンROと遅延ROは、データベースプロキシの下にマウントすることはできません。
   - **読み取り専用インスタンスの排除**：排除ポリシーを有効にするかを設定します。読み取り専用インスタンスでレプリケーションの異常（レプリケーション遅延、レプリケーション中断）が発生した時、データベースプロキシは読み取り専用インスタンスを読み取り/書き込み分離から一時的に外します。遅延排除閾値はデフォルトで10秒で、読み取り専用インスタンスの最小保留数は1個となります。
>?読み取り専用インスタンス排除はしきい値とインスタンスの最小保留数を設定後、新たな接続に対してのみ有効となります。
   - **遅延排除閾値**：読み取り専用インスタンスがマスターインスタンスのデータと同期を取るときに許容される最大遅延時間。読み取り専用インスタンスの遅延時間が閾値を超えた場合、この読み取り専用インスタンスのウェイトがいくらかにもかかわらず、読み取りリクエストはこの読み取り専用インスタンスに転送されません。値の範囲は1以上の整数です。
     - 読み取り専用インスタンスの遅延がしきい値を超えた時は排除され、排除されたインスタンスの重みは自動的に0に設定されます。また、システムがユーザーにアラームを出します（まず「データベースプロキシマウントノードの排除」アラームをサブスクリプトする必要があります。設定については [アラーム機能](https://intl.cloud.tencent.com/document/product/236/8457)をご参照ください）。
     - 読み取り専用インスタンスの遅延がしきい値より小さい時は、新たにデータベースプロキシに追加されます。同時に、遅延排除機能が有効かどうかに関わらず、読み取り専用インスタンスの障害が排除された後、インスタンスが修復されるのを待って新たにデータベースプロキシに追加されます。
     - 読み取り専用の最小保留数の設定により、データベースプロキシが現在のルート中の読み取り専用インスタンスが設定された値よりも小さいことがわかった時は、読み取り/書き込み分離に関与する読み取り専用インスタンスの個数が最小保留数を満たすまで、異常のある読み取り専用インスタンスを読み取り/書き込み分離に戻します。
>!読み取り専用データベースで致命的な障害（パニックなど）が発生した時、最小保留数を致命的な障害が発生したインスタンスに適用できません。
   - **読み取り専用インスタンス最小保留数**：確保しなければならないインスタンスの最小数。既存の読み取り専用インスタンス数がこの最小値以下であり、かつ遅延時間が閾値を超えた場合、既存の読み取り専用インスタンスはいずれも排除されません。
   - **読み取りウェイト割当**：インスタンスに読み取りウェイトを割り当てます。システムによる自動割当かカスタムを指定できます。割り当てるウェイトの範囲は0 - 100の整数です。読み取りウェイト割当を設定すると、直ちにすべての接続に反映されます。
     - データベースプロキシは、重みの設定に従って読み取りリクエストのトラフィックを割り当てます。例えば、2つの読み取り専用データベースの重みがそれぞれ10と20の場合、それらの読み取りリクエストのトラフィックは1：2の比率で割り当てられます。
     - 重みは読み取りリクエストの重みのみで、書き込みリクエストはマスターデータベースに直接ルーティングされ、重みの計算には関与しません。 例えば、クライアントが10個の書き込みステートメントと10個の読み取りステートメントを送信し、マスターデータベースと読み取り専用データベースの重み比が1:1の場合、マスターデータベースは10個の書き込みステートメントと5個の読み取りステートメントを受信し、読み取り専用データベースは5個の読み取りステートメントのみ受信することになります。
     - システムによるウェイトの自動割り当てを選択した時、システムはインスタンスのCPUとメモリの仕様に基づいて自動的にウェイトを割り当てます。このときに設定できるのはマスターインスタンスの重みのみです。
     - 読み取り専用インスタンスのウェイトが0の場合、データベースプロキシはこの読み取り専用インスタンスへの接続を構築することはありません。読み取り専用インスタンスのウェイトを0から非0に変更しても、ウェイトはすぐに有効とならず、新規接続に対してのみ有効となります。
   - **フェイルオーバー**：有効にするかを設定します。有効にすることを推奨します。読み取り専用インスタンスに異常が発生した場合、データベースプロキシは読み取リクエストをマスターインスタンスへ送信します。
>?フェイルオーバー設定後は、新規接続に対してのみ有効となります。
   - **読み取り専用インスタンスの自動追加**：有効にするかを設定します。有効に設定した場合、新しい読み取り専用インスタンスを購入すると、自動的にデータベースプロキシに追加されます。
     - 読み取りウェイトがシステムによる自動割当の場合、新たに購入した読み取りインスタンスに対して、仕様に応じたデフォルトウェイトを割り当てます。
     - 読み取りウェイトがカスタムの場合、新たに購入した読み取りインスタンスを追加する時、そのウェイトはデフォルトで0とします。データベースプロキシ読み取り/書き込み分離を調整することで、ウェイトを変更できます。
![](https://main.qcloudimg.com/raw/f2eb858b2b37fd134913738b243a17e8.png)

## 画面での表示
データベースプロキシ読み取り/書き込み分離機能を有効にした場合、**読み取り/書き込み分離**画面で基本情報と読み取り/書き込みの構成イメージを確認できます。右側のボタンを使用し、設定の変更や読み取り/書き込み分離機能の無効化を実施できます。
![](https://main.qcloudimg.com/raw/098c9fae971719881b6d20eee6ba0e73.png)

## 読み取り/書き込みの無効化
1. [MySQL コンソール](https://console.cloud.tencent.com/cdb)にログインします。
2. 上側でリージョンを選択し、インスタンスIDまたは**操作**列の**管理**をクリックすると、インスタンス管理画面が表示されます。
3. インスタンス管理画面の**データベースプロキシ**で、**読み取り/書き込み分離**を選択し、右側で**読み取り/書き込みを無効にする**をクリックします。
![](https://qcloudimg.tencent-cloud.cn/raw/efa07dc1350c2fc9dc878914e22aef05.png)

