
본문에서는 TencentDB for MySQL 콘솔을 통한 데이터베이스 프록시 읽기/쓰기 분리 방법에 대해 소개합니다. 

[데이터베이스 프록시 읽기/쓰기 분리](https://intl.cloud.tencent.com/document/product/236/41093)기능을 통해 응용 프로그램에 데이터베이스 프록시 주소를 설정하면 쓰기 요청을 자동으로 마스터 인스턴스로 포워딩하고 읽기 요청을 자동으로 각 읽기 전용 인스턴스로 포워딩할 수 있습니다. 

##  전제 조건
- [데이터베이스 프록시 활성화]가 완료되어 있어야 합니다. (https://intl.cloud.tencent.com/document/product/236/41087)
- 해당 마스터 인스턴스는 [읽기 전용 인스턴스 생성](https://intl.cloud.tencent.com/document/product/236/7270)이 완료되어야 하며, 읽기 전용 인스턴스를 생성하지 않았다면 활성화 페이지에서 읽기 전용 인스턴스 구매를 안내합니다. 

- 작업 순서
1. [MySQL 콘솔](https://console.cloud.tencent.com/cdb)에 로그인한 뒤, 인스턴스 리스트에서 프록시를 활성화한 마스터 인스턴스를 선택하고 인스턴스 ID 혹은 '작업'열의 [관리]를 클릭하여 인스턴스 관리 페이지로 이동합니다.
2. 인스턴스 관리 페이지에서 [데이터베이스 프록시]>[읽기/쓰기 분리]페이지를 선택하고 [즉시 활성화]를 클릭합니다. 
![](https://main.qcloudimg.com/raw/b07508f045b727ca63c294b707159474.png)
3. 팝업된 대화 상자에서 딜레이 제거, 가중치 등을 설정하고 [확인]을 클릭합니다. 
>!
>- 상태가 ‘실행중’인 마스터 인스턴스와 읽기 전용 인스턴스 여야만 데이터베이스 프록시에 추가할 수 있습니다. 
>- 현재 원격 RO와 딜레이 RO는 데이터베이스 프록시에 마운트 할 수 없습니다.
>
 - **읽기 전용 인스턴스 제거**: 제거 정책 실행 여부. 읽기 전용 인스턴스에서 복사 이상 경고가 발생(복사 딜레이, 복사 중단)할 경우, 데이터베이스 프록시는 읽기 전용 인스턴스의 읽기/쓰기 분리를 일시적으로 삭제합니다. 딜레이 제거 임계값의 기본 설정은 10초이며, 읽기 전용 인스턴스의 최소 보관 수량은 1개 입니다.
 >?읽기 전용 인스턴스 제거 임계값과 최소 보관 수량을 설정하면 새롭게 연결된 것에 한해서만 설정이 적용이 됩니다.
 >
    - 만약 읽기 전용 인스턴스 딜레이가 임계값을 초과할 경우 삭제되며, 삭제된 인스턴스의 가중치는 0으로 자동 설정되고 시스템은 사용자에게 알람을 발송합니다(먼저 ‘데이터베이스 프록시 마운트 노드 제거’알람을 구독해야 하며, 설정에 관하여는 [알람 정책](https://intl.cloud.tencent.com/document/product/236/8457)을 참고 바랍니다.))
    - 읽기 전용 인스턴스의 딜레이가 임계값보다 작을 경우 다시 새롭게 데이터베이스 프록시에 추가됩니다. 동시에 딜레이 제거 기능 활성화 여부에 상관 없이 읽기 전용 인스턴스의 장애가 제거 되어 복구 되면, 복구된 인스턴스도 다시 새롭게 데이터베이스 프록시에 추가됩니다.
    - 읽기 전용 최소 보관 수량 설정을 통해 데이터베이스 프록시가 현재 라우팅 중인 읽기 전용 인스턴스가 설정한 값보다 작은 것을 발견 시, 오류가 난 읽기 전용 인스턴스를 읽기 전용 인스턴스 개수가 최소 보관 수량에 만족할 때까지 읽기/쓰기 분리로 이동시킵니다.
주의: 읽기 전용 라이브러리에서 치명적인 장애(예: 시스템 다운)가 발생할 경우, 최소 보류 수량은 치명적인 장애가 발생한 인스턴스에 대하여 작용하지 못합니다.
 - **읽기 가중치 할당**: 시스템 가중치 자동 할당과 사용자 정의 할당 2가지 방식을 지원하여, 마스터 인스턴스와 읽기 전용 인스턴스의 읽기 가중치를 설정합니다. 가중치 입력 범위는 0-100이며 정수여야 합니다.
 >?읽기 가중치 할당 설정 후, 모든 연결에 즉시 적용 됩니다. 
 >
    - 데이터베이스 프록시는 가중치 설정에 따라 읽기 요청의 트래픽을 할당합니다. 예를 들어, 2개의 읽기 전용 데이터베이스의 가중치가 각각 10과 20인 경우, 읽기 요청 트래픽은 1:2의 비율로 할당됩니다.
    - 가중치는 읽기 요청의 가중치만 해당되며, 쓰기 요청은 바로 마스터 데이터베이스로 라우팅 되어 가중치 계산에 포함되지 않습니다. 예를 들어, 클라이언트가 10개의 쓰기 명령과 10개의 읽기 명령을 발송하면 마스터 데이터베이스와 읽기 전용 데이터베이스의 가중치는 1:1이 되며, 마스터 데이터베이스는 10개의 쓰기 명령과 5개의 읽기 명령을 수신하고, 읽기 전용 데이터베이스는 5개의 읽기 명령을 수신합니다.
    - 시스템 가중치 자동 할당을 선택할 경우, 시스템은 인스턴스의 CPU와 메모리 사양에 따라 자동으로 가중치를 할당하며, 이 경우 마스터 인스턴스의 가중치만 설정 가능합니다. 
    - 읽기 전용 인스턴스의 가중치가 0일 경우, 데이터베이스 프록시는 해당 읽기 전용 인스턴스와 연결하지 않습니다. 또한 읽기 전용 인스턴스의 가중치를 0에서 0 이상으로 설정할 경우, 가중치는 바로 적용되지 않고 새로운 연결에 한해서만 설정이 적용합니다.
 - **장애 조치**: 활성화를 권장합니다. 읽기 전용 인스턴스에 오류가 발생할 경우 데이터베이스 프록시가 읽기 요청을 마스터 인스턴스로 발송합니다. 
 >?장애 조치 설정 후 새로운 연결에 한해서만 설정 적용됩니다. 
 >
해당 파라미터를 비활성화할 경우 읽기 전용 인스턴스에 오류가 생겨도 읽기 요청은 마스터 인스턴스로 발송되지 않습니다(과도한 읽기 부하로 마스터 인스턴스에 영향을 주는 것을 방지하기 위함). 모든 읽기 요청은 실패하게 되고 읽기 요청 실패 후 데이터베이스 프록시는 자동으로 클라이언트와의 연결을 끊습니다.
 - **읽기 전용 인스턴스 자동 추가**: 활성화할 경우 마스터 인스턴스가 추후에 생성한 읽기 전용 인스턴스를 데이터베이스 프록시에 추가합니다. 
![](https://main.qcloudimg.com/raw/f2eb858b2b37fd134913738b243a17e8.png)
4. 활성화 성공 후 읽기/쓰기 분리 페이지에서 기본 정보, 읽기/쓰기 분리 아키텍처를 확인할 수 있으며 읽기/쓰기 분리 설정을 수정할 수 있습니다. 
  - 우측 상단의 [설정 수정]을 클릭하면 딜레이 제거, 가중치 할당 등을 새롭게 설정할 수 있습니다.
  - 우측 상단의 [읽기/쓰기 분리 비활성화]를 클릭하면 데이터베이스 프록시의 읽기/쓰기 분리를 비활성화할 수 있습니다.
![](https://main.qcloudimg.com/raw/098c9fae971719881b6d20eee6ba0e73.png)
