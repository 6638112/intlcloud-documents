
## 操作シナリオ
TencentDB for MySQLは任意にユーザーのデータを変更することは一切ありません。ユーザーによるデータ損壊はロールバック操作を行いリカバーすることが可能です。ロールバック機能を使用してTencent Cloudプラットフォームにおけるデータベース又はテーブルに対しロールバック操作を行うことが可能です。ロールバックはデータバックアップ + ログバックアップ（binlog）に基づく機能であり、リアルタイムにデータのロールバックを行うことが可能です。

TencentDB for MySQLのロールバックは定期イメージとリアルタイムトランザクションの再作成により、MySQL又はテーブルを指定した時間にロールバックし、すべてのデータのタイムスライスが一致することを保証することができます。その間、元々のデータベース又はテーブルへのアクセスは影響されません。ロールバック操作により、元のインスタンスに新しいデータベース又はテーブルが作成されます。ロールバック完了後、ユーザーは元のデータベース又はテーブル、及び新しいデータベース又はテーブルが見られます。

## 機能原理
ロールバック機能は、直近時点の`コールドバックアップ+ 対応するbinlogバックアップ`に基づき、データベースまたはテーブルを特定の時点にロールバックできます。
![](https://main.qcloudimg.com/raw/89ab32296ba576cf8e087d760b5a8109.png)
1. コールドバックアップシステムは毎日、MySQLのスレーブホストからデータをコールドバックアップシステムにエクスポートします。
2. ロールバックを実行する際には、まずロールバックシステムから1つの一時ロールバックインスタンスをリクエストし、次にコールドバックアップシステムからコールドバックアップデータをエクスポートし、それを一時ロールバックインスタンスをインスポートします（ロールバック方式によって異なるデータをインスポートする）。
3. ロールバックインスタンスとMySQLマスターインスタンスはマスター／スレーブ関係を確立し、ロールバック時間を設定し、ロールバックするデータベースまたはテーブルを指定します。
4. ロールバックされたデータベースとテーブルをMySQLマスターインスタンスにコピーします。

## 機能制限
- ロールバック対象としては、マスターインスタンスがサポートされていますが、読み取り専用インスタンスとディザスタリカバリインスタンスがサポートされていません。
- 現在、指定したデータベースまたはテーブルのみをロールバックできます。ロールバックされたデータベースとテーブルはソースインスタンス（リネームする必要があります）に複製されます。インスタンス全体のロールバックがサポートされていません。

## 注意事項
- ロールバック機能は自動バックアップに設定されているバックアップサイクルと保持日数に関連しており、保持日数以内、且つバックアップサイクル以内のデータバックアップ + ログバックアップ（binlog）のロールバックを提供します。バックアップサイクルの設定については[MySQLデータの自動バックアップ](https://intl.cloud.tencent.com/document/product/236/37796)をご参照ください。データの安全性を確保するために、自動バックアップに設定されたバックアップサイクルとして、1週間に少なくともMySQLを2回以上バックアップするように設定してください。
- ロールバックしようとするデータベースまたはテーブルが存在しないか、誤って削除された場合は、コンソールでロールバックを実行する前に、TencentDBインスタンスにログインして作成する必要があります。
- ロールバック前のコールドバックアップにこのテーブルが含まれていない場合、ロールバックは失敗します。

## 操作手順
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストで、ロールバックする1つ以上のインスタンスを選択して、上部にある【その他の操作】>【ロールバック】を選択します。
>?
>- ロールバックするインスタンスが1つのみの場合は、インスタンス管理画面に進み、右上隅の【ロールバック】をクリックします。
>- 同一のAPPIDで、同時に5回のロールバックタスクを行うことができます。
>
![](https://main.qcloudimg.com/raw/abd517cf8b6db3db57b622f13d365893.png)
2. ロールバック画面で、ロールバックデータベーステーブルを選択し、【次へ：ロールバック時間の設定とデータベーステーブル名】をクリックします。
   - 	普通：このインスタンスの完全バックアップをインポートして、選択したデータベース、テーブルをロールバックします。このロールバックモードが無制限であるが、ロールバック速度が遅い。
   - 高速：完全バックアップ+データベースレベルのバイナリログがインポートされます。データベース間の操作があり、且つ関連データベースが同時に選択されていない場合、ロールバックが失敗することがあります。
   - 超高速：完全バックアップ+テーブルレベルのバイナリログがインポートされます。テーブル間の操作があり、且つ関連テーブルが同時に選択されていない場合、ロールバックが失敗することがあります。
>?
>- 現在、名前が数字、アルファベット、アンダーラインおよびその組み合わせであるデータベーステーブルのロールバックのみをサポートしています。現時点では、その他の特殊文字を使用したデータベーステーブル名はサポートしていません。
>- 指定したデータベース/テーブルのみをロールバックできるモードでは、同じインスタンスは500個までのデータベース又はテーブルを同時にロールバックすることができます。
>- ロールバックにbinlogを実行する時、他のデータベースとテーブルの複合操作に関する場合、SQLステートメントの実行に失敗する可能性があります。　　
>- ロールバックにbinlogを実行する時、テーブルが外部キーなどの制限に関わると、SQLステートメントの実行に失敗する可能性があります。
>
![](https://main.qcloudimg.com/raw/6cb2fa4d3e8b0d795bd5bf19f8d69d86.png)
3. ロールバック後のデータベースまたはテーブルの名前およびロールバック時間を設定し、【ロールバック】をクリックします。
>?
>- インスタンスごとに１つのロールバック時間のみ設定できます。
>- 一括ロールバック時間の設定を選択した場合、すべてのデータベースまたはテーブルは一括ロールバック時間を基準とします。
>- 単一テーブルのロールバック時間の設定を選択した場合、データベースとテーブルはそれぞれ設定されたロールバック時間を基準とします。
>- ロールバック後のデータベースまたはテーブルの名前には、64桁以内の英文字、数字、小数点（.）、ハイフン（-）、アンダーライン（\_）、$のみをサポートしています。
>
![](https://main.qcloudimg.com/raw/62377981b147bdb453d79631b3557d12.png)
5. 送信後、【操作ログ】>【ロールバックログ】ページに戻り、ロールバックの進捗を確認できます。【詳細を見る】をクリックすると、リアルタイムにロールバックログを確認できます。
![](https://main.qcloudimg.com/raw/b5206b3c23d532553fb54dfc4fe7bfd0.png)
6. ロールバック完了後、【データベース管理】>【データベースリスト】に移動して、元のインスタンスでロールバック後の新しいデータベースとテーブルが見られます。
![](https://main.qcloudimg.com/raw/9b939d9a6a7da59092df0051f452b5cd.png)

