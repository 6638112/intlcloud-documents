본 문서에서는 TencentDB for MySQL의 데이터를 Tencent 클라우드 데이터 웨어하우스 PostgreSQL(CDWPG)로 동기화하는 프로세스에 대해 소개합니다.

CDWPG는 Tencent Cloud의 빅 데이터 웨어하우스 제품으로서, DTS를 통해 TencentDB for MySQL에서 CDWPG로 데이터를 실시간 동기화하여 TP(온라인 트랜잭션) 데이터베이스에서부터 AP(온라인 분석) 데이터베이스에 이르는 데이터 폐쇄 루프를 구축해 줍니다.

## 전제 조건
- [TencentDB for MySQL 인스턴스 생성](https://intl.cloud.tencent.com/document/product/236/37785)이 완료되어 있어야 하고, MySQL 5.6, MySQL 5.7 버전이 지원되어야 합니다.
- 원본 MySQL 인스턴스에 마이그레이션 계정을 생성해야 하며, 다음과 같은 계정 권한이 필요합니다.
```
GRANT RELOAD, LOCK TABLE, REPLICATION CLIENT, REPLICATION SLAVE, SELECT ON *.* TO ‘마이그레이션 계정’@"%" IDENTIFIED BY ‘마이그레이션 비밀번호’:
GRANT ALL PRIVILEGES ON `__tencentdb__`.* TO ‘마이그레이션 계정’@"%";
FLUSH PRIVILEGES;
```
- [CDWPG 생성](https://cloud.tencent.com/document/product/878/31447)이 완료되어 있고, CDWPG 1.0.0 버전을 지원합니다.
- 타깃 CDWPG 인스턴스에 마이그레이션 계정을 생성해야 하며, 다음과 같은 계정 권한이 필요합니다.
```
Delete
Truncate
Insert
References
Select
Update
TRIGGER
```
- TencentDB for MySQL에서 CDWPG로의 데이터 동기화 작업을 구성하고, 작업 실행 전에 사전 점검을 진행해야 합니다. 점검 내용 및 점검 포인트는 다음과 같습니다.

| 점검 내용                            | 점검 포인트                                             |
| ------------------------------ | ------------------------------------------- |
| 타깃 데이터베이스 schema와 table 존재 여부 검증 | 반드시 사전에 schema와 table을 생성해야 하며 미생성 시 오류 알림이 발생합니다. |
| 현재 사용자의 타깃 데이터 테이블 권한 보유 여부 검증 | 동기화할 테이블에 대해 우선 현재 사용자가 해당 테이블의 owner(owner는 모든 권한 보유)인지 확인하고, owner가 아닌 경우 information_schema.table_privilege 테이블에서의 권한 부여 정보를 확인하여 반드시 Delete, Truncate, Insert, References, Select, Update, TRIGGER 권한을 부여해야 합니다. 권한이 부여되지 않으면 오류 알림이 발생합니다. |
| 타깃 데이터베이스의 디스크 공간이 충분한지 검증 | 타깃 데이터베이스의 가용 공간과 소스 데이터베이스의 필요 공간을 비교합니다. |
| 소스 데이터베이스 권한 검증 | 원본 인스턴스에 대해 Reload, LockTable, ReplClient, ReplSlave, Select, REPLICATION CLIENT 권한이 있는지 확인합니다. |
| 소스 MySQL connect_timeout 매개변수 검증 | MySQL 측의 connect_timeout 매개변수가 10보다 작은지 검증합니다. 10보다 작은 경우 오류 알람이 발생합니다. |
| 소스 및 타깃 데이터베이스 연결 검증 | MySQL과 CDWPG가 제대로 연결되어 있는지 검증합니다. |
| 소스 데이터베이스 버전 검증	| MySQL 버전이 MySQL 5.6 또는 MySQL 5.7이어야 합니다. |
| 소스 최적화 매개변수 검증 | innodb_stats_on_metadata 지표를 비활성화해야 합니다. |
| 소스 binlog 매개변수 검증 |	binlog_format은 ROW, binlog_row_image는 FULL, log_bin은 ON, gtid_mode는 ON이어야 합니다. |
| 기본 키 제한 검증 |	동기화할 원본 테이블에 기본 키가 있어야 합니다. |
| 소스 데이터베이스 인코딩 검증	| 소스 데이터베이스는 utf8 또는 utf8mb4여야 합니다. |
| MySQL 테이블 이름의 대소문자 구성이 올바른지 검증	| lower_case_table_names 매개변수가 0인지 확인합니다. 0인 경우 올바른 구성이 아닙니다. |
| MySQL 데이터베이스 이름과 열 이름에 `"`이 있는지 검증	| CDWPG는 열 이름에`"`를 지원하지 않습니다. |

## 주의 사항
- DTS가 전체 데이터 마이그레이션을 진행할 때 일정 원본 인스턴스 리소스를 점유함으로써 원본 인스턴스 부하가 높아져 데이터베이스 자체의 부담이 가중될 수 있습니다. 데이터베이스의 사양이 낮을 경우 서비스 사용량이 적은 시간대에 진행하는 것을 권장합니다.
- TencentDB for MySQL에서 동기화할 테이블에는 반드시 기본 키가 있어야 합니다.

## 동기화 지원 SQL 작업
INSERT, UPDATE, DELETE, REPLACE를 포함한 원본 데이터베이스 동기화 테이블의 DML 작업을 지원합니다.

## 동기화 지원 아키텍처
- 일대일 단방향 동기화를 지원합니다.
- 일대다 단방향 동기화를 지원합니다.
- 다대일 단방향 동기화를 지원합니다.

## 작업 순서
1. [데이터 동기화 구매 페이지](https://buy.cloud.tencent.com/dts)에 로그인하여 알맞은 구성을 선택하고 [즉시 구매]를 클릭합니다.
 - 과금 방식: 정액 과금제 및 종량제 과금 방식을 지원하며, 현재는 무료입니다. 향후 과금 관련 내용은 이메일이나 내부 메시지를 통해 한달 전에 미리 사용자에게 공지할 예정입니다.
 - 원본 인스턴스 유형: 현재는 MySQL만 지원합니다.
 - 원본 인스턴스 리전: 한번 선택하면 수정할 수 없습니다. 원본 인스턴스가 소재한 리전을 선택하십시오.
 - 타깃 인스턴스 유형: 현재는 CDWPG만 지원합니다.
 - 타깃 인스턴스 리전: 한번 선택하면 수정할 수 없습니다. 타깃 인스턴스가 소재한 리전을 선택하십시오.
 - 동기화 작업 사양: 현재는 표준 버전만 지원합니다.
2. 팝업 대화창에서 오류가 없는지 확인한 뒤, [즉시 구매]를 클릭하여 데이터 동기화 리스트로 돌아가면 새로 생성된 데이터 동기화 작업을 확인할 수 있습니다. 새로 생성된 동기화 작업은 구성을 완료해야 사용할 수 있습니다.
3. [데이터 동기화 리스트](https://console.cloud.tencent.com/dts/replication)에서 '작업'열의 [구성]을 클릭해 동기화 작업 구성 페이지로 들어갑니다.
4. 동기화 작업 구성 페이지에서 원본 인스턴스와 타깃 인스턴스를 구성하고 계정 및 비밀번호를 설정한 뒤 연결성 테스트를 하고 [다음 단계]를 클릭합니다.
 - 작업 이름: DTS는 자동으로 작업 이름을 생성하며 사용자가 실제 상황에 따라 설정할 수 있습니다.
 - 실행 모드: 즉시 실행과 예약 실행의 두 가지 모드를 지원합니다.
 - 원본 인스턴스 유형: 선택한 CDB 인스턴스의 유형으로, 수정할 수 없습니다.
 - 원본 인스턴스 리전: 선택한 CDB 인스턴스의 소재 리전으로, 수정할 수 없습니다.
 - 액세스 유형: 현재 CDB를 지원합니다.
 - 인스턴스 ID: 원본 인스턴스 ID를 선택합니다.
 - 원본 인스턴스 데이터베이스 계정과 비밀번호: 실제 [데이터베이스 계정과 비밀번호](https://intl.cloud.tencent.com/document/product/236/31901)를 입력하고 [연결성 테스트]를 클릭합니다.
 - 타깃 인스턴스 유형: 선택한 타깃 인스턴스의 유형으로, 수정할 수 없습니다.
 - 타깃 인스턴스 리전: 선택한 타깃 인스턴스의 소재 리전으로, 수정할 수 없습니다.
 - 액세스 유형: 현재 CDWPG를 지원합니다.
 - 인스턴스ID: 타깃 인스턴스 ID를 선택합니다.
 - 데이터베이스 이름: CDWPG가 포함된 데이터 이름과 동기화 합니다.
 - 타깃 인스턴스 데이터베이스 계정과 비밀번호: 실제 [데이터베이스 계정과 비밀번호](https://console.cloud.tencent.com/cdwpg)를 입력하고 [연결성 테스트]를 클릭합니다.
5. 동기화 옵션과 동기화 객체 설정 페이지에서 적합한 설정을 선택하고 [저장 및 다음 단계]를 클릭합니다.
 - 동기화 초기화: 현재는 전체 데이터 초기화만 지원합니다.
 - 동일한 테이블 이름이 존재하는 경우: 삭제하고 초기화하기와 무시하고 계속 실행하기의 두 가지 정책을 지원합니다.
    - 삭제하고 초기화하기: 타깃에 동일한 이름의 테이블이 있는 경우 동일한 이름의 테이블에 있는 데이터를 삭제하고 초기화합니다.
    - 무시하고 계속 실행하기: 전체 데이터를 초기화하면 모든 데이터를 추가하고 여러 테이블을 하나의 테이블로 취합합니다.
 - 동기화 작업 유형: 현재 DML 작업만 지원합니다.
 - 동기화 객체: 소스 라이브러리에서 동기화할 테이블 객체를 선택합니다.
6. 검증 작업 페이지에서 검증을 완료하고 모든 점검 항목이 통과되면 [작업 실행]을 클릭합니다.
7. 데이터 동기화 작업 리스트로 돌아가면 작업이 ‘실행 중’ 상태가 됩니다.
 - 작업을 일시 중단하면 데이터 동기화가 일시 중단되고, [실행]을 클릭하면 데이터 동기화를 계속 진행합니다.
 - 작업을 중단하면 작업이 그대로 종료됩니다. 데이터 동기화가 완료되었는지 확인하고 작업을 종료하십시오.
 - 일시 중단 상태에서 해당 작업을 리셋할 수 있습니다. 작업 리셋 후에는 해당 동기화 정보가 저장되지 않으니 작업 시 유의하여 주십시오.
8. (옵션) 작업 이름을 클릭하여 작업 상세 보기 페이지로 들어가면 작업 초기화 상태 및 모니터링 데이터를 확인할 수 있습니다.


