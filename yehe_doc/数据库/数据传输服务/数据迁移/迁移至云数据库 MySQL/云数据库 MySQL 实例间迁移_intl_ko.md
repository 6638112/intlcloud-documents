
본 문서에서는 DTS 데이터 마이그레이션 기능을 사용한 TencentDB for MySQL 인스턴스 간의 데이터 마이그레이션에 대해 소개합니다. DTS는 구조 마이그레이션, 전체 데이터 마이그레이션 및 증분 데이터 마이그레이션을 지원하며, 서비스를 중단하지 않고도 TencentDB for MySQL 인스턴스 간에 원활한 마이그레이션 구현이 가능합니다.
<span id="qttj"></span>
## [전제 조건]
- [TencentDB for MySQL 인스턴스 생성](https://intl.cloud.tencent.com/document/product/236/37785)이 완료되어 있어야 하며, MySQL 5.5, MySQL 5.6, MySQL 5.7 버전이 지원되어야 합니다.
- 타깃 MySQL에 마이그레이션 계정을 생성해야 하며, 마이그레이션 예정 객체에 대한 모든 읽기 쓰기 권한 등 계정 권한이 필요합니다.

## 주의 사항 
- TencentDB for MySQL 간의 데이터 마이그레이션 작업은 콜드 스탠바이 데이터 내보내기와 증분 데이터 동기화로 나뉩니다. 그중 콜드 스탠바이 데이터 내보내기와 마이그레이션 후의 데이터 대조 과정은 소스 라이브러리에 부하를 일으켜 영향을 줄 수 있습니다. 따라서 서비스 사용량이 적은 때 또는 백업 데이터베이스에서 데이터베이스 마이그레이션을 하는 것을 권장합니다.
- lower_case_table_name의 마이그레이션 검증 작업 중 소스와 타깃의 해당 항목 설정이 일치하지 않는 경우에는 오류가 보고됩니다. lower_case_table_name으로 인해 재시작되지 않도록 미리 조치하십시오.
- 전체 인스턴스 마이그레이션이 모든 백업을 가져온 후에는 타깃 인스턴스를 재시작해야 합니다.

## 지원하는 마이그레이션 유형
- 구조 마이그레이션: DTS는 마이그레이션 객체의 구조 정의를 타깃 인스턴스로 마이그레이션하는 것을 지원하며, 현재 DTS가 구조 마이그레이션을 지원하는 객체로는 전체 인스턴스와 지정 DB 테이블이 있습니다.
- 전체 마이그레이션: DTS는 소스 MySQL 데이터베이스 마이그레이션 객체의 모든 데이터를 타깃 TencentDB for MySQL로 마이그레이션하는 것을 지원합니다.
- 증분 동기화: DTS는 전체 데이터 마이그레이션을 바탕으로 소스 MySQL 데이터베이스의 binlog 정보를 읽어와 분석하고, 소스 MySQL의 증분 업데이트를 타깃 MySQL로 동기화합니다.

## 사전 점검 항목
1. 충돌을 피하기 위해 타깃 TencentDB for MySQL에 동명의 DB 테이블이 있는지 확인합니다.
2. 데이터베이스 버전이 MySQL 5.5, MySQL 5.6, MySQL 5.7 버전의 클라우드 마이그레이션을 지원하는지 확인합니다.
3. 타깃 TencentDB for MySQL 용량은 반드시 소스 TencentDB for MySQL보다 커야 합니다.
4. 소스 TencentDB for MySQL에서 마이그레이션 계정을 생성합니다(데이터 마이그레이션에 사용 가능한 권한이 있는 계정이 있을 경우에는 생성하지 않아도 됨).
```
GRANT ALL PRIVILEGES ON *.* TO "마이그레이션 계정"@"%" IDENTIFIED BY "마이그레이션 비밀번호";
FLUSH PRIVILEGES;
```
5. 소스 라이브러리 MySQL의 변수 확인
`SHOW GLOBAL VARIABLES LIKE 'XXX';`를 통해 MySQL 전역 변수를 조회하여 현재 마이그레이션 진행이 가능한 상황인지 확인합니다.
```
server_id > 1
log_bin = ON;
binlog_format = ROW/MIXED
binlog_row_image = FULL
innodb_stats_on_metadata = 0
wait_timeout은 3600초 이상을 권장하며, 7200초 미만이어야 합니다.
interactive_timeout과 wait_timeout 시간을 동일하게 설정합니다.
```
원본 인스턴스가 slave 역할일 경우, 원본 인스턴스에서 다음 매개변수를 확인해야 합니다.
```
log_slave_updates = 1
```
6. 변수 수정
a. 자체구축 MySQL 데이터베이스의 경우, 소스 라이브러리 MySQL 구성 파일 `my.cnf` 수정 시 재시작 필요:
```
log-bin=[사용자 정의 binlog 파일명]
```
b. 동적 설정 수정:
```
set global server_id = 99;
set global binlog_format=ROW;
set global binlog_row_image=FULL;
set global innodb_stats_on_metadata = 0;
```

## 작업 순서
1. [DTS 데이터 마이그레이션 콘솔](https://console.cloud.tencent.com/dts/migration)에 로그인한 뒤 [마이그레이션 작업 생성]을 클릭해 신규 마이그레이션 작업 생성 페이지로 이동합니다.
2. 신규 마이그레이션 작업 생성 페이지에서 마이그레이션의 타깃 인스턴스 소재 리전을 선택하고 [0USD 구매]를 클릭하면 DTS 데이터 마이그레이션 기능을 무료로 이용하실 수 있습니다.
3. 소스와 타깃 데이터베이스 설정 페이지에서 작업 설정, 소스 라이브러리 설정 및 타깃 라이브러리 설정을 완료하고, 소스 라이브러리와 타깃 라이브러리의 연결성 테스트를 통과하면 [생성]을 클릭합니다.
>?연결성 테스트에 실패한 경우 알림에 따라 문제를 확인하고 해결한 뒤 재시도 하십시오.
>
 - 작업 설정
    - 작업 이름: 작업 이름을 지정합니다.
    - 예약 실행: 마이그레이션 작업 시작 시간을 지정할 수 있습니다.
    - 태그: 태그는 다양한 각도에서 리소스를 분류하여 관리하는 데 사용됩니다.
 - 소스 라이브러리 설정
    - 소스 라이브러리 유형: CDB를 선택하세요.
 - 타깃 라이브러리 설정
    타깃 데이터- 타깃 데이터베이스 인스턴스를 선택하고 타깃 라이브러리의 계정과 비밀번호를 입력합니다.
4. 마이그레이션 옵션 설정 및 마이그레이션 객체 선택 페이지에서 마이그레이션 유형과 마이그레이션 객체를 설정하고 [저장]을 클릭합니다.
>!
>- 전체 인스턴스 마이그레이션 시에만 character_set_server, lower_case_table_names 설정 항목을 마이그레이션합니다.
>- 원본 인스턴스에서 마이그레이션한 DB 테이블 문자 세트 설정과 타깃 인스턴스 문자 세트 설정이 일치하지 않을 경우, 마이그레이션 시 원본 인스턴스의 문자 세트 설정이 유지됩니다.
>
 - 마이그레이션 유형: 구조 마이그레이션, 전체 마이그레이션, 전체 + 증분 마이그레이션을 지원합니다.
 - 마이그레이션 객체: 전체 인스턴스, 지정 객체를 지원합니다.
 - 소스 라이브러리의 root 계정으로 타깃 라이브러리 덮어쓰기: root 계정은 CDB의 보안성 검증에 사용되기 때문에 소스 라이브러리의 root 계정이 존재하지 않을 경우 이후 CDB의 사용에 불편을 초래할 수 있습니다. 따라서 전체 인스턴스 마이그레이션 시, 소스 라이브러리의 root 계정으로 타깃 라이브러리의 root 계정을 덮어쓰기 할 것인지 여부를 지정해야 합니다. 소스 라이브러리의 root 계정을 사용해야 하거나 타깃 라이브러리의 root 계정을 아직 설정하지 않았을 경우 [예]를 선택하고, 타깃 라이브러리의 root 계정을 유지해야 하는 경우 [아니오]를 선택합니다.
 - 타깃 라이브러리 읽기 전용: 읽기 전용을 선택한 후 데이터 마이그레이션 중 소스 데이터베이스에서 마이그레이션한 데이터는 타깃 데이터베이스에서 읽을 수만 있으며(Read Only), 사용자가 마이그레이션 작업 완료를 클릭할 때까지는 수정할 수 없습니다.
 - 데이터 일관성 검증: 전량 검증 및 미검증을 지원합니다.
5. 검증 작업 페이지에서 검증을 진행하고 검증을 통과한 후 [작업 실행]을 클릭합니다.
작업 검증에는 3가지 상태가 있습니다.
 - 통과: 검증 통과를 의미합니다.
 - 경고: 검증 미통과를 의미하며, 마이그레이션 과정 혹은 마이그레이션 후 데이터베이스의 정상적인 실행에 영향을 줄 수 있습니다. 하지만 마이그레이션 작업의 실행에는 영향을 주지 않습니다.
 - 실패: 검증에 통과하지 못해 마이그레이션을 진행할 수 없다고 표시됩니다. 검증 실패 시 오류가 발생한 점검 항목에 따라 마이그레이션 작업 정보를 체크 및 수정한 후 다시 검증하십시오. 실패 원인은 [상세 보기]를 클릭해 ‘검증 상세 보기’에서 확인하실 수 있습니다.
6. 검증 통과 후 마이그레이션 작업 리스트에서 [즉시 실행]을 클릭하면 바로 데이터 마이그레이션을 시작합니다. 마이그레이션 작업을 예약한 경우, 마이그레이션 작업이 설정된 시간에 정렬되고 시작되니 주의하십시오. 작업 시간을 설정하지 않은 경우에는 즉시 마이그레이션 작업이 시작됩니다.
마이그레이션 실행 후에는 마이그레이션 작업에서 해당 작업의 진행 정보를 볼 수 있습니다. 절차 뒤의 느낌표 프롬프트에 커서를 갖다 대면 마이그레이션에 필요한 과정 및 현재 단계가 표시됩니다.
>!시스템 설계의 한계로 인해 여러 마이그레이션 작업을 한꺼번에 제출하거나 정렬하는 경우에는 정렬 순서에 따라 순차적으로 실행됩니다.
>
7. 마이그레이션 작업 생성 시 기본적으로 증분 동기화 옵션을 반드시 선택해야 합니다. 데이터 마이그레이션 완료 후에는 타깃 TencentDB for MySQL 데이터베이스가 소스 데이터베이스의 백업 데이터베이스가 되며, 액티브/스탠바이 동기화로 마이그레이션 과정 중에 소스 라이브러리에 신규 추가된 데이터가 TencentDB for MySQL로 동기화됩니다. 이때, 소스 라이브러리의 변경사항도 모두 TencentDB for MySQL로 동기화됩니다.
>!동기화를 종료하기 전에는 타깃 데이터베이스의 인스턴스에 데이터를 입력해서는 안 됩니다. 입력할 경우 소스 라이브러리와 타깃 라이브러리 데이터 불일치로 인해 데이터 대조에 실패하고, 마이그레이션에 실패할 수 있습니다.
>
8. (옵션) 마이그레이션 진행 도중에 마이그레이션을 취소해야 할 경우에는 [취소]를 클릭하십시오.
>!
>- [취소]를 클릭해도 타깃 인스턴스에 동기화된 데이터는 제거되지 않습니다.
>- 다시 실행 시 검증에 실패하거나 작업에 실패할 수 있습니다. 수동으로 타깃 라이브러리 내에서 충돌이 발생할 수 있는 데이터베이스 혹은 리스트를 삭제해야 마이그레이션 작업을 다시 실행하실 수 있습니다.
>- 단독 리스트를 마이그레이션할 시 반드시 모든 외래 키에 종속된 테이블이 마이그레이션되어야 합니다.
>
9. 마이그레이션 완료.
>!현재 마이그레이션이 '미완료' 상태일 경우, 마이그레이션 작업이 계속 진행되어 데이터가 계속 동기화됩니다.
>
마이그레이션 진행도가 100%에 도달하고, 타깃과 소스 라이브러리의 데이터 차이가 0MB이고 타깃과 소스 라이브러리의 딜레이가 0초일 경우, 데이터가 일치한다고 표시되며, 오른쪽의 [완료]를 클릭해 마이그레이션 작업을 완료할 수 있습니다.
완료 결과는 다음과 같습니다.
