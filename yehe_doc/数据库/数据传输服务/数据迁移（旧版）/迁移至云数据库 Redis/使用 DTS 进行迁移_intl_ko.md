## 배경 개요
Tencent Cloud [Data Transmission Service(DTS)](https://intl.cloud.tencent.com/document/product/571)는 데이터 마이그레이션, 동기화 및 구독과 같은 기능을 통합한 데이터 전송 서비스입니다. 비즈니스를 중단하지 않고 데이터베이스를 클라우드로 마이그레이션하고 실시간 동기화 채널을 통해 고가용성 데이터베이스 재해 복구 아키텍처를 구축하는 데 도움이 됩니다. 데이터 구독 기능은 상용 데이터 마이닝 및 비동기 비즈니스 분리에 대한 요구 사항을 충족합니다. 

DTS for Redis는 현재 한 번에 논스톱 방식으로 데이터를 TencentDB로 마이그레이션할 수 있는 데이터 마이그레이션 기능을 지원합니다. 또한 전체 + 증분 데이터 마이그레이션 모드에서는 마이그레이션 전에 작성된 원본 데이터베이스의 이력 데이터와 마이그레이션 중에 작성된 증분 데이터를 함께 마이그레이션할 수 있습니다. 

## 적용 시나리오

Redis용 DTS 데이터 마이그레이션은 다음 배포 모드에서 원본 및 대상 데이터베이스를 지원합니다.

| 원본 데이터베이스                                            | 대상 데이터베이스       | 설명                                                         |
| ----------------------------------------------- | ------------ | ------------------------------------------------------------ |
| IDC 및 CVM의 자체 구축 데이터베이스와 같은 자체 구축 Redis 데이터베이스 | Redis용 TencentDB | -                                                            |
| 타사 Redis                              | Redis용 TencentDB | 타사 클라우드 벤더는 SYNC 또는 PSYNC 명령 권한을 부여해야 함            |
| Redis용 TencentDB                                    | Redis용 TencentDB | 동일한 Tencent Cloud 계정의 데이터베이스 인스턴스 간에 데이터 마이그레이션, 버전 업그레이드 및 리전 간 마이그레이션이 지원됩니다. |

## 마이그레이션 지원 설명
>?싱글 버전 마이그레이션 메모리 버전(클러스터 구성)의 호환성 문제는 [Check on Migration from Standard Architecture to Cluster Architecture](https://intl.cloud.tencent.com/document/product/239/37594)를 참조하십시오.

#### 지원 버전
- DTS는 Redis 2.8, 3.0, 3.2, 4.0, 5.0 및 6.0을 지원합니다. v6.0에서 사용하려면 [티켓을 제출](https://console.cloud.tencent.com/workorder/category)하여 신청하십시오. 이전 버전에서 같거나 더 높은 버전으로 마이그레이션하는 것이 좋습니다. 그렇지 않으면 호환성 문제가 발생할 수 있습니다.
- 표준 아키텍처와 클러스터 아키텍처 인스턴스는 서로 마이그레이션할 수 있습니다. 그러나 이러한 이기종 마이그레이션에는 호환성 문제가 있을 수 있습니다.
- 지원하는 구성은 단일 노드, redis cluster, codis, twemproxy가 있습니다.
- 마이그레이션 권한 요구사항: DTS 마이그레이션 데이터는 SYNC 혹은 PSYNC 명령어를 지원하는 원본 인스턴스가 필요합니다.

#### 지원 네트워크
DTS 마이그레이션 서비스는 공용 네트워크, CVM 자체구축, DC, VPN 액세스, CCN 시나리오 등 일반적인 네트워크 마이그레이션의 데이터 마이그레이션을 지원합니다.

- 공용 네트워크: 원본 데이터베이스는 공용 IP를 통해 액세스할 수 있습니다.
- CVM에서 자체 구축: 원본 데이터베이스가 [CVM](https://intl.cloud.tencent.com/document/product/213) 인스턴스에 배포됩니다.
- Direct Connect: 원본 데이터베이스는 [Direct Connect](https://intl.cloud.tencent.com/document/product/216)를 통해 VPC와 상호 연결될 수 있습니다. 
- VPN 액세스: 원본 데이터베이스는 [VPN 연결](https://intl.cloud.tencent.com/document/product/1037)을 통해 VPC와 상호 연결될 수 있습니다. 
- CCN: 원본 데이터베이스는 [CCN](https://intl.cloud.tencent.com/document/product/1003)을 통해 VPC와 상호 연결될 수 있습니다.

#### 마이그레이션 제한
- 마이그레이션의 효율을 보장하기 위해 CVM 자체구축 인스턴스 마이그레이션은 리전 간 마이그레이션을 지원하지 않습니다.
- 공인 네트워크 인스턴스 마이그레이션 시, 외부 네트워크에서 원본 인스턴스를 액세스할 수 있는지 확인해야 합니다.
- 마이그레이션 작업 진행은 정상 실행되고 있는 인스턴스만 허용됩니다. 비밀번호를 초기화하지 않았거나 다른 작업이 진행중인 인스턴스는 마이그레이션을 할 수 없습니다.
- 타깃 인스턴스는 데이터가 없는 빈 인스턴스여야 하며, 마이그레이션 중에는 타깃 인스턴스가 읽기 전용으로 설정되어 쓰기 작업을 할 수 없습니다.
- 마이그레이션 성공 시, 서비스측에서 데이터 인증 후 오픈 소스 인스턴스의 연결을 끊고 타깃 인스턴스 연결로 전환할 수 있습니다.

## 환경 요건
### 시스템 확인
> ?DTS 시스템은 마이그레이션 작업을 시작하기 전에 다음 환경 요구 사항을 확인하고 요구 사항이 충족되지 않으면 오류를 보고합니다. 미리 확인할 수도 있습니다. 오류 처리에 대한 자세한 내용은 [확인 항목 개요](https://intl.cloud.tencent.com/document/product/571/42551)를 참고하십시오.

<table>
<tr><th width="20%">유형</th><th width="80%">환경 요건</th></tr>
<tr>
<td>원본 데이터베이스 요구 사항</td>
<td>
<li>원본과 대상 데이터베이스를 연결할 수 있습니다. </li><li>원본 데이터베이스의 데이터베이스 수는 대상 데이터베이스의 수보다 작거나 같아야 합니다. </li><li>원본 데이터베이스는 v2.2.6 이상이어야 합니다. </li><li>원본 데이터베이스는 Slave 노드여야 합니다.</li></td></tr>
<tr> 
<td>대상 데이터베이스 요구 사항</td>
<td>
<li>대상 데이터베이스 버전은 원본 데이터베이스 버전 이상이어야 합니다. 그렇지 않으면 확인 중에 호환성 문제에 대한 경보가 트리거됩니다. </li><li>대상 데이터베이스에는 최신 Proxy가 있어야 합니다.</li>
<li>대상 데이터베이스의 공간은 원본 데이터베이스에서 마이그레이션할 데이터 볼륨의 1.5배 이상이어야 합니다.</li>
<li>대상 데이터베이스는 비어 있어야 합니다.</li></td></tr>
</table>

### [수동 확인](id:zxjc)
마이그레이션하기 전에 다음 항목을 확인하고 통과해야 합니다. 그렇지 않으면 마이그레이션이 실패할 수 있습니다.

#### 원본 데이터베이스의 큰 Key
마이그레이션하기 전에 원본 데이터베이스에 큰  Key가 있는지 확인하십시오. 마이그레이션 중에 버퍼(client-output-buffer-limit)가 오버플로되어 마이그레이션 실패로 이어질 수 있습니다.
- TencentDB 데이터베이스의 경우 TencentDB for DBbrain(DBbrain)의 성능 최적화 기능을 사용하여 큰 Key를 빠르게 분석할 수 있습니다. 자세한 내용은 [Memory Analysis](https://intl.cloud.tencent.com/document/product/239/47576)를 참고하십시오.
- TencentDB가 아닌 데이터베이스의 경우 rdbtools를 사용하여 Redis에서 큰 Key를 분석합니다.

분할 또는 정리를 위해 큰 Key를 평가합니다. 유지해야 하는 경우 소스 버퍼 크기(client-output-buffer-limit)를 무한으로 설정합니다.
```
config set client-output-buffer-limit 'slave 0 0 0' 
```

#### 원본 Linux 커널의 TCP 연결 수 제한
동시 업무 요청 수가 많으면 마이그레이션 전 Linux 커널에서 연결 수 제한을 확인하십시오. 이 값을 초과하면 Linux 서버가 DTS에서 능동적으로 연결을 끊습니다.
```
echo "net.ipv4.tcp_max_syn_backlog=4096" >> /etc/sysctl.conf
echo "net.core.somaxconn=4096" >> /etc/sysctl.conf
echo "net.ipv4.tcp_abort_on_overflow=0" /etc/sysctl.conf
sysctl -p
```

#### 원본 RDB 파일 디렉터리의 액세스 권한
마이그레이션하기 전에 원본 데이터베이스에서 RDB 파일이 저장된 디렉터리를 읽을 수 있는지 확인합니다. 그렇지 않으면 마이그레이션이 실패합니다.

RDB 파일 디렉터리를 읽을 수 없는 경우 원본 데이터베이스에서 다음 명령을 실행하여 ‘디스크 없는 복사’를 설정합니다. 그런 다음 RDB 파일은 저장을 위해 DTS로 직접 전송되며 원본 데이터베이스에 먼저 저장한 다음 전송할 필요가 없습니다. 
```
config set repl-diskless-sync yes
```

#### 명령 호환성(표준 아키텍처에서 클러스터 아키텍처로 마이그레이션용)
표준 에디션에서 메모리 에디션(클러스터 아키텍처)으로 데이터를 마이그레이션할 때 가장 어려운 문제는 메모리 에디션(클러스터 아키텍처)의 사용 사양과의 명령 호환성입니다.

- 멀티 Key 작업
  Redis Memory Edition(클러스터 아키텍처)용 TencentDB는 mget, mset, del 및 exists 명령에 대한 교차 SLOT 멀티 Key 액세스만 지원합니다. 원본 데이터베이스에서 멀티 Key 컴퓨팅에 참여해야 하는 Key는 Hash Tag를 통해 동일한 SLOT으로 집계될 수 있습니다. Hash Tag를 사용하는 방법에 대한 자세한 내용은 [Redis Cluster 사양](https://redis.io/topics/cluster-spec)을 참고하십시오. 
- 트랜잭션 작업
  Memory Edition(클러스터 아키텍처)은 트랜잭션을 지원하지만 트랜잭션의 Key에 대한 교차 SLOT 액세스는 지원되지 않습니다.

[Check on Migration from Standard Architecture to Cluster Architecture](https://intl.cloud.tencent.com/document/product/239/37594)의 지침에 따라 정적 및 동적 평가를 수행합니다.

## 마이그레이션 과정
#### 1. 마이그레이션 작업 생성
1) [DTS 콘솔](https://console.cloud.tencent.com/dts)에 로그인해 데이터 마이그레이션 페이지에서 **마이그레이션 작업 생성**을 클릭합니다.
2) 마이그레이션 작업 생성 페이지에서 소스 및 타깃 데이터베이스의 유형 및 리전 정보를 선택한 후 **구매하기**를 클릭합니다.

#### 2. 원본과 대상 데이터베이스 설정
원본 데이터베이스 설정 및 대상 데이터베이스 설정을 구성하고 **연결 테스트**를 클릭합니다. 테스트를 통과한 후 **저장**을 클릭하여 다음 단계로 진행합니다.
![](https://main.qcloudimg.com/raw/c08aad1d17a1cc39b1ae4cf978c4194b.png)

<table>
<thead><tr><th width="10%">설정 유형</th><th width="20%">설정 항목</th><th width="70%">설명</th></tr></thead>
<tbody>
<tr>
<td rowspan=3>작업 설정</td>
<td>작업 이름</td>
<td>쉬운 작업 식별을 위해 의미 있는 이름을 설정합니다.</td></tr>
<tr>
<td>실행 모드</td>
<td>즉시 실행 또는 예약 실행을 설정할 수 있습니다. <ul><li>예약된 작업이 수정되어 검증을 통과한 경우 <b>시작 예약</b>을 다시 클릭하여 예약된 시간에 작업이 시작되도록 해야 합니다. </li><li>지정된 시간이 지나면 작업이 즉시 시작됩니다. 즉시 시작을 클릭하여 작업을 <b>즉시 시작</b>할 수도 있습니다.
</li></ul></td></tr>
<tr>
<td>태그</td>
<td>태그는 다양한 차원의 범주별로 리소스를 관리하는 데 사용됩니다. 기존 태그가 요구 사항을 충족하지 않는 경우 콘솔로 이동하여 추가로 생성하십시오.</td></tr>
<tr>
<td rowspan=7>원본 데이터베이스 설정</td>
<td>원본 데이터베이스 유형</td><td>구매 시 선택한 원본 데이터베이스 유형으로, 변경할 수 없습니다.</td></tr>
<tr>
<td>리전</td><td>구매 시 선택한 리전으로, 변경할 수 없습니다.</td></tr>
<tr>
<td>액세스 유형</td><td>타사 클라우드 데이터베이스의 경우 일반적으로 공중망을 선택하거나 실제 네트워크 조건에 따라 VPN 액세스, 직접 연결 또는 CCN을 선택할 수 있습니다. <br>이 시나리오에서는 ‘DC(Direct Connect)’ 또는 ‘VPN 액세스’를 선택합니다. 이 시나리오에서는 <a href="https://intl.cloud.tencent.com/document/product/571/42651">VPN과 IDC간의 통신을 설정</a>해야 합니다. 다른 액세스 유형에 대한 준비 작업은 <a href="https://intl.cloud.tencent.com/document/product/571/42652">준비 작업 개요</a>를 참고하십시오.
<ul><li>공중망: 원본 데이터베이스는 공용 IP를 통해 액세스할 수 있습니다.</li>
<li>CVM에서 자체 구축: 원본 데이터베이스가 <a href="https://intl.cloud.tencent.com/document/product/213">CVM 인스턴스</a>에 배포됩니다.</li>
<li>DC: 원본 데이터베이스는 <a href="https://intl.cloud.tencent.com/document/product/216">DC</a>를 통해 VPC와 상호 연결될 수 있습니다.</li>
<li>VPN 액세스: 원본 데이터베이스는 <a href="https://intl.cloud.tencent.com/document/product/1037">VPN 연결</a>을 통해 VPC와 상호 연결될 수 있습니다.</li>
<li>데이터베이스: 원본 데이터베이스는 TencentDB 데이터베이스입니다.</li>
<li>CCN: 원본 데이터베이스는 <a href="https://intl.cloud.tencent.com/document/product/1003">CCN</a>을 통해 VPC와 상호 연결될 수 있습니다.</li></ul></td></tr>
<tr>
<td>VPC 기반 전용 게이트웨이</td><td>VPC 기반 전용 게이트웨이만 지원됩니다. 게이트웨이와 연결된 네트워크 유형을 확인하십시오.</td></tr>
<tr>
<td>VPC</td><td>VPC 기반 전용 게이트웨이의 연결 VPC 및 서브넷을 선택합니다.</td></tr>
<tr>
<td>노드 유형</td><td>단일 노드 마이그레이션 및 클러스터 마이그레이션이 지원됩니다. ‘클러스터 마이그레이션’은 여기에서 예시로 사용됩니다. <br>현재 클러스터 에디션 Redis에서 클러스터 에디션 Redis로 마이그레이션할 때 샤드 및 복제본 수에는 제한이 없습니다. </td></tr>
<tr>
<td>노드 정보</td><td>원본 데이터베이스 클러스터의 모든 샤드에 대한 주소와 비밀번호(IP: 포트: 비밀번호 또는 IP: 포트)를 입력하고 다른 노드의 정보를 줄 바꿈으로 구분합니다. <br>원본 데이터베이스에 대한 비즈니스 액세스에 영향을 미치지 않도록 원본 데이터베이스의 복제본 노드에서 데이터를 마이그레이션하는 것이 좋습니다.</td></tr>
<tr>
<td rowspan=6>타깃 라이브러리 설정</td>
<td>타깃 데이터베이스 유형</td><td>구매 시 선택한 타깃 데이터베이스 유형으로, 변경할 수 없습니다.</td></tr>
<tr>
<td>리전</td><td>구매 시 선택한 타깃 데이터베이스 리전으로, 변경할 수 없습니다.</td></tr>
<tr>
<td>액세스 유형</td><td>시나리오에 따라 유형을 선택하십시오. 본문은 ‘데이터베이스’를 선택합니다.</td></tr>
<tr>
<td>데이터베이스 인스턴스</td><td>타깃 데이터베이스의 인스턴스 ID를 선택합니다.</td></tr>
</tbody></table>

#### 3. 작업 확인 및 시작
확인 작업 페이지에서 확인을 진행하고 확인 통과 후 **작업 실행**을 클릭합니다.

- 실패: 확인 항목이 실패하여 작업이 차단되었음을 나타냅니다. 문제를 수정하고 확인 작업을 다시 실행해야 합니다.  
- 알람: 확인 항목이 요구 사항을 완전히 충족하지 못함을 나타내며 작업을 계속할 수 있지만 비즈니스에 영향을 미칩니다. 알람을 무시할지 아니면 문제를 해결할지 여부를 평가하고 알람 메시지를 기반으로 작업을 계속해야 합니다.

데이터 마이그레이션 작업 목록으로 돌아가면 작업이 준비 중 상태로 들어간 것을 볼 수 있습니다. 1 - 2분 후 데이터 마이그레이션 작업이 시작됩니다.

#### 4. 마이그레이션 작업 완료 
1) (옵션) 작업 조회, 삭제 등 작업을 수행하려면 해당 작업을 클릭하고 **작업** 열에서 해당 작업을 선택합니다. 자세한 내용은 [작업 관리](https://intl.cloud.tencent.com/document/product/571/42637)를 참고하십시오.
2) 원본 데이터베이스와 대상 데이터베이스의 key가 같으면 **작업** 열에서 **완료**를 클릭하여 데이터 마이그레이션 작업을 중지합니다.
3) 마이그레이션 작업 상태가 **작업 성공**이 된 후 대상 데이터베이스의 데이터를 확인합니다. 검증이 통과되면 공식적으로 비즈니스를 중단할 수 있습니다. 자세한 내용은 [컷오버 설명](https://intl.cloud.tencent.com/document/product/571/42612)을 참고하십시오.

## 이벤트 경보 및 지표 모니터링
1) DTS는 마이그레이션 중단 시 트리거된 이벤트 알람을 자동으로 보고하여 예외를 계속 알려줄 수 있습니다. 자세한 지침은 [데이터 마이그레이션 알람 정책 설정](https://intl.cloud.tencent.com/document/product/571/42610)을 참고하십시오.
2) DTS를 사용하면 마이그레이션 중에 다양한 메트릭의 모니터링 데이터를 보고 시스템의 성능 메트릭을 이해할 수 있습니다. 자세한 내용은 [모니터링 메트릭 조회](https://intl.cloud.tencent.com/document/product/571/42606)를 참고하십시오.


