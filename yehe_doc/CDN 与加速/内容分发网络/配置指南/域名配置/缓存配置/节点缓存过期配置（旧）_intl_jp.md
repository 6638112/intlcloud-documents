ノードキャッシュ期限切れの設定は包括的にアップグレードしました。詳細モードはよりきめ細かな設定に対応するようになりました。詳細については、 [ノードキャッシュ期限切れの設定（新）](https://intl.cloud.tencent.com/document/product/228/38424)をご参照ください。 

## 設定シナリオ
Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返すことが心配な場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。

各CDNノードでキャッシュされているリソースには期限切れ時間があります。リクエストされたキャッシュリソースが期限切れになった場合、ノードにリソースがキャッシュされている場合でも、そのリソースは無効と見なされます。再度back-to-originしてリソースを取り出します。ノードキャッシュルール設定は、特定のタイプ、特定のディレクトリ、パスのリソースのノードにおけるキャッシュ期限切れ時間を指定することができます。実際のサービスシナリオに応じて設定できます。

## 設定ガイド
### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューバーで【ドメイン名管理】を選択し、ドメイン名操作列の【管理】をクリックして、ドメイン名設定画面に入ります。タブを【キャッシュ設定】に切り替えると、【ノードキャッシュ期限切れの設定】が表示されます。
![](https://main.qcloudimg.com/raw/834d620b98c9d7d387547e59a7e6a1f4.png)

### 新しいルール

CDNサービスは現在、以下の4種類のノードキャッシュ期限切れルールをサポートしています。
+ ファイルタイプ：入力されたファイル拡張子に応じてキャッシュ期限切れを設定します。形式は`jpg;css`のようなファイル形式で、異なる拡張子間は`;`で区切る必要があります。
+ フォルダ：入力されたディレクトリパスに応じてキャッシュ期限切れを設定します。形式は `/test`で、`/`で終了する必要はありません。異なるディレクトリ間は`;`で区切ります。
+ フルパスファイル：完全なファイルパスを指定してキャッシュ期限切れを設定します。形式は`/index.html`で、完全なファイルパスとファイルタイプのマッチングモード（`/test/*.jpg`など）をサポートします。
+ ホームページ：ルートディレクトリに応じてキャッシュ期限切れを設定します。

![](https://main.qcloudimg.com/raw/1a72478ce0bc4fc1ef6a22bcb8064a6b.png)
**設定の制約：**

- 1つのドメイン名で最大20件までのキャッシュルールを追加できます。
- 複数件のルールは優先順位を変更できます。最下位ルールの優先順位が最上位のものよりも高くなります。
- 1つのファイルタイプ/フォルダ/フルパスファイルルールでは、最大100グループのコンテンツを入力でき、異なるコンテンツ間に「;」で区切ります。例：ファイルタイプ - jpg;png。
- キャッシュ期間は最大365日間まで設定できます。

#### プラットフォームのデフォルトポリシー
ユーザーが特定のサービスリソースをリクエストすると、オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが含まれている場合、デフォルトのプラットフォームポリシーは次の通りです。
- Cache-ControlフィールドがMax-Ageの場合、このリソースに対するキャッシュ時間は設定されているキャッシュ期限切れに準じ、Max-Ageの指定時間は継承されません。
- Cache-Controlフィールドはno-cache 、no-storeまたはprivateである場合、CDNノードはこのリソースをキャッシュしません。


#### 高度なキャッシュ期限切れ設定の有効化・無効化
有効にすると、CDNは命中したキャッシュルールのキャッシュ時間をオリジンサーバーのmax-age値と比較し、小さい方を実際の有効キャッシュ時間とします。

- オリジンサーバーの`/index.html`に設定されたMax-Ageが200秒で、CDNに設定されたキャッシュ期間が600秒の場合、ファイルがノードにおける実際のキャッシュ期間は200秒となります。
- オリジンサーバーの`/index.html`に設定されたMax-Ageが800秒で、CDNに設定されたキャッシュ期間が600秒の場合、フファイルがノードにおける実際のキャッシュ期間は600秒となります。

> ! 有効にした後、オリジンサーバーがLast-Modifiedフィールドを返さない場合、CDNはデフォルトでLast-Modifiedフィールドを追加し、10分ごとにその値を変更します。

#### オリジンサーバー準拠の有効化・無効化
有効にすると、リクエストが設定されたキャッシングルールのいずれにも命中しない場合、オリジンサーバーに準拠します。

>! オリジンサーバー準拠を有効にすると、高度なキャッシュ期限切れ設定を有効にすることはできません。どちらかのみを有効にすることができます。


## 設定例
アクセラレーションドメイン名`cloud.tencent.com`のノードキャッシュ期限切れが次のように設定されている場合、
![](https://main.qcloudimg.com/raw/a585a6b560cb0e555b71e08bea179353.png)
実際のキャッシュ期限切れは次のとおりです。
1. `/test/def.jpg` ファイルのノードキャッシュ期間は400秒です。
2. `/test/1.png`ファイルのノードキャッシュ期間は5分間です。
3. 他のファイルのノードキャッシュ期間は30日間です。
