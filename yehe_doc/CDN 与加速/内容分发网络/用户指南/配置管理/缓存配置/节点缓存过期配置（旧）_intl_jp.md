ノードキャッシュの有効期限の設定機能が完全にアップグレードされ、詳細モードはより洗練された構成をサポートします。詳細については、[ノードキャッシュの有効期限の設定（New）](https://intl.cloud.tencent.com/document/product/228/38424)ドキュメントをご参照ください。 

## 設定の概要
Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返すことが心配な場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。

各CDNノードのキャッシュリソースには有効期限があります。リクエストされたキャッシュリソースが期限切れになった場合、リソースがノードにキャッシュされている場合でも、そのリソースは無効と見なされます。ノードは、オリジンサーバーからリソースを再度取り出します。ノードキャッシュルール設定は、特定のタイプ、特定のディレクトリ、パスのリソースがノードでのキャッシュ有効期限を指定することができます。実際のビジネスシナリオに従って設定できます。

## 設定ガイド
### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のナビゲーションメニューバーで【ドメイン名管理】を選択して、ドメイン名の右側にある【管理】をクリックすると、ドメイン名の設定画面に入ります。第3欄の【キャッシュ設定】タブで、【ノードキャッシュ有効期限の設定】セクションを見つけます。
![](https://main.qcloudimg.com/raw/834d620b98c9d7d387547e59a7e6a1f4.png)

### ルールの追加

CDNサービスは現在、次の4種類のノードキャッシュ有効期限ルールをサポートしています。
+ ファイルタイプ：入力されたファイル拡張子に応じてキャッシュの有効期限を設定します。形式は`jpg;css`のようなファイル形式で、異なる拡張子間は`;`で区切る必要があります。
+ フォルダ：入力されたディレクトリパスに応じてキャッシュの有効期限を設定します。形式は `/test`で、`/`で終了する必要はありません。異なるディレクトリ間は`;`で区切る必要があります。
+ フルパスファイル：完全なファイルパスを指定してキャッシュの有効期限を設定します。形式は`/index.html`で、完全なファイルパスとファイルタイプのマッチングモード（`/test/*.jpg`など）をサポートします。
+ ホームページ：ルートディレクトリに応じてキャッシュの有効期限を設定します。

<img src="https://main.qcloudimg.com/raw/1a72478ce0bc4fc1ef6a22bcb8064a6b.png" style="width:400px"/>

**設定の制約事項：**
- キャッシュルールは、1つのドメイン名に20個まで設定できます。
- 複数のルールが設定されている場合、ルールの優先順位を変更できます。リストの一番下にあるルールの優先度が最も高くなります。 
- 1つのファイルタイプ/フォルダ/フルパスファイルのルールには、最大100グループのコンテンツを入力できます。異なるコンテンツは「;」で区切る必要があります。例：ファイルタイプ - jpg;png。
- キャッシュの有効期限は、最大365日まで設定できます。

>! 【モード】オプションで[詳細モード]を選択してルールを送信すると、詳細モードにアップグレードされます。詳細については、[ノードキャッシュの有効期限の設定（New）](https://intl.cloud.tencent.com/document/product/228/38424)ドキュメントをご参照ください。アップグレード後、元の基本モードに戻すことはできません。

#### プラットフォームのデフォルトポリシー
- ユーザーがあるサービスリソースをリクエストし、オリジンサーバーに対応するResponse HTTP HeaderにCache-Coontrolフィールドが存在している場合、デフォルトのポリシーは次の通りです。
	- Cache-ControlフィールドがMax-Ageの場合、このリソースのキャッシュの有効期限は、max-ageで指定された値ではなく、CDNノードに設定された有効期限の影響を受けます。
	- Cache-Controlフィールドが no-cache/no-store/privateの場合、CDNノードはこのリソースをキャッシュしません。
- オリジンサーバーに対応するResponse HTTP HeaderにCache-Coontrolフィールドが存在していない場合、CDNノードはこのリソースをキャッシュしません。
**注記：**一部のプラットフォームには、次のデフォルトポリシーがある場合があります。CDNノードは最初のリクエストをオリジンサーバーに転送し、リクエストされたリソースをキャッシュします。同じリソースが再度要求され、キャッシュがヒットした場合、CDNはヘッダーCache-Control：max-age = 600をデフォルトで追加します。

#### 高度なキャッシュ有効期限設定スイッチ
この機能を有効にすると、CDNは、一致したキャッシュルールのキャッシュ時間をオリジンサーバーの「max-age」値と比較し、小さい方の値を実際のキャッシュ有効期限として採用します。

- オリジンサーバーの`/index.html`に設定されたMax-Ageが200秒で、CDNに設定されたキャッシュ有効期限が600秒の場合、ファイルがノードにおける実際のキャッシュ有効期限は200秒となります。
- オリジンサーバーの`/index.html`に設定されたMax-Ageが800秒で、CDNに設定されたキャッシュ有効期限が600秒の場合、フファイルがノードにおける実際のキャッシュ有効期限は600秒となります。

> !高度なキャッシュ設定機能を有効にした後、オリジンサーバーがLast-Modifiedフィールドを返さない場合、CDNはデフォルトでLast-Modifiedフィールドを追加し、10分ごとにその値を変更します。

#### 「オリジンサーバーに従う」スイッチ
有効にした後、リクエストがどのキャッシュルールにも一致しない場合は、オリジンサーバーに従います。

>! 「オリジンサーバーに従う」スイッチをオンにした場合、高度なキャッシュ有効期限設定スイッチをオンにすることはできません。 2つのスイッチを同時に開く事はできません。


## 設定例
アクセラレーションドメイン名`cloud.tencent.com`のノードキャッシュの有効期限ルールが次のように設定されている場合：
![](https://main.qcloudimg.com/raw/a585a6b560cb0e555b71e08bea179353.png)
実際のキャッシュ時間は次のとおりです。

1. `/test/def.jpg` ファイルのノードキャッシュ時間は400秒です。
2. `/test/1.png` ファイルのノードキャッシュ時間は5分です。
3. 他のファイルのノードキャッシュ時間は30日です。
