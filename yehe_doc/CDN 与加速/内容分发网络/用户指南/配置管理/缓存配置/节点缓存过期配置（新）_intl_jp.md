
## 設定シナリオ

Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返すことが心配な場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。


## 設定ガイド

### 設定の確認

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューバーで【ドメイン名管理】を選択し、ドメイン名操作列の【管理】をクリックして、ドメイン名設定画面に入ります。タブを【キャッシュ設定】に切り替えると、【ノードキャッシュ期限切れの設定】が表示されます。

アクセラレーションドメイン名にアクセスする場合、異なるサービスタイプに応じて、CDNはデフォルトのノードキャッシュ期限切れルールを追加します。お客様は必要に応じて変更できます。
- 静的アクセラレーションサービスタイプを選択した場合、通常の動的ファイル（php、jsp、asp、aspxなど）はデフォルトでキャッシュされず、他のすべてのファイルはデフォルトでオリジンサーバーに準拠します。
![](https://main.qcloudimg.com/raw/5f48bc5246397975544baadf5ac81f4e.png)
- ダウンロードアクセラレーション、ストリーミングメディアVODアクセラレーションサービスタイプを選択した場合、デフォルトでは、すべてのファイルのキャッシュ期間は30日間です。
![](https://main.qcloudimg.com/raw/cdd00154330b8cb217287874f4f40693.png)

### 新しいルール

必要に応じてノードキャッシュの期限切れルールを追加し、ファイルタイプ/フォルダー/フルパスファイルを指定して、ノードキャッシュの動作を設定できます。


- オリジンサーバーに準じる：オリジンサーバーのCache-Controlヘッダーに準じます。
- キャッシュ：ノード上のリソースのキャッシュ時間を設定します。キャッシングを強制するかどうか（すなわち、オリジンサーバーのCache-Control: no-store/no-cache/privateを無視するかどうか）を追加で設定できます
- キャッシュしない：back-to-originしてリソースを取得します。

<img src="https://main.qcloudimg.com/raw/5454a77683dca1cfb491eccdae839aa4.png" height="207" width="408" />


#### 制約の設定

- 1つのドメイン名で最大20件までのキャッシュルールを追加できます。
- 複数件のルールは優先順位を変更できます。最下位ルールの優先順位が最上位のものよりも高くなります。
**注：すべてのファイル - max-age ルールなしでは、デフォルトで最も低い優先順位となり、また、優先順位を変更することはできません。**
- 1つのファイルタイプ/フォルダ/フルパスファイルルールでは、最大100グループのコンテンツを入力でき、異なるコンテンツ間に「;」で区切ります。例：ファイルタイプ - jpg;png。
- キャッシング動作が「キャッシュ」として選択されて、強制キャッシングを「有効」にすると、CDNは設定されたキャッシングルールに従ってキャッシュします。強制キャッシングを「無効」にすると、オリジンサーバーがCache-Control: no-store/no-cache/privateの場合、CDNはリソースをノードにキャッシュせず、back-to-originしてリソースを取得します。

>! 既存がノードキャッシュ期限切れの設定旧）（つまり基本モード）である場合、詳細モード設定で送信された後に完全にアップグレードされ、元の基本モードに復元することはできません。
### ルールの変更

追加されたキャッシングルールは変更できます。キャッシュキールール操作欄の【変更】をクリックして変更します

### ルールの削除

追加されたキャッシュルールは削除できます。キャッシュルール操作欄の【削除】をクリックして削除します。





## 設定例

アクセラレーションドメイン名 `www.test.com`の【ノードキャッシュ期限切れの設定】が次の場合、
![](https://main.qcloudimg.com/raw/c1402003c4549d2e6035420921f67bd0.png)

実際のキャッシュ設定は以下のとおりです。

- `www.test.com/abc.jpg`リソースのノードキャッシュ期間は10日間です。
- `www.test.com/def.php`リソースはノードにキャッシュされません。



