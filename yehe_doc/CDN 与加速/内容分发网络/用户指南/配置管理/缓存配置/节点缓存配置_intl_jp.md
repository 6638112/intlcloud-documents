
## 設定シナリオ
Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始するときに、リクエストを受信するCDNノードがリソースをキャッシュしていない場合、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されても、CDNノードがレガシーリソースをキャッシュしてユーザーに返すことが心配な場合は、ノードキャッシュルールを設定することで制御できます。

各CDNノードのキャッシュされたリソースには有効期限があります。リクエストされたリソースが期限切れになった場合、ノードにまだキャッシュがある場合でも、無効であると判断され、ノードは、オリジンサーバーからリソースを再度取り出します。ノードキャッシュルール設定は、特定のタイプ、特定のディレクトリ、パスのリソースがノードでのキャッシュ有効期限を指定することができます。実際のビジネスシナリオに基づいて設定できます。　

## 設定ガイド
### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のナビゲーションメニューバーで【ドメイン管理】を選択して、ドメイン名の右側にある【管理】をクリックすると、ドメイン名設定画面に入ります。【キャッシュ設定】タブで、キャッシュ有効期限の設定を確認できます。
アクセラレーションドメイン名にアクセスする場合：
+ 静的アクセラレーションタイプを選択した場合、通常の動的ファイル（.php .jsp .asp .aspxなど）のデフォルトのキャッシュ有効期限は0（キャッシュせずに直接back to origin）であり、他のすべてのファイルタイプのデフォルトの有効期限は30日間です。
+ ダウンロードアクセラレーションまたはストリーミングVODアクセラレーションを選択した場合、すべてのファイルのデフォルトのキャッシュ有効期限は30日間です。

![](https://main.qcloudimg.com/raw/ea544580fa0912774ba73235a5c935b8.png)

### 設定の変更
#### 1. 設定の変更
CDNサービスは現在、次の4種類のキャッシュ有効期限ルール設定をサポートしています。
+ ファイルタイプ：入力されたファイル拡張子に応じてキャッシュの有効期限を設定します。形式は`.jpg`で、異なるファイル拡張子は`;`で区切る必要があります。
+ フォルダ：入力されたディレクトリパスに応じてキャッシュの有効期限を設定します。形式は `/test`で、`/`で終了する必要はありません。異なるディレクトリ間は`;`で区切る必要があります。
+ フルパスファイル：完全なファイルパスを指定してキャッシュの有効期限を設定します。形式は`/index.html`で、完全パスとファイルタイプのマッチングモード（`/test/*.jpg`など）をサポートします。　　
+ ホームページ：ルートディレクトリに対してキャッシュの有効期限を設定します。

![](https://main.qcloudimg.com/raw/eaf7940e3d3ead143d7b6d487ae257d9.png)
**設定ルール：**
+ 最大10個のキャッシュ有効期限ルールを設定できます。
+ 複数のキャッシュ有効期限ルールがある場合、一番下のルールが最も優先度が高くなります。
+ 有効期限は最大365日まで設定できます。

>ご利用のアクセラレーションドメイン名のサービスエリアがグローバルの場合、設定されたキャッシュ有効期限はグローバルに有効になり、中国本土と中国本土以外の異なる設定に対応しません。

#### 2. プラットフォームポリシー
お客様が特定のサービスリソースをリクエストすると、オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが含まれている場合、デフォルトのプラットフォームポリシーは次の通りです。
- Cache-ControlフィールドがMax-Ageの場合、このリソースのキャッシュ有効期限は設定されたノードキャッシュの有効期限に準じ、Max-Ageが指定された時間は継承されません。
- Cache-Controlフィールドがno-cache、no-store、またはprivateの場合、CDNノードはこのリソースをキャッシュしません。
- Cache-Controlフィールドが存在しない場合、CDNはデフォルトで`Cache-Control:max-age = 600`ヘッダーを追加します。

#### 3. 高度なキャッシュ設定
高度なキャッシュ設定を有効にすると、ユーザーは、オリジンサーバーのHTTP応答ヘッダー Cache-ControlのMax-Age値を調整することにより、ノードキャッシュの有効期限を動的に調整できます。

高度なキャッシュ設定が有効にした後、CDNは設定されたノードキャッシュ時間をMax-Age値と比較し、小さい方を実際に有効となるノードキャッシュ時間とします。
+ ユーザーのオリジンサーバーで`/index.html`のMax-Ageが200秒で、CDNに対応するキャッシュ時間が600秒に設定されている場合、ファイルがノードにおける実際のキャッシュ有効期限は200秒となります。
+ ユーザーのオリジンサーバーで `/index.html` のMax-Age が800秒で、CDNに対応するキャッシュ時間が600秒に設定されている場合、フファイルがノードにおける実際のキャッシュ有効期限は600秒となります。

>高度なキャッシュ設定を有効にして、オリジンサーバーがLast-Modifiedフィールドを返さない場合、CDNはデフォルトでLast-Modifiedフィールドを追加し、10分ごとにその値を変更します。

## 設定例
アクセラレーションドメイン名`cloud.tencent.com`のキャッシュ有効期限ルールが次のように設定されている場合：
![](https://main.qcloudimg.com/raw/92990b8fdc69a94646b7b2e8f304b7a4.png)
実際のキャッシュ有効期限は次のとおりです。
1. `/test/abc.jpg` ファイルのノードキャッシュの有効期限は200秒です。
2. `/test/def.jpg` ファイルのノードキャッシュの有効期限は400秒です。
3. `/test/1.png` ファイルのノードキャッシュの有効期限は300秒です。

