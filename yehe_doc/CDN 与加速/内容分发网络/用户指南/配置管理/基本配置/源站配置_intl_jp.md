## 設定シナリオ

オリジンサーバー設定モジュールで、ドメイン名オリジンサーバーの基本情報、back-to-originリクエストプロトコル、ホストヘッダーなどの情報を変更することができます。

## 設定ガイド

### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のナビゲーションメニューバーで【ドメイン名管理】を選択して、ドメイン名の右側にある【管理】をクリックすると、ドメイン名設定画面に入ります。「基本情報」の下にオリジンサーバー設定モジュールがあります。
![](https://main.qcloudimg.com/raw/524f3c9aa2f9f2017d53409ee610bb5b.png)
**オリジンサーバータイプ**
外部オリジンサーバー：すでにビジネスサーバー（オリジンサーバーなど）が安定して稼働している場合は、対応するIPアドレスリストまたはドメイン名をオリジンサーバーアドレスとして入力します。
[Cloud Object Storage（COS）](https://intl.cloud.tencent.com/product/cos)：リソースがすでにCOSに保存されている場合は、バケットをオリジンサーバーとして選択できます。
**オリジンサーバーアドレス**
オリジンサーバータイプに対応するオリジンサーバーのアドレスを記入します。
**back-to-originプロトコル**
CDNキャッシュノードがback-to-origin要求をオリジンサーバーに転送するときに使用されるプロトコル（HTTPまたはHTTPS）です。
**ホストヘッダー**
つまり、back-to-originドメイン名です。CDNノードがback-to-originするときに、オリジンサーバーでアクセスされたサイトドメイン名です。詳細については、[Back-to-Originドメイン名の設定](#exp)をご参照ください。

### 設定の変更
#### 1. プライマリオリジンサーバーの設定を変更する
右上隅にある【編集】をクリックして、プライマリオリジンサーバーの設定内容を変更します。

**オリジンサーバーアドレスの変更**
外部オリジンサーバーを選択する場合、オリジンサーバーアドレスは最大511文字まで入力でき、以下の設定モードをサポートされています。
- **マルチIPラウンドロビンback-to-origin**：オリジンサーバーに複数のIPが入力されている場合、ラウンドロビンback-to-originが使用されます。CDNのオリジンサーバー検出機能はデフォルトで有効になっています。失敗したIPのback-to-originの数がしきい値を超えると、要求はこのIPアドレスに転送されなくなり、一定期間ブロックされた後、自動的に再開されます。
- **IPv6 オリジンサーバー**：IPv6内部テスト資格を有し、ドメイン名のリクエストプロトコルとして「IPv4 + IPv6」を選択した場合、オリジンサーバーとしてIPv6アドレスを入力できます。
- **特殊なポートback-to-origin**：「IP：port」形式がサポートされています。 HTTPプロトコルは、1〜65535のカスタムポートをサポートします。HTTPSプロトコルは現在、ポート443のみをサポートしています。
- **重みback-to-origin**：重み（1 - 100）を設定可能、形式は`オリジンサーバー:ポート:重み`となります（ポートは`オリジンサーバー::重み`のように省略可能）。
- **ドメイン名back-to-origin**：ドメイン名をオリジンサーバーとして設定することが可能です。このドメイン名は、サービスのアクセラレーションドメイン名と異なる必要があります。 （現在、IPv6ドメイン名のback-to-originがサポートされていません）。

**back-to-originプロトコルの変更**
オリジンサーバーの設定で、ドメイン名back-to-originプロトコルをHTTP、HTTPS、またはfollow protocolに調整できます。
+ **HTTP back-to-origin**：HTTPとHTTPSの両方を介したアクセス要求に使用されます。
+ **HTTPS back-to-origin**：HTTPとHTTPSの両方を介したアクセス要求に使用されます。
+ **Follow protocol**：HTTPリクエストはHTTP back-to-originを使用し、HTTPSリクエストはHTTPS back-to-originを使用します。

> !
> + HTTPS back-to-originを選択する場合は、オリジンサーバーがHTTPSアクセスをサポートしていることを確認してください。そうでない場合、back-to-originが失敗します。
> + 現在、証明書管理ページでこの設定アイテムを変更でき、今後移行する予定です。

**back-to-origin Hostの変更**
ドメイン名にアクセスする場合、デフォルトのホストヘッダーはアクセラレーションドメイン名です。ワイルドカードドメイン名にアクセスする場合、デフォルトがワイルドカードドメイン名になりますが、実際のホストヘッダーはアクセスドメイン名です。必要に応じて、ここで変更できます。

> ! COSがオリジンサーバーとして使用されている場合、back-to-origin Hostは変更できません。

#### 2.  ホットバックアップオリジンサーバーの設定
プライマリオリジンサーバーが外部サーバーの場合、ホットバックアップオリジンサーバーを追加できます。すべてのback-to-originリクエストは、最初にプライマリオリジンサーバーに転送されます。4XXまたは5XXエラーコードが返された場合、または接続タイムアウト、プロトコルの非互換性などの例外が発生した場合、リクエストがホットバックアップオリジンサーバーに転送され、リソースを取り出して、back-to-originの高可用性に確保します。

ホットバックアップオリジンサーバーに個別でback-to-originプロトコルおよびback-to-origin情報を設定可能です。
![](https://main.qcloudimg.com/raw/4d2ba172412182eb87ba40149775689f.png)

>! プライマリオリジンサーバーでIPv6オリジンサーバーが有効化されている場合、ホットバックアップオリジンサーバーを追加できません。

#### 3. リージョンの特別な設定
ご利用のアクセラレーションドメイン名がグローバルアクセラレーション用に設定されている場合、国際トラフィックの発生を防ぐために、下部にある【特別な設定の追加】をクリックして、ドメイン名の異なるサービスエリアに異なるオリジンサーバーを設定できます。
![](https://main.qcloudimg.com/raw/d4a7a61ed28daa2c3eb0febf02ca931c.png)
異なるback-to-originポリシーが必要なリージョンを選択し、対応するオリジンサーバー情報を入力します。
![](https://main.qcloudimg.com/raw/d8f02e0ae1e44972cedd07160bb9f5cb.png)

> !
> + リージョンの特別な設定を追加した後、現在では、直接削除することはできません。
> + リージョンの特殊設定が基本設定と完全に一致する場合は、自動的にマージされます。それらが一致するように設定することで、リージョンの特殊設定を削除できます。

## 設定例
<a ID="exp"></a>
### back-to-originドメイン名の設定
CDNオリジンサーバーとアクセラレーションドメイン名`www.test.com`が次のように設定されているとします。
![](https://main.qcloudimg.com/raw/ec2e007bb32723f7dd12aac17524c8af.png)
ユーザーのアクセスパスは次のとおりです。
ユーザーがCDNノードにキャッシュされていないリソース`http://www.test.com/test.txt`にアクセスすると、ノードはドメイン名`www.abc.com`を解決して、オリジンサーバーアドレスを取得します。例えばアドレスが`1.1.1.1`の場合、CDNノードはサーバー`1.1.1.1`にアクセスし、ウェブサイトパス`www.def.com`でtest.txtファイルを見つけて、ユーザーに返します。

### リージョンの特別な設定
CDNオリジンサーバーとアクセラレーションドメイン名`www.test.com`が次のように設定されているとします。
![](https://main.qcloudimg.com/raw/e9104ca2b0e38c62bdffb022a933b2b9.png)
実際のback-to-originシナリオは次のとおりです。

1. 中国本土のユーザーが`http://www.test.com/test.txt`ファイルにアクセスし、中国本土のノードがこのリソースをキャッシュしていない場合、back-to-originリクエストがサーバー`1.1.1.1`に到達し、Webサイト`1.test.com`の下にあるtest.txt ファイルを見つけて、当該リソースが存在する場合は、ノードはファイルをユーザーに直接返します。そうでない場合は、ステップ2に進みます。
2. 中国本土のCDNノードはリクエストをプライマリオリジンサーバーに転送できず、リソースを見つけることができないため、リクエストをサーバー`2.2.2.2`に転送し、Webサイト`1.test.com`の下にあるtest.txtファイルを見つけて、ユーザーに返してキャッシュします。
3. この時点で、中国本土以外のユーザーも`http://www.test.com/test.txt`ファイルにアクセスし、中国本土以外のノードはこのリソースをキャッシュしていないため、back-to-originリクエストをサーバー`3.3.3.3`に転送し、Webサイト`3.test.com`の下にあるtest.txt ファイルを見つけて、当該リソースが存在する場合、ノードはファイルをユーザーに直接返します。そうでない場合は、ステップ4に進みます。
4. 中国本土以外のCDNノードはリクエストを中国本土以外のプライマリオリジンサーバーに転送できず、リソースを見つけることができないため、リクエストをサーバー`4.4.4.4`に転送し、Webサイト`4.test.com`の下にあるtest.txtファイルを見つけて、中国本土以外のユーザーに返してキャッシュします。　
