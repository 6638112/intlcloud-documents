
## 現象の説明
TencentDB for MySQLのデフォルトのスレーブデータベース、読み取り専用インスタンスはいずれもMySQLのネイティブbinlogレプリケーションテクノロジーを使用しており、データのレプリケーション方式が非同期または準同期レプリケーションの時、いずれも遅延が発生する恐れがあります。

## 故障の影響
- [スレーブデータベース](https://intl.cloud.tencent.com/document/product/236/38328) に遅延が存在する場合、マスター／スレーブインスタンスが短時間で切り替えを完了できなくなり、これにより業務にも影響が出て、短時間で正常にリストアできなくなります。
- 読み取りサービスのデータ整合性に対する要求が高い場合、[読み取り専用グループ](https://intl.cloud.tencent.com/document/product/236/11361)は遅延排除ポリシーを設定することができ、読み取り専用インスタンスとマスターインスタンスの遅延時間がしきい値を超えると、対応する読み取り専用インスタンスが自動的に削除されることにより、読み取りサービスは読み取り専用インスタンスに正常にアクセスできなくなります。

## 考えられる原因
- **非プライマリキーまたはセカンダリインデックス**
binlogがrow形式、かつテーブルが非プライマリキーまたはセカンダリインデックスの場合、ビッグテーブルに対してDML操作（例：delete、update、insert）を実行し、スレーブデータベースでbinlogアプリケーションを実行する際、プライマリキーまたはセカンダリインデックスに基づき変更が必要な行を検索します。対応するテーブルがプライマリキーまたはセカンダリインデックスを作成していない場合、大量の全テーブルスキャンが発生することによりログアプリケーションの速度が低下し、その結果、データ遅延が発生します。
処理手順については、 [非プライマリキーまたはセカンダリインデックス](#wzjhejsy)をご参照ください。

- **大規模トランザクション 
大規模トランザクション：特に、データを追加、削除、変更するinsert，update，delete，replcaeなどのセンテンスのことを意味します。1つのトランザクションに数百万行のデータに対する操作が含まれ、または1つのSQLセンテンスが数百万行のデータを変更することから、実行時間が30sを超えます。
マスターインスタンスがビッグデータを含むDML操作を実行し、大量のbinlogがスレーブデータベースに送信される際、スレーブデータベースはマスターインスタンスと同等の時間を費やして対応するトランザクションを完了する必要があり、それによりスレーブデータベースにデータ遅延が発生します。処理手順については、[大規模トランザクション](#dsw)をご参照ください。


- **DDL操作**
読み取り専用ノード上でユーザーのクエリーが上層で実行されるため、読み取り専用ノード上で実行時間が非常に長いクエリーが実行されると、このクエリーは、実行が完了するまでマスターデータベースからのDDLをブロックし、これにより読み取り専用ノードのデータ遅延が発生します。処理手順については、[DDL操作](#dcz)をご参照ください。

- **インスタンスの仕様が小さすぎる**
読み取り専用インスタンスの仕様がマスターインスタンスよりも小さく、かつ負荷が高いと、読み取り専用インスタンスのデータ遅延が発生します。
処理手順については、[インスタンス仕様が小さすぎる](#slgggx)をご参照ください。

- **Waiting for table metadata lockのエラー**
大規模トランザクションを実行すると、DDLがブロックされ、これが続くと同一テーブルのすべての後続の操作に支障が出ます。また、トランザクションを送信しない場合もDDLがブロックされ、これが続くと同一テーブルのすべての後続の操作に支障が出ます。
処理手順については、[Waiting for table metadata lockのエラー](#wftmlbc)をご参照ください。

## 処理手順
### [非プライマリキーまたはセカンダリインデックス](id:wzjhejsy)
1. [DBbrainコンソール](https://console.cloud.tencent.com/dbbrain/performance/disk)にログインし、左側のナビゲーションで【最適化診断】を選択し、上部で対応するデータベースを選択した後、さらに【空間分析】ページを選択します。
2. 空間分析ページ下部で、【非プライマリキーテーブル】ページを選択し、リストの非プライマリキーテーブルをクリックすれば、テーブルのフィールドとインデックス情報を表示することができます。
![](https://main.qcloudimg.com/raw/070bf60984827fb43a33048a38a5969b.png)
>?非プライマリキーテーブルリストは定期的なスキャン（スキャンの頻度は1日1回）と手動リフレッシュの2つの形式をサポートしており、実際の状況に応じて選択することができます。
3. 手順2の非プライマリキーテーブルにプライマリキーを作成します。テーブルにプライマリキーを作成できない場合、基数が高い列を選択してセカンダリインデックスを作成することをお勧めします。

### [大規模トランザクション](id:dsw)
1. [DBbrainコンソール](https://console.cloud.tencent.com/dbbrain/event)にログインし、異常アラームページで対応するデータベースとリージョンを選択し、「診断項目」で【トランザクションによるレプリケーションの遅延】にチェックを入れれば、インスタンスの大規模トランザクションをフィルタリングして表示することができます。
![](https://main.qcloudimg.com/raw/508e3bfd033a2f5a5422aae9902cc598.png)
2. 大規模トランザクションを小さく分割し、where条件によって毎回処理するデータ量を制限します。
>?DBbrainによって大規模トランザクションを特定し、大規模トランザクションを小さく分割して実行すれば、読み取り専用ノードが迅速にトランザクションを完了でき、データ遅延が発生することはありません。

### [DDL操作](id:dcz)
1. [DBbrainコンソール](https://console.cloud.tencent.com/dbbrain/event)にログインし、異常アラームページで対応するデータベースとリージョンを選択し、「診断項目」で【DDLによるレプリケーションの遅延】にチェックを入れると、インスタンスの対応するDDLをフィルタリングして表示することができます。
![](https://main.qcloudimg.com/raw/7d7c9ec01da894fa1554f6d9bf135366.png)
2. アラームリストで「操作」列の【詳細】をクリックすると、イベントの詳細ページにジャンプして対応する処理を行うことができます。
 - イベントの詳細：診断項目、開始・終了時間、リスクレベル、持続時間、概要などの情報が含まれます。
 - 現場の説明：異常イベント（またはヘルスチェックイベント）の外部パフォーマンス現象のスナップショットとパフォーマンスの傾向。
 - インテリジェント分析：パフォーマンス異常を引き起こす根本的な原因を分析し、具体的な操作を特定します。
 - 最適化の提案：SQL最適化（インデックスの提案、書き換えの提案）、リソース設定の最適化およびパラメータのチューニングなどを含む最適化のガイダンスと提案を行います。


### [インスタンス仕様が小さすぎる](#slgggx)
1. 読み取り専用インスタンスの仕様をマスターインスタンス以上にすることをお勧めします。インスタンスの仕様は[MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストで確認できます。
2. 読み取り専用インスタンスが大量の分析型ビジネスをホストすることによりインスタンスの負荷が過剰に高くなった場合、そのインスタンスの仕様を適切な構成にアップグレードするか、低パフォーマンスのSQLステートメントを最適化する必要があります。
 - 非効率性の最適化については、[SQLの最適化](https://intl.cloud.tencent.com/document/product/1035/36040)をご参照ください。
 - インスタンス仕様のアップグレードについては、[データベースインスタンスの仕様の調整](https://intl.cloud.tencent.com/document/product/236/19707)をご参照ください。

### [Waiting for table metadata lockのエラー](id:wftmlbc)
[TencentDB for DBbrain](https://intl.cloud.tencent.com/document/product/1035/36036) を使用して実際の業務およびインスタンスに対する診断を行い、スロークエリーなどの指標を調査して、大規模トランザクションを特定することをお勧めします。
1. [DBbrainコンソール](https://console.cloud.tencent.com/dbbrain/event)にログインし、異常アラームページで対応するデータベースとリージョンを選択し、「診断項目」で次の診断項目にチェックを入れ、時間を消費する大規模トランザクションを特定します。
![](https://main.qcloudimg.com/raw/11e0dc3ba8fa61eaf07ec3ecf7e38474.png)
2. 次の各種故障シナリオへの対策を講じます：
 - 大規模トランザクションを実行すると、DDLがブロックされ、これが続くと同一テーブルのすべての後続の操作に支障が出るため、DBbrainの異常診断プロンプトに基づき、大規模トランザクションのIDを見つけ出し、kill（強制終了） します。
 - トランザクションが送信されていないとDDLがブロックされ、これが続くと同一テーブルのすべての後続の操作に支障が出るため、DBbrainの異常診断に基づき、送信されていないトランザクションのIDを見つけ出し、kill（強制終了） すると同時にプログラムをチェックし、直ちにトランザクションを送信します。
 - 明示的なトランザクションでは、 TableAに対して失敗した操作（存在しないフィールドをクエリーするなど）が実行されます。この時点でトランザクションは開始されていませんが、失敗したセンテンスによって取得されたロックは引き続き有効であり、解放されません。DBbrainの異常診断に基づき、sessionのIDを見つけ出し、 kill（強制終了）します。
