Tencent Cloud는 클라우드 네이티브 데이터베이스 TDSQL-C (MySQL 버전 호환)에 데이터베이스 감사 기능을 제공하여, 데이터베이스 액세스 및 SQL 명령 실행 상황을 기록하고 기업의 리스크 관리와 데이터 보안 등급 향상에 기여합니다.  

## 감사 작업
## SQL 감사 서비스 활성화
1. [TDSQL-C 콘솔] (https://console.cloud.tencent.com/dls/cynosdb/instance)에 로그인한 후, 좌측 메뉴에서 [데이터베이스 감사] 페이지를 선택하고, 상단의 해당 리전을 선택한 후, [감사 로그] 페이지를 선택합니다. 
2. 감사 로그 페이지에서 SQL 감사 기능을 활성화합니다. 
![](https://main.qcloudimg.com/raw/f80b3ed667734c9aa1b00838a73fada0.png)

## 감사 로그 조회
1. [TDSQL-C 콘솔] (https://console.cloud.tencent.com/dls/cynosdb/instance)에 로그인한 후, 좌측 메뉴에서 [데이터베이스 감사] 페이지를 선택하고, 상단의 해당 리전을 선택한 후, [감사 로그] 페이지를 선택합니다. 
2. ‘감사 인스턴스’에서 감사가 활성화된 데이터베이스 인스턴스를 선택하면 해당 SQL 감사 로그를 조회할 수 있습니다.  
 - ‘시간 상자’를 클릭한 후 시간대를 선택하면 해당 시간대의 감사 효과를 조회할 수 있습니다. 
 - ‘텍스트 상자’에서 키 태그로 검색하여 해당 감사 효과를 조회할 수 있고 키 SQL 명령어 조합으로 검색하여 해당 감사 효과를 조회할 수 있습니다.
>?
>- ‘텍스트 상자’에서 다수의 키 태그로 검색할 경우 엔터 키를 사용하여 키 태그를 분할할 수 있습니다. 
>- ‘텍스트 상자’에 SQL 명령어, 클라이언트 IP, 계정, 데이터베이스, 객체 이름, 정책명, 실행 시간 범위, 영향을 받는 행의 수 등을 조합하여 입력할 수 있습니다.
>

## SQL 감사 필드 
클라우드 네이티브 데이터베이스 TDSQL-C의 감사 로그에서 지원하는 필드는 다음과 같습니다. [TDSQL-C 콘솔] (https://console.cloud.tencent.com/dls/cynosdb/instance)의 [감사 로그] 페이지에서 아래와 같은 아이콘을 클릭하면 전체 SQL 감사 로그를 조회할 수 있습니다.  
![](https://main.qcloudimg.com/raw/6abe06ccce258894303eb8776ec394a9.png)

| 시리얼 넘버 | 필드 이름 | 필드 의미                                                         | 비고                                         |
| ---- | ------------- | ------------------------------------------------------------ | -------------------------------------- |
| 1            | host     |클라이언트 IP                                           |   -                                           |
| 2            |dbname   | 데이터베이스 이름                                                 |  -                                            |
| 3            |user       | 사용자 이름                                                    |      -                                        |
| 4            | sql        | SQL 명령                                             |    -                                          |
| 5            | sqlType    | SQL 명령 유형                                          |   -                                           |
| 6    | errCode       | 에러 코드                                                | 0은 성공을 의미함                           |
| 7    | affectRows    | 영향받는 행의 수                                                    |     -                                       
| 8    | checkRows     | 스캔된 행의 수                                                     |     -                                         |
| 9    | sentRows      | 반환된 행의 수                                                     |    -                                          |
| 10   | threadId      | 스레드 ID                                                       |       -                                       |
| 11   | ruleNum       | 감사 규칙 번호                                                 |     -                                         |
| 12   | policyName    | 감사 정책 이름                                                   |    -                                          |
| 13   | instanceName  | 인스턴스 이름                                                       |    -                                          |
| 14   | timestamp     | 시작 시간 (초)                                               |   -                                           |
| 15   | nsTime        | 시작 시간 (나노 초). timestamp와 조합하여 시작 시간을 나노 초 단위까지 표기 가능 | 예시 timestamp.nsTime 1577953020.887984015 |
| 16   | execTime      | 실행 시간（마이크로 초）                                             |    -                                          |
| 17   | cpuTime       | CPU 시간（나노 초）                                              |     -                                         |
| 18   | lockWaitTime  | 잠금 대기 시간（마이크로 초）                                           |    -                                          |
| 19   | ioWaitTime    | IO 대기 시간（마이크로 초）                                           |     -                                         |
| 20   | trxLivingTime | 트랜잭션 실행 시간 (마이크로 초）                                   |      -                                        |

## SQL 감사 규칙
### 규칙 내용
지원하는 설정은 다음과 같습니다. 
클라이언트 IP, 데이터베이스 계정, 데이터베이스 이름, [포함, 불포함, 같음, 다름] 방식의 매칭을 지원합니다. 

전수 감사 규칙은 특수 규칙으로, 활성화하면 모든 명령을 감사합니다.

## 규칙 연산
- 모든 규칙 내부의 유형은 조건 추가 제한 관계로 and (&&) 관계입니다.
예를 들어 사용자 이름은 user1, 매칭 유형은 같음으로 지정하고, 데이터베이스 이름은 test, 매칭 유형은 같음으로 지정하면 user1 사용자의 test 라이브러리에 대한 작업만 감사하고 나머지는 무시합니다.
- 규칙과 규칙 간에는 or (||) 관계입니다.
모든 인스턴스는 하나 혹은 다수의 감사 규칙을 지정할 수 있으며 어느 한 규칙에만 부합해도 감사가 진행됩니다. 예를 들어 A 규칙으로 user1의 실행 시간이 1초와 같거나 이상인 작업만 감사하도록 지정하고 B 규칙으로 user1과  실행 시간이 &lt; 1인 명령을 감사하라고 한 경우, 결국 user1의 모든 명령에 감사가 진행됩니다.

### 규칙 상세 설명
클라이언트 IP, 데이터베이스 계정, 데이터베이스 이름이 [포함, 불포함, 같음, 다름]을 지원하는 것과 관련하여 ‘다름’ 처럼 한 번에 하나의 오퍼레이터 설정만 가능합니다.
‘같음’과 ‘다름’의 경우 다수의 값을 쓸 수 있으며 쉼표로 구분할 수 있습니다. 포함, 불포함의 경우 하나의 값만 쓸 수 있습니다. 예를 들어 오퍼레이터가 ‘같음’인 경우 user1, user2, user3의 값을 지정할 수 있습니다.

#### 데이터베이스 이름 관련 설명
다음 테이블 객체 유형의 명령에 해당하는 경우:
```
SQLCOM_SELECT, SQLCOM_CREATE_TABLE, SQLCOM_CREATE_INDEX, SQLCOM_ALTER_TABLE,
SQLCOM_UPDATE, SQLCOM_INSERT, SQLCOM_INSERT_SELECT, SQLCOM_DELETE, SQLCOM_TRUNCATE, SQLCOM_DROP_TABLE
```
이런 유형의 동작에 있어서 데이터베이스 이름은 명령 중 실제 작업하는 데이터베이스 이름을 기준으로 합니다. 예를 들어 현재 use db3인 경우 명령어는 다음과 같습니다.
```
select *from db1.test,db2.test;
```
db1과 db2를 타깃 라이브러리로 하여 규칙 판단을 하고 규칙에 db1 CFA 설정이 있다면 감사를 진행합니다. db3 CFA 설정이 있다 해도 감사를 진행하지 않습니다.
상기 테이블 객체 유형의 명령이 아닌 경우, 현재 use 라이브러리를 타깃 라이브러리로 인식하고 판단합니다. 현재 라이브러리가 use db1이고 실행 명령이 `show databases`인 경우, 현재 라이브러리 db1을 타깃 라이브러리로 하여 규칙 판단을 하며 규칙에 db1 CFA 설정이 있다면 감사를 진행합니다.

### 특이 사항
포함, 불포함은 하나의 값만 쓸 수 있습니다. 여러 값을 쓸 경우 하나의 열로 인식되어 매칭 오류가 발생할 수 있습니다.

