Tencent CloudはTencentDB for MySQLにデータベース監査機能を提供し、データベースのアクセスおよびSQLステートメントの実行状況を記録し、企業のリスク制御実施を助け、データのセキュリティレベルを引き上げます。  

>!データベース監査のサポート状況：TencentDB for MySQL 5.6、5.7の2ノードと3ノード。TencentDB for MySQL 5.5 バージョン、およびTencentDB for MySQLシングルノードは現時点ではサポートしていません。

## 監査の操作
### 監査ルールの作成
1. [MySQLコンソール]](https://console.cloud.tencent.com/dls/mysql)にログインし、左側のナビゲーションで【データベース監査】ページを選択し、上部でリージョンを選択した後、【監査ルール】ページを選択します。
2. 監査ルールページで、【ルールの作成】をクリックします。
![](https://main.qcloudimg.com/raw/c4e92d4471a82b2c38d1bc78d8995044.png)
3. 監査ルールの作成ページで、ルール名と説明を入力し、【次のステップ】をクリックします。
4. パラメータ設定画面で、必要な監査方法とパラメータを選択し、【保存】をクリックします。
>?ルールの作成が完了すると、関連付けが必要な監査ポリシーが有効になります。
>
![](https://main.qcloudimg.com/raw/b6059e729814c6f585f9098370f5eef0.png)

### SQL監査サービスのアクティブ化
1. [MySQLコンソール]](https://console.cloud.tencent.com/dls/mysql)にログインし、左側のナビゲーションで【データベース監査】ページを選択し、上部でリージョンを選択した後、【監査ポリシー】ページを選択します。
2. 監査ポリシーページで、監査の有効化が必要なデータベースインスタンスを選択し、関連するプロトコルにチェックを入れ、【次のステップ】をクリックします。
![](https://main.qcloudimg.com/raw/f80b3ed667734c9aa1b00838a73fada0.png)
3. SQL監査サービス設定ページで、監査の保存期間を選択し、【次のステップ】をクリックします。
>!SQLログ保留時間に対するセキュリティコンプライアンスの要求を確実に満たすために、保存期間を180日以上とすることをお勧めします。
4. ポリシー作成ページで、ポリシー名を設定し、監査ルールを選択し、【ポリシーの作成】をクリックします。

### 監査ポリシーの作成
1. [MySQLコンソール]](https://console.cloud.tencent.com/dls/mysql)にログインし、左側のナビゲーションで【データベース監査】ページを選択し、上部でリージョンを選択した後、【監査ポリシー】ページを選択します。
2. 監査ポリシーページで、【ポリシーの作成】をクリックします。
![](https://main.qcloudimg.com/raw/9713931fcbd22e2f47d31b764c2d09c4.png)
3. ポップアップしたダイアログボックスで、ポリシー名を設定し、監査ルールを選択し、【OK】をクリックします。

### 監査ログの確認
1. [MySQLコンソール]](https://console.cloud.tencent.com/dls/mysql)にログインし、左側のナビゲーションで【データベース監査】ページを選択し、上部でリージョンを選択した後、【監査ログ】ページを選択します。
2. 「監査インスタンス」で、監査の有効化済みのデータベースインスタンスを選択すると、対応するSQL監査ログを確認できます。 
 - 「時間枠」をクリックし、時間帯を選択すると、選択した時間帯に関する監査効果を確認できます。
 - 「テキストボックス」で、キーとなるタグを入力して検索すると、関連する監査効果を確認できます。キーとなるSQLコマンドの組み合わせを入力して検索すると、関連する監査効果を確認できます。
>?
>- 「テキストボックス」でキーとなるタグを複数入力して検索する時、リターンキーを使用してキーとなるタグを分割できます。
>- 「テキストボックス」でSQLコマンド、 クライアントIP、アカウント、データベース、オブジェクト名、ポリシー名、実行時間範囲、影響を受ける行数などのキーとなる組み合わせ情報を入力できます。
>
![](https://main.qcloudimg.com/raw/33443b0991fb282782cf054d0cba0812.png)

## SQL監査フィールド
TencentDB for MySQLの監査ログにおいて以下のフィールドをサポートします。[MySQLコンソール](https://console.cloud.tencent.com/dls/mysql) の【監査ログ】ページで以下のアイコンをクリックして、完全なSQL監査ログを取得・確認することができます。
![](https://main.qcloudimg.com/raw/a504bd3353af1c0fce27b223bda0003c.png)

| 番号 | フィールド名        | フィールドの定義                                                     | 備考                                         |
| ---- | ------------- | ------------------------------------------------------------ | -------------------------------------- |
| 1    | host          | クライアントIP                                                     |   -                                           |
| 2    | dbname        | データベース名                                                     |  -                                            |
| 3    | user          | ユーザー名                                                       |      -                                        |
| 4    | sql           | SQLステートメント                                                      |    -                                          |
| 5    | sqlType       | SQLステートメントのタイプ                                                  |   -                                           |
| 6    | errCode       | エラーコード                                                       | 0は成功を表す                                    |
| 7    | affectRows    | 影響を受ける行数                                                     |     -                                         |
| 8    | checkRows     | スキャン行数                                                     |     -                                         |
| 9    | sentRows      | リターン行数                                                     |    -                                          |
| 10   | threadId      | スレッドID                                                       |       -                                       |
| 11   | ruleNum       | 監査ルール番号                                                   |     -                                         |
| 12   | policyName    | 監査ポリシー名                                                   |    -                                          |
| 13   | instanceName  | インスタンス名                                                       |    -                                          |
| 14   | timestamp     | 開始時間（秒）                                               |   -                                           |
| 15   | nsTime        | 開始時間（ナノ秒精度）； timestampと組み合わせたナノ秒単位まで正確な開始時間 | 例 timestamp.nsTime 1577953020.887984015 |
| 16   | execTime      | 実行時間（マイクロ秒）                                             |    -                                          |
| 17   | cpuTime       | CPU時間（ナノ秒）                                              |     -                                         |
| 18   | lockWaitTime  | ロック待機時間（マイクロ秒）                                           |    -                                          |
| 19   | ioWaitTime    | IO待機時間（マイクロ秒）                                           |     -                                         |
| 20   | trxLivingTime | トランザクション実行時間（マイクロ秒）                                   |      -                                        |

## SQL監査ルール
### ルールの内容
以下のタイプの設定をサポート：
クライアントIP、データベースアカウント、データベース名。【含む、含まない、等しい、等しくない】方法のマッチングをサポート。

全量監査ルールは特殊なルールで、有効にするとすべてのステートメントを監査します。

### ルールの演算
- 各ルール内の異なるタイプは追加の制限条件関係、すなわちAND（&&）関係になります。
ユーザー名にuser1を指定、マッチングタイプを等しいとし、データベース名にtestを指定、マッチングタイプを等しいとすると、user1ユーザーのtestに対する動作のみ監視し、そのほかはスキップします。
- ルールとルールの間はOR（||）関係です。
各インスタンスには1つまたは複数の監査ルールを指定でき、どれか1つのルールに当てはまれば、監査を行う必要があります。 例えば、ルールAがuser1の実行時間≧1秒の操作のみを監査すると指定し、ルールBがuser1ならびに実行時間&lt;1のステートメントを監査する場合、最終的にはuser1のすべてのステートメントについて監査する必要があります。

### ルールの詳細説明
クライアントIP、データベースアカウント、データベース名について【含む、含まない、等しい、等しくない】演算をサポートします。1回にサポートするのは1つの演算子設定のみ、例えば「等しくない」のみとなります。
「等しい」と「等しくない」の場合は、複数の値を書くことができ、複数の値の間はコンマで区切ります。「含む」と「含まない」は一意の値のみ書くことができます。 演算子が「イコール」の場合、値はuser1,user2,user3とすることができます。

#### データベース名についての説明
ステートメントが以下のテーブルオブジェクトタイプの場合：
```
SQLCOM_SELECT, SQLCOM_CREATE_TABLE, SQLCOM_CREATE_INDEX, SQLCOM_ALTER_TABLE,
SQLCOM_UPDATE, SQLCOM_INSERT, SQLCOM_INSERT_SELECT, SQLCOM_DELETE, SQLCOM_TRUNCATE, SQLCOM_DROP_TABLE
```
このタイプの動作について、データベース名はステートメントの中で実際に操作されるデータベースの名前に基づきます。例えば、現在のデータベースがuse db3で、ステートメントが以下の場合：
```
select *from db1.test,db2.test;
```
このとき、db1とdb2がターゲットデータベースとして判断され、db1のデータベースを監査するようにルール設定されている場合は監査され、db3のデータベースを監査するようにルール設定されている場合は監査されないことになります。
ステートメントが上記のようなテーブルオブジェクトタイプでない場合は、現在useのデータベースがターゲットとして判断されます。現在のデータベースがuse db1で、実行ステートメントが`show databases`の場合、現在のデータベースdb1がターゲットとして判断され、db1を監査するようにルール設定されている場合は監査されます。

### 特記事項
「含む」と「含まない」は1つの値のみ書くことができます。複数書いた場合は1つの文字列とみなされ、マッチングが正しく行われなくなります。

