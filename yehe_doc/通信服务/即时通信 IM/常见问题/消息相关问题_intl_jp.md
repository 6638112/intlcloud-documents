### メッセージが受信されなかった場合、またはメッセージが失われた場合、どうすればいいですか。

- 1対1チャットメッセージ
 - メッセージが正常に送信されたことを確認します。
 - 受信者が正常にログインしたことを確認します。
 - メッセージ送信のための指定されたセッションが受信者と一致していることを確認します。
- グループメッセージ
 - メッセージが正常に送信されたことを確認します。
 - 受信者が正常にログインしたことを確認します。
 - 受信者がグループメンバーであることを確認します。

C2Cメッセージかグループメッセージかにかかわらず、上記の手順で問題を確認できない場合、次のことを確認し続ける必要があります。
1. メッセージリスナーが登録されたことを確認します。
2. 送信者がメッセージを送信する際に、`elem`がメッセージに加えられたことを確認します（メッセージを送信する際には`addElement`の戻り値をチェックする必要があります）。
3. Androidの場合、複数のメッセージリスナーが登録されたこと、メッセージリスナーに`true`が返されたことを確認する必要があります。



### オフラインプッシュ通知を受信できない場合はどうすればいいですか。

- APN
オフラインプッシュ（iOS）の説明ドキュメントを参照して、次のことを確認してください。
 - 証明書がTencent Cloudコンソールに正しくアップロードされたことを確認します。
 - ログインに成功した後、tokenがTencent Cloudにアップロードされたことを確認します。
 - token送信の際に、正しい証明書IDが送信されたことを確認します。
 - フォアグラウンドとバックグラウンドの切り替えイベントが正しく送信されたことを確認します。
 - メッセージに`TIMCustomElem`しかないこと、かつ`desc`属性が空であることを確認します。
 - `MsgRandom`などの重複削減タグが同じに設定されたため、重複削減されてプッシュ送信することができません。
 - グループメッセージの場合、メッセージの非通知項目が設定されたことを確認します。

- Android
オフラインプッシュの説明ドキュメントを参照して、次のことを確認してください。
 - Push証明書が正しくアップロードされたことを確認します。
 - tokenが正常に送信されたことを確認します。
 - サードパーティのオフラインプッシュ（Huawei、Xiaomi、MEIZU）でない場合、QALServiceプロセスが生存しているかどうかを確認してください。生存していない場合、オフラインプッシュ通信を受信できません。システムの自動起動権限に依存する必要があります。
 - マルチプロセスが存在する場合、IM SDKの初期化がメインプロセスでのみ行われたか確認します。そうでない場合、メインプロセスでのみの初期化を行うように変更する必要があります。
 - サードパーティのオフラインプッシュ（Xiaomi、Huawei、MEIZUなど）である場合、サードパーティのコンソールを通じて直接メッセージをプッシュして、携帯電話が受信できるかどうかを確認します。受信できない場合、次の2つの理由が考えられます。
    1）サードパーティのオフラインプッシュの統合について問題があります。ドキュメントを参照しながら操作してください。
    2）携帯電話の互換性問題です。携帯電話自体がオフラインプッシュとうまく互換性がありません。例えば、一部のHuawei携帯電話はHuaweiのオフラインプッシュを受信できないことがあります。
 - OPPOオフラインプッシュの場合、IMコンソールのAndroidプッシュ証明書にAppSecretではなくMasterSecretが入力されていることを確認してください。

APNプッシュかAndroidのオフラインプッシュかにかかわらず、上記の手順で問題を確認できない場合、次のことを確認し続ける必要があります。
1. 受信者IDが、メッセージプッシュ送信対象となるユーザーIDと一致していることを確認します。
2. オフラインプッシュリスナー（Android）が設定されたことを確認します。
3. 「通知を許可」がオフになっているかを確認します。iOSの場合、カスタムプッシュの通知音の設定を確認し、Androidの場合、グローバルオフラインプッシュ送信構成の設定を確認します。
4. `sendOnlineMessage`インターフェースから送信されたオンラインメッセージであるか、REST APIを介してプッシュ送信された場合、`MsgLifeTime`が`0`に設定されたかを確認します。
5. オフラインプッシュを行わないというタグが設定されたかを確認します。iOSの場合、カスタムオフラインメッセージ属性を確認し、Androidの場合、単一メッセージのオフラインプッシュ送信構成の設定を確認します。
6. まだ原因を特定できない場合、関連情報を技術者に提供してください。

### グループの@メッセージはどのように処理しますか。

グループ内の@メッセージは一般メッセージと本質的な違いがありません。@の対象となる者がメッセージを受信した際に、UIの特殊処理を実行する必要があります。例えば、QQのメッセージリストに赤色をつけます。具体的な実現方法は、次の方法をご参照ください。
1. メッセージ送信時に、@文字が入力されたかどうか、キーボードイベントを傍受します。送信者が@文字を入力したことを検出した場合、グループメンバーリストをUIにポップアップ表示します。このとき、送信者が@送信を必要とする対象を選択します。ここで、選択されたユーザをuser1とします。
2. @送信の対象を選択した後、メッセージ入力ボックスに@と選択された者のIDを追加します。例えば「@user1」となります。
3. メッセージに`TIMCustomElem`を追加し、`TIMCustomElem`に、このメッセージを@メッセージとして識別するためのユーザ定義のメッセージプロトコルを追加します。
簡単なプロトコルは次のように定義されます。
```
{
	"type":"REMIND",
	"target":"user1"
}
```
@ メッセージ構築プロセスのためのサンプルコードは次のとおりです（Androidを例とする）。

```java
// テキストメッセージを送信し、メッセージに「@ グループメンバーuser1」を加える
TIMMessage msg = new TIMMessage();
// テキストメッセージ要素本体を構築する
TIMTextElem txtElem = new TIMTextElem();
txtElem.setText("@user1 nice to meet u");
if(msg.addElement(txtElem) != 0){
	Log.e(TAG, "add text elem failed");
	return;
}
try {
	// カスタマイズしたメッセージプロトコルを入力する
	JSONObject remindProto = new JSONObject();
	remindProto.put("type", "REMIND");
	remindProto.put("target", "user1");
	// カスタマイズしたプロトコルを使ってカスタムメッセージ要素を構築する
	TIMCustomElem customElem = new TIMCustomElem();
	customElem.setDesc("remind msg");
	customElem.setData(remindProto.toString().getBytes("utf-8"));
	if(msg.addElement(customElem) != 0){
		Log.e(TAG, "add custom elem failed");
		return;
	}
}catch(Exception e){
	Log.e(TAG, "build custom elem failed");
	return;
}
```

>`TIMTextElem`は必須ではありません。ダーティワードのフィルタリングが不要であることが確認された場合、`TIMTextElem`のメッセージ内容を、`TIMCustomElem`の`desc`属性に入力することができます。
>
4. メッセージを構築した後、グループに送信します。
5. グループメンバーがメッセージを受信した後、メッセージの`TIMCustomElem`のメッセージプロトコルが@メッセージプロトコルであるかを確認します。そうである場合、次の処理に進みますが、そうでない場合、スキップします。
6. @送信の対象が現在のログインユーザーであるかどうかを判断します。そうである場合、UIの特殊処理を実行し、そうでない場合、処理を実行しません。

### ラッキーマネーメッセージはどのように処理しますか。

ラッキーマネーメッセージは@メッセージと同様、`TIMCustomElem`を介して実現します。UIの特殊処理を実行する必要があります。例えば、現在のメッセージがラッキーマネーメッセージであることを検出した後、メッセージをラッキーマネー仕様として表示します。
ラッキーマネーメッセージは重要なメッセージとして、メッセージ送信の際に、それを高優先度メッセージに設定してください。このため、メッセージが頻度制限になっても送信されるように処理します（現在デフォルトで、グループ内のメッセージ送信頻度制限は40件/sで、1対1チャットメッセージ送信頻度制限は5件/sである）。

メッセージ優先順位に関する内容については、[メッセージの優先順位](https://intl.cloud.tencent.com/document/product/1047/33526)をご参照ください。

>アプリのラッキーマネーメッセージ支払い機能は、自ら必要な支払いSDKを組み込む必要があります。IM SDKはこの機能をまだ提供していません。

簡単のラッキーマネーメッセージの構築プロセスは次のとおりです（Android）。
```java
// 新しいメッセージを構築する
TIMMessage msg = new TIMMessage();
try {
	// カスタマイズしたメッセージプロトコルを入力する
    JSONObject redPacket= new JSONObject();
	redPacket.put("type", "RED_PACKET");
    redPacket.put("amount", 2018);
	redPacket.put("msg", "Happy new year!");

    // カスタマイズしたプロトコルを使ってカスタムメッセージ要素を構築する
	TIMCustomElem customElem = new TIMCustomElem();
    customElem.setDesc("red packet");
	customElem.setData(redPacket.toString().getBytes("utf-8");
    if(msg.addElement(customElem) != 0){
	    Log.e(TAG, "add custom elem failed");
	    return;
	}
}catch(Exception e){
	Log.e(TAG, "build custom elem failed");
    return;
}

// メッセージの優先度を高優先度に設定する
msg.setPriority(TIMMessagePriority.High);
```

### IMメッセージの保存期間はどのぐらいですか。
1対1チャットメッセージと非ライブ配信グループメッセージには履歴メッセージの保存機能があります。<a href="https://console.cloud.tencent.com/im">IMコンソール</a>にログインして構成を変更することができます。各パッケージのデフォルト設置は次のとおりです：<ul style="margin:0;"><li>体験版：7日、延長できません</li><li>Professional Edition：7日、延長できます</li><li>Ultimate Edition：30日、延長できます</li></ul>履歴メッセージの保存期間の延長は有料の付加価値サービスです。具体的な課金については、<a href="https://intl.cloud.tencent.com/document/product/1047/34350">付加価値サービス料金</a>をご参照ください。

