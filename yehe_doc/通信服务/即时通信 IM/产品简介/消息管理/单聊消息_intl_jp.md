## ユースケース
- **App内の二人チャット**
1対1チャットメッセージはApp内の二人チャットに適用する。
- **App管理者がメッセージを送信する**
1対1チャットメッセージはApp管理者がバックグラウンドからメッセージを送信するか、他のユーザをシミュレートしてメッセージを送信することができます。
- **App管理者がシステムメッセージをシミュレートする**
App管理者がバックグラウンドでメッセージを送信することにより、システムメッセージをシミュレートし、システムメッセージでユーザに通知を送信することができ、App側はApp管理者のカスタムメッセージを受信して特殊処理を行うことができます。

インスタントメッセージIMが強化した1対1チャットメッセージ能力を提供し、また1対1チャットメッセージの権限管理と拡張能力を提供して、お客様のメッセージ記録、多端末同期、オフラインメッセージプッシュと送信者情報の組み入れなどの機能を実現するようサポートします。


## 1対1チャットメッセージのタイプ

| 機能タイプ     | 機能説明                                                     |
| ------------ | ------------------------------------------------------------ |
| テキストメッセージ     | メッセージ内容は通常のテキスト                                           |
| 絵文字メッセージ     | 絵文字メッセージは開発者がカスタマイズしたもの                                       |
| 地理位置メッセージ | メッセージ内容は地理位置の表題、経度、緯度情報                       |
| 画像メッセージ     | メッセージ内容は画像のURLアドレス、サイズ、画像の大きさなどを含み、最大28MBの画像をサポートする                |
| 音声メッセージ     | メッセージ内容は音声ファイルのURLアドレス、サイズ、時間などを含み、最大28MBの音声ファイルをサポートする                         |
| ファイルメッセージ     | メッセージ内容はファイルのURLアドレス、サイズ、形式などを含み、形式を問わず、最大100MBのファイルをサポートする |
| ショート動画メッセージ   | メッセージ内容はショート動画ファイルのURLアドレス、時間、サイズ、形式などを含み、最大100MBのショート動画ファイルをサポートする |
| カスタムメッセージ   | 開発者が定義したメッセージのタイプ、例えば、ラッキーマネーメッセージ、じゃんけんなどの形式のメッセージ |
| システム通知メッセージ | 組み込みのシステム通知メッセージと開発者のカスタマイズしたシステム通知メッセージ             |


## 1対1チャットメッセージ機能

| 1対1チャットメッセージ機能 | 機能説明                        | ユースケース                                                     |
| ------------ | ------------------------------- | ------------------------------------------------------------ |
| 1対1チャットメッセージを送信する | SDKとREST APIを介して1対1チャットメッセージを送信する | App内の二人チャット<br>App管理者がメッセージを送信する<br>App管理者がシステムメッセージをシミュレートする |
| 1対1チャットメッセージを受信する | SDKを介して1対1チャットメッセージを受信する           | オンラインメッセージを受信する<br>オフラインメッセージを受信する<br>履歴メッセージを照合する             |


## 1対1チャットメッセージ権限管理

| 1対1チャットメッセージ権限管理                   | 機能説明                               | ユースケース                                                    |
| ---------------------------------- |------------------------------------- | -------------------------------------------------------- |
| App内の任意の2つのユーザの間で1対1チャットメッセージを送信する | 任意の知らぬ二人間のメッセージ送信をサポートする             | 知らない人がメッセージを送信する                                              |
| App管理者が1対1チャットメッセージを送信する             | App内の管理者は任意のユーザに1対1チャットメッセージを送信できる | App管理者が他のユーザをシミュレートしてメッセージを送信する <br> App管理者はシステムメッセージをシミュレートする |
| 友達だけにメッセージの送信を許可する               | 友達だけのメッセージ送信をサポートする                     | 友達がメッセージを送信する                                              |
| 特定の人からのメッセージを拒否する                 | ブラックリストを使って特定のユーザからのメッセージを拒否する       | 友達関係を解除する  <br>    特定の人のメッセージを拒否する                           |


## 1対1チャットメッセージ拡張能力

| 1対1チャットメッセージ拡張能力         | 機能説明                                                    | ユースケース                                |
| ------------------------ | ----------------------------------------------------------- | --------------------------------------- |
| チャット記録を取得する             | SDKまたはREST APIを介して履歴メッセージを取得する                        | リアルタイムなチャット記録を取得する    <br>  定期的にメッセージ記録をダウンロードする |
| 多端末同期               | 1対1チャットメッセージの多端末同期をサポートする                                      | ユーザの多端末メッセージ同期                        |
| 1対1チャットメッセージのオフラインプッシュ         | Apple、Huawei、Xiaomi、OPPO、vivoおよびMEIZUなどの携帯電話のオフラインプッシュをサポートする | メッセージのオフラインプッシュ                            |
| 1対1チャットメッセージに送信者の情報を含める | メッセージに送信者情報を含めることを実現できる                                  | 送信者のニックネーム、プロファイル画像などを表示する                  |

## 1対1チャットオフラインメッセージ処理の流れ
![](https://main.qcloudimg.com/raw/d28999fa32da4e5e6750f34117e116bb.png)

#### 1対1チャットメッセージオフラインとローミング処理の流れ：

1. ユーザAが`sendMessage`を呼び出してユーザBにメッセージを送信し、ユーザBがオフライン状態にあります。
  - ユーザAをユーザBの最近使用した連絡先に追加します。キャッシュは100件までです。
  - メッセージをオフラインキャッシュに保存します。キャッシュのサイズは30KBで、時間制限は7日です。
  - メッセージをローミングサーバーに保存します。時間制限は7日です。
2. ユーザBは、`login`インターフェースを呼び出しインスタントメッセージIMにログインします。
3. SDKはオフラインキャリアのメッセージを自動的に取得し、`OnNewMessage`を介してスローします。
4. SDKは最近使用した連絡先を自動的に取得し、`OnNewMessage`インターフェースを介してスローします。
5. メッセージ同期が完了すると、`OnRefresh`インターフェースを介してユーザに、メッセージ同期完了を通知します。
6. ユーザが`getMessage`を呼び出し、ローカルメッセージが不完全である場合、SDKがローミングサーバーを自動的にプルします。

