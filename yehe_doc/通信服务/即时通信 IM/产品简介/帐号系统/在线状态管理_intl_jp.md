
## コンセプト概要
各ユーザー状態には、次の3つのタイプがあります。
- フォアグラウンド動作状態（Online）
- バックグラウンド動作状態（PushOnline）
- 未ログイン状態（Offline）

>!バックグラウンド動作状態（PushOnline）は、スマートフォン（Android/iOS）を使用している場合のみ当てはまります。PCとWebブラウザにこの状態はありません。

### フォアグラウンド動作状態（Online）
フォアグラウンド動作状態（Online）とは、クライアントがインスタントメッセージング（IM）サーバーとスムーズなTCPネットワーク接続を維持している状態を指します。クライアントは、IMサーバーにメッセージを送信したり、IMサーバーからプッシュされたメッセージを受信したりできます。

**ユーザーがアプリを開いたとき、状態はフォアグラウンド動作状態（Online）になります。**

アプリの起動後、クライアントはIMサーバーとのTCP接続を一定時間確立します。IMサーバーは、クライアントのネットワークリンク情報やクライアントのプラットフォームバージョンなどの、クライアントのオンライン情報を記憶します。アプリの動作中、IM SDKは定期的にハートビートを送信し、ユーザーのオンライン状態を確認します。

>?ハートビート：IM SDKは、2分ごとにハートビートパケットをサーバーに送信して、ユーザーのオンライン状態を確認します。

### バックグラウンド動作状態（PushOnline）
バックグラウンド動作状態（PushOnline）とは、クライアントとIMサーバーの間でTCP接続が一定時間切断されていることを指します。このとき、オフラインプッシュメッセージを受信できます。
ユーザー状態は次のシナリオでは、バックグラウンド動作状態（PushOnline）になります：

- ユーザーがアプリを終了し、アプリがバックグラウンドに切り替えられ、スマートフォンのオペレーティングシステムによってプロセスが強制終了された場合、またはユーザが自身でアプリのプロセスを強制終了した場合。
 アプリがスマートフォンのオペレーティングシステムのキープアライブリストにある場合、ユーザーがアプリをバックグラウンドに切り替えても、プロセスはスマートフォンのオペレーティングシステムによって強制終了されません。このとき、状態は依然としてフォアグラウンド動作状態（Online）です。フォアグラウンド動作状態（Online）とバックグラウンド動作状態（PushOnline）について判断するための基準の1つは、アプリプロセスが強制終了されたかどうか、つまり、クライアントとIMサーバーの間でTCP接続が一定時間切断されたかどうかです。
- ユーザーが自身でクライアント側ネットワークを切断している（たとえば、スマートフォンの機内モードをオンにしている）場合、またはクライアント側ネットワークが完全に利用できない（たとえば、ネットワーク信号がまったくないトンネルに入っている）場合。
 この特殊な状況では、クライアントはTCPプロトコルのFINパケットまたはRSTパケットを送信することができません。IMサーバーは、ハートビートパケットのタイムアウトが検出されてから、状態がバックグラウンド動作状態に変わるまで400秒間待機する必要があります（PushOnline）。

>!バックグラウンド動作状態（PushOnline）は、スマートフォン（Android/iOS）を使用している場合のみ当てはまり、PCとWebブラウザにこの状態はありません。

### 未ログイン状態（Offline）
未ログイン状態（Offline）とは、ユーザーがアカウントとパスワードを入力していない、ログインする前の状態を指します。このときユーザーはメッセージのオンラインプッシュもオフラインプッシュも受信できません。
ユーザーの状態は次のシナリオでは、未ログイン状態（Offline）です：

- ユーザーが自身でログアウトした場合、またはアプリをダウンロードしてからログインしていない場合。
- ユーザー状態がバックグラウンド動作状態（PushOnline）になった後、7日以内に再度ログインしなかった場合。このとき、状態は未ログイン状態（Offline）になっています。

## ユーザーのオンライン状態を照会する
アプリのバックグラウンドでは、[REST API：ユーザーのオンライン状態を取得する](https://intl.cloud.tencent.com/document/product/1047/35477)を使用して、ユーザーのオンライン状態を一括照会できます。
IM SDKは現時点では、ユーザーのオンライン状態照会をサポートしていません。

## ユーザーのオンライン状態変更通知
IMは、ユーザーのオンラインイベントとオフラインイベントについてアプリのバックグラウンドに通知できます。[状態変更コールバック](https://intl.cloud.tencent.com/document/product/1047/34357)ドキュメントをご覧ください。

## 状態変更をリアルタイムで検出する
### Android/iOS/PC
ほとんどの場合、ユーザー状態の変化はいずれも次のようにリアルタイムで検出できます。
- ユーザーが自身でログインすると、状態がフォアグラウンド動作状態（Online）になります。
- ユーザーが自身でログアウトすると、状態が未登録状態（Offline）になります。
- ユーザーが自身でクライアント側プロセスを強制終了するか、バックグラウンドに切り替えた後、クライアント側プロセスがスマートフォンのオペレーティングシステムによって強制終了されると、状態はバックグラウンド動作状態（PushOnline）になります。

次の特殊な状況のいずれかでのみ、IMクラウドサーバーは状態の変化を検出するために、ハートビートタイムアウトを400秒間待機する必要があります。
ネットワークが完全に利用できず、クライアントがTCPプロトコルレイヤーのFINパケットもRSTパケットも送信できない場合、IMクラウドサーバーは、状態がバックグラウンド動作状態（PushOnline）になることを検出するために、ハートビートタイムアウトを400秒間待機する必要があります。一般的なシナリオとしては、ユーザーが自身でクライアント側ネットワークを切断している（たとえば、スマートフォンの機内モードをオンにしている）場合、またはネットワーク信号がまったくないトンネルに入った場合が挙げられます。

### Webブラウザ
- ユーザーが自身でWebブラウザにログインすると、IMクラウドサーバーは、状態がフォアグラウンド動作状態（Online）になったことをリアルタイムで検出できます。
ネットワークが利用できない場合、またはユーザーが自身でWebブラウザのページを閉じている場合、IMクラウドサーバーは、状態が未ログイン状態（PushOnline）になることを検出するために、ハートビートタイムアウトを400秒間待機する必要があります。

## 複数デバイスからのログイン
### 競合
IM SDKは、複数のデバイスから同時にログインすると（例えば、PCとAndroidで同時にログインする）、デフォルトでは相互に競合するようになっています。最後にログインしたデバイスのみがオンラインになり、それ以前にログインしていたデバイスはすべてオフラインになります。競合ロジックについて詳しくは以下のドキュメントをご覧ください：

- [Androidユーザー状態変更](https://intl.cloud.tencent.com/document/product/1047/36255)
- iOSユーザー状態変更


### 同時オンライン
IMは、[コンソール](https://console.cloud.tencent.com/im)での同時オンラインポリシーの変更に対応しています。PCとスマートフォンでの同時オンライン、PC、iOS、Androidすべての同時オンラインなどを設定することができます。異なるデバイスからログインして同時にオンラインになっている場合、これらのデバイスは競合しませんが、2つの同じデバイスでのオンライン状態にある場合（2つのiOSデバイスからのログインなど）、依然として競合します。
