## 概要

Cloud Object Storage（COS）はメタデータアクセラレーション機能を有効にすることで、HDFSプロトコルによるアクセスが可能になります。メタデータアクセラレーション機能を有効にすると、COSはバケットにマウントポイントを作成し、お客様は[HDFSクライアント](https://github.com/tencentyun/chdfs-hadoop-plugin/tree/master/jar)をダウンロードすることで、クライアントにこのマウントポイントを入力してCOSをマウントできます。ここでは、コンピューティングクラスターに、メタデータアクセラレーションを有効にしたバケットをマウントする方法について詳しくご説明します。

##  前提条件

- コンピューティングクラスター内のマウントしたいマシンまたはコンテナ内に、[Java 1.8](https://www.oracle.com/java/technologies/downloads/)がインストールされていることをご確認ください。
- コンピューティングクラスター内のマウントしたいマシンまたはコンテナがアクセス権限を有していることをご確認ください。HDFS権限設定で、アクセス可能なVPCネットワークおよびIPアドレスを指定する必要があります。

## 操作手順

1. [Hadoopクライアントツールインストールパッケージ](https://github.com/tencentyun/chdfs-hadoop-plugin/tree/master/jar)をダウンロードします。
2. インストールパッケージをコンピューティング作業に対応するディレクトリ下に配置します。EMRクラスターの場合、すべてのノードの`/usr/local/service/hadoop/share/hadoop/common/lib/`ディレクトリ下に同期できます。
3. `core-site.xml`ファイルを編集し、次の基本設定を追加します。
```
<!--chdfsの実装クラス-->
<property>
		 <name>fs.AbstractFileSystem.ofs.impl</name>
		 <value>com.qcloud.chdfs.fs.CHDFSDelegateFSAdapter</value>
</property>

<!--chdfsの実装クラス-->
<property>
		 <name>fs.ofs.impl</name>
		 <value>com.qcloud.chdfs.fs.CHDFSHadoopFileSystemAdapter</value>
</property>

<!--ローカルcacheの一時ディレクトリ。データの読み取りと書き込みの場合、メモリcacheが不足すると、ローカルディスクに書き込まれます。このパスが存在しない場合は、自動的に作成されます-->
<property>
		 <name>fs.ofs.tmp.cache.dir</name>
		 <value>/data/chdfs_tmp_cache</value>
</property>

<!--ユーザーのappId。Tencent Cloudコンソール(https://console.cloud.tencent.com/developer)にログインして確認できます-->      
<property>
		 <name>fs.ofs.user.appid</name>
		 <value>1250000000</value>
</property>

<!--flushセマンティクス。デフォルトではfalse(非同期フラッシュ)です。下図のデータ可視性および永続化についての詳細な説明をご参照ください -->      
<property>
		 <name>fs.ofs.upload.flush.flag</name>
		 <value>false</value>
</property>

```
4. `core-site.xml`をすべての`hadoop`ノードに同期します。
>?EMRクラスターの場合、EMRコンソールのコンポーネント管理で上記の手順3と4において、HDFSの設定を変更することができます。
>
5. `hadoop fs`コマンドラインツールを使用して、`hadoop fs -ls ofs://${bucketname-appid}/`コマンドを実行します。この`bucketname-appid`はマウントアドレス、すなわちバケット名です。ファイルリストが正常にリストアップされている場合は、COSバケットが正常にマウントされたことを意味します。
6. ユーザーは`hadoop`の他の設定項目または`mr`タスクを使用して、メタデータアクセラレーション機能を有効にしたCOSバケット上でデータタスクを実行することもできます。`mr`タスクの場合、`-Dfs.defaultFS=ofs://${bucketname-appid}/`によって、このタスクのデフォルトの入力・出力`FS`を対応するバケットに変更することができます。

## ケースの説明

### データ可視性および永続化

メタデータアクセラレーション機能を有効にすると、`COS`をクラウド分散ファイルシステムとして使用することができるようになります。`Hadoop`クライアントツールでファイルを開くと、クライアントは一定のサイズ （通常は4MB）を満たす場合に非同期フラッシュを行い、データをパブリッククラウドの`COS`バケットに書き込みます。上位階層のコンピューティング業務がデータ出力ストリームの`Flush`インターフェースを自主的に呼び出した場合、**デフォルトのアクションは無視されます（通常のflushによる同期フラッシュのセマンティクスとは異なります）**。クライアントはその後、書き込み量が一定のサイズに達するのを待ってから非同期`flush`を行い、最後に`Close`を呼び出した時点で強制的に同期フラッシュします。 `Close`が正常に行われたデータは永続化されており、その後正常に読み取れることが保証されます。

`Hadoop`クライアントツールがデフォルトで非同期`Flush`を選択する理由は、ローカルディスクに比べてクラウドではアクセス遅延が大きいため、非同期`Flush`とすることでクラウドとの対話を減らし、`Flush`操作によってユーザーの書き込み操作が妨げられることを防ぎ、書き込みパフォーマンスを大幅に向上させて作業時間を短縮することが可能になるためです。リスクとしては、最後に自主的に`Close`インターフェースを呼び出さなかった場合、フラッシュされなかったデータが失われる危険がある点です。

このため、**リアルタイムに書き込みを必要とするデータについて、例えば、`Hbase Wal Log`、`Journal`ログの保存など、データの即時可視化とクラウドでの永続化を保証するケースでは、設定項目`fs.ofs.upload.flush.flag`の説明をご参照の上、同期`Flush`のオプションを有効にしてください。**

## 設定項目の説明

|        設定項目      |                             説明                             |  デフォルト値   | 入力必須かどうか |
| :------------------------------| :----------------------------------------------------| :-------| :------ |
|       fs.ofs.tmp.cache.dir        |   一時データの保存    |    なし    |    はい    |
|       fs.ofs.map.block.size       | クライアントはデータを複数の`Block`に分割して書き込みます。このパラメータはデータのblockサイズの制御に用いられ、単位はバイト、デフォルトは128MBです（mapのセグメンテーションにのみ影響を与え、CHDFS最下層のストレージロックサイズとは関係ありません） | 134217728 |    いいえ    |
| fs.ofs.data.transfer.thread.count |               クライアントデータ転送時の並列スレッドの数                |    32     |    いいえ    |
| fs.ofs.block.max.memory.cache.mb  | クライアントプラグインによって使用されるメモリ`Buffer`のサイズ。単位はMBです。（読み取りと書き込みのアクセラレーション効果あり） |    16     |    いいえ    |
|  fs.ofs.block.max.file.cache.mb   |  CHDFSプラグインによって使用されるディスク`Buffer`のサイズ。単位はMBです。（書き込みにアクセラレーション効果あり）  |    256    |    いいえ    |
|   fs.ofs.prev.read.block.count    | 読み取りの際の先行読み取りデータの`Block`の数（サイズは通常4MB）。ランダムリードの場合はこの数値を適宜少なくしてください。シーケンシャルリードの場合はこの数値およびメモリbufferのサイズを適宜大きくすることができます|     4     |    いいえ    |
|  fs.ofs.prev.read.block.release.enable| すでに読みとった1つ前の`Block`のBufferをリリースするかどうか。シーケンシャルリードの場合はオンにすることをお勧めします。ランダムリードの場合は、ある部分のデータを繰り返し読み取る場合は煩雑になるため、オフにすることをお勧めします。オプション値は`true（オン）`、`false（オフ）`です | `true` | いいえ |
|      fs.ofs.plugin.info.log       |          クライアントのデバッグログを印刷するかどうか。ログはinfoレベルで印刷されます。 オプション値はtrue（オン）、false（オフ）です |   false   |    いいえ    |
|      fs.ofs.upload.flush.flag     | データを書き込み、出力ストリームの`Flush`インターフェースを呼び出す際、データを同期フラッシュするかどうか。デフォルトでは非同期データ出力（`false`）です。同期フラッシュが必要な場合は、`true`に設定してください | false | いいえ |

