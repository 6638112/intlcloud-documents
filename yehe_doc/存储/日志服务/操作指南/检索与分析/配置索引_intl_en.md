Index configuration is a necessary condition for using CLS for log search and analysis; that is, search and analysis can be performed only after index is enabled. In addition, different index rules can lead to different search and analysis results. This document describes how to configure an index and how it works.

CLS supports the following index types: 

| Type       | Description                                                         | Configuration Method    |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Full-text index   | A raw log is split into multiple segments, and indexes are created based on the segments. You can query logs based on segments. For example, entering `error` means to query logs that contain the keyword `error`.<br>If you use LogListener to collect logs in a single-/multi-line full-text manner, you must enable full-text indexing before you can search for logs. | Console: enable full-text indexing on the index configuration page.                     |
| Key-value index   | Indexes are created based on key-value pairs for raw logs, and logs are searched by key-value. For example, entering `level:error` means to query logs with a `level` field whose value is `error`. | Console: on the index configuration page, enable key-value indexing and enter the corresponding field name (i.e., the key name `key`), such as `level`. |
| Metadata index | A metadata index is a key-value index in essence, but the key name is identified by `__TAG__` as the prefix field. For example, entering `__TAG__.client:192.168.10.10` means to query metadata with a `client` field whose value is `192.168.10.10`. | Console: on the index configuration page, enable key-value indexing and enter the corresponding metadata field name (i.e., the key name `key`), such as `__TAG__.client`. |

CLS has built-in reserved fields, including `__FILENAME__` (collection file name), `__SOURCE__` (collection source IP), and `__TIMESTAMP__` (timestamp).

| Built-in Field        | Description                                                     | Fees                                           |
| :-------------- | :----------------------------------------------------------- | :--------------------------------------------- |
| `__FILENAME__`  | Filename for log collection, which can be used to filter filenames. For example, you can use `__FILENAME__:/"var/log/access.log"` to query logs from the `/var/log/access.log` file. | An index is created automatically, but the traffic generated by indexing it is not billed, so no fees will be incurred. |
| `__SOURCE__`    | Source IP for log collection, which can be used to filter servers. For example, you can use `__SOURCE__:192.168.10.10` to query logs from the `192.168.10.10` server. | An index is created automatically, but the traffic generated by indexing is not billed, so no fees will be incurred. |
| `__TIMESTAMP__` | Log timestamp (UNIX timestamp in milliseconds). When a log is searched by time range, the system automatically filters the log by this time and displays the time as the log time on the console. | An index is created automatically, but the traffic generated by indexing is not billed, so no fees will be incurred. |
| `__PKG_LOGID__` | Log ID in a log group. This ID is used for [context search and analysis](https://intl.cloud.tencent.com/document/product/614/39795). You are not recommended to use this ID alone. | An index is created automatically, but the traffic generated by indexing is not billed, so no fees will be incurred. |
| `__CONTENT__`   | If the extraction mode in the collection configuration is set to full text in a single line or full text in multi lines, the original log is stored under this field. You cannot configure a key-value index for this field. If search is required, you only need to enable full-text indexing. | An index needs to be configured manually, and the traffic generated by indexing will be billed. For more information on the fees, please see the billing description. |
| `__TAG__`       | Prefix of the metadata field, which is used to distinguish between raw log contents. For more information on how to carry metadata, please see the description of the `logTags` field in [UploadLog](https://intl.cloud.tencent.com/document/product/614/42787). | An index needs to be configured manually, and the traffic generated by indexing will be billed. For more information on the fees, please see the billing description. |


## Full-Text Index

Full-Text index allows you to perform searches by using keywords. It splits all field values in the raw log content into several keywords according to the delimiter rules and then creates an index. Therefore, if no key name (i.e., the field name `key`) is specified for keyword queries, searches will be performed based on full-text index.

| Configuration Item     | Description                                                     |
| ---------- | ------------------------------------------------------------ |
| Full-Text Delimiter | A set of characters that split the raw log content into segments. The delimiters <code>@&()='",;:&lt;>[]{}/ \n\t\r\ </code> are entered by default in the console. |
| Case Sensitivity | Specifies whether a keyword after segmentation is case-sensitive during queries. For example, if the keyword after segmentation is `Error` and is case-sensitive, `error` cannot be queried. |
| Allow Chinese Characters     | This feature can be enabled when logs contain Chinese characters and the Chinese characters need to be searched. For example, if the original text of a log is in Chinese, and this feature is disabled, you cannot query the log by using a Chinese keyword contained in the original text. The query can be successful only if you use the exact original log text to query the log. However, if you enable this feature, you can query the log using a Chinese keyword contained in the original log text. If this feature is enabled, Chinese log text will be segmented according to Chinese semantics, which will increase the index volume to some extent. Please use this feature as needed.              |


For example, a complete log is as shown below:
```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

If you extract key-value pairs from the raw log content as instructed in [Collecting CSV Logs](https://intl.cloud.tencent.com/document/product/614/32285), the structured format uploaded to CLS will be:

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
```

If the full-text delimiter rule is <code>@&()='",;:&lt;>[]{}/ \n\t\r</code> (including space), all field values in the raw log will be split into the following keywords (each line denotes a keyword):

```
10.20.20.10
GET
online
sample
HTTP
1.1
200
2018-07-16
13
12
57
```

The rule for determining a search hit is that a hit log must contain at least one keyword. For more information, please see the following samples:

- Sample query 1. If you enter `200` for query, the sample log will be hit because it contains the keyword `200`.
- Sample query 2. If you enter `/online/sample` for query, the sample log cannot be returned since `/` is a reserved character (regular expression identifier) in CLS [search syntax](https://intl.cloud.tencent.com/document/product/614/30439), which needs to be escaped to `\/online\/sample` by using <code>\\</code>. As `/` is included in the full-text index delimiter rule, the actual query logic of `\/online\/sample` is `online OR sample`, and other logs that contain the keyword `online` or `sample` may be hit.
- Sample query 3. If you enter `"/online/sample" ` for query, the sample log can be returned. Because `""` is also a reserved character in CLS [search syntax](https://intl.cloud.tencent.com/document/product/614/30439), `/`, `online`, and `sample ` contained in `"/online/sample"` are regarded as ordinary characters and don't need to be escaped. As `/` is included in the full-text index delimiter rule, the actual query logic of `"/online/sample"` is `online AND sample` and the word order remains unchanged; however, `"/online/sample"` may hit other logs such as `/online/sample/abc`.

## Key-Value Index

Indexes are created based on key-value pairs. An index rule can be configured for each field name (key name), such as the data type, delimiter, and statistics. To perform a key-value query, you must specify the field name, and the query syntax format is `key:value`, for example, `status:200`. If no field name is specified, a full-text search will be performed.

>? CLS has built-in reserved fields, including the collection source IP `__SOURCE__`, the collection file `__FILENAME__`, and the timestamp `__TIMESTAMP__`. By default, a key-value index is configured, the key-value index delimiters are empty, and statistics collection is enabled. The traffic generated by indexing such fields is not billed, so no fees will be incurred.
>

| Configuration Item     | Description                                                     | Remarks                       |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Data Type   | Data type of the field. For example, the `text ` type supports fuzzy query, while the `long` and `double` types support range query. | long - integer (Int 64)<br/>double - floating point (64-bit)<br/>text - string |
| Delimiter     | They are used to segment fields into keywords according to the defined character set. | Default delimiters: <code>@&()='",;:&lt;>[]{}/ \n\t\r\ </code>                       |
| Allow Chinese Characters     | This feature can be enabled when fields contain Chinese characters and the Chinese characters need to be searched. For example, if the original text of a field is in Chinese, and this feature is disabled, you cannot query the log by using a Chinese keyword contained in the original text. The query can be successful only if you use the exact original log text to query the log. However, if you enable this feature, you can query the log using a Chinese keyword contained in the original log text. | If this feature is enabled, Chinese log text will be segmented according to Chinese semantics, which will increase the index volume to some extent. Please use this feature as needed.              |
| Enable Statistics   | After it is enabled, statistical analysis can be performed on fields, such as `group by ${key}` and `sum(${key})`. For more information, please see [Overview](https://intl.cloud.tencent.com/document/product/614/37803).| Disabled by default                                                            |
| Case Sensitivity | Specifies whether a keyword after segmentation is case-sensitive during queries. For example, if the keyword after segmentation is `Error` and is case-sensitive, `level:error` cannot be queried. | Case-insensitive by default |


For example, a complete log is as shown below:

```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

If you extract key-value pairs from the raw log content as instructed in [Collecting CSV Logs](https://intl.cloud.tencent.com/document/product/614/32285), the structured format uploaded to CLS will be:

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
```

If the rules for key-value indexing as follows:

| Key-Value Index Field Name  | Delimiters                     |
| -------------- | -------------------------- |
| IP             | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code>|
| request        | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code> |
| status         | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code>|
| time           | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code> |

- Sample query 1. If you enter `IP:10.20.20.10`, the sample log can be returned since the delimiters don't include a period and `10.20.20.10` is regarded as a keyword.
- Sample query 2. If you enter `request:GET /online/sample`, the sample log cannot be returned since `/` is a reserved character (regular expression identifier) in CLS [search syntax](https://intl.cloud.tencent.com/document/product/614/30439), which needs to be escaped to `request:GET \/online\/sample`. As `/` is included in the `request` index delimiter rule, the actual query logic of `request:GET \/online\/sample` is `request:GET OR request:online OR request:sample`, and other logs may be hit.
- Sample query 3. If you enter `request:"GET /online/sample"`, the sample log can be retrieved. Because `""` is also a reserved character in CLS [search syntax](https://intl.cloud.tencent.com/document/product/614/30439), `GET`, `/`, `online`, and `sample` contained in `request:"GET /online/sample"` are regarded as ordinary characters and don't need to be escaped. However, as `/` is included in the `request` index delimiter rule, the actual query logic of `request:"GET /online/sample"` is `request:(GET AND online AND sample)` and the word order remains unchanged, and other logs such as `request:GET /online/sample/abc` may be hit.



## Metadata Index

When a log is uploaded to CLS, its metadata is passed through the `LogTag` field (for more information, please see the `LogTag` field in [Uploading Structured Log](https://intl.cloud.tencent.com/document/product/614/16873)), while the raw log content is passed through the `Log` field. A metadata index needs to be configured for all data which is passed via `LogTag`. A metadata index is a key-value index in essence, adopting the same indexing rules and configuration methods as key-value indexes. The only difference is that the metadata field in a metadata index is identified by the specific prefix `__TAG__. `. For example, the `client` metadata field is indexed as `__TAG__.client`.

For example, a complete log is as shown below:

```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

If you extract key-value pairs from the raw log content as instructed in [Collecting CSV Logs](https://intl.cloud.tencent.com/document/product/614/32285) which carries the metadata `region:ap-beijing`, the structured format uploaded to CLS will be:

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
__TAG__.region:ap-beijing
```

If the rules for metadata indexing are as follows:

| Key-Value Index Field Name  | Delimiters                     |
| --------------- | -------------------------- |
| \_\_TAG\_\_.region | <code>@&()='",;:&lt;>[]{}/ \n\t\r</code>|

Sample query: if you enter `__TAG__.region:"ap-beijing"`, the sample log can be returned.


## Notes

- Log data collected cannot be searched when index is disabled. It takes about one minute for the log search and analysis feature to become available after index is enabled.
- Only fields for which **Enable Statistics** is toggled on in the key-value index configuration support statistical analysis. `__CONTENT__` does not support configuring key-value indexes and enabling statistics (to configure the features, use log extraction modes other than full text in a single line or full text in multi lines).
- Index rule modifications (including adding, modifying, and deleting fields, and adjusting delimiter configuration) take effect only for newly written logs. Existing data is not updated, and the data before the index rule modifications does not support statistical analysis (SQL).
- In the future, CLS will parse nested JSON fields only to the levels for which indexes are configured (the update period is from February 21, 2022 to March 4, 2022, and existing log topics whose index configuration remains unchanged will not be affected), and the rest levels will be stored and displayed as strings. For more information, see [JSON field parsing rules](#JSON).

## Directions

### Modifying index configuration

1. Log in to the [CLS console](https://console.cloud.tencent.com/cls).
2. On the left sidebar, click **Log Topic** to go to the log topic list page.
3. Click the desired log topic ID/name to go to the log topic management page.
4. Click the **Index Configuration** tab and click **Edit** to go to the index configuration page. 
![](https://qcloudimg.tencent-cloud.cn/raw/64b23d441c8fb39f9127a1abadbd8632.png)
5. Modify the index configuration as needed and click **OK**.
When modifying index configuration, you can also click **Auto Configure** to enable the system to automatically get the latest log collected as a sample and parse the fields in it into key-value indexes. You can perform fine tuning on the basis of automatic configuration to quickly obtain the final index configuration information, greatly simplifying operations.
![](https://qcloudimg.tencent-cloud.cn/raw/28067fad28d0cc4f7f5d5fe9ee7cede6.png)


### Importing the index configuration

1. Log in to the [CLS console](https://console.cloud.tencent.com/cls).
2. On the left sidebar, click **Log Topic** to go to the log topic list page.
3. Click the desired log topic ID/name to go to the log topic management page.
4. Click the **Index Configuration** tab and click **Import Configuration Rule**.
![](https://qcloudimg.tencent-cloud.cn/raw/50939b3d966a718e35f0062f2281110d.png)
5. In the pop-up dialog box, select the log topic whose index configuration is to be imported and click **OK**.
![](https://qcloudimg.tencent-cloud.cn/raw/ac1203c18ebd63a90236b65bd71f8df6.png)
6. The index configuration of the selected the log topic is automatically filled into the index configuration of the current log topic. After confirming that the configuration is correct, click **OK**.


## Appendix

<span id="JSON"></span>
### JSON field parsing rules

During the storage process, logs may fail to be stored because there are too many JSON field levels, objects, or object types. In the future, CLS will parse nested JSON fields only to the levels for which indexes are configured (the update period is from February 21, 2022 to March 4, 2022, and existing log topics whose index configuration remains unchanged will not be affected), and the rest levels will be stored and displayed as strings. This feature upgrade affects only the search results of raw logs (query statements contain only search criteria but not SQL statements) and does not affect the statistical analysis results (SQL results).


The following uses an actual log as an example to describe the parsing rule in detail.

**Sample log:**

The log contains three fields, where `kye1` is a common field, and `kye2` and `kye3` are nested JSON fields.
```
{
	"kye1": "http://www.example.com",
	"kye2": {
		"address": {
			"country": "China",
			"city": {
				"name": "Beijing",
				"code": "065001"
			}
		},
		"contact": {
			"phone": {
				"home": "188xxxxxxxx",
				"work": "187xxxxxxxx"
			},
			"email": "xxx@xxx.com"
		}
	},
	"kye3": {
		"address": {
			"country": "China",
			"city": {
				"name": "Beijing",
				"code": "065001"
			}
		},
		"contact": {
			"phone": {
				"home": "188xxxxxxxx",
				"work": "187xxxxxxxx"
			},
			"email": "xxx@xxx.com"
		}
	}
}
```

**Index configuration**

The following figure shows the key-value index configuration. Key-value index is configured for the `kye1` and `kye2.address` fields but not the `kye3` field.

![](https://qcloudimg.tencent-cloud.cn/raw/fe89301d39616006fcb1ebaedb7f26fa.png)

**Search and analysis effect on the console**

JSON code:
![](https://qcloudimg.tencent-cloud.cn/raw/a4a2ef55ee6184a80e3e9e5256c578f5.png)
Table format:
![](https://qcloudimg.tencent-cloud.cn/raw/62beab77d76d8b6740475b88a14f7caa.png)

- `kye2.address` is displayed as a string, and its attributes and objects are not further expanded.
- Although `kye2.contact` is not configured with a key-value index, because `kye2.address` is configured with an index, `kye2.contact` as an object at the same level as `kye2.address` is also displayed as a string.
- `kye3` is not configured with a key-value index, and therefore its attributes and objects are not expanded.

The console provides the JSON formatting feature to display string-type JSON fields in a hierarchical manner, but this feature is only a display effect on the console, and the actual fields are still strings, as shown in the **API-based log search and analysis effect** section below.

![](https://qcloudimg.tencent-cloud.cn/raw/6d810627af2dc7d8355c07839b51e618.png)


**API-based log search and analysis effect**

If you use the [SearchLog](https://intl.cloud.tencent.com/document/product/614/42788) API to search for logs, the value of the `Results` parameter in the output parameters is as follows (other parameters are not affected and remain unchanged):
```
{
  "Time": 1645065742008,
  "TopicId": "f813385f-aee0-4238-xxxx-c99b39aabe78",
  "TopicName": "TestJsonParse",
  "Source": "172.17.0.2",
  "FileName": "/root/testLog/jsonParse.log",
  "PkgId": "5CB847DA620DB3D4-10D",
  "PkgLogId": "65536",
  "HighLights": [],
  "Logs": null,
  "LogJson": "{\"kye1\":\"http://www.example.com\",\"kye2\":{\"address\":\"{\\\"country\\\":\\\"China\\\",\\\"city\\\":{\\\"name\\\":\\\"Beijing\\\",\\\"code\\\":\\\"065001\\\"}}\",\"contact\":\"{\\\"phone\\\":{\\\"home\\\":\\\"188xxxxxxxx\\\",\\\"work\\\":\\\"187xxxxxxxx\\\"},\\\"email\\\":\\\"xxx@xxx.com\\\"}\"},\"kye3\":\"{\\\"address\\\":{\\\"country\\\":\\\"China\\\",\\\"city\\\":{\\\"name\\\":\\\"Beijing\\\",\\\"code\\\":\\\"065001\\\"}},\\\"contact\\\":{\\\"phone\\\":{\\\"home\\\":\\\"188xxxxxxxx\\\",\\\"work\\\":\\\"187xxxxxxxx\\\"},\\\"email\\\":\\\"xxx@xxx.com\\\"}}\"}"
}
```

- `kye2.address` is a string, so its value is escaped as a string.
- `kye2.contact` is an object at the same level as `kye2.address`, and although `kye2.contact` is not configured with a key-value index, its value is also escaped as a string.
- `kye3` is not configured with a key-value index and is escaped as a string as a whole.

**If you use code to process the search results of the [SearchLog](https://intl.cloud.tencent.com/document/product/614/42788) API, pay attention to the escape characters to avoid processing logic exceptions.** To help you compare the API output parameters before and after the feature upgrade, the API output parameters before the upgrade are provided below:
```
{
  "Time": 1645065742008,
  "TopicId": "f813385f-aee0-4238-xxxx-c99b39aabe78",
  "TopicName": "zhengxinTestJsonParse",
  "Source": "172.17.0.2",
  "FileName": "/root/testLog/jsonParse.log",
  "PkgId": "25D0A12F620DBB64-D3",
  "PkgLogId": "65536",
  "HighLights": [],
  "Logs": null,
  "LogJson": "{\"kye1\":\"http://www.example.com\",\"kye2\":{\"address\":\"{\\\"city\\\":{\\\"code\\\":\\\"065001\\\",\\\"name\\\":\\\"Beijing\\\"},\\\"country\\\":\\\"China\\\"}\",\"contact\":{\"phone\":{\"work\":\"187xxxxxxxx\",\"home\":\"188xxxxxxxx\"},\"email\":\"xxx@xxx.com\"}},\"kye3\":{\"address\":{\"country\":\"China\",\"city\":{\"code\":\"065001\",\"name\":\"Beijing\"}},\"contact\":{\"phone\":{\"work\":\"187xxxxxxxx\",\"home\":\"188xxxxxxxx\"},\"email\":\"xxx@xxx.com\"}}}"
}
```

