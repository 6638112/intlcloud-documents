索引配置是使用日志服务（Cloud Log Service，CLS）进行检索分析的必要条件，只有开启索引，才能进行检索和分析。而且，设置不同的索引规则，也会产生不同的日志检索和分析表现效果。本文档会详细介绍索引的配置规则及原理。

日志服务的索引类型如下： 

| 类别       | 描述                                                         | 如何配置                                                     |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 全文索引   | 全文索引将原始日志拆分成多个分词进行索引构建，检索日志时基于分词进行查询，例如输入 `error` 表示查询包含 `error` 关键词的日志<br>如果您使用 Loglistener 以单行/多行全文的方式采集日志，需开启全文索引才能进行日志检索 | 控制台：在索引配置页面中，开启全文索引                     |
| 键值索引   | 键值索引将原始日志按键值对（即 key-value）进行索引构建，检索日志时基于键值方式进行查询，例如输入 `level:error` 表示查询 `level` 字段中为 `error`的日志 | 控制台：在索引配置页面中，开启键值索引，并填写对应的字段名称（即键名称 key），例如 `level` |
| 元数据索引 | 元数据索引本质也是键值索引，但键名称会以`__TAG__`作为前缀字段进行标识，例如输入`__TAG__.client:192.168.10.10` 表示查询元数据中 `client` 字段为`192.168.10.10` 的日志 | 控制台：在索引配置页面中，开启键值索引，并填写对应元数据字段名（即键名称 key），例如 `__TAG__.client` |

日志服务内置保留字段包括采集文件 `__FILENAME__`、采集源 IP `__SOURCE__`、时间戳 `__TIMESTAMP__` 等：

| 内置字段        | 描述说明                                                     | 费用                                           |
| :-------------- | :----------------------------------------------------------- | :--------------------------------------------- |
| `__FILENAME__`  | 日志采集的文件名，可以利用该字段过滤文件名，例如`__FILENAME__:"/var/log/access.log"` 查询 `/var/log/access.log` 文件的日志 | 自动创建索引，但不会计算索引流量，不会增加费用 |
| `__SOURCE__`    | 日志采集的源 IP，可以利用该字段过滤主机，例如 `__SOURCE__:192.168.10.10` 查询`192.168.10.10` 主机的日志 | 自动创建索引，但不会计算索引流量，不会增加费用 |
| `__TIMESTAMP__` | 日志时间戳（毫秒级别Unix时间戳），按时间范围检索日志时，将自动使用该时间对日志进行过滤，在控制台显示为“日志时间” | 自动创建索引，但不会计算索引流量，不会增加费用 |
| `__PKG_LOGID__` | 日志在日志组中的ID，用于[上下文检索分析](https://intl.cloud.tencent.com/document/product/614/39795)，不建议单独使用 | 自动创建索引，但不会计算索引流量，不会增加费用 |
| `__CONTENT__`   | 采集配置提取模式为单行全文或多行全文时，日志原文存储在该字段下。不支持为该字段配置键值索引，如需检索只需要开启全文索引即可 | 需要手动配置，会计算索引流量，计费参考计费说明 |
| `__TAG__`       | 元数据字段的前缀，用于区别原始日志内容。如何携带元数据，请参考 [上传日志](https://intl.cloud.tencent.com/document/product/614/42787) 中的 logTags 字段说明 | 需要手动配置，会计算索引流量，计费参考计费说明 |


## 全文索引

全文索引是按照关键词进行检索的一种索引类型。全文索引会根据分词符规则，将原始日志内容的所有字段值内容拆分成若干个关键词，然后构建索引。因此，若不指定键名称（即字段名key）进行关键词查询时，会根据全文索引进行检索。

| 配置项     | 描述说明                                                     |
| ---------- | ------------------------------------------------------------ |
| 全文分词符 | 对原始日志内容进行分词的字符集合，控制台默认填入分词符 <code>@&()='",;:&lt;>[]{}/ \n\t\r\ </code> |
| 大小写敏感 | 切分后的关键词，查询时是否对大小写敏感；例如切分后的关键词为 `Error`，若大小写敏感，则 `error` 无法查询 |
| 是否包含中文	| 日志中包含中文且需要对中文进行检索时可开启该功能。例如日志原文为“用户登录接口超时”，若未开启该功能，搜索“超时”无法查询到该日志，只有完整的搜索“用户登录接口超时”才能查询到该日志，开启后便可通过搜索“超时”查询到该日志。开启该功能会按照语义对日志进行分词，增加部分索引量，请结合实际需要适当配置 |


例如，一条完整的日志如下所示：
```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

若使用 [分隔符模式](https://intl.cloud.tencent.com/document/product/614/32285) 提取原始日志内容键值对，则上传到日志服务的结构化格式为：

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
```

若全文分词符规则为 <code>@&()='",;:&lt;>[]{}/ \n\t\r</code>（包含空格符），则原始日志的所有字段值内容会拆分成如下关键词（每行表示一个关键词）：

```
10.20.20.10
GET
online
sample
HTTP
1.1
200
2018-07-16
13
12
57
```

检索命中的判定规则为：命中日志必须包含至少一个关键词，具体可参考以下示例：

- 查询示例1：输入`200 `进行查询，该条示例日志被命中，因为该日志包含 `200` 关键词。
- 查询示例2：输入 `/online/sample` 进行查询，不可以检索出该示例日志，因为`/` 是CLS [检索语法](https://intl.cloud.tencent.com/document/product/614/30439) 保留符号(正则表达式标识符)，需要用<code>\\</code> 进行转义输入 `\/online\/sample` 。由于`/`被包含在全文索引分词符里面，所以`\/online\/sample`实际的查询逻辑是 `online OR sample`，所以可能会命中其他带有`online`或`sample`关键字的日志。
- 查询示例3：输入`"/online/sample" ` 进行查询，可以检索出该示例日志。因为`""`  也是 CLS [检索语法](https://intl.cloud.tencent.com/document/product/614/30439) 保留符号，`"/online/sample"` 所包含的 `/` 、`online`、`sample `均视为普通字符，无需再转义。由于 `/`被包含在全文索引分词符里，`"/online/sample"` 的查询逻辑是 `online AND sample` 且词序不变，但 `"/online/sample"` 可能会命中其他日志内容，例如会命中`/online/sample/abc`。

## 键值索引

键值索引是根据键值对（key-value）进行索引构建，每个字段名（键名称）可以配置索引规则：包括数据类型、分词符、统计开启等。进行键值查询的时候，必须指定字段名，查询语法格式为:`key:value`，例如`status:200`。若不指定字段名，则会当成全文检索处理。

>? 日志服务内置保留字段，包括采集源IP： `__SOURCE__`、采集文件： `__FILENAME__`、时间戳：`__TIMESTAMP__` ，默认配置键值索引，键值索引分词符为空，并开启统计，此部分不算作索引流量，因此不收费。
>

| 配置项     | 功能描述                                                     | 说明                                                         |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 数据类型   | 字段的数据类型。例如`text `类型支持模糊查询，`long、double` 类型支持范围查询。 | long - 整型（Int 64）<br/>double - 浮点型（64 bit）<br/>text - 字符串 |
| 分词符     | 用于检索时的字段值分词规则，根据定义的字符集合对每个字段进行关键词切分。 | 默认分词符 <code>@&()='",;:&lt;>[]{}/ \n\t\r\ </code>                       |
| 包含中文     |字段中包含中文且需要对中文进行检索时可开启该功能。例如字段原文为“用户登录接口超时”，若未开启该功能，搜索“超时”无法查询到该日志，只有完整的搜索“用户登录接口超时”才能查询到该日志，开启后便可通过搜索“超时”查询到该日志。 | 开启该功能会按照语义对该字段进行分词，增加部分索引量，请结合实际需要适当配置             |
| 开启统计   | 启用后，可对字段进行统计分析，如 `group by ${key}`，`sum(${key})` 等分析，详细请参见 [日志分析](https://intl.cloud.tencent.com/document/product/614/37803) 。| 默认关闭                                                            |
| 大小写敏感 | 切分后的关键词，查询时是否对大小写敏感；例如切分后的关键词为`Error`，若大小写敏感，则`level:error`无法查询。 |默认不敏感                                           |


例如，一条完整的日志如下所示：

```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

若使用 [分隔符模式](https://intl.cloud.tencent.com/document/product/614/32285) 提取原始日志内容键值对，则上传到日志服务的结构化格式为：

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
```

若键值索引的设置规则如下：

| 键值索引字段名 | 分词符                     |
| -------------- | -------------------------- |
| IP             | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code>|
| request        | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code> |
| status         | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code>|
| time           | <code>@&()='",;:&lt;>[]{}/ \n\t\r </code> |

- 查询示例1：输入`IP:10.20.20.10` ，可以检索出该示例日志，因为分词符不包含点号，`10.20.20.10` 视作一个关键词。
- 查询示例2：输入`request：GET /online/sample`，不可以检索出该示例日志，因为`/` 是CLS [检索语法](https://intl.cloud.tencent.com/document/product/614/30439) 保留符号(正则表达式标识符)，需要转义输入 `request:GET \/online\/sample` 。由于`/`被包含在`reqeust` 的索引分词符里面，所以`request:GET \/online\/sample`实际的查询逻辑是 `request:GET OR request:online OR request:sample`，所以可能会命中其他带有日志。
- 查询示例3：输入 `request:"GET /online/sample"`，可以检索出该示例日志。由于`""`  也是CLS [检索语法](https://intl.cloud.tencent.com/document/product/614/30439) 保留符号，所以`request:"GET /online/sample"` 所包含的`GET`、 `/` 、`online`、`sample `均视为普通字符，无需再转义。但是， `/` 被包含在`request`的索引分词符里，`request:"GET /online/sample"` 的查询逻辑是 `request:（GET AND online AND sample）` 且保持词序不变，可能还会命中其他日志内容，例如`request:GET /online/sample/abc`。



## 元数据索引

上传日志到日志服务时，元数据通过 `LogTag` 字段传递（详细请参见 [上传结构化日志](https://intl.cloud.tencent.com/document/product/614/16873) 中的`LogTag`字段 ），而原始日志内容通过 `Log` 字段传递。所有通过`LogTag` 传递的数据，配置索引时，均需配置元数据索引。元数据索引其实也归属键值索引，索引规则以及配置方式与键值索引相同，唯一差别在于，元数据字段有特定前缀`__TAG__. `进行标识，例如配置`client` 元数据字段的索引为 `__TAG__.client`。

例如一条完整的日志如下所示：

```
10.20.20.10;[2018-07-16 13:12:57];GET /online/sample HTTP/1.1;200
```

若使用 [分隔符模式](https://intl.cloud.tencent.com/document/product/614/32285) 提取原始日志内容键值对，且携带元信息 `region:ap-beijing`，则上传到日志服务的结构化格式为：

```
IP: 10.20.20.10
request: GET /online/sample HTTP/1.1
status: 200
time: [2018-07-16 13:12:57]
__TAG__.region:ap-beijing
```

其中，元数据的索引配置规则：

| 键值索引字段名  | 分词符                     |
| --------------- | -------------------------- |
| \_\_TAG\_\_.region | <code>@&()='",;:&lt;>[]{}/ \n\t\r</code>|

查询示例：输入`__TAG__.region:"ap-beijing"`，可以检索到该示例日志。


## 注意事项

- 索引关闭时采集的日志数据无法被检索，从开启索引到支持日志检索分析约存在一分钟左右的延迟。
- 只有键值索引中“开启统计”的字段支持统计分析，`__CONTENT__`不支持配置键值索引及开启统计（如需配置，请使用除单行全文和多行全文以外的日志采集提取模式）。
- 索引规则编辑（包括新增/编辑/删除字段、调整分词符配置等在内的所有操作）后仅对新写入的日志生效，已有数据不会更新，且编辑索引时刻前的数据不支持统计分析（即 SQL）。
- 多层 JSON 字段后续将仅解析至索引所配置的层级（2022年2月21日至2022年3月4日期间进行升级，未修改过索引配置的存量日志主题不受影响），其他层级会以字符串形式存储和展示，详见 [ JSON 字段解析规则](#JSON)。

## 操作步骤

### 编辑索引配置

1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)。
2. 在左侧导航栏中，单击**日志主题**，进入日志主题列表页面。
3. 单击需要配置索引的日志主题ID/名称，进入日志主题管理页面。
4. 选择**索引配置**页签， 单击**编辑**，进入编辑索引配置页面。 

5. 根据实际需求，编辑索引配置，单击**确定**即可保存该索引配置。
编辑索引配置过程中，您还可以单击**自动配置**，系统将自动获取采集到的最近1条日志作为样例，并将其中的字段解析为键值索引。您可以在自动配置的基础上进行微调，快速获取最终的索引配置信息，大幅简化操作复杂度。



### 导入索引配置

1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)。
2. 在左侧导航栏中，单击**日志主题**，进入日志主题列表页面。
3. 单击需要配置索引的日志主题ID/名称，进入日志主题管理页面。
4. 选择**索引配置**页签，单击**导入配置规则**。

5. 在对话框中，选择需要导入的日志主题索引配置，单击**确定**。

6. 将选中的日志主题的索引配置填写至当前日志主题的索引配置中，确认无误后，单击**确定**即可保存当前日志主题索引配置。


## 附录

<span id="JSON"></span>
### JSON 字段解析规则

在存储过程中，为了避免日志中的 JSON 字段层级过多、对象过多或对象类型不一致，导致日志存储失败，CLS 后续将仅解析多层 JSON 字段至索引所配置的层级（2022年2月21日至2022年3月4日期间进行升级，未修改过索引配置的存量日志主题不受影响），其他层级会以字符串形式存储和展示。该功能升级仅影响原始日志检索结果（即查询语句中仅包含检索条件，不包含 SQL 语句），不影响统计分析结果（即SQL结果）。


下面以实际日志为例，详细介绍解析规则。

**样例日志：**

共三个字段，kye1 为普通字段，kye2 和 kye3 为多层 JSON 字段。
```
{
	"kye1": "http://www.example.com",
	"kye2": {
		"address": {
			"country": "中国",
			"city": {
				"name": "北京",
				"code": "065001"
			}
		},
		"contact": {
			"phone": {
				"home": "188xxxxxxxx",
				"work": "187xxxxxxxx"
			},
			"email": "xxx@xxx.com"
		}
	},
	"kye3": {
		"address": {
			"country": "中国",
			"city": {
				"name": "北京",
				"code": "065001"
			}
		},
		"contact": {
			"phone": {
				"home": "188xxxxxxxx",
				"work": "187xxxxxxxx"
			},
			"email": "xxx@xxx.com"
		}
	}
}
```

**索引配置**

键值索引配置如下图，键值索引配置字段为 kye1 和 kye2.address，kye3 未配置键值索引。



**控制台检索分析效果**

JSON 代码：
![](https://qcloudimg.tencent-cloud.cn/raw/a4a2ef55ee6184a80e3e9e5256c578f5.png)
Table 样式：
![](https://qcloudimg.tencent-cloud.cn/raw/62beab77d76d8b6740475b88a14f7caa.png)

- kye2.address 整体显示为字符串，没有进一步展开其下的属性和对象。
- kye2.contact 虽然没有配置键值索引，但由于索引配置到了 kye2.address，kye2.contact 作为同层级对象，同样整体显示为字符串。
- kye3 未配置键值索引，所以没有展开任何属性和对象。

控制台展示日志时提供了 JSON 格式化功能，可将字符串形式的 JSON 字段按层级显示，但该功能仅为控制台显示效果，实际的字段仍为字符串，这一点可在下文的 API 检索分析结果中体现出来。




**API 检索分析结果效果**

使用 API 文档 [搜索日志](https://intl.cloud.tencent.com/document/product/614/42788) 检索日志时，输出参数中的 Results 参数值如下（其他参数不受影响，无变化）：
```
{
  "Time": 1645065742008,
  "TopicId": "f813385f-aee0-4238-xxxx-c99b39aabe78",
  "TopicName": "TestJsonParse",
  "Source": "172.17.0.2",
  "FileName": "/root/testLog/jsonParse.log",
  "PkgId": "5CB847DA620DB3D4-10D",
  "PkgLogId": "65536",
  "HighLights": [],
  "Logs": null,
  "LogJson": "{\"kye1\":\"http://www.example.com\",\"kye2\":{\"address\":\"{\\\"country\\\":\\\"中国\\\",\\\"city\\\":{\\\"name\\\":\\\"北京\\\",\\\"code\\\":\\\"065001\\\"}}\",\"contact\":\"{\\\"phone\\\":{\\\"home\\\":\\\"188xxxxxxxx\\\",\\\"work\\\":\\\"187xxxxxxxx\\\"},\\\"email\\\":\\\"xxx@xxx.com\\\"}\"},\"kye3\":\"{\\\"address\\\":{\\\"country\\\":\\\"中国\\\",\\\"city\\\":{\\\"name\\\":\\\"北京\\\",\\\"code\\\":\\\"065001\\\"}},\\\"contact\\\":{\\\"phone\\\":{\\\"home\\\":\\\"188xxxxxxxx\\\",\\\"work\\\":\\\"187xxxxxxxx\\\"},\\\"email\\\":\\\"xxx@xxx.com\\\"}}\"}"
}
```

- kye2.address 为字符串，因此其值被转义为字符串。
- kye2.contact 作为 kye2.address 的同层级对象，虽然未配置键值索引，其值同样被转义为字符串。
- kye3 未配置键值索引，所以整体被转义为字符串。

**如果您在使用代码处理 [搜索日志](https://intl.cloud.tencent.com/document/product/614/42788) 的检索结果，请注意此处的转义符，避免处理逻辑出现异常**。为方便您对比功能升级前后的 API 输出参数变化细节，升级前的 API 输出参数如下：
```
{
  "Time": 1645065742008,
  "TopicId": "f813385f-aee0-4238-xxxx-c99b39aabe78",
  "TopicName": "zhengxinTestJsonParse",
  "Source": "172.17.0.2",
  "FileName": "/root/testLog/jsonParse.log",
  "PkgId": "25D0A12F620DBB64-D3",
  "PkgLogId": "65536",
  "HighLights": [],
  "Logs": null,
  "LogJson": "{\"kye1\":\"http://www.example.com\",\"kye2\":{\"address\":\"{\\\"city\\\":{\\\"code\\\":\\\"065001\\\",\\\"name\\\":\\\"北京\\\"},\\\"country\\\":\\\"中国\\\"}\",\"contact\":{\"phone\":{\"work\":\"187xxxxxxxx\",\"home\":\"188xxxxxxxx\"},\"email\":\"xxx@xxx.com\"}},\"kye3\":{\"address\":{\"country\":\"中国\",\"city\":{\"code\":\"065001\",\"name\":\"北京\"}},\"contact\":{\"phone\":{\"work\":\"187xxxxxxxx\",\"home\":\"188xxxxxxxx\"},\"email\":\"xxx@xxx.com\"}}}"
}
```

