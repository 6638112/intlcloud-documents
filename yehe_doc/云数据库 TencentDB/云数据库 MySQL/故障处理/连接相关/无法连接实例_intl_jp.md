
## 現象の説明
- [現象1](id:xz1)：CVMからTencentDB for MySQLに接続してログインすると、接続に失敗する。
- [現象2](id:xz2)：ローカルコンピュータからTencentDB for MySQLに接続してログインすると、接続に失敗する。
- [現象3](id:xz3)：データベース管理DMCプラットフォームからTencentDB for MySQLに接続してログインすると、接続に失敗する。


## 考えられる原因
<table>
<thead><tr><th width=15%>考えられる原因</th><th width=35%>説明</th><th width=15%>考えられる原因</th><th width=35%>説明</th></tr></thead>
<tbody><tr>
<td><a href="#cvmj">ネットワークの問題1</a></td><td>Cloud Virtual Machine（CVM）はVirtual Private Cloud（VPC）を採用し、MySQLは基本ネットワークを採用</td>
<td><a href="#sjkzhzjpzyw">アカウントが権限を付与するホストアドレスの問題</a></td><td>データベースアカウントがアクセスする具体的なホストアドレスを制限しています</td></tr>
<tr>
<td><a href="#cjmv">ネットワークの問題2</a></td><td>CVMは基本ネットワークを採用し、MySQLはVPCを採用</td>
<td><a href="#ljyfwt">接続の構文エラー</a></td><td>接続コマンドにエラーがあります</td></tr>
<tr>
<td><a href="#cmvbt">ネットワークの問題3</a></td><td>CVMとMySQLは同じリージョン、ただし異なるVPCネットワークに帰属</td>
<td><a href="#idyw">IPおよびポートのエラー</a></td><td>コマンドラインまたは設定ファイルのIPおよびポートにエラーがあります</td></tr>
<tr>
<td><a href="#dywt">ネットワークの問題4</a></td><td>CVMとMySQLが同じリージョンになく、異なるVPCネットワークに帰属</td>
<td>MySQLインスタンスの状態</td><td>MySQLインスタンスは隔離中です。<a href="https://console.cloud.tencent.com/mysql/recycle">ごみ箱</a>から復元できます</td></tr>
<tr>
<td><a href="#caqzpzyw">セキュリティグループ設定の問題</a></td><td>CVMセキュリティグループの設定にエラーがあります</td>
<td>CVMインスタンスの状態</td><td>CVMインスタンスが隔離中またはシャットダウン中です。<a href="https://console.cloud.tencent.com/cvm/instance">コンソール</a>から復元させます</td></tr>
<tr>
<td><a href="#maqzpzyw">セキュリティグループ設定の問題</a></td><td>MySQLセキュリティグループの設定にエラーがあります</td>
<td>パブリックネットワーク接続の有効状態</td><td>MySQLインスタンスのパブリックネットワーク接続が有効になっていません。<a href="https://intl.cloud.tencent.com/document/product/236/37788">パブリックネットワーク接続の有効化</a>をご参照ください</td></tr>
</tbody></table>

## 解決方法
### [現象1、2](#xz1) 解決のためのアプローチ
1. **チェックツールによる原因診断**
TencentDB for MySQLコンソールでは、[クイック接続チェックツール](#step1)を提供し、接続不能に至った原因の判断に役立つようにしています。その後、提示内容にしたがって修正を行い、インスタンスに再接続します。
2. **原因のセルフ診断**
クイック接続チェックツールで問題の原因を特定できない場合は、[以下に紹介する失敗の原因から、失敗の原因を自身で識別し、特定する](#step2)ことができます。

### [現象3](#xz3) 解決のためのアプローチ
1. ログインアカウントのホストの制限の中で、当該リージョンのDMCサーバーのすべてのIPに権限がすでに付与されていることを確認します。権限付与については、[アクセス権限を付与するホストアドレスの修正](https://intl.cloud.tencent.com/document/product/236/31903)をご参照ください。また直接%を使用し、すべてのIPを通過させ、セキュリティグループによってのみデータベースのアクセス元を制限することもできます。
2. IPへの権限付与が確認された場合、アカウントのパスワードエラーの可能性がありますので、正しいパスワードを再度入力してください。[パスワードの再設定](https://intl.cloud.tencent.com/document/product/236/31901)または[権限がニーズを満たす臨時アカウントの作成](https://intl.cloud.tencent.com/document/product/236/31900)を行うこともできます。

## 処理手順
### 現象1、2：CVM、ローカル接続失敗の対処方法
#### [手順1：クイック接続チェックツールを使って原因を特定し、対応する処置を行います](id:step1)
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、チェックが必要なインスタンスを選択して、インスタンスIDをクリックし、インスタンス管理ページに進みます。
2. インスタンス管理ページで、【接続チェック】>【プライベートネットワークのチェック】または【パブリックネットワークのチェック】ページを選択します。
>?プライベート/パブリックネットワークアドレスの判断については、インスタンス詳細ページの基本情報で確認できます。
3. 当該MySQLインスタンスにアクセスするCVMまたはパブリックネットワークサーバーを追加します。
 - プライベートネットワークのチェック：当該MySQLインスタンスにアクセスするCVMを追加します。
 - パブリックネットワークのチェック：当該MySQLインスタンスにアクセスするパブリックネットワークサーバーを追加します。
4. 追加完了後、【チェック開始】をクリックします。チェックタスクが完了すると、チェックレポートが発行されます。
5. チェックレポートに基づいて問題を特定し、推奨する対処方法にしたがって調整した後に、MySQLに再度接続します。
   - プライベートネットワークのチェックの場合、検査項目および推奨する対処方法は次となります。
<table>
<thead><tr><th>検査項目</th><th>異常および対処方法</th></tr></thead>
<tbody><tr>
<td>MySQLインスタンスの状態</td>
<td>お客様のMySQLインスタンスが破棄済みであることが検出されました。インスタンスを破棄しようとしていない場合は、<a href="https://console.cloud.tencent.com/mysql/recycle">ごみ箱</a>から復元することができます</td></tr>
<tr>
<td rowspan=2>CVMインスタンスの状態</td>
<td>お客様のCVMインスタンスが破棄済みであることが検出されました。インスタンスを破棄しようとしていない場合は、<a href="https://console.cloud.tencent.com/cvm/recycler/cvm">ごみ箱から</a>復元することができます</td></tr>
<tr>
<td>お客様のCVMインスタンスが停止済みであることが検出されました。当該CVMインスタンスを引き続き使用したい場合は、<a href="https://console.cloud.tencent.com/cvm/instance">コンソール</a>にアクセスして当該CVMインスタンスを有効にしてください</td></tr>
<tr>
<td rowspan=2>CVMとMySQLが同じVPCに帰属</td>
<td>お客様のCVMとMySQLのネットワークタイプが異なることが検出されました。CVMとMySQLを同じネットワークタイプにする必要があります。<a href="#wlwt">ネットワークの問題</a>を参考にネットワークタイプを修正してください</td></tr>
<tr>
<td>お客様のCVMとMySQLが同じVPCネットワークセグメントにないことが検出されました。CVMとMySQLを同じリージョンの同じVPCに置く必要があります。<a href="#wlwt">ネットワークの問題</a>を参考にVPCを修正してください</td></tr>
<tr>
<td>CVMセキュリティグループポリシー</td>
<td>お客様のCVMにバインドされているセキュリティグループの<strong>アウトバウンドルール</strong>がIPポートへのアクセスを通過させていないことが検出されました。<a href="#caqzpzyw">CVMセキュリティグループ設定エラー</a>を参考にアウトバウンドルールを開放してください</td></tr>
<tr>
<td>MySQLセキュリティグループポリシー</td>
<td>お客様のMySQLインスタンスにバインドされているセキュリティグループの<strong>インバウンドルール</strong>がIPポートへのアクセスを通過させていないことが検出されました。<a href="#maqzpzyw">MySQLセキュリティグループ設定エラー</a>を参考にインバウンドルールを開放してください</td></tr>
</tbody></table>
<img src="https://main.qcloudimg.com/raw/ae30ffd0f9df350e1360ed3f870ff441.png">
   - パブリックネットワークのチェックの場合、検査項目および推奨する対処方法は次となります。
<table>
<thead><tr><th>検査項目</th><th>異常および対処方法</th></tr></thead>
<tbody><tr>
<td>MySQLインスタンスの状態</td><td>お客様のMySQLインスタンスが破棄済みであることが検出されました。インスタンスを破棄しようとしていない場合は、<a href="https://console.cloud.tencent.com/mysql/recycle">ごみ箱</a>から復元することができます</td></tr>
<tr>
<td>パブリックネットワーク接続の有効状態</td>
<td>お客様のMySQLインスタンスはパブリックネットワーク接続が有効になっていないことが検出されました。<a href="https://intl.cloud.tencent.com/document/product/236/37788">パブリックネットワーク接続の有効化</a>をご参照ください</td></tr>
</tbody></table>
<img src="https://main.qcloudimg.com/raw/502f00b7c8913baf52c9548a525c9772.png">

#### [手順2：ツールチェックで問題を解決できないときは、以下の原因を参考にしてチェックできます](id:step2)
[**パスワードエラー**](id:mmwt)
接続時に使用するパスワードのエラー。[パスワードの再設定](https://intl.cloud.tencent.com/document/product/236/31901)または[権限がニーズを満たす臨時アカウントの作成](https://intl.cloud.tencent.com/document/product/236/31900)により、データベースにログインすることができます。

[**接続の構文エラー**](id:ljyfwt)
接続のコマンドに誤りがないかチェックしてください。次の標準的な接続コマンドをご参照いただけます。プライベートネットワーク接続は`mysql -h hostname -u username -p`、パブリックネットワーク接続は`mysql -h hostname -P port -u username -p`です。詳しい手順は、[MySQLインスタンスの接続](https://intl.cloud.tencent.com/document/product/236/37788)をご参照ください。

[**コマンドラインまたは設定ファイルのIPおよびポートのエラー**](id:idyw)
[MySQLコンソール](https://console.cloud.tencent.com/cdb)でインスタンスのIPポートとコマンドライン、設定ファイルの中の情報が一致しているかどうかチェックしてください。

[**アカウントの権限設定エラー**](id:sjkzhzjpzyw)
データベースアカウントは、セキュリティグループ、サブネットなどのネットワーク環境の制限の他にも、MySQL自身のアカウントシステムの制限を受けます。データベースアカウントに具体的なホストアドレスを指定している場合、その他のアドレスではMySQLに接続できません。
MySQLコンソールからデータベースアカウントが権限を付与しているホストアドレスを修正することで、データベースの接続を制限でき、さらにはデータベース接続の安全性も向上させることができます。
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストでインスタンスIDをクリックして、インスタンス管理ページに進みます。
2. 【データベース管理】>【アカウント管理】ページを選択し、修正が必要なホストのアカウントを見つけ、「操作」列で【その他】>【ホストの修正】を選択します。
3. ポップアップしたダイアログボックスに、新しいホストアドレスを入力し、【OK】をクリックすればアカウントが権限を付与するホストアドレスを修正することができます。
>?ホストアドレスにはIPアドレスをサポートし、%の入力（IPの範囲を制限しないことを意味します）にも対応しています。複数のホストは分離記号で分離し、分離記号には改行、スペース、「;」「,」「|」をサポートしています。
>- 例1：%を入力すると、IP範囲を制限しないことを表し、すべてのIPアドレスのクライアントが当該アカウントを使用してデータベースに接続することを許可します。
>- 例2：10.5.10.%と入力すると、IPの範囲が10.5.10.%の中にあるクライアントが当該アカウントを使用してデータベースに接続できることを意味します。

### 現象3：DMCプラットフォームのログイン失敗の対処方法](id:dptdlsbclff)
1. ログインアカウントのホストの制限の中で、当該リージョンのDMCサーバーのすべてのIPに権限がすでに付与されていることを確認してください。権限付与については、[アクセス権限を付与するホストアドレスの修正](https://intl.cloud.tencent.com/document/product/236/31903)をご参照ください。また直接%を使用し、すべてのIPを通過させ、セキュリティグループによってのみデータベースのアクセス元を制限することもできます。
2. IPへの権限付与が確認された場合、アカウントのパスワードエラーの可能性がありますので、正しいパスワードを再度入力してください。[パスワードの再設定](https://intl.cloud.tencent.com/document/product/236/31901)または[権限がニーズを満たす臨時アカウントの作成](https://intl.cloud.tencent.com/document/product/236/31900)を行うこともできます。

## 付録1
### [ネットワークの問題の解決方法](id:wlwt)
CVMとMySQLのネットワークタイプが一致しない場合、CVMはプライベートネットワーク経由でのMySQLへの直接接続ができません。

#### [CVMはVPCを採用し、MySQLは基本ネットワークを採用](id:cvmj)
- **対処方法1（推奨）**：MySQLを基本ネットワークからVPCネットワークに切り替えます。[ネットワークの切り替え](https://intl.cloud.tencent.com/document/product/236/31915)をご参照ください。
>!
>- 切り替え後、プライベートネットワークで相互通信するためには、両者が同じVPCネットワークに属する必要があります。
>- 基本ネットワークをVPCネットワークに切り替えると、元に戻すことができなくなります。
>- ネットワークを切り替えると、このインスタンスのプライベートネットワークIPが変更される場合があります。旧IPアドレスの回収時間を超えると、旧アクセスIPが無効になります。クライアントプログラムを速やかに変更してください。
>  旧IPアドレスの保留時間はデフォルトで24時間、最長保留時間は168時間までサポートしています。旧IPアドレスの回収時間を0時間に設定すると、ネットワークの切り替え後にすぐに旧IPアドレスが回収されます。
>- 基本ネットワークからVPCへの切り替え後は元に戻せません。クラウドデータベースからVPCへの切り替え後、その他のVPCおよび基本ネットワークのクラウドサービスとは相互接続できません。
>- 切り替えたクラウドデータベースがマスターインスタンスで、読み取り専用インスタンスやディザスタリカバリインスタンスがマウントされている場合、マスターインスタンスがネットワークを切り替えても、マウントされた読み取り専用インスタンスやディザスタリカバリインスタンスは、マスターインスタンスに従って自動的にネットワークを切り替えるわけではないため、手動でネットワークを切り替える必要があります。
- **対処方法2**：基本ネットワークのCVMをあらためて購入します（CVMではVPCから基本ネットワークへの移行をサポートしていません）。ただしVPCネットワークは基本ネットワークに比べ、より安全ですので、VPC ネットワークの使用を推奨します。
- **対処方法3**：CVMでMySQLのパブリックネットワークの接続アドレスを使用してMySQLに接続します。この方式は性能、安全性、安定性が劣りますので、VPCネットワークの使用を推奨します。

#### [CVMは基本ネットワークを採用し、MySQLは VPCを採用](id:cjmv)
- **対処方法1（推奨）**：CVMを基本ネットワークからVPCネットワークに切り替えます。[VPCサービスへの切り替え](https://intl.cloud.tencent.com/document/product/213/20278)をご参照ください。
>!  
>- 切り替え後、プライベートネットワークで相互通信するためには、両者が同じVPCネットワークに属する必要があります。
>- 移行前に、プライベート/パブリックネットワークのロードバランサ（CLB）およびElastic Network Interface（ENI）のバインドを自身で解除し、プライマリENIの補助IPをリリースしてください。移行後に再びバインドします。
>- 移行プロセスでは、インスタンスを再起動する必要があります。その他の操作は行わないでください。
>- 移行後、インスタンスの稼働状態を注意深くチェックし、プライベートネットワークの接続およびリモートログインが正常かどうかチェックしてください。
>- 基本ネットワークをVPCネットワークに切り替えると元には戻せません。CVMをVPCネットワークに切り替えた後はその他の基本ネットワークのクラウドサービスとは相互通信が行われなくなります。
- **対処方法2**：[基本ネットワークを利用した相互通信](https://intl.cloud.tencent.com/document/product/215/31807)。
- **対処方法3**：CVMでMySQLのパブリックネットワークの接続アドレスを使用してMySQLに接続します。この方式は性能、安全性、安定性が劣りますので、VPCネットワークの使用を推奨します。

#### [CVMとMySQLが同じリージョンにあるが、異なるVPCネットワークに帰属](id:cmvbt)
デフォルトの状態では、CVMとMySQLのネットワークタイプはいずれもVPCネットワークとなり、かつ両者が同じVPCネットワーク内にある場合にのみ、プライベートネットワーク経由で直接相互通信できます。同じリージョンでも異なるVPCに属する場合は、以下の方法を採用してCVMとMySQLを相互通信させることができます。
- **対処方法1（推奨）**：MySQLをCVMが属するVPCネットワークに移行します。[ネットワークの切り替え](https://intl.cloud.tencent.com/document/product/236/31915)をご参照ください。
- **対処方法2**：2つのVPCネットワーク間に[CCN](https://intl.cloud.tencent.com/zh/document/product/1003)を構築します。
  上記の方法を採用しない場合、異なるVPCネットワークに属するCVMとMySQLはパブリックネットワーク経由でのみ相互通信が可能となります。この方式は性能、安全性、安定性が劣ります。

#### [CVMとMySQLが同じリージョンになく、異なるVPCネットワークに帰属](id:dywt)
CVMとMySQLが同じリージョンになく、異なるVPCネットワークに属する場合、CVMはプライベートネットワーク経由でのMySQLへの直接接続ができません。
- **対処方法1（推奨）**：MySQLと同じVPCのCVMを使用して接続します。
- **対処方法2**：2つのVPCネットワーク間に[CCN](https://intl.cloud.tencent.com/zh/document/product/1003)を構築します。
- **対処方法3**：CVMでMySQLのパブリックネットワークの接続アドレスを使用してMySQLに接続します。この方式は性能、安全性、安定性が劣りますので、VPCネットワークの使用を推奨します。

### [セキュリティグループ設定の問題の解決方法](id:aqzpzwt)
CVMとMySQLのセキュリティグループの設定にエラーがある場合、CVMはプライベートネットワークまたはパブリックネットワーク経由でのMySQLへの直接接続ができません。

#### [CVMセキュリティグループ設定エラー](id:caqzpzyw)
CVMを利用してMySQLに接続したい場合は、CVMのセキュリティグループの中でアウトバウンドルールの設定が必要です。**アウトバウンドの仕様のターゲット設定が0.0.0.0/0ではなく、プロトコルのポートもALLでないとき**は、MySQLのIPおよびポートをアウトバウンドルールに追加する必要があります。

1. [セキュリティグループコンソール](https://console.cloud.tencent.com/cvm/securitygroup)にログインしてセキュリティグループ名をクリックし、CVMにバインドするセキュリティグループの詳細ページに入ります。
2. 【アウトバウンドルール】ページを選択し、【ルールの追加】をクリックします。
「タイプ」にMySQL(3306)を選択し、「ターゲット」にお客様のMySQLのIPアドレス（範囲）を入力し、「ポリシー」は許可を選択します。

#### [MySQLセキュリティグループ設定エラー](id:maqzpzyw)
指定するCVMをMySQLインスタンスに接続したい場合は、MySQLセキュリティグループの中でインバウンドルールの設定が必要です。**インバウンドルールのソースの設定が0.0.0.0/0ではなく、プロトコルのポートもALLでないとき**は、CVMのIPおよびポートをインバウンドルールに追加する必要があります。 

1. [セキュリティグループコンソール](https://console.cloud.tencent.com/cvm/securitygroup)にログインしてセキュリティグループ名をクリックし、MySQLにバインドするセキュリティグループの詳細ページに入ります。
2. 【インバウンドルール】ページを選択し、【ルールの追加】をクリックします。
接続を許可するIPアドレス（範囲）および開放する必要があるポート情報（MySQLプライベートネットワークポート）を入力し、開放の許可を選択します。
「タイプ」にMySQL(3306)を選択し、「ソース」にお客様のCVMのIPアドレス（範囲）を入力して、「ポリシー」に許可を選択します。
>!TencentDB for MySQLに接続するには、MySQLインスタンスポートが開放されている必要があります。
>- MySQLプライベートネットワークのデフォルトのポートは3306となりますが、同時にポートのカスタマイズもサポートしています。デフォルトのポート番号を修正している場合は、セキュリティグループの中でMySQLの新規ポートを開放する必要があります。
>- MySQLパブリックネットワークのデフォルトポートは60719です。[MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスIDをクリックして詳細ページに移動し、ポートを表示します。
  >![](https://main.qcloudimg.com/raw/9f471c644eb9a5aa86bd092fdebd0255.png)

## 付録2
### [プライベート/パブリックネットワークアドレスの表示](id:nwwpdff)
[MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストで、インスタンスIDをクリックして、インスタンス詳細ページに入ると、プライベート/パブリックネットワークアドレスを確認できます。
![](https://main.qcloudimg.com/raw/322c89b12772441c4fd8e83f597092ed.png)

### [ネットワークタイプ/VPCの判断方法](id:wllxvpdff)
プライベートネットワークアドレスを使用してクラウドデータベースに接続する場合、CVMとMySQLは同じアカウントにし、かつ同じVPC内（同じリージョンを保障）、または共に基本ネットワークに置く必要があります。
>?CVMとMySQLは同じアカウントにする必要があります。
>- インスタンスリストの「ネットワーク」の箇所にいずれも「基本ネットワーク」またはいずれも「VPC」が表示されている場合は、CVMとMySQLが同じネットワークタイプであることを意味します。
>- インスタンスリストの「ネットワーク」の箇所にいずれも同じ「VPC」（同じリージョンを保障）が表示されている場合は、CVMとMySQLが同じVPCであることを意味します。
>
- **CVMネットワークタイプ/同じVPCの確認** ：[CVMコンソール](https://console.cloud.tencent.com/cvm/instance)にログインし、インスタンスリストで「ネットワーク」を確認します。
  ![](https://main.qcloudimg.com/raw/ce2550045bc286172f841f4fcceb0cc4.png)
- **MySQLネットワークタイプ/同一VPCの確認**：[MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストで「ネットワーク」を確認します。
  ![](https://main.qcloudimg.com/raw/2cc5396f1b3f8af2028d75ae642a5126.png)

