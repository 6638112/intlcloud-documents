
## 現象の説明
TencentDB for MySQLに、突発的なメモリの増加が発生し、メモリが解放されずに増加し続ける現象です。具体的なパフォーマンスは、次の図に示すように、インスタンス監視のメモリ使用率監視グラフに表示されます。
![](https://main.qcloudimg.com/raw/56d978df5b08cd8320bf36654df783ab.png)
突発的な増加の後、または長期的なゆっくりとした増加の過程で、最終的に過度に高いレベル(>96%) に達し、かつ一定範囲内で小幅に変動することによって、カスタマイズされたBasic Cloud Monitorメモリアラームを頻繁に発生させる恐れがあります。

## 故障リスク
非効率なSQLセンテンスまたは不適切なデータベースパラメータ設定により、メモリ使用率が増加する恐れがあります。TencentDB for MySQLの2ノード、3ノードアーキテクチャを使用している場合に、突発的な業務ピークに遭遇すると、クラウドデータベースのメモリOOM（Out Of Memory）が発生し、マスター/スレーブの切り替えが発生する恐れがあります。マスター/スレーブの切り替え中はサービスが短時間利用できなくなりますが、インスタンスが利用できない時間は、通常60秒を超えることはありません。業務ピーク時にマスター/スレーブの切り替えが発生すると、業務の安定性と連続性に深刻な影響を及ぼす恐れがあります。

## 解決方法
MySQLのメモリは、globalレベルの共有メモリとsessionレベルのプライベートメモリの2つの部分に大別できます。
- 共有メモリはインスタンス作成時に割り当てられるメモリキャパシティであり、すべての接続で共有されます。
- プライベートメモリは、MySQLサーバーへの各接続に使用される場合に、それぞれにキャッシュが割り当てられます。
  一部の特殊なSQLまたはフィールドタイプにより、単一のスレッドに複数のキャッシュが割り当てられることがあります。OOM異常の発生は、すべて各接続のプライベートメモリに起因しています。データベース接続数を制限し、非効率なSQLを最適化することにより、メモリ使用率が高すぎるというリスクを低減することができます。MySQLのメモリ使用率が引き続き高すぎる場合は、メモリ設定をアップグレードすることで、データベース全体の同時実行性と安定性を向上させることができます。メモリパラメータの詳細な説明については、[メモリ割り当て問題](https://intl.cloud.tencent.com/document/product/236/31922)をご参照ください。

## 処理手順
1. 低速SQLを最適化し、sessionレベルのプライベートメモリの使用量を減少させます。
2. 業務に影響を与えることなく、無効な長時間の接続を減少させ、プログラム側の接続プール設定を減少させるか、またはプログラム側の同時実行レベルを低下させます。
3.メモリ使用状況の監視 (オプション、MySQL 8.0 にのみ適用)： performance_schemaのメモリ監視機能を有効化するには、performance_schemaを有効化した後、performance_schemaライブラリで、グローバルディメンションのメモリ使用率分析テーブル：memory_summary_global_by_event_nameなど、memory_summaryで始まる名前のメモリ使用状況を確認する必要があります。
4. 最適化完了後の手段：[TencentDB for MySQL設定のアップグレード](https://intl.cloud.tencent.com/document/product/236/19707)。

>?
>- アップグレードプロセスは、業務の通常の使用に影響しません。アップグレードが完了すると、秒レベルの瞬断のみで、切り替えが実施されます。業務が再接続メカニズムを備えていることを確認してください。
>- メモリまたはCPUリソースの不足によって業務の通常運用に影響が出ることを防ぐため、現在のネットワークインスタンス上のリソースに対して合理的なアラームポリシーを設定し、リソース不足の隠れたリスクを事前に発見できるようにしてください。詳細については、[アラームポリシー](https://intl.cloud.tencent.com/document/product/236/8457)をご参照ください。
