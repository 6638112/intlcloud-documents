## テストツール
データベースのベンチマークパフォーマンステストはsysbench 0.5です。

ツールの変更説明：
sysbenchに付属しているotlpスクリプトを、読み取りと書き込みの比率を1:1に設定して、テストコマンドパラメータoltp_point_selectsとoltp_index_updatesを使用して読み取りと書き込みの比率をコントロールするよう変更しました。このドキュメントのテスト例は4つのselect点、1つのupdate点を採用し、読み取りと書き込みの比率を4:1に保持します。

#### インストールツール
このドキュメントでは、Sysbench 0.5バージョンを使用してテストを行います。そのインストール方法は次の通りです。
```
git clone https://github.com/akopytov/sysbench.git
git checkout 0.5
yum -y install make automake libtool pkgconfig libaio-devel
yum -y install mariadb-devel
./autogen.sh
./configure
make -j
make install
```
>?上記は、負荷テスト用CVM（CentOSシステム）上のインストール方法です。別のOSにインストールする必要がある場合、[Sysbench公式ドキュメント](https://github.com/akopytov/sysbench?spm=a2c4g.11186623.2.12.36061072oZL2qS)をご参照ください。

## テスト環境

|タイプ|説明|
|--|--|
|インスタンス物理的機器|高可用性エディション-単一機器は最高488GBメモリ、6TBディスクのデータベースをサポートできます|
|インスタンス規格|現在販売中の人気ある構成規格（詳細について [テスト例](#cscs)）をご参照ください|
|クライアント構成| 4コア8GBメモリ|
|クライアント数量|1～6個（構成が改善されると、クライアント数量も適切に改善されなければなりません）|
|ネットワーク環境|ギガビットネットワークデータセンター、ネットワーク遅延 < 0.05ms|
|環境負荷| mysqlをインストールした機器の負荷 > 70%（非排他的インスタンスの場合）|

- クライアント規格説明：機器は、高い構成のクライアント機器を採用し、負荷テストにより単一のクライアントのデータベースインスタンスのパフォーマンスを測定できます。クライアント構成規格が小さい場合、複数のクライアントのインスタントの同時負荷テストを実行してデータの和を求めることをお勧めします。
- ネットワーク遅延説明：テスト環境はクライアント機器とデータベースインスタンスが同一のアベイラビリティーゾーンにあること、テスト結果はネットワーク環境の影響を受けないことを保証します。

## テスト方法
### 1. データベーステーブルの構造をテストする
```
CREATE TABLE `sbtest1` ( 
`id` int(10) unsigned NOT NULL AUTO_INCREMENT, 
`k` int(10) unsigned NOT NULL DEFAULT '0', 
`c` char(120) NOT NULL DEFAULT '', 
`pad` char(60) NOT NULL DEFAULT '',
 PRIMARY KEY (`id`), KEY `k_1` (`k`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8；
```

### 2. データ行のフォーマットをテストする
```
id: 1
k: 20106885
c: 08566691963-88624912351-16662227201-46648573979-64646226163-77505759394-75470094713-41097360717-15161106334-50535565977
pad: 63188288836-92351140030-06390587585-66802097351-4928296184
```


### 3. データ準備
```
sysbench --mysql-host=xxxx --mysql-port=xxxx --mysql-user=xxx --mysql-password=xxx --mysql-db=test --mysql-table-engine=innodb --test=tests/db/oltp.lua --oltp_tables_count=20 --oltp-table-size=10000000  --rand-init=on prepare
```

データ準備パラメータ説明：
- `--test=tests/db/oltp.lua`は、tests/db/oltp.luaスクリプトを呼び出して、oltpモードのテストを実行することを意味します。
- `--oltp_tables_count=20`は、テスト用のテーブル数量は20個であることを意味します。
- `--oltp-table-size=10000000`は、各テストテーブルに格納されているデータの行数が1000万行であることを意味します。
- `--rand-init=on`は、各テストテーブルがすべてランダムデータを格納していることを意味します。
   

### 4. パフォーマンスの負荷テストコマンド
```
sysbench --mysql-host=xxxx --mysql-port=xxx --mysql-user=xxx --mysql-password=xxx --mysql-db=test --test=/root/sysbench_for_z3/sysbench/tests/db/oltp.lua --oltp_tables_count=xx --oltp-table-size=xxxx --num-threads=xxx --oltp-read-only=off --rand-type=special --max-time=600 --max-requests=0 --percentile=99 --oltp-point-selects=4 run
```

パフォーマンスの負荷テストパラメータ説明：
- `--test=/root/sysbench_for_z3/sysbench/tests/db/oltp.lua`は、/root/sysbench_for_z3/sysbench/tests/db/oltp.luaスクリプトを呼び出してoltpモードのテストを実行することを意味します。
- `--oltp_tables_count=20`は、今回テスト用テーブルの数量が20個であることを意味します。
- `--oltp-table-size=10000000`は、今回テストに使用されたテーブルの行数はいずれも1000万行であることを意味します。
- `--num-threads=128`は、今回テストのクライアントの同時接続数が128であることを意味します。
- `--oltp-read-only=off`のoffは、テストの際に読み取り専用テストモデルをオフにして、読み取りと書き込みの混在モデルを使用することを意味します。
- `--rand-type=special`は、ランダムモデルが特定のものであることを意味します。
- `--max-time=1800`は、今回のテストの実行時間を意味します。
- `--max-requests=0`の0は、リクエストの総数を制限せず、max-timeを使用してテストすることを意味します。
- `--percentile=99`は、サンプリングスケール（デフォルトは95%）を、1%の長いリクエストを破棄して、残りの99%から最大値とするよう設定することを意味します。
- `--oltp-point-selects=4`は、oltpスクリプトのsqlテストコマンドのselect処理回数を4（既定値は1）に設定することを意味します。

### 5. シナリオモデル
このドキュメントの例は、ユースケーススクリプト our_oltp.luaを使用し、また4つのselect点によるクエリ、1つのupdate（インデックスカラム）、読取りと書き込みの比率を4:1に変更します。
最大構成タイプについて、データシナリオにパラメータ最適化調整モデルを追加します。テスト結果については、[テスト結果](#document_test_result)をご参照ください。

<span id="cscs"></span>
### テストのパラメータ

|インスタンス規格|ストレージスペース|テーブル数量|テーブルの行数|データセットの大きさ|同時処理数|実行時間（分）|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|1コア1GB|200GB| 4|2000万|19GB|128|30|
|1コア2GB|200GB| 4|4000万|38GB|128|30|
|2コア4GB|200GB| 8|4000万|76GB|128|30|
|4コア8GB|200GB| 15|4000万|142GB|128|30|
|4コア16GB|400GB| 25|4000万|238GB|128|30|
|8コア32GB|700GB| 25|4000万|238GB|128|30|
|16コア64GB|1TB| 40|4000万|378GB|256|30|
|16コア96GB|1.5TB| 40|4000万|378GB|128|30|
|16コア128GB|2TB| 40|4000万|378GB|128|30|
|24コア244GB|3TB| 60|4000万|567GB|128|30|
|48コア488GB|6TB| 60|4000万|567GB|128|30|
|48コア488GB（最適化調整）|6TB| 60|1000万|140GB|128|30|

<span id="document_test_result"></span>
## テスト結果

|インスタンス規格|ストレージスペース|データセット|クライアント数|単一クライアント同時処理数|QPS|TPS|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|1コア1GB|200GB|19GB|1|128|1757|97|
|1コア2GB|200GB|38GB|1|128|3016|167|
|2コア4GB|200GB|76GB|1|128|4082|816|
|4コア8GB|200GB|142GB|1|128|6551|1310|
|4コア16GB|400GB|238GB|1|128|11098|2219|
|8コア32GB|700GB|238GB|2|128|20484|3768|
|16コア64GB|1TB|378GB|2|128|36395|7279|
|16コア96GB|1.5TB|378GB|3|128|56464|11292|
|16コア128GB|2TB|378GB|3|128|81752|16350|
|24コア244GB|3TB|567GB|4|128|98528|19705|
|48コア488GB|6TB|567GB|6|128|142246|28449|
|48コア488GB（最適化調整）|6TB|140GB|6|128|245509|46304|
