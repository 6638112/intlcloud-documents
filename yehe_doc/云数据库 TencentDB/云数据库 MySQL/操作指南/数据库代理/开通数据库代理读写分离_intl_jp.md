
ここでは、TencentDB for MySQLコンソールを介してデータベースプロキシの読み取り/書き込み分離をアクティブ化する方法をご紹介します。

[データベースプロキシ読み取り/書き込み分離](https://intl.cloud.tencent.com/document/product/236/41093) 機能により、アプリケーションにデータベースプロキシのアドレスを設定すると、書き込みリクエストを自動的にマスターインスタンスへ転送し、読み取りリクエストを自動的に個々の読み取り専用インスタンスへ転送することができます。

## 前提条件
- [データベースプロキシのアクティブ化](https://intl.cloud.tencent.com/document/product/236/41087)が完了していること。
- このマスターインスタンスが [読み取り専用インスタンスの作成](https://intl.cloud.tencent.com/document/product/236/7270)済みであること。まだ読み取り専用インスタンスが作成されていない場合は、画面を開いて読み取り専用インスタンスの購入を提示できます。

## 操作手順
1. [MySQLコンソール](https://console.cloud.tencent.com/cdb)にログインし、インスタンスリストで、プロキシを有効化したマスターインスタンスを選択し、インスタンスIDまたは「操作」の列の【管理】をクリックし、インスタンス管理ページに進みます。
2. インスタンス管理ページで、【データベースプロキシ】>【読み取り/書き込み分離】ページを選択し、【今すぐ有効化】をクリックします。
![](https://main.qcloudimg.com/raw/b07508f045b727ca63c294b707159474.png)
3. ポップアップしたダイアログボックスで、遅延の排除、重みなどを設定した後、【OK】をクリックします。
>!
>- ステータスが「実行中」のマスターインスタンスと読み取り専用インスタンスのみ、データベースプロキシに追加することができます。
>- 現在、クロスリージョンROと遅延ROは、データベースプロキシの下にマウントすることはできません。
>
 - **読み取り専用インスタンスの排除**：排除ポリシーを起動するかどうか。読み取り専用インスタンスにレプリケーションの異常（レプリケーション遅延、レプリケーション中断）が発生した時、データベースプロキシは読み取り専用インスタンスを読み取り/書き込み分離から一時的に外します。遅延排除しきい値はデフォルトで10秒で、読み取り専用インスタンスの最小保留数は1個となります。
 >?読み取り専用インスタンス排除はしきい値とインスタンスの最小保留数を設定後、新たな接続に対してのみ有効となります。
 >
    - 読み取り専用インスタンスの遅延がしきい値を超えた時は排除され、排除されたインスタンスの重みは自動的に0に設定されます。また、システムがユーザーにアラームを出します（まず「データベースプロキシマウントノードの排除」アラームをサブスクリプトする必要があります。設定については [アラーム機能](https://intl.cloud.tencent.com/document/product/236/8457)をご参照ください）。
    - 読み取り専用インスタンスの遅延がしきい値より小さい時は、新たにデータベースプロキシに追加されます。同時に、遅延排除機能が有効かどうかに関わらず、読み取り専用インスタンスの障害が排除された後、インスタンスが修復されるのを待って新たにデータベースプロキシに追加されます。
    - 読み取り専用の最小保留数の設定により、データベースプロキシが現在のルート中の読み取り専用インスタンスが設定された値よりも小さいことがわかった時は、読み取り/書き込み分離に関与する読み取り専用インスタンスの個数が最小保留数を満たすまで、異常のある読み取り専用インスタンスを読み取り/書き込み分離に戻します。
注意：読み取り専用データベースに致命的な障害（ダウンタイムなど）が発生した時、最小保留数を致命的な障害が発生したインスタンスに適用することはできません。
 - **読み取りの重みの割り当て**：システムによる重みの自動割り当てと重みのカスタマイズの2種類の方式をサポートし、マスターインスタンスと読み取り専用インスタンスの読み取りの重みを設定します。 重みの入力範囲は0～100で、整数である必要があります。
 >?読み取りの重みは割り当て設定後、直ちにすべての接続に対して有効となります。
 >
    - データベースプロキシは、重みの設定に従って読み取りリクエストのトラフィックを割り当てます。例えば、2つの読み取り専用データベースの重みがそれぞれ10と20の場合、それらの読み取りリクエストのトラフィックは1：2の比率で割り当てられます。
    - 重みは読み取りリクエストの重みのみで、書き込みリクエストはマスターデータベースに直接ルーティングされ、重みの計算には関与しません。 例えば、クライアントが10個の書き込みステートメントと10個の読み取りステートメントを送信し、マスターデータベースと読み取り専用データベースの重み比が1:1の場合、マスターデータベースは10個の書き込みステートメントと5個の読み取りステートメントを受信し、読み取り専用データベースは5個の読み取りステートメントのみ受信することになります。
    - システムによる重みの自動割り当てを選択した時、システムはインスタンスのCPUとメモリの仕様に基づいて自動的に重みを割り当てます。このときに設定できるのはマスターインスタンスの重みのみです。
    - 読み取り専用インスタンスの重みが0の場合、データベースプロキシはこの読み取り専用インスタンスへの接続を構築することはありません。読み取り専用インスタンスの重みを0から非0に変更しても、重みはすぐに有効とならず、新規接続に対してのみ有効となります。
 - **フェイルオーバー**：有効化を推奨します。読み取り専用インスタンスが異常な場合、データベースプロキシが読み取リクエストをマスターインスタンスへ送信します。
 >?フェイルオーバー設定後は、新規接続に対してのみ有効となります。
 >
このパラメータをオフにすると、読み取り専用インスタンスの異常時は、読み取りリクエストがマスターインスタンスへ送信されません（過度の読み取り負荷がマスターインスタンスに影響するのを防ぐため）。ただし、すべての読み取りリクエストが失敗することになるため、読み取りリクエストの失敗後、データベースプロキシはクライアントとの接続を自動的に切断します。
 - **読み取り専用インスタンスの自動追加**：有効化すると、マスターインスタンスの後続の新規読み取り専用インスタンスは、自動的にデータベースプロキシに追加されます。
![](https://main.qcloudimg.com/raw/f2eb858b2b37fd134913738b243a17e8.png)
4. 有効化が成功すると、読み取り/書き込み分離画面で基本情報と読み取り/書き込み分離アーキテクチャ図の確認、読み取り/書き込み分離の設定の修正が可能になります。
  - 右上隅の【設定を変更】をクリックし、遅延の排除、重みの割り当てなどを新たに設定できます。
  - 右上隅の【読み取り/書き込み分離の無効化】をクリックし、データベースプロキシの読み取り/書き込み分離を無効化できます。
![](https://main.qcloudimg.com/raw/098c9fae971719881b6d20eee6ba0e73.png)
