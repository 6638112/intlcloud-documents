## 동기화 딜레이 영향
TencentDB for MySQL의 상응하는 기본 백업 데이터베이스, 재해 복구 인스턴스, 읽기 전용 인스턴스는 모두 MySQL 네이티브 binlog 복제 기술을 사용하며, 데이터 복제 방식이 비동기화 복제 또는 반동기화 복제인 경우 딜레이가 발생할 수 있습니다.

- [백업 데이터베이스](https://intl.cloud.tencent.com/document/product/236/38328)에 딜레이가 존재하는 경우 마스터-슬레이브 인스턴스가 짧은 시간 내에 전환되지 않아 작업에 영향이 미쳐 단시간 내에 정상 상태로 복구되지 않습니다.

## 주요 원인에 대한 솔루션
[모니터링 기능](https://intl.cloud.tencent.com/document/product/236/8455)을 통해 [마스터/슬레이브 딜레이 시간]을 확인할 수 있으며, 마스터/슬레이브 딜레이 시간이 0을 초과하는 경우 해당 인스턴스에 데이터 딜레이가 존재한다는 의미입니다. 주요 원인은 다음과 같습니다.

### 기본 키 또는 2단계 인덱스 없음
**원인**
binlog가 row 포맷이고 테이블에 기본 키 또는 2단계 인덱스가 없는 상태에서 대용량 테이블에 DML 작업(예: delete, update, insert)을 진행하고 슬레이브 데이터베이스에서 binlog 로그를 응용하는 경우, 기본 키 또는 2단계 인덱스에 따른 인덱스에 라인 변경이 필요합니다. 해당 테이블에 기본 키 또는 2단계 인덱스를 생성하지 않은 경우 대량의 전체 테이블 스캔 작업이 발생해 로그 응용 속도가 감소되어 데이터 딜레이가 발생합니다.

**솔루션**
- 모든 테이블에 기본 키를 생성합니다. 테이블에 기본 키를 생성하지 못하는 경우에는 기수가 높은 열을 선택하여 2단계 인덱스를 생성하는 것을 권장합니다.
- truncate 명령어를 사용하여 테이블의 모든 기록을 삭제하는 것을 권장합니다.

### 대규모 트랜잭션
**원인**
마스터 인스턴스에서 대규모 데이터 양의 DML 작업을 진행하여 대량의 binlog 로그가 슬레이브 데이터베이스로 전송되는 경우, 슬레이브 데이터베이스는 해당 트랜잭션을 완료하는 데 마스터 인스턴스와 동일한 시간을 소비하므로 슬레이브 데이터베이스에 데이터 딜레이가 발생합니다.

**솔루션**
대규모 트랜잭션을 소규모 트랜잭션으로 분할하여 where 조건으로 매번 처리해야 하는 데이터 양을 제한하면 슬레이브 데이터베이스가 빠르게 트랜잭션을 완료할 수 있어 데이터 딜레이를 방지할 수 있습니다.

### DDL 작업
**원인**
대규모 트랜잭션 원리와 마찬가지로, 마스터 인스턴스에서 DDL 작업 시간이 너무 긴 경우, 슬레이브 데이터베이스에서 해당 작업 실행을 위해 동일하거나 심지어는 더 긴 시간을 소비해 DDL 작업이 정체될 수 있습니다.

**솔루션**
비즈니스 사용량이 적은 시간대에 DDL 작업 진행을 권장합니다. 재해 복구 인스턴스, 읽기 전용 인스턴스의 쿼리 작업으로 인해 DDL 작업이 정체되는 경우 정체를 유발하는 세션을 직접 KILL하여 마스터-슬레이브 데이터의 동기화를 복구합니다.

### 인스턴스 사양이 너무 낮음
**원인**
읽기 전용 인스턴스, 재해 복구 인스턴스의 사양이 너무 낮고 마스터 인스턴스의 부하가 비교적 높은 경우, 읽기 전용 인스턴스, 재해 복구 인스턴스에 데이터 딜레이가 발생합니다.

**솔루션**
읽기 전용 인스턴스, 재해 복구 인스턴스를 마스터 인스턴스와 동일하거나 더 높은 사양으로 사용하기를 권장합니다. 읽기 전용 인스턴스, 재해 복구 인스턴스가 대용량의 분석 작업을 실행하여 인스턴스 부하가 너무 높아지는 경우, 해당 인스턴스 사양을 적합한 구성으로 업그레이드하거나 성능이 비교적 낮은 SQL을 최적화해야 합니다.


## Waiting for table metadata lock 오류
**원인**
장시간 트랜잭션이 실행되면 DDL이 정체되어 계속하여 모든 동일한 테이블의 후속 작업이 정체됩니다. 트랜잭션을 제출하지 않았으나 DDL이 정체되어 계속하여 모든 동일한 테이블의 후속 작업이 정체된 경우 다음 솔루션을 권장합니다.

**솔루션**
[DBbrain](https://intl.cloud.tencent.com/document/product/1035/36036)을 사용하여 실제 비즈니스 및 인스턴스를 진단하고 슬로우 쿼리 등의 지표를 점검하여 시간을 소모하는 장시간 트랜잭션 위치를 파악하는 것을 권장합니다.
- DBbrain을 통해 결과를 진단하여 관련 DDL 명령을 최적화합니다.
- 읽기 전용 노드 상에는 사용자 조회가 상위에서 실행되고 있을 수 있으므로, 읽기 전용 노드에 실행 시간이 긴 조회가 진행되고 있는 경우 해당 조회가 종료될 때까지 마스터 데이터베이스의 DDL을 지체시켜 읽기 전용 노드에 데이터 딜레이가 발생할 수 있습니다.
DBbrain을 통해 시간이 소모되는 대규모 조회의 위치를 파악하여 읽기 전용 노드 상의 대규모 조회를 Kill하면 읽기 전용 노드와 마스터 노드 데이터를 동기화할 수 있습니다.
- DBbrain을 통해 시간이 소모되는 장시간 트랜잭션의 위치를 파악하여 장시간 트랜잭션을 작은 단위로 분할하면 읽기 전용 노드에서 트랜잭션을 빠르게 완료할 수 있으며 데이터 딜레이가 발생하지 않습니다.
