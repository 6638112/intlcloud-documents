クラウドデータベースMySQLのメモリは重要な性能パラメータであり、例外的なSQLリクエストおよび最適化するデータベースにより、メモリ使用率が高くなりすぎる状況がしばしば発生します。ひどい場合にはOOMによりインスタンスがHA切り替えを発生させ、タスクの安定及び可能性に影響することもあります。

MySQLのメモリは主にglobalクラスの共有メモリとsessionクラスのプライベートメモリの2つに分かれます。共有メモリはインスタンス作成時に割り当てられたメモリ領域で、すべてに接続し共有されます。プライベートメモリはMySQLサーバーに接続するたびにそれぞれのキャッシュに割り当てられます。特殊な一部のSQLまたはフィールドタイプは、単一スレッドが複数のキャッシュに割り当てられることがあります。このため、OOM例外は、それぞれの接続のプライベートメモリによるものです。以下、各部の構成の詳細について説明します。

## 共有メモリ
以下のコマンドを実行し、例示した共有メモリの割り当て状況を照会します。
```
show variables where variable_name in ('innodb_buffer_pool_size','innodb_log_buffer_size','innodb_additional_mem_pool_size','key_buffer_size','query_cache_size');
```
	
>?5.7バージョンではinnodb_additional_mem_pool_sizeをサポートしていません。

以下のパラメータは、メモリの仕様が1000MBのインスタンスの共有メモリの割り当て状況の照会結果（以下はテストインスタンスの構成）です：
	1.  +---------------------------------+-----------+
	2.  | Variable_name                   | Value     |
	3.  +---------------------------------+-----------+
	4.  | innodb_additional_mem_pool_size | 8388608   |
	5.  | innodb_buffer_pool_size         | 524288000 |
	6.  | innodb_log_buffer_size          | 67108864  |
	7.  | key_buffer_size                 | 16777216  |
	9.  | query_cache_size                | 0         |
	10. +---------------------------------+-----------+
	11. 5 rows in set (0.01 sec)

**パラメータの説明**：
- **innodb_buffer_pool_size**
 この部分のキャッシュはinnodbエンジンで最重要のキャッシュエリアで、メモリによって物理データファイルを補完する重要な手段です。クラウドデータベースMySQLではインスタンス仕様設定の50%～80%をこの部分の容量（上図では1000MB * 0.5 = 500MB）にしています。これには主に、データ画面、インデックス画面、undo画面、insert buffer、アダプティブハッシュインデックス、キー情報およびデータディクショナリ等の情報が含まれます。SQLの読み書き操作では、先に物理的データファイルの操作は行わず、buffer_poolの操作を先に行ってから、checkpoint等のメカニズムによって再度データファイルを書き換えます。この領域の利点はデータベースの性能を向上させ、SQL稼働速度を速められることで、欠点は障害から回復する速度が遅いことです。

- **innodb_log_buffer_size**
 この部分は主にredo logの情報を保存し、クラウドデータベースMySQLでは64MBに設定します。InnoDBは先にrendo logをここに書き出してから、一定の頻度でログファイルの中に改めて作成します。領域は大きくしすぎる必要はありません。一般にはこの部分のキャッシュは比較的高い頻度でredo logを更新するためです（Master Threadは毎秒、またはタスク提出時に更新します。その領域が1/2より小さいときも同様に更新します）。

- **innodb_additional_mem_pool_size**
 この部分はInnoDB内の一部のデータ構造を保存し、クラウドデータベースMySQLの中で8MBに統一して設定します。通常、buffer_poolにメモリ申請するときは、別のメモリにそのオブジェクトの構造情報をストレージする領域も必要とします。その大きさはテーブル数と関係し、テーブル数が大きくなるほど大きな領域が必要になります。

- **key_buffer_size**
 この部分はMyISAMテーブルの重要なキャッシュ区域で、すべてのインスタンスは16Mに統一しています。この部分は主にMylSAMテーブルのキーを保存します。MylSAMテーブルはInnoDBテーブルとは異なり、そのインデックスキャッシュはkey_bufferに保存され、データキャッシュはOSのメモリに保存されています。クラウドデータベースMySQLのシステムはMylSAMエンジンのため、この部分に一定量の領域を割り当てる必要があります。

- **query_cache_size**
 この部分はクエリ結果をキャッシュして、SQLの解析とオーバーヘッドの実行を減らし、クラウドデータベースMySQL上で該当部分のキャッシュを閉じます。SQL言語のハッシュ値を基にキャッシュにし、テーブルデータに変化が生じるとエラーになるため、主に読み出しが多く書き込みが少ないアプリケーションのケースに対応しています。

## プライベートメモリ
以下のコマンドを実行し、作成例に示したsessionプライベートメモリの割り当て状況を照会します：
```
show variables where variable_name in ('read_buffer_size','read_rnd_buffer_size','sort_buffer_size','join_buffer_size','binlog_cache_size','tmp_table_size');
```

照会結果は以下のとおりです（以下はテストインスタンスの構成）。
		1.  +----------------------+-----------+
		2.  | Variable_name        | Value     |
		3. +----------------------+-----------+
		4.  | binlog_cache_size    | 32768     |
		5.  | join_buffer_size     | 262144    |
		6.  | read_buffer_size     | 262144    |
		7.  | read_rnd_buffer_size | 524288    |
		8.  | sort_buffer_size     | 524288    |
		9.  | tmp_table_size       | 209715200 |
		10.  +----------------------+-----------+
		11.  6 rows in set (0.00 sec)

**パラメータの説明：**

- **read_buffer_size**
	シーケンシャルスキャンのキャッシュをそれぞれ保存します。threadがデータをシーケンシャルスキャンするとき、まずそのbuffer領域をスキャンして物理的な読み出しが多くなるのを回避します。

- **read_rnd_buffer_size**
	ランダムスキャンへのキャッシュをそれぞれ保存します。threadがデータをランダムスキャンするとき、まずそのbuffer領域をスキャンして物理的な読み出しが多くなるのを回避します。
	
- **sort_buffer_size**
	order byやgroup byのSQLを実行する際にはsort_bufferを割り当て、並べ替えた中間結果の保存に用います。並べ替えの過程で、sort_buffer_sizeよりもストレージ量が大きい場合は、ディスクに一時テーブルを作成し、操作を完了させます。

- **join_buffer_size**
	MySQLはnested loop joinのみサポートしており、ロジック処理は駆動表の1行および非駆動表を結合して照会します。この時に非駆動表をjoin_bufferに組み入れられるので、同時発生保護機能を持つbuffer_poolにアクセスする必要はありません。

- **binlog_cache_size**
	このブロックはそのthreadのbinlogログをキャッシュするのに用い、タスクがまだcommitする前に先にそのログをbinlog_cacheに保存します。タスクがcommitしてから、そのbinlogをディスクに更新して戻したbinlogファイルを長期保存します。

- **tmp_table_size**
	上記各sessionクラスのbufferとは異なり、このパラメータはコンソール上で修正できます。このパラメータはユーザーメモリの一時テーブルの大きさを指し、このtreadが作成した一時テーブルが設定した大きさを超過すると、一時テーブルをディスク上のMyISAM一時テーブルに転換します。
