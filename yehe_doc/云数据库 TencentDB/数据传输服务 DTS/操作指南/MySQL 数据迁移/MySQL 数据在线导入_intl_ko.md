
## 작업 시나리오
데이터 전송 서비스 DTS는 데이터 마이그레이션 기능을 지원하여 자체구축 MySQL 데이터베이스를 TencentDB의 연속 데이터로 복사할 수 있습니다. 사용자는 무정지 상황에서 데이터를 온라인 핫 마이그레이션을 할 수 있습니다. 공용 네트워크를 보유한 IP/Port 혹은 Tencent Cloud DC의 로컬 IDC, Tencent Cloud CVM의 MySQL 데이터베이스에 마이그레이션할 수 있습니다. 현재는 MySQL 5.7 데이터 전송 서비스를 지원하고 있습니다.

## 준비 사항
### 주의사항
- DTS 데이터 마이그레이션 작업은 콜드 스탠바이 데이터 내보내기와 증분 데이터 동기화로 나뉩니다. 그중 콜드 스탠바이 데이터 내보내기와 마이그레이션 후의 데이터 대조 과정은 소스 라이브러리에 부하를 일으켜 영향을 줄 수 있습니다. 따라서 서비스 사용량이 적은 때나 백업 데이터베이스에서 데이터베이스 마이그레이션을 하는 것을 권장합니다.
- 지정 DB 테이블 마이그레이션
 lower_case_table_name이 마이그레이션 인증 작업 중 소스와 타깃의 이 항목 설정이 일치하지 않는 경우에는 lower_case_table_name 으로 인한 재시작 문제를 방지하기 위해 불일치 오류가 발생합니다. 
- 전체 인스턴스 마이그레이션
 -  마이그레이션 설정, 원본 인스턴스에 반드시 재시작해야 하는 매개변수가(예: lower_case_table_name) 객체 인스턴스와 다를 경우에는 재시작이 필요한 객체 인스턴스를 설정합니다. 
 -  모든 백업을 가져온 후에는 객체 인스턴스를 재시작해야 합니다.
- 일부 시나리오는 원본 인스턴스의 super 권한이 필요합니다.

### 원본 인스턴스 super 권한
대부분 시나리오는 원본 인스턴스에 super 권한을 요구하지 않습니다. 다음 시나리오에서는 원본 인스턴스의 super 권한이 필요합니다.
- 사용자는 '데이터 일관성 인증'에서 '모두 인증' 인증 모드를 선택합니다.
- binlog 동기화 과정 중 사용자가 원본 인스턴스에 Event를 생성하고, 해당 Event가 DTS 데이터 마이그레이션에 사용하지 않는 계정을 DEFINER로 지정합니다. 이때 super 권한이 없을 시 오류가 발생합니다.

### 마이그레이션을 지원하는 데이터베이스
- 기본 네트워크, VPC 네트워크의 CVM 자체구축 MySQL 데이터베이스를 TencentDB 인스턴스로 마이그레이션합니다.
- 공용 네트워크 IP/Port를 보유한 MySQL 데이터베이스를 TencentDB 인스턴스로 마이그레이션합니다.
- VPN 액세스, DC Tencent Cloud의 MySQL 데이터베이스를 TencentDB 인스턴스로 마이그레이션합니다.

### 사전 검사 페이지
1. 충돌을 피하기 위해 타깃 TencentDB 인스턴스에 동명의 DB 테이블이 있는지 확인합니다.
2. 데이터베이스 버전을 검사해 MySQL 5.1/5.5/5.6/5.7 버전 클라우드 마이그레이션을 지원합니다. 현재 Tencent Cloud TencentDB는 더 이상 MySQL 5.1 버전을 지원하지 않으니 마이그레이션 완료 전 MySQL 5.1을 MySQL 5.5로 업그레이드한 후에 TencentDB for MySQL 5.5로 마이그레이션하십시오. 물론 DTS 데이터 마이그레이션 툴을 사용해서 로컬에서 MySQL 5.1을 Tencent Cloud TencentDB for MySQL 5.5로 마이그레이션할 수도 있습니다.
3. 타깃 TencentDB의 인스턴스 용량은 반드시 원본 인스턴스보다 커야 합니다.
4. 원본 MySQL 데이터베이스에 새 계정을 생성합니다(데이터 마이그레이션에 사용 가능한 권한이 있는 계정이 있을 경우에는 생성하지 않아도 됨).
```  	
        GRANT ALL PRIVILEGES ON *.* TO "마이그레이션 계정"@"%" IDENTIFIED BY "마이그레이션 비밀번호";
    		FLUSH PRIVILEGES; 	
```
5. 소스 라이브러리 MySQL의 변수 확인
    `SHOW GLOBAL VARIABLES LIKE 'XXX'; `MySQL 전역 변수 조회, 지금 마이그레이션 진행 가능한 상황인지 확인:
```    	
            server_id > 1      
            log_bin = ON;            
            binlog_format = ROW/MIXED           
            binlog_row_image = FULL            
            innodb_stats_on_metadata = 0            
            wait_timeout은 3600초 이상을 권장하며, 7200이하여야 합니다.            
            interactive_timeout과 wait_timeout을 같은 시간으로 설정합니다.            
            원본 인스턴스가 slave 역할일 경우에는 원본 인스턴스에서 다음 매개변수를 확인해야 합니다.           
            log_slave_updates = 1           
```
6. 변수 수정
  a.  자체구축 MySQL 데이터베이스, 소스 라이브러리 MySQL 구성 파일`my.cnf` 수정 시 재시작 필요:
```
  	        log-bin=[사용자 정의 binlog 파일명]
```
  b.  동적 수정 설정:
```
             set global server_id = 99;                
             set global binlog_format=ROW;              
             set global binlog_row_image=FULL;                
             set global innodb_stats_on_metadata = 0;
```


## 작업 순서
### 1. 마이그레이션 작업 생성
[DTS 콘솔](https://console.cloud.tencent.com/dts/migration)에 로그인해 데이터 마이그레이션 페이지로 이동해 [Create Migration Task]을 클릭합니다.

###  2. 소스와 타깃 데이터베이스 설정
작업, 소스 라이브러리와 객체 라이브러리를 설정하고 네트워크 연결성 테스트에 성공한 후 [저장]을 클릭합니다.

#### a. 작업 설정
- 작업 이름: 작업 이름을 지정합니다.
- 예약 실행: 마이그레이션 작업 시작 시간을 지정합니다.
- 태그: 다양한 각도에서 리소스 분류 및 관리에 사용합니다.

#### b. 소스 라이브러리 설정
소스 라이브러리 유형: 공인 IP의 MySQL, CVM의 자체구축 MySQL, DC Tencent Cloud의 MySQL, VPN 액세스 등 MySQL 소스 라이브러리 유형이 있습니다.

| 소스 라이브러리 유형 | 설명 |
|---------|---------|
| 공인 IP가 있는 MySQL | 공인 IP로 액세스할 수 있는 MySQL 데이터베이스. 필요 정보:<li>MySQL 호스트 주소<li>MySQL 포트<li>MySQL 계정<li>MySQL 비밀번호 |
| CVM의 자체구축 MySQL | 기본 네트워크와 사설 네트워크 두 환경에서 CVM을 바탕으로 한 자체구축 MySQL 데이터베이스, 사용 시 지정 CVM의 인스턴스 ID 필요, 필요 정보:<li>소속 리전: CVM 자체구축 MySQL, 모두 Tencent Cloud 내부 네트워크를 통해 TencentDB for MySQL로 마이그레이션 가능<li>CVM 인스턴스 ID<li>MySQL 포트<li> MySQL 계정<li>MySQL 비밀번호			 |
| DC Tencent Cloud의 MySQL | 로컬 IDC 자체구축 MySQL 사용 [DC](https://intl.cloud.tencent.com/product/dc) Tencent Cloud 연결 후 Tencent Cloud로 DTS 데이터 마이그레이션 사용 가능. 필요 정보:<li> 전용 게이트웨이: Tencent Cloud의 데이터베이스 서버 액세스 시 사용하는 전용 게이트웨이, [전용 게이트웨이](https://intl.cloud.tencent.com/document/product/216/19256) 참조<li>사설 네트워크: 전용 게이트웨이 소속의 사설 네트워크<li> MySQL 호스트 주소: IDC 내의 MySQL 호스트 주소, DTS 데이터 마이그레이션은 전용 게이트웨이 IP 매핑 후 액세스<li> MySQL 포트<li>MySQL 계정<li> MySQL 비밀번호 |
| VPN 액세스 MySQL |  로컬 IDC 자체구축 MySQL는 [VPN 연결 서비스](https://intl.cloud.tencent.com/product/vpn) 혹은 CVM의 자체구축 VPN 서버 액세스와 Tencent Cloud 연결 후 DTS로 Tencent Cloud로 데이터 마이그레이션 가능. 필요 정보:<li>소속 리전: 현재는 리전 내의 VPN 서비스만 지원<li>VPN 유형: 클라우드 VPN 서비스 혹은 CVM의 자체구축 VPN <li>VPN 게이트웨이: 클라우드 VPN 서비스에 VPN 게이트웨이정보 보충 필요, [VPN](https://intl.cloud.tencent.com/document/product/1037) 참조<li> 사설 네트워크: VPN 서비스 소속의 사설 네트워크 <li>MySQL CVM 주소: IDC 내의 MySQL CVM 주소, DTS 데이터 마이그레이션이 전용 게이트웨이를 통해 IP 매핑 후 액세스<li>MySQL 포트<li>MySQL 계정<li> MySQL 비밀번호 |

#### c. 객체 라이브러리 설정
타깃 데이터베이스 인스턴스를 선택하고 객체 라이브러리의 계정과 비밀번호를 입력합니다.

### 3. 마이그레이션 옵션 설정 및 마이그레이션 객체 선택
마이그레이션이 필요한 데이터베이스(모두 마이그레이션 샤딩 마이그레이션 선택 가능)를 선택하고 마이그레이션 작업 정보를 생성하고 확인합니다.
>!
>1. 전체 인스턴스 마이그레이션 시 character_set_server, lower_case_table_names를 설정하는 페이지입니다.
>2. 원본 인스턴스에서 마이그레이션 한 DB 테이블 문자 세트 설정과 객체 인스턴스 문자 세트 설정이 일치하지 않을 경우, 마이그레이션 시 원본 인스턴스의 문자 세트 설정이 유지됩니다.

- **마이그레이션 유형**: 아키텍처 마이그레이션, 전량 마이그레이션, 전량 + 증분 마이그레이션을 지원합니다.
- **마이그레이션 객체**: 전체 인스턴스, 지정 객체를 지원합니다.
- **소스 라이브러리 root 계정 덮어쓰기 객체 라이브러리**: root 계정을 데이터베이스 보안 인증에 사용할 경우 소스 라이브러리 root 계정이 존재하지 않으면 향후 TencentDB 사용에 불편을 초래할 수 있습니다. 이 때문에 전체 인스턴스 마이그레이션 시에는 소스 라이브러리 root 계정으로 객체 라이브러리의 root 계정을 덮어쓸지 선택해야 합니다. 소스 라이브러리 root 계정을 사용하거나 객체 라이브러리에 root가 설정되지 않았으면 [예]를, 객체 라이브러리의 root 계정을 유지하려면 [아니오]를 선택합니다.
- **객체 라이브러리 읽기 전용**: 읽기 전용을 선택한 후 데이터 마이그레이션 중 원본 데이터베이스에서 마이그레이션한 데이터는 타깃 데이터베이스에서 읽을 수만 있으며(Read Only), 사용자가 마이그레이션 작업 완료를 클릭할 때까지는 수정할 수 없습니다. 
- **데이터 일관성 점검**: 전량 점검 및 미점검을 지원합니다.


### 4. 마이그레이션 작업 인증
 마이그레이션 생성을 완료한 후에는 마이그레이션 작업 정보를 인증합니다. [다음 단계: 작업 인증]을 클릭해 인증을 진행하여 모든 항목의 인증을 통과해야 마이그레이션 작업을 실행할 수 있습니다. 인증 완료 후 [작업 실행]을 클릭하시면 됩니다.
 작업 인증은 3가지 상태가 있습니다.

 - 통과: 인증 통과를 의미합니다.
 - 경고: 인증 미통과를 의미하며, 마이그레이션 과정 혹은 마이그레이션 후 데이터베이스의 정상적인 실행에 영향을 줄 수 있습니다. 하지만 마이그레이션 작업의 실행에는 영향을 주지 않습니다.
 - 실패: 인증에 통과하지 못해 마이그레이션을 진행할 수 없다고 표시됩니다. 인증 실패 시 오류가 발생한 인증 페이지에 따라 마이그레이션 작업 정보를 확인하고 수정한 후 다시 인증하십시오. 실패 원인은 [상세 보기]를 클릭해 '인증 상세정보'를 볼 수 있습니다.



### 5. 마이그레이션 실행
인증 통과 후 마이그레이션 작업 리스트에서 [즉시 실행]을 클릭해 데이터 마이그레이션을 시작할 수 있습니다. 마이그레이션 작업 시간을 예약한 경우 마이그레이션 작업이 설정된 시간에 정렬되고 시작되니 주의하시기 바랍니다. 작업 시간을 설정하지 않은 경우에는 즉시 마이그레이션 작업이 시작됩니다.
마이그레이션 실행 후에는 마이그레이션 작업에서 해당 작업의 진행 정보를 볼 수 있습니다. 커서를 절차 뒤의 느낌표에 대면 마이그레이션의 필요 과정과 현재 단계가 표시됩니다.

>!시스템 설계의 한계 때문에 1회성 제출 혹은 다수의 마이그레이션 작업을 정렬하는 경우에는 정렬 순서에 따라 순차적으로 실행됩니다.

### 6. 증분 동기화
마이그레이션 작업 생성 시 증분 동기화 옵션은 반드시 선택해야 합니다. 데이터 마이그레이션 완료 후에는 타깃 TencentDB for MySQL 데이터베이스가 원본 데이터베이스의 백업 데이터베이스가 되며, 마스터/슬레이브 동기화로 마이그레이션을 할 경우 소스 라이브러리에 추가된 데이터가 타깃 TencentDB for MySQL 데이터베이스에 동기화됩니다. 이 때 소스 라이브러리의 수정 사항은 모두 타깃 TencentDB for MySQL로 동기화됩니다.

>!동기화를 종료하기 전에는 타깃 데이터베이스의 인스턴스에 데이터를 입력해서는 안 됩니다. 입력할 경우 소스 라이브러리와 객체 라이브러리 데이터 불일치로 인해 데이터 대조에 실패하고, 마이그레이션에 실패할 수 있습니다.


### 7. (선택 가능) 마이그레이션 취소
>!
>1. [취소]를 클릭해도 객체 인스턴스에 동기화된 데이터는 제거되지 않습니다.
>2. 다시 실행 시 인증에 실패하거나 작업에 실패할 수 있습니다. 수동으로 객체 라이브러리 내에서 충돌이 발생할 수 있는 데이터베이스 혹은 리스트를 삭제해야 마이그레이션 작업을 다시 실행할 수 있습니다.
>3. 단독 리스트를 마이그레이션할 경우 반드시 모든 외래 키에 종속된 테이블이 마이그레이션되어야 합니다.

마이그레이션 과정 중 마이그레이션을 취소해야 할 경우에는 [취소]를 클릭할 수 있습니다.


### 8. 마이그레이션 완료
>!현재 마이그레이션이 '미완료' 상태일 경우에는 마이그레이션 작업이 계속 진행되어 데이터가 계속 동기화됩니다.

마이그레이션 진행도가 100%에 도달하고, 타깃과 소스 라이브러리의 데이터 차이가 0MB 및 타깃과 소스 라이브러리의 딜레이가 0초일 경우 데이터가 일치한다고 표시되며, 오른쪽의 [완료]를 클릭해 마이그레이션 작업을 완료할 수 있습니다.
