

SCF allows developers to deploy container images as functions. This document describes the background, working principle, function development, function log printing, cold start optimization, billing instructions and usage limits of deploying the image as the function.

## Background

SCF was designed as a FaaS product based on cloud native architecture. After the deployment of container images as functions is supported in the runtime layer, the overall product form moves towards a containerized ecology. On the one hand, it solves the problem of environment dependence when the function is running, and users can use it more flexibility. On the other hand, it frees users from being trapped by technical thresholds such as Kubernetes cluster management, security maintenance, troubleshooting, etc., and processes the requirements for auto scaling and usability in the computing platform, which further releases the cloud computing capabilities.

## How it Works
Before you develop the function, you need to confirm the function type. SCF supports two function types including event function and Web function.

During the initialization of the function instance, SCF will obtain the temporary user name and password of the image repository as the access credential to pull the image. After the image is pulled successfully, start the HTTP Server you defined according to the specified start command `Command`, the parameter `Args` and the port (fixed to 9000). Finally, HTTP Server will receive all entry requests of SCF, including the event function invocations and Web function invocations.

The following diagram illustrates how it works:
![](https://main.qcloudimg.com/raw/f884ec7454c39392e4b5b19752e8d732.png)





## Function Development Based on Image

### Building the HTTP Server

To deploy a function based on the image, you need to build an HTTP Server. The configuration requirements are as follows:
- Listen on `0.0.0.0:9000` or `*:9000`.
- The HTTP Server should be started within 30 seconds.

If the above configurations are not completed, it may cause the health check to time out, and the following error may occur:
```
The request timed out in 30000ms.Please confirm your http server have enabled listening on port 9000.
```

### Function Input Parameters

- **event**: POST request body (HTTP Body)
The request body contains the event data. For the structure, see [Trigger Event Message Structure Summary](https://intl.cloud.tencent.com/document/product/583/31439).

- **context**: request header (HTTP Header).
	- Common parameter: it is used to identify the user and API signatures, which needs to be carried in each request.
	- Obtain the current request ID through X-Scf-Request-Id.
<dx-alert infotype="explain" title="">
<li>Both event function and Web function contain the Common Headers.</li>
<li>The common request header is generated by SCF, and mainly contains permissions, basic function information, etc.</li>
</dx-alert>
The detailed list is shown in the following table:
<table>
<thead>
<tr>
<th>Header Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>X-Scf-Request-Id</td>
<td>The current request ID</td>
</tr>
<tr>
<td>X-Scf-Memory</td>
<td>The maximum memory that can be used during the runtime of the function instance</td>
</tr>
<tr>
<td>X-Scf-Timeout</td>
<td>The timeout period of function execution</td>
</tr>
<tr>
<td>X-Scf-Version</td>
<td>Function version</td>
</tr>
<tr>
<td>X-Scf-Name</td>
<td>Function name</td>
</tr>
<tr>
<td>X-Scf-Namespace</td>
<td>Function namespace</td>
</tr>
<tr>
<td>X-Scf-Region</td>
<td>Function region</td>
</tr>
<tr>
<td>X-Scf-Appid</td>
<td>The Appid of the function owner</td>
</tr>
<tr>
<td>X-Scf-Uin</td>
<td>The UIN of the function owner</td>
</tr>
<tr>
<td>X-Scf-Session-Token</td>
<td>Temporary SESSION TOKEN</td>
</tr>
<tr>
<td>X-Scf-Secret-Id</td>
<td>Temporary SECRET ID</td>
</tr>
<tr>
<td>X-Scf-Secret-Key</td>
<td>Temporary SECRET KEY</td>
</tr>
<tr>
<td>X-Scf-Trigger-Src</td>
<td>Timer (when the scheduled trigger is used）</td>
</tr>
</tbody></table>




### Built-in environment variables

Compared with the deployment based on code packages, the custom images have changed the environment variables built-in the container, which you can refer to as needed.

| Environment Variable Key | Specific Value or Value Source |
| -------------------------------- |---------------|
| TENCENTCLOUD_RUNENV | SCF |
| USER_CODE_ROOT | /var/user/ |
| USER | qcloud |
| SCF_FUNCTIONNAME | Function name |
| X-Scf-Name | Function name |
| SCF_FUNCTIONVERSION | Function version |
| TENCENTCLOUD_REGION | Region |
| TENCENTCLOUD_APPID | Account APPID |
| TENCENTCLOUD_UIN | Account UIN |

### Function invocation

- For the event function, user needs to listen on the path `/event-invoke` to receive the function invocation request.
- For the Web function, users do not need to listen on the specified path, and the API gateway will pass through the request path in the way of layer-7 reverse proxy.

### Function log printing

The SCF will collect the stdout, stderr and other standard output logs generated in the container in a non-intrusive way and report them to the log module. After invoking the function, you can view the display effect of log aggregation in the console.

## Cold Start Optimization

Since image has added the file layers such as the basic environment and system dependencies, compared to the fully built-in deployment based on code packages, there will be extra time for file download and image decompression. To further reduce the cold start time, the following policies are recommended:
 - Create image repository and function in the same region. When the function triggers the image pull, it can pull image faster and more stable through the VPC.
 - The image is based on the principle of minimization, that is, only the necessary basic environment and running dependencies are contained, and the unnecessary files are removed.
 - The image deployments can be used together with the provisioned concurrency feature to start the function instances in advance to achieve the optimal reduction of cold start time. For more information, see [Provisioned Concurrency](https://intl.cloud.tencent.com/document/product/583/37704).

## Billing Overview

The billing items of deploying functions via image are the same as that of using code packages to deploy. For billing details, see [Billing Mode](https://intl.cloud.tencent.com/document/product/583/12284).


## Limits

#### Image size
Currently, only the images (before decompression) less than 1Gi are supported. We recommend that you choose the appropriate memory for function instance execution based on the image size.

| Image Size (X) | Execution Memory (Y) |
| -------------------------------- |---------------|
| X < 256MB  |  256MB < Y < 512MB  |
| 256MB < X <512MB | 512MB < Y < 1Gi |
| 512MB < X < 1Gi | Y>1Gi |

#### Image repository access
- Only Tencent Cloud TCR Enterprise Edition and Personal Edition are supported. For more information, see [Tencent Container Registry](https://intl.cloud.tencent.com/document/product/1051).
	- For more information about the image repository of TCR Enterprise Edition, see [Basic Image Repository Operations](https://intl.cloud.tencent.com/document/product/1051/35488).
	- For more information about the image repository of TCR Personal Edition, see [Activating Image Registry](https://intl.cloud.tencent.com/document/product/1051/38866).
- Only the image pull of private image repositories in the same region is supported.

#### The read and write permissions of the files in the container
- The `/tmp` can be read and written by default. We recommend you to select `/tmp` when output files. The read and write permissions of other directories are controlled by the image file system.
- Avoid using other users’ files that are restricted from being accessed or executed.
- The storage capacity of the writable layer of files in the container is limited to 512M.

#### Client limits for building the image
Either of the conditions is met:
- Docker image manifest V2, schema 2 (using Docker version 1.10 or later)
- Open Container Initiative (OCI) Specifications (v1.0.0 and later)




