After you create a product, you can configure it on the message queue page and select the device message type for push to the message queue, from which your server can get the device data. The message queue feature provides a reliable async communication mechanism between devices and third-party servers.

The figure below uses CMQ as an example to illustrate the whole process of data forwarding from the rule engine to the message queue:
![image](https://main.qcloudimg.com/raw/404b8179231f565d45afc270a14ca4d8.png)

## Use Cases
A highlight of the message queue feature is that it can work with Tencent Cloud's message queue services to provide a reliable message storage and transfer mechanism. The message queue can even be connected to other Tencent Cloud computing modules to provide seamless computing services. Because of its characteristics, the message queue feature is suitable for the following scenarios where:
 - Fast and stable receipt of device messages is required, especially if the device generates a high number of messages or the message volume fluctuates greatly over time.
 - Real-time processing of device status messages is required to ensure that device status information will not get lost.
 - Connection with other Tencent Cloud computing modules is required to process massive amounts of device information.
 
## Message Type
Currently, the message queue feature can forward the following two types of messages:
- **Device status notification**: this includes the notifications of changes in devices' online and offline status as well as some system notifications generated by IoT Hub.
- **Device-reported message**: this includes all messages published by devices to topics. After the message queue feature is activated for the product and the **Device-reported** option is selected on the parameter configuration page, the IoT Hub backend will forward all messages published by all devices under the product to the topics to the message queue.

## Message Format
The messages reported to the message queue must be in the format of JSON string as shown below:

```
{
    "MsgType":"Publish",
    "Event":"",
    "Topic":"iot-product/iot-device/update",
    "Seq":244,
    "PayloadLen":121,
    "ProductId":"iot-product",
    "DeviceName":"iot-device",
    "Payload":"eyJhY3Rpb24iOiAicmVwb3J0IiwgInRhcmdldERldmljZSI6ICJhYyIsICJkZXZJZCI6MTQ0MTE1MjA1MjU5ODM4NjY0LCAiZGF0YSI6eyJjdXJyZW50IjoyNTExLCAidGVtcCI6MjczMSwgIndhcm5pbmciOjF9fQ=="
}
```
The fields are as described below:

| Field | Description | 
|---------|---------|
| MsgType | Type of the reported message. Valid values: Publish (device-reported message); Status (device status notification) | 
| Event | This field takes effect only when `MsgType` is `Status`, representing the event of the status notification. For example, the value `Online` means that the device is online, while `Offline` offline. | 
| Topic | The topic that publishes the message | 
| Seq | Serial number of the message | 
| PayloadLen | Message payload length | 
| ProductID | Product ID | 
| DeviceName | Device name | 
| Payload | Message content, which is a Base64-encoded string. | 

## Message Configuration
IoT Hub supports two types of message queue: CMQ and CKafka.

1. Log in to the [IoT Hub console](https://console.cloud.tencent.com/iotcloud) and click **Products** on the left sidebar.
2. Go to the product details page and click **Message Queue** to configure the message queue type as needed.
![](https://main.qcloudimg.com/raw/b416715dccd7a4fb140d0ab784861d79.png)





