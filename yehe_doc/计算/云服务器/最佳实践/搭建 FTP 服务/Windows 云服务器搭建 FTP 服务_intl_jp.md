## ユースケース
このドキュメントでは、Windows OSのCloud Virtual Machine（CVM）で IIS を介して FTP サイトをセットアップする方法について説明します。

## サンプルソフトウェアバージョン
本文では、 FTP サービス構成バージョンを次のように設定します。
 - Windows OS、本文では Windows Server 2012 を例として説明します。
 - IIS：Web サーバー、本文では IIS 8.5 を例として説明します。

## 操作手順
### ステップ1：CVMにログインする
[RDP ファイルを利用して Windows インスタンスにログインする（推奨）](https://cloud.tencent.com/document/product/213/5435)。
実際の利用習慣に応じて、[リモートデスクトップを利用して Windows インスタンスにログインする](https://cloud.tencent.com/document/product/213/35703)。

### ステップ2： IIS に FTP サービスをインストールする
1. OSインターフェースで、 <img src="https://main.qcloudimg.com/raw/446c1e8cb7da2ce280d710c6a46b693d.png" style="margin:-3px 0px">をクリックして、サーバーマネージャーを開きます。
2. 「サーバーマネージャー」ウィンドウで、【役割と機能の追加】をクリックします。
3. ポップアップされた「役割と機能の追加ウィザード」ウィンドウで、【次へ】をクリックして、「インストールの種類」インターフェースを表示されます。
4. 「インストールタイプの選択」インターフェースで、【役割ベースまたは機能ベースのインストール】を選択して、【次へ】をクリックします。
5. 「対象サーバーの選択」インターフェースで、デフォルト設定を維持して、【次へ】をクリックします。
6. 「サーバー役割の選択」インターフェースで、【Web サーバー(IIS)】をチェックし、ポップアップされたウィンドウで【機能の追加】をクリックします。
7. 【次へ】を3回連続してクリックして、「役割サービスの選択」インターフェースが表示されます。
8. 「役割サービスの選択」インターフェースで、【FTP サービス】と【FTP 拡張】をチェックし、【次へ】をクリックします。
9. 【インストール】をクリックして、 FTP サービスのインストールを開始します。
10. インストールが完了したら、【閉じる】をクリックします。
<span id="user"></span>
### ステップ3： FTP ユーザー名とパスワードを新規作成する
> FTP ユーザー名とパスワードを設定するには、次の手順に従ってください。匿名ユーザーを使用して FTP サービスにアクセスする必要がある場合は、この手順をスキップできます。
>
1. 「サーバーマネージャー」ウィンドウで、右上のナビゲーションバーの【ツール】>【コンピューターの管理】を選択して、コンピューター管理ウィンドウを開きます。
2. 「コンピューターの管理」インターフェースで、左側ナビゲーションバーの【システムツール】>【ローカルユーザーとグループ】>【ユーザー】を選択します。
3. 【ユーザー】の右側のインターフェースで、空白部分を右クリックして、【新しいユーザー】を選択します。
4. 「新しいユーザー」インターフェースで、以下のメッセージに従ってユーザー名とパスワードを設定し、【作成】をクリックします。
主なパラメータは次の通り：
  - ユーザー名：カスタマイズ、本文では `ftpuser` を例として説明します。
  - パスワードとパスワードの確認：カスタマイズ、パスワードには大文字と小文字、数字を全て含む必要があります。本文では `tf7295TFY` を例として説明します。
  - 【ユーザーは次回ログイン時にパスワードの変更が必要】のチェックを外し、【パスワードを無制限にする】をチェックします。
  実際の需要に応じてチェックしてください、本文ではパスワードは期限切れなしを例として説明します。
5.【閉じる】をクリックし、「新しいユーザー」ウィンドウを閉じた後に、リストでに作成された`ftpuser` ユーザーを確認できます。
	
### ステップ4：共有フォルダーの権限を設定する
> FTP サーバー用の共有フォルダーを設定する必要があります。本文では `C:\test` フォルダーを例として、 `test.txt`ファイルはすでにフォルダーに存在します。
>
1.  OSインターフェースで、<img src="https://main.qcloudimg.com/raw/863967bab67b6cd83ce5f0924e1b19c8.png" style="margin:-3px 0px"> をクリックして、「PC」を開きます。
2. Cドライブの下で、 `test` フォルダーを選択して右クリックし、【プロパティ】を選択します。
3. 「test プロパティ」ウィンドウで、【セキュリティ】タグを選択します。
4.  `Everyone` ユーザーを選択し、【編集】をクリックします。下図に示すように：
「グループまたはユーザー名」に `Everyone`が表示されない場合は、[Everyone User追加](#add) を参考して追加してください。
5. <span id="step5"></span>「テストの権限」インターフェースで、必要に応じて`Everyone` ユーザーの権限を設定し、【OK】をクリックします。下図に示すように：
本文では、 `Everyone` ユーザーの所有権限を例として説明します。
6. 「test プロパティ」ウィンドウで、【OK】をクリックして設定を完了します。


### ステップ5： FTP サイトを追加
1. 「サーバーマネージャー」ウィンドウで、右上のナビゲーションバーの【ツール】>【Internet Information Services (IIS)マネージャー】を選択します。
2. 表示されてる「Internet Information Services (IIS)マネージャー」ウィンドウで、左側ナビゲーションバーのサーバー名を展開し、【ウェブサイト】を右クリックして、【FTP サイト追加】を選択します。
3. 「サイト情報」インターフェースで、以下の情報を参考して設定し、【次へ】をクリックします。
    -  **FTP サイト名**： FTP サイト名を記入し、本文では `ftp` を例として説明します。
    - **物理パス**：権限が設定された共有フォルダーパスを選択し、本文では、`C:\test` を例として説明します。
4. 「バインディングと SSL 設定」インターフェースで、設定するのを以下の情報を参考し、【次へ】をクリックします。
主な設定パラメータ情報は下記の通り：
     - **バインディング**：IP アドレスのデフォルト選択は【すべて未アサイン】で、ポートのデフォルトは21（FTP のデフォルトのポート番号）であり、自分でポートを設定することもできます。
     - **SSL**：必要に応じて選択してください、本文では【SSLなし】を例として説明します。
       -  **SSLなし**：SSL 暗号化は必要ないです。
       - **SSL許可**： FTP サーバーがクライアントとの非 SSL 及び SSL 接続をサポートできるようにします。
      -  **SSLが必要**： FTP サーバーとクライアント間の通信には SSL 暗号化が必要です。
   【 SSLを許可する】あるいは【 SSLを要求する】を選択した場合、「SSL証明書」で既存のSSL証明書を選択します、[サーバー証明書の作成](#ssl) を参考してSSL証明書を作成することもできます。
5. 「身分認証と承認情報」インターフェースで、設定するのを以下の情報を参考し、【次へ】をクリックします。
 - **身分認証**：身分認証方法を選択してください。本文では、【基本】を例として説明します。
    - **匿名**：すべてのユーザーに匿名または FTP ユーザー名のみを提供するコンテンツへのアクセスを許可します。
	 - **基本**：ユーザーに有効なユーザー名とパスワードを入力することでコンテンツにアクセスすることができるようになります。基本認証は暗号化されていないパスワードをネットワーク経由で送信するため、クライアントと FTP サーバー間の接続が安全であることが分っている場合（たとえば、Secure Sockets Layer SSLを使用する場合）にのみ、この認証方法を使用します。
 - **認可する**：アクセスを許可ドロップダウンリストから一つの方式を選択し、本文では指定されたユーザー`ftpuser` を例として説明します。
	    - **すべてのユーザー**： すべてのユーザーは、匿名であれ特定されているであれ、コンテンツにアクセスできます。
	    - **匿名ユーザー**：匿名ユーザーはコンテンツにアクセスできます。
	    - **指定されたロール或はユーザグループ**：特定されたロール或はユーザグループのメンバーのみがコンテンツにアクセスできます。これを選択するには、ロール或はユーザグループを指定する必要があります。
	    - **指定されたユーザー**：指定されたユーザーのみコンテンツにアクセスできます。これを選択するには、ユーザー名を指定する必要があります。
 - **権限**：必要に応じて権限を設定してください、本文では【読み取り】と【書き込み】権限の設定を例として説明します。
    - **読み取り**：許可されたユーザーがディレクトリからコンテンツを読み取ることができます。
    - **書き込み**：許可されたユーザーがディレクトリに書き込むことができます。
7. 【完了】をクリックして、 FTP サイトを正常に作成することができます。

### ステップ6：セキュリティグループとファイアウォールを設定する
1.  FTP サイトをセットアップした後、 FTP サイトを追加するときにバインディングされるポートのインバウンド ルールをインターネットにオープンします。例えばポート21のインバウンド ルール。
 FTP サイトを追加する時に別のポートを選択した場合、このポートを開放するインバウンド ルールをファイアウォールに追加する必要があります。
2. （オプション）[Microsoft公式ドキュメント](https://docs.microsoft.com/en-us/previous-versions/orphan-topics/ws.11/hh831655(v=ws.11))を参考して FTP サイトのファイアウォールサポートを設定することにより、 FTP サーバーはファイアウォールからのパッシブ接続を受け入れることができます。

### ステップ7： FTP サイトをテストする
 FTP クライアントソフトウェア、ブラウザー或はファイルエクスプローラーなどのツールを利用して FTP サービスを確認できます。本文ではクライアントのファイルエクスプローラーを例として説明します。
1. 実際の使用状況に応じて、 IE ブラウザを設定してください：
 -  FTP サイトファイアウォールが設定済み：クライアントの IE ブラウザーを開き、【ツール】>【インターネットオプション】>【詳細設定】を選択し、【パッシブＦＴＰ（ファイアーウオールおよびＤＳＬモデム互換用）を使用する】のチェックを外し【OK】をクリックします。
 -  FTP サイトファイアウォールが設定されていません：
    1.  **FTP サーバー**の IE ブラウザを開き、【ツール】> 【インターネットオプション】>【詳細設定】を選択し、【パッシブＦＴＰ（ファイアーウオールおよびＤＳＬモデム互換用）を使用する】のチェックを外し【OK】をクリックします。
    2.  **クライアント**の IE ブラウザを開き、【ツール】>【インターネットオプション】>【詳細設定】を選択し、【パッシブＦＴＰ（ファイアーウオールおよびＤＳＬモデム互換用）を使用する】をチェックし【OK】をクリックします。
2. クライアントのコンピューターを起動して、パスバーで以下のアドレスをアクセスします。
```
ftp://CVMパブリックIP:21
```
3. ポップアップされた「ログイン身分」ウィンドウで、[ FTP ユーザー名とパスワードの作成](#user)で設定されたユーザー名とパスワードを入力します。
本文で使用されるユーザー名は `ftpuser` で、パスワードは `tf7295TFY`です。
4. ログインに成功した後、ファイルをアップロード及びダウンロードできます。

## 付録
<span id="add"></span>
###  Everyone ユーザーを追加
1. 「test プロパティ」ウィンドウで、【セキュリティ】タグを選択し、【編集】をクリックします。
2. 「test の権限」インターフェースで、【追加】をクリックします。
3. 「ユーザーまたはグループの選択」インターフェースで、【詳細設定】をクリックします。
4. ポップアップされた「ユーザーまたはグループの選択」インターフェースで、【今すぐ検索】をクリックします。
5. 検索結果に `Everyone` を選択し、【OK】をクリックします。
6. 「ユーザーまたはグループの選択」インターフェースで、【OK】をクリックして追加できます。
[ステップ5](#step5) に進み `Everyone` ユーザーの権限を設定します。
<span id="ssl"></span>
### サーバー証明書の作成
1. 「サーバーマネージャー」ウィンドウで、右上のナビゲーションバーの【ツール】>【Internet Information Services (IIS)マネージャー】を選択します。
2. ポップアップされた「Internet Information Services (IIS)マネージャー」ウィンドウで、左側のナビゲーションバーでサーバーを選択し、右側のインターフェースで【サーバー証明書】をダブルクリックします。
3. 右側のツールバーで【自己署名証明書の作成】を選択します。
4. ポップアップされた「自己署名証明書の作成」ウィンドウで、証明書名とストレージ種類を設定します。
本文では個人用ストレージ種類のSSL証明書の作成を例として説明します。
5. 【OK】をクリックして、正常に作成できます。
