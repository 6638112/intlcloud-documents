## 버츄얼 클라이언트 종료 프로세스 분석

### 종료 프로세스
Tencent Cloud Windows 인스턴스의 종료 프로세스는 다음과 같습니다.
1. qmp 프로토콜을 통해 마스터 머신의 libvirt가 shutdown 명령어를 qemu 컴포넌트로 전달합니다.
2. qumu 컴포넌트가 acpi 인터럽트 모드 유입을 통해 shutdown 명령어를 CVM으로 전달합니다(상세 내용은 vmcs 관련 기술 문서를 참조 바랍니다).
3. Windows에서 종료 신호를 받으면 애플리케이션과 서비스 프로세스가 종료됨을 알립니다.
4. 핵심 서비스 프로세스를 종료합니다.
5. 전원을 종료합니다.
>**참고: **
>시스템 설정에 따라 3~4의 과정이 다를 수 있으며, 개별 애플리케이션과 서비스의 종료 순서가 다를 수 있습니다.

Windows는 하나의 클로즈드 소스 시스템으로, 커널 모드와 사용자 모드의 프로세스로 하여금 종료 과정에 관여하도록 하는 API를 제공합니다. 한편, Windows 자체의 일부 서비스가 실행 과정 중에 종료 프로세스에 영향을 주어 컴퓨터가 종료되지 않을 수 있습니다. 따라서, 상황에 따라 Windows의 종료 시간이 오래 걸릴 수 있습니다.

### 하드 셧다운
가상화 시나리오에서는 메시지로 Windows 자체의 종료를 알리는 방식 외에, 가상 컴퓨터를 중지시키는 다른 방식도 제공합니다. 이는 물리적 기기에서 전원을 종료하는 것과 유사한 방식으로, **하드 셧다운**이라고 부릅니다. 또한, 시스템 신호에 의해 진행되는 종료 작업을 상대적 의미로 **소프트 셧다운**이라고 합니다.
하드 셧다운은 Windows 자체와 사용자 체험 모두에 영향을 미치며, 그 영향은 주로 다음 두 가지 방면에서 나타납니다.
1. 하드 셧다운은 일부 서비스와 애플리케이션을 중단시킴으로써 저장되지 않은 문서, 완료되지 않은 Windows Update 프로세스 등의 프로그램 작동을 비정상으로 만들 수 있습니다.
2. Windows NTFS 시스템(또는 초기 FAT32 등의 시스템)은 종료 과정에 일부 중요 데이터를 기록합니다. 하드 셧다운을 하면 이러한 중요 데이터가 디스크에 입력되지 않을 수 있어 Windows에서 NTFS 파일 시스템이 손상되었다고 판단하게 됩니다.

위와 같은 원인으로 Tencent Cloud 사용자는 **소프트 셧다운 방식을 우선으로 사용해** Windows를 종료할 것을 권장합니다.

## 종료 실패 관련 시나리오
Windows 시스템에 일부 문제가 존재해 종료 프로세스에 영향을 주어 종료에 실패할 수 있습니다. 종료 실패에는 다음 몇 가지를 비롯한 시나리오가 포함됩니다.
1. Windows Update 프로세스로 인해 종료 시간이 길어질 수 있습니다. Windows 패치 과정에서 시스템을 종료할 때 일부 프로세스를 진행할 수 있습니다. 이때 스크린에는 일반적으로 "컴퓨터 전원을 종료하거나 전원 코드를 뽑지 마십시오."라는 메시지가 표시됩니다.
2. Windows 시스템에 "종료 이벤트 추적" 메커니즘을 연 상태에서 시스템의 서비스 및 드라이버 오류가 발생할 경우, 시스템이 설정에 따라 사용자에게 알림 창을 보여주거나 오류 내용을 입력하라는 메시지가 뜨고, 사용자가 이러한 작업을 완료할 때까지 대기한 후 전원을 종료합니다. 사용자가 지정된 작업을 완료하기 전까지는 Windows가 전원을 종료하지 않습니다.
3. Windows에서는 사용자가 시스템에 로그인하지 않았을 때 종료를 허용하지 않도록 설정할 수 있습니다. 이러한 경우 가상화 호스트에서 전송한 소프트 셧다운 명령어는 Windows에 의해 삭제되므로 종료되지 않습니다.
4. Windows는 종료할 때 모든 서비스 및 애플리케이션에 메시지를 전송합니다. 이러한 애플리케이션이 해당 메시지를 받은 후 종료 가능 응답을 리턴하지 않으면 종료 프로세스는 진행되지 않습니다. 이러한 시나리오에서 Windows는 일부 설정을 통해 이 프로세스를 무시할 수 있습니다.
5. Windows에서 전원 관련 설정에서 [전원을 누를 때 Windows의 처리 방식] 항목을 무시하거나 작업하지 않도록 설정해 놓으면, Windows가 가상화 마스터 머신의 종료 이벤트를 무시합니다.
6. 전원 관리 설정으로 인해 Windows가 절전 상태에 진입할 경우, 종료 이벤트를 처리하지 않습니다.
7. Windows 최초 구입 시 시스템에서는 sysprep 방식을 사용해 미러 이미지를 배포하기 때문에 초기화 과정이 다소 오래 걸릴 수 있습니다. 초기화 완료 전에 Windows에서는 종료 이벤트를 무시합니다.
8. Windows 시스템에 악성 프로그램을 설치했거나 트로이 목마 혹은 이와 같은 바이러스 등에 감염되어 Windows 시스템 환경 자체가 손상되었을 경우 Windows 종료가 차단될 수 있습니다.

Tencent Cloud는 Windows 공용 이미지를 배포할 때 소프트 셧다운의 원활한 진행을 위해 상기의 몇 가지 시나리오를 최적화했습니다. 그러나, 이러한 최적화 조치로는 Windows의 트로이 목마를 비롯한 바이러스 감염, 그리고 시스템 손상 등의 시나리오를 해결할 수 없습니다. 이밖에 사용자의 Windows 인스턴스에서 이와 관련된 설정이 변경되었을 경우에도 소프트 셧다운이 원활하게 진행되지 않을 수 있습니다.
**하드 셧다운은 리스크가 있기 때문에 반드시 필요한 경우에만 하드 셧다운 방식을 사용 바랍니다.**