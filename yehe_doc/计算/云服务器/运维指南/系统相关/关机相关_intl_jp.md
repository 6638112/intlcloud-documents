## 仮想クライアントPCのシャットダウンプロセスの分析

### シャットダウンプロセス
以下は、Tencent CloudのWindows インスタンスのシャットダウンプロセスです。
1. ホスト PCのlibvirt は shutdown コマンドを qmp プロトコルを通して qemu コンポーネントに転送します。
2. qemu コンポーネントはacpi中断をインジェクションすることでshutdownコマンドをCVMに転送します（詳細については、 vmcs に関する技術ドキュメントをご覧ください）。
3. Windowsはシャットダウンシグナルを受信した後、アプリケーションとサービスプロセスに終了するように通知します。
4. コアサービスプロセスを終了します。
5. 電源を切ります。
>**注意事項：**
>その中、ステップ 3~4 は、システム設定によって、各アプリケーションとサービスの終了順番が異なる可能性があります。

Windows はクローズドソースシステムであり、いくつの API を提供することによってカーネルモードおよびユーザーモードのプログラムがシャットダウンプロセスに関与できるようにします。同時に Windows自体の一部実行中のサービスがシャットダウンプロセスに影響するため、コンピューターがシャットダウンできなくなります。そのため、Windowsのシャットダウンプロセスは時間がかかる場合があります。

### ハードシャットダウン
仮想化のユースケースで、他の仮想マシンを停止する方法も提供します。物理マシンの電源を切るの方法と類似であり、このシャットダウン方法を**ハードシャットダウン**と呼ばれます。システムシグナルによる開始されるシャットダウン操作は、**ソフトシャットダウン**と呼ばれます。
ハードシャットダウンは、主に次の2つの側面で、Windows自体とユーザーエクスペリエンスに影響を与えます。
1. ハードシャットダウンは一部のサービスとアプリケーションを中断するため、これらのプログラムが正常に動作できない可能性があります。例えば、保存されていないドキュメントや未完了WindowsUpdateプロセスなど。
2. WindowsのNTFSシステム（または以前のFAT32などのシステム）はシャットダウンプロセス中にいくつかの重要なデータを書き込むため、ハードシャットダウンによってこれらの重要なデータをディスクに書き込むことができなくなり、WindowsがNTFSファイルシステムが破損していると判断する可能性があります。

上記の理由に基づき、Tencent Cloudのユーザーに**ソフトシャットダウンを優先利用**してWindows をシャットダウンすることを推薦します。

## シャットダウン失敗のシナリオ
上記の通り、Windows システムにいくつかの問題があるため、シャットダウンプロセスを妨害し、シャットダウンできない場合があります。シャットダウン失敗のシナリオには以下が含まれますが、これらに限定されません。
1. WindowsUpdateプロセスにより、シャットダウン時間が延長される場合があります。Windowsが特定のパッチ操作を実行する場合、Windowsシステムがシャットダウンプロセス中いくつかの処理を行います。この時、「コンピューターの電源を切ったり、電源プラグを抜いたりしないでください」などのプロンプト情報が画面に表示されます。
2. Windowsシステムが「シャットダウンイベントトラッカー」メカニズムが有効になっている場合、システムのサービスとドライバープログラムがエラー発生する時にシャットダウンする場合は、システムの設定により、ユーザーにプロンプ​​トボックスを表示するか、エラーの説明を記入させ、ユーザーがこれらの操作を完了するのを待ちます。ユーザーが指定された操作を完了するまでに、Windowsは電源をオフにはしません。
3. Windowsはユーザーがシステムにログインしていない場合、シャットダウンを許可しないように設定します。この場合、仮想ホストから送信されたソフトシャットダウンコマンドがWindowsに廃棄されるため、シャットダウンすることができません。
4. Windowsはシャットダウンする時、すべてのサービスとアプリケーションにメッセージをブロードキャストします。これらのプログラムがこのメッセージを受信した後、シャットダウンを許可する応答を送信しない場合、シャットダウン処理は実行されません。この場合、このプロセスを無視するようにWindowsでいくつかの設定を行うことができます。
5. Windows の電源管理の設定に関する操作で、【電源が落ちるときのWindowsの対処法】を無視するかまたは操作しないように設定する場合、Windows は仮想ホストのシャットダウンイベントを無視します。
6. Windowsは電源管理の設定によってスリープ状態になる時、シャットダウンイベントを処理しません。
7. 初めてWindowsを購入した場合、システムは sysprep 方式を利用してイメージを配布するため、初期化プロセスは少し長くなります。indowsは、初期化が完了するまでシャットダウンイベントを無視します。
8. Windowsシステムに悪意のあるソフトウェアをインストールした場合、又はトロイの木馬、ウイルスなどを感染した場合、Windowsシステム自体が損傷したため、Windowsのシャットダウンがブロックされる可能性があります。

Tencent CloudはWindowsパブリックイメージをリリースしたとき、上記のほとんどのシナリオを最適化し、ソフト シャットダウンを正常に完了できるようになりました。ただし、これらの最適化対策では、Windowsがウイルス又はトロイの木馬を感染した場合やOSが破壊された場合などのシナリオを解決できません。また、ユーザーのWindowsインスタンスの関連設定を再度調整しても、ソフトシャットダウンがスムーズに実行することを保証できません。
**強制的にシャットダウンはリスクがあるため、どうしても必要な場合のみハードシャットダウンを実行することを推薦します。**