CLBはヘルスチェックによってバックエンドサービスの可用性を判断し、バックエンドサービスの異常によるフロントエンドへの影響を回避することで、業務全体の可用性を向上させます。
- ヘルスチェックを有効化すると、バックエンドCVMの重みの高低にかかわらず（重みが0の場合も含めて）、CLBインスタンスは常にヘルスチェックを実行します。ヘルスチェックのステータスはインスタンスリストページの「ヘルスチェック」列か、もしくはリスナーにバインドしたバックエンドサービスの詳細ページで確認することができます。
    - バックエンドCVMインスタンスが異常と判定された場合、CLBインスタンスは新しいリクエストを異常なCVMには転送せず、他の正常なCVMに自動的に転送します。
    - 異常なインスタンスが正常に復旧すると、CLBはそのインスタンスをCLBサービスに復帰させ、リクエストの転送を再開します。
    - ヘルスチェックの結果、バックエンドサービスのすべてに異常が検出された場合、リクエストはすべてのバックエンドCVMに転送されます。
- ヘルスチェックを無効化すると、CLBはすべてのバックエンドサーバー（異常なバックエンドサーバーも含めて）にトラフィックを転送します。このため、ヘルスチェックを有効化し、CLBが異常なバックエンドサーバーを自動的にチェックして削除できるようにしておくことを強く推奨します。

## ヘルスチェックステータス
ヘルスチェックでの検出状況に基づく、バックエンドCVMのヘルスチェックステータスは次のとおりです。

|ステータス|説明|トラフィックを転送するかどうか|
| ------- | ----------- | ---------------- |
| チェック中 | 新たにバインドしたバックエンドCVMの、チェック間隔×正常閾値の時間内におけるステータスです。例えば、チェック間隔が2秒、正常閾値が3回の場合は、6秒間のステータスを表します。 | CLBは「チェック中」のバックエンドサービスへのトラフィック転送を行いません。|
| 正常| バックエンドサービスは正常です。 |  CLBは「正常」なバックエンドサービスにトラフィックを転送します。|
| 異常| バックエンドサービスは異常です。 |  <li>CLBは「異常」なバックエンドサービスにトラフィックを転送しません。</li><li>レイヤー4リスナーまたはレイヤー7URLルールの下では、CLBがバックエンドサービスのすべてに異常を検出した場合、all-dead-all-aliveロジックがアクティブ化され、リクエストがすべてのバックエンドサービスに転送されます。</li>|
| 無効| ヘルスチェックは無効化されています。 | CLBはバックエンドサービスにトラフィックを転送します。|

## TCPヘルスチェック
レイヤー4 TCPリスナーについては、TCPヘルスチェックを設定できます。TCPヘルスチェックではSYNパケット、すなわちTCPの3ウェイハンドシェイクの開始によって、バックエンドCVMのステータス情報を取得します。もしくは、カスタムプロトコルのリクエスト内容および返される結果によってバックエンドCVMのステータス情報を取得することもできます。
![](https://main.qcloudimg.com/raw/5f30ebbb5e061affeff6eb031facaf28.png)
TCPヘルスチェックのメカニズムは次のとおりです。
1. CLBがバックエンドCVM（プライベートIPアドレス+ヘルスチェックポート）にSYN接続リクエストメッセージを送信します。
2. バックエンドCVMはSYNリクエストメッセージを受信後、対応するポートが正常なリスニング状態にある場合は、SYN+ACK応答メッセージを返します。
3. 応答タイムアウト時間内にCLBがバックエンドCVMから返されたSYN+ACK応答メッセージを受信した場合、サービスは正常に実行されていることを表し、ヘルスチェックは成功と判定されます。CLBはバックエンドCVMにRSTリセットメッセージを送信し、TCP接続を中断します。
4. 応答タイムアウト時間内にCLBがバックエンドCVMから返されたSYN+ACK応答メッセージを受信しなかった場合、それはサービスの実行に異常があることを表し、ヘルスチェックは失敗と判定されます。CLBはバックエンドCVMにRSTリセットメッセージを送信し、TCP接続を中断します。

## UDPヘルスチェック
レイヤー4 UDPリスナーについては、UDPヘルスチェックを設定できます。UDPヘルスチェックでは、`Ping`コマンドおよびヘルスチェックポートへのUDPチェックメッセージの送信によってヘルスステータスを取得します。もしくは、カスタムプロトコルのリクエスト内容および返される結果によってバックエンドCVMのステータス情報を取得することもできます。
![](https://main.qcloudimg.com/raw/97127e438782907e02e183e9258e652c.png)
UDPヘルスチェックのメカニズムは次のとおりです。

1. CLBがバックエンドCVMのプライベートIPアドレスに対し、`Ping`コマンドを送信します。
2. CLBがバックエンドCVM（プライベートIPアドレス+ヘルスチェックポート）にUDPチェックメッセージを送信します。
3. `Ping`に成功し、なおかつ応答タイムアウト時間内に、バックエンドCVMからエラーメッセージ`port XX unreachable`が返されなかった場合、サービスは正常であることを表し、ヘルスチェックは成功と判定されます。
4. `Ping`に失敗するか、または応答タイムアウト時間内に、システムがバックエンドCVMから返されたエラーメッセージ`port XX unreachable`を受信した場合、サービスに異常があることを表し、ヘルスチェックは失敗と判定されます。

>!
>1. UDPヘルスチェックはICMPプロトコルに依存しているため、バックエンドCVMはICMPパケット（`Ping`をサポート）、ICMPポート到達不能パケット（ポートチェックをサポート）を返せるよう許可する必要があります。
>2. バックエンドCVMがLinuxサーバーの場合、多数同時実行のシーンにおいて、LinuxはICMP攻撃からの保護メカニズムを備えるため、サーバーからのICMPパケット送信の速度を制限します。この場合、バックエンドサービスに異常が生じていても、CLBに`port XX unreachable`を返すことができないため、CLBはICMP応答を受信していないことからヘルスチェックを成功と判定し、最終的にバックエンドサービスの真のステータスがヘルスチェックと一致しなくなります。
対処方法：UDPヘルスチェックの設定の際に、バックエンドサーバーに指定の文字列を送信するよう入力および出力をカスタム設定し、CLBが指定の応答を受信した場合のみヘルスチェック成功と判断するようにします。この方法はバックエンドサーバーに依存しますので、バックエンドサーバーはヘルスチェックの入力を処理し、指定の出力を返す必要があります。
>

## <span id="http"></span>HTTPヘルスチェック
レイヤー4 TCPリスナーおよびレイヤー7 HTTP/HTTPSリスナーについては、HTTPヘルスチェックを設定できます。HTTPヘルスチェックでは、HTTPリクエストの送信によって、バックエンドCVMのステータス情報を取得します。
![](https://main.qcloudimg.com/raw/94d491d305eca2c6b891912fc1a62ffe.png)
HTTPヘルスチェックのメカニズムは次のとおりです。

1. CLBがヘルスチェック設定に基づいて、バックエンドCVM（プライベートIPアドレス+ヘルスチェックポート+チェックパス）にHTTPリクエストを送信します（チェックドメイン名を選択して設定できます）。
2. バックエンドCVMはリクエストを受信後、該当するHTTPステータスコードを返します。
3. 応答タイムアウト時間内にCLBがバックエンドCVMから返されたHTTPステータスコードを受信し、それが設定したHTTPステータスコードと一致した場合、ヘルスチェックは成功と判定され、そうでない場合は失敗と判定されます。
4. 応答タイムアウト時間内にCLBがバックエンドCVMから返されたHTTPステータスコードを受信しなかった場合、ヘルスチェックは失敗と判定されます。

>? レイヤー7 HTTPSリスナーについては、HTTPSリスナーの転送ルールのバックエンドプロトコルにHTTPを選択した場合、ヘルスチェックにはHTTPヘルスチェックを使用します。HTTPSを選択した場合、ヘルスチェックにはHTTPSヘルスチェックを使用します。
HTTPSヘルスチェックと<a href="#http">HTTPヘルスチェック</a>は基本的に類似していますが、HTTPSヘルスチェックはHTTPSリクエストを送信し、返されたHTTPSステータスコードによってバックエンドCVMのステータス情報を判断する点が異なります。
>
## ヘルスチェックの時間範囲
CLBのヘルスチェックメカニズムは業務の可用性を効果的に向上させます。ヘルスチェックの頻繁な失敗に伴う切り替えがシステムの可用性に影響を与えることを防ぐため、ヘルスチェックはヘルスチェックの時間範囲内で複数回連続して成功または失敗した場合のみ、正常と異常のステータスを切り替えます。ヘルスチェックの時間範囲は次の要因によって決定されます。
<table>
<tr>
<th>ヘルスチェックの設定</th>
<th>説明</th>
<th>デフォルト値</th>
</tr>
<tr>
<td>応答タイムアウト</td>
<td><ul><li>ヘルスチェック応答の最大タイムアウト時間です。</li><li>バックエンドCVMからタイムアウト時間内に正確なレスポンスがない場合は、ヘルスチェックに異常があると判断されます。</li><li>設定可能範囲は2～60秒です。</li></ul></td>
<td>2～60秒</td>
</tr>
<tr>
<td>チェック間隔</td>
<td><ul><li>CLBがヘルスチェックを行う時間間隔です。</li><li>設定可能範囲は5～300秒です。</li></ul></td>
<td>5秒</td>
</tr>
<tr>
<td>異常閾値</td>
<td><ul><li>n回（nには数値を入力）連続してヘルスチェック失敗の結果を受信した場合に、異常であると認識し、コンソールで<b>異常</b>と表示します。</li><li>設定可能範囲は2～10回です。</li></ul></td>
<td>3回</td>
</tr>
<tr>
<td>正常閾値</td>
<td><ul><li>n回（nには数値を入力）連続してヘルスチェック成功の結果を受信した場合に、正常であると認識し、コンソールで<b>正常</b>と表示します。</li><li>設定可能範囲は2～10回です。</li></ul></td>
<td>3回</td>
</tr>
</table>

**レイヤー4ヘルスチェック時間範囲**の計算方法は次のとおりです。
>?レイヤー4ヘルスチェック、すなわちTCPヘルスチェックまたはUDPヘルスチェックでは、チェックに成功したか、または応答タイムアウトかにかかわらず、前後2回の間の送信パケットのチェック間隔はすべて設定済みのチェック間隔となります。
>
- ヘルスチェック失敗時間範囲 = チェック間隔 ×（異常閾値 - 1）
下の図はヘルスチェックの応答タイムアウト時間が2秒、チェック間隔が5秒、異常閾値が3回の場合の例です。ヘルスチェック失敗時間範囲 = 5 x（3-1）= 10秒となります。
![](https://main.qcloudimg.com/raw/63ee9657f3bb44c31c8e271484a67729.png)
- ヘルスチェック成功時間範囲 = チェック間隔 ×（正常閾値 - 1）
下の図はヘルスチェック成功応答時間が1秒、チェック間隔が5秒、正常閾値が3回の場合の例です。ヘルスチェック成功時間範囲 = 5 x（3-1）= 10秒となります。
![](https://main.qcloudimg.com/raw/9f147597b7eb8879c4460ec6eadea3cb.png)

**レイヤー7ヘルスチェック時間範囲**の計算方法は次のとおりです。
- ヘルスチェック失敗時間範囲 = 応答タイムアウト時間 × 異常閾値 + チェック間隔 ×（異常閾値 - 1）
下の図はヘルスチェックの応答タイムアウト時間が2秒、チェック間隔が5秒、異常閾値が3回の場合の例です。ヘルスチェック失敗時間範囲 = 2 x 3 + 5 x（3-1）= 16秒となります。
![](https://main.qcloudimg.com/raw/8ddafd2348fd071942752dc24f5c5c2c.png)
- ヘルスチェック成功時間範囲 = ヘルスチェック成功応答時間 × 正常閾値 + チェック間隔 ×（正常閾値 - 1）
下の図はヘルスチェック成功応答時間が1秒、チェック間隔が5秒、正常閾値が3回の場合の例です。ヘルスチェック成功時間範囲 = 1 x 3 + 5 x（3-1）= 13秒となります。
![](https://main.qcloudimg.com/raw/a6afea17bf2767081c2fcd66913233d0.png)


## ヘルスチェック検出識別子
CLBでヘルスチェックを有効化すると、バックエンドサーバーは正常な業務リクエストに加えて、ヘルスチェックリクエストも受信することになります。ヘルスチェックリクエストは次の識別子を有します。
- ヘルスチェックリクエストのソースIPはCLBのVIPまたは100.64ネットワークセグメントです。
- レイヤー4（TCP、UDP、TCP SSL）リスナーのヘルスチェックリクエストには「HEALTH CHECK」の識別子が含まれます。
- レイヤー7（HTTP、HTTPS）リスナーのヘルスチェックリクエストHeaderのuser-agentは「clb-healthcheck」です。


## 関連ドキュメント
- [ヘルスチェックの設定](https://intl.cloud.tencent.com/document/product/214/39251)
- [アラートポリシーの設定](https://intl.cloud.tencent.com/document/product/214/8886)
