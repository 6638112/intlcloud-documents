CLBインスタンスにHTTPSリスナーを追加し、クライアントからのHTTPSプロトコルリクエストを転送することができます。HTTPSプロトコルは暗号化伝送を必要とするHTTPアプリケーションに適しています。

## 前提条件
[CLBインスタンスの作成](https://intl.cloud.tencent.com/document/product/214/6149)が必要です。

## 操作手順

### ステップ1：リスナーの設定
1. [CLBコンソール](https://console.cloud.tencent.com/clb)にログインし、左側のナビゲーションバーで**インスタンス管理**をクリックします。
2. CLBインスタンスリストページの左上隅でリージョンを選択し、インスタンスリスト右側の操作列で**リスナーの設定**をクリックします。
![]()
3. HTTP/HTTPSリスナーで**新規作成**をクリックし、ポップアップした「リスナーの作成」ダイアログボックスでHTTPSリスナーの設定を行います。
**a. リスナーの作成**
<table>
<thead>
<tr>
<th width="15%">リスナーの基本設定</th>
<th width="70%">説明</th>
<th width="15%">事例</th>
</tr>
</thead>
<tbody><tr>
<td>名称</td>
<td>リスナーの名称です。</td>
<td><span>test-https-443</span></td>
</tr>
<tr>
<td>リスニングプロトコルポート</td>
<td>
<ul><li>リスニングプロトコル：この例ではHTTPSを選択します。</li><li>リスニングポート：リクエストを受信してバックエンドサーバーにリクエストを転送するために用いるポートです。ポートの範囲は1～65535です。このうち、843、1020、1433、1434、3306、3389、6006、20000、36000、42222、48369、56000、65010はシステムによって予約されているポートであり、現時点では外部に開放されていません。</li><li>同一のCLBインスタンス内では、リスニングポートは重複してはなりません。</li></ul></td>
<td>HTTPS:443</td>
</tr>
<tr>
<td>長時間接続の有効化</td>
<td>有効化すると、CLBとバックエンドサービス間で長時間接続を使用し、CLBはソースIPをパススルーしなくなりますので、XFFからソースIPを取得してください。正常な転送を保証するため、CLB上でセキュリティグループを有効化してデフォルトで開放するか、またはCVMのセキュリティグループで`100.127.0.0/16`を開放してください。</td>
<td><span>既存の証明書の選択</span></td>
</tr>
<tr>
<td>SNIの有効化</td>
<td>SNIの有効化は、1つのリスナーの下でドメイン名ごとに異なる証明書を設定できることを意味します。 SNIを有効化しないことは、このリスナーでは複数のドメイン名に同一の証明書を使用することを意味します。</td>
<td><span>有効化しない</span></td>
</tr>
<tr>
<td>SSL解析方式</td>
<td>単方向認証および双方向認証をサポートしています。CLBがSSLの暗号化と復号のオーバーヘッドを代行し、アクセスの安全性を保証します。</td>
<td><span>単方向認証</span></td>
</tr>
<tr>
<td>サーバー証明書</td>
<td><a href="https://console.cloud.tencent.com/ssl">SSL証明書プラットフォーム</a>にすでにある証明書を選択するか、または証明書をアップロードできます。</td>
<td><span>単方向認証</span></td>
</tr>
</tbody>
</table>
 <b>b. 転送ルールの作成</b>
 <table>
<tr>
<th>転送ルールの基本設定</th>
<th>説明</th>
<th>事例</th>
</tr>
<tr>
<td>ドメイン名</td>
<td>転送ドメイン名：<ul style="margin-bottom:0px;"><li>長さ制限：1～80文字。</li><li>`_`で開始することはできません。</li><li>完全一致ドメイン名およびワイルドカードドメイン名をサポートしています。</li><li>正規表現をサポートしています。</li><li>具体的な設定ルールについては、 <a href="https://intl.cloud.tencent.com/document/product/214/9032">転送ドメイン名の設定ルール</a>をご参照ください。</li></ul></td>
<td>www.example.com</td>
</tr>
<tr>
<td>デフォルトドメイン名</td>
<td><li>リスナーのすべてのドメイン名がマッチングに成功しなかった場合、システムはリクエストにデフォルトのアクセスドメイン名を指定し、デフォルトアクセスを制御可能にします。</li><li>1つのリスナーに設定できるデフォルトドメイン名は1つのみです。</li></td>
<td>有効化</td>
</tr>
<tr>
<td>HTTP 2.0</td>
<td>HTTP2.0を有効化すると、CLBはHTTP 2.0のリクエストを受信できるようになります。クライアントがCLBをリクエストする際にどのHTTPバージョンを使用していても、CLBがバックエンドサーバーにアクセスする際のHTTPバージョンは常にHTTP 1.1となります。</td>
<td>有効化</td>
</tr>
<tr>
<td>URLパス</td>
<td>転送URLパス：<ul style="margin-bottom:0px;"><li>長さ制限：1～200文字。</li><li>正規表現をサポートしています。</li><li>具体的な設定ルールについては、 <a href="https://intl.cloud.tencent.com/document/product/214/9032">転送URLパスの設定ルール</a>をご参照ください。</li></ul></td>
<td>/index</td>
</tr>
<tr>
<td>バランシング方式</td>
<td>HTTPSリスナーにおいて、CLBは重み付けラウンドロビン（WRR）、重み付け最小接続（WLC）、IP Hashの3種類のスケジューリングアルゴリズムをサポートしています。<ul style="margin-bottom:0px;"><li>重み付けラウンドロビンアルゴリズム：バックエンドサーバーの重み付けに基づき、リクエストを順序に従ってそれぞれのサーバーに振り分けます。重み付けラウンドロビンアルゴリズムでは**新規接続数**に基づいてスケジューリングを行います。重みが高いサーバーへの問い合わせ回数が多く（確率が高く）なると、同じ重みのサーバーはそれに応じて同等の接続数を処理します。</li><li>重み付け最小接続：サーバーの現在のアクティブ接続数に応じてサーバーの負荷状態を予測します。重み付け最小接続はサーバーの負荷と重みを総合的にスケジューリングし、重みが同じ場合は、その時点での接続数が少ないバックエンドサーバーへの問い合わせ回数を多く（確率を高く）します。</li><li>IP Hash：リクエストのソースIPアドレスに応じて、ハッシュキー（Hash Key）を使用し、静的に割り当てられたハッシュテーブルから対応するサーバーを見つけます。そのサーバーが使用可能であり、かつオーバーロード状態ではない場合はリクエストがそのサーバーに送信され、そうではない場合は空が返されます。</li></ul></td>
<td>重み付けラウンドロビン</td>
</tr>
<tr>
<td>バックエンドプロトコル</td>
<td>バックエンドプロトコルとはCLBとバックエンドサービス間のプロトコルのことです。：<ul style="margin-bottom:0px;"> <li>バックエンドプロトコルにHTTPを選択した場合は、バックエンドサービスでHTTPサービスをデプロイする必要があります。</li><li>バックエンドプロトコルにHTTPSを選択した場合は、バックエンドサービスでHTTPSサービスをデプロイする必要がありますが、HTTPSサービスの暗号化と復号によってバックエンドサービスはより多くのリソースを消費します。</li></ul></td>
<td>HTTP</td>
</tr>
<tr>
<td>クライアントIPの取得</td>
<td>デフォルトで有効化</td>
<td>有効化済み</td>
</tr>
<tr>
<td>Gzip圧縮</td>
<td> デフォルトで有効化</td>
<td>有効化済み</td>
</tr>
</table>
 <b>c. ヘルスチェック</b>
ヘルスチェックの詳細については、<a href="https://intl.cloud.tencent.com/document/product/214/39251">HTTPSヘルスチェック</a>をご参照ください。</br> 
 <b>b. セッション維持</b>
<table>
<tr>
<th>セッション維持の設定</th>
<th>説明</th>
<th>事例</th>
</tr>
<tr>
<th>セッション維持の有効化と無効化</th>
<td><ul><li>セッション維持を有効化すると、CLBのリスナーは同一のクライアントからのアクセスリクエストを同一のバックエンドサーバーに配信します。</li><li>TCPプロトコルはクライアントIPアドレスベースのセッション維持であり、同一のIPアドレスからのアクセスリクエストを同一のバックエンドサーバーに転送します。</li><li>重み付けラウンドロビンスケジューリングはセッション維持をサポートしますが、重み付け最小接続スケジューリングはセッション維持機能の有効化をサポートしていません。</li></ul></td>
<td>有効化</td>
</tr>
<tr>
<td>セッション維持時間</td>
<td><ul><li>維持時間を超え、接続中に新たなリクエストがない場合は、自動的にセッションの維持が切断されます。</li><li>設定可能範囲は30～3600秒です。</li></ul></td>
<td>30s</td>
</tr>
</table>


### ステップ2：バックエンドCVMのバインド
1. 「リスナー管理」ページで、上記の`HTTPS:443`リスナーなどの、先ほど作成したリスナーをクリックし、左側の**+**をクリックしてドメイン名およびURLパスを表示します。具体的なURLパスを選択すると、リスナーの右側にそのパスにバインド済みのバックエンドサービスが表示されます。
2. **バインド**をクリックし、バインドしたいバックエンドサーバーをポップアップボックスから選択し、サービスポートと重みを設定します。
>? デフォルトポート機能：先に「デフォルトポート」を入力してからCVMを選択すると、それぞれのCVMのポートがすべてデフォルトポートとなります。
>

### ステップ3：セキュリティグループ（オプション）
CLBのセキュリティグループを設定して、パブリックネットワークトラフィックの分離を行うことができます。詳細については、[CLBセキュリティグループの設定](https://intl.cloud.tencent.com/document/product/214/14733)をご参照ください。

### ステップ4：リスナーの変更/削除（オプション）
作成済みのリスナーを変更または削除したい場合は、「リスナー管理」ページで作成済みのリスナーをクリックし、![](https://qcloudimg.tencent-cloud.cn/raw/4ab10b98316964812832043bbfd99df6.svg)のアイコンをクリックして変更するか、![](https://qcloudimg.tencent-cloud.cn/raw/e863cc51c29790d665d53feba800fd90.svg)のアイコンをクリックして削除してください。
