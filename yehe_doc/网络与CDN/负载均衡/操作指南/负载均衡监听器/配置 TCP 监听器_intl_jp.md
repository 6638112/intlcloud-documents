CLBインスタンスにTCPリスナーを追加して、クライアントからのTCPプロトコルリクエストを転送することができます。TCPプロトコルは、信頼性およびデータの正確性に対する要件が高く、伝送速度に対する要件が比較的低いシーン（ファイル伝送、メール送受信、リモートログインなど）に適しています。TCPリスナーにバインドしたバックエンドサーバーはクライアントのリアルIPを直接取得することができます。

## 前提条件
[CLBインスタンスの作成](https://intl.cloud.tencent.com/document/product/214/6149)が必要です。

## 操作手順
### ステップ1：リスナーの設定
1. [CLBコンソール](https://console.cloud.tencent.com/clb)にログインし、左側のナビゲーションバーで**インスタンス管理**をクリックします。
2. CLBインスタンスリストページの左上隅でリージョンを選択し、インスタンスリスト右側の操作列で**リスナーの設定**をクリックします。
![](https://qcloudimg.tencent-cloud.cn/raw/e3b94945c6dbe084ba51e1e22b46b341.png)
3. TCP/UDP/TCP SSL/QUIC リスナーで**新規作成**をクリックし、ポップアップした「リスナーの作成」ダイアログボックスでTCPリスナーの設定を行います。
    **a. 基本設定**
<table>
<thead>
<tr>
<th width="15%">リスナーの基本設定</th>
<th width="70%">説明</th>
<th width="15%">事例</th>
</tr>
</thead>
<tbody><tr>
<td>名称</td>
<td>リスナーの名称です。</td>
<td><span>test-tcp-80&nbsp;&nbsp;&nbsp;&nbsp;</span></td>
</tr>
<tr>
<td>リスニングプロトコルポート</td>
<td>
<ul><li>リスニングプロトコル：この例ではTCPを選択します。</li><li>リスニングポート：リクエストを受信してバックエンドサーバーにリクエストを転送するために用いるポートです。ポートの範囲は1～65535です。</li><li>同一のCLBインスタンス内では、リスニングポートは重複してはなりません。</li></ul></td>
<td>TCP:80</td>
</tr>
<tr>
<td>バランシング方式</td>
<td>TCPリスナーにおいて、CLBは重み付けラウンドロビン（WRR）と重み付け最小接続（WLC）という2種類のスケジューリングアルゴリズムをサポートしています。<br><ul><li>重み付けラウンドロビンアルゴリズム：バックエンドサーバーの重み付けに基づき、リクエストを順序に従ってそれぞれのサーバーに振り分けます。重み付けラウンドロビンアルゴリズムでは<strong>新規接続数</strong>に基づいてスケジューリングを行います。重みが高いサーバーへの問い合わせ回数が多く（確率が高く）なると、同じ重みのサーバーはそれに応じて同等の接続数を処理します。</li><li>重み付け最小接続：サーバーの現在のアクティブ接続数に応じてサーバーの負荷状態を予測します。重み付け最小接続はサーバーの負荷と重みを総合的にスケジューリングし、重みが同じ場合は、その時点での接続数が少ないバックエンドサーバーへの問い合わせ回数を多く（確率を高く）します。</li></ul>
<dx-alert infotype="explain" title="">
重み付け最小接続のバランシング方式を選択した場合、リスナーはセッション維持機能の有効化をサポートしません。
</dx-alert>
</td>
<td>重み付けラウンドロビン</td>
</tr>
<tr>
<td>双方向RST</td>
<td>チェックを入れると、対応する操作によって両側（クライアントとサーバー）に対しRSTレポートを送信して接続を終了します。チェックを入れない場合は双方向RSTを送信せず、タイムアウトするまで長時間接続します。</td>
<td><span>チェックを入れる</span></td>
</tr>
</tbody>
</table>	
 <b>b. ヘルスチェック</b></br>
ヘルスチェックの詳細については、<a href="https://intl.cloud.tencent.com/document/product/214/39251">TCPヘルスチェック</a>をご参照ください。</br>
<b>c. セッション維持</b>
<table>
<tr>
<th width="15%">セッション維持の設定</th>
<th width="70%">説明</th>
<th width="15%">事例</th>
</tr>
<tr>
<td width="15%">セッション維持の有効化と無効化</td>
<td width="70%"><ul><li>セッション維持を有効化すると、CLBのリスナーは同一のクライアントからのアクセスリクエストを同一のバックエンドサーバーに配信します。</li><li>TCPプロトコルはクライアントIPアドレスベースのセッション維持であり、同一のIPアドレスからのアクセスリクエストを同一のバックエンドサーバーに転送します。</li><li>重み付けラウンドロビンスケジューリングはセッション維持をサポートしますが、重み付け最小接続スケジューリングはセッション維持機能の有効化をサポートしていません。</li></ul></td>
<td width="15%">有効化</td>
</tr>
<tr>
<td width="15%">セッション維持時間</td>
<td width="70%">セッション維持時間<br><ul><li>維持時間を超え、接続中に新たなリクエストがない場合は、自動的にセッションの維持が切断されます。</li><li>設定可能範囲は30～3600秒です。</li></ul></td>
<td width="15%">30s</td>
</tr>
</table>	



### ステップ2：バックエンドCVMのバインド
1. 「リスナー管理」ページで、上記の`TCP:80`リスナーなどの、先ほど作成したリスナーをクリックすると、リスナーの右側にバインド済みのバックエンドサービスが表示されます。
2. **バインド**をクリックし、バインドしたいバックエンドサーバーをポップアップボックスから選択し、サービスポートと重みを設定します。
>? デフォルトポート機能：先に「デフォルトポート」を入力してからCVMを選択すると、それぞれのCVMのポートがすべてデフォルトポートとなります。


### ステップ3：セキュリティグループ（オプション）
CLBのセキュリティグループを設定して、パブリックネットワークトラフィックの分離を行うことができます。詳細については、[CLBセキュリティグループの設定](https://intl.cloud.tencent.com/document/product/214/14733)をご参照ください。

### ステップ4：リスナーの変更/削除（オプション）
作成済みのリスナーを変更または削除したい場合は、「リスナー管理」ページで作成済みのリスナーをクリックし、![](https://qcloudimg.tencent-cloud.cn/raw/4ab10b98316964812832043bbfd99df6.svg)のアイコンをクリックして変更するか、![](https://qcloudimg.tencent-cloud.cn/raw/e863cc51c29790d665d53feba800fd90.svg)のアイコンをクリックして削除してください。



