Cloud Load Balancer（CLB）を作成すると、CLBのセキュリティグループを設定してパブリックネットワークのトラフィックを分離することができるようになります。ここではさまざまな方式のCLBセキュリティグループの設定方法についてご説明します。
## 使用制限
- 各CLBにつき、最大5つまでのセキュリティグループをバインドできます。
- CLBの各セキュリティグループのルール数は最大512個です。
- 基幹ネットワークのプライベートネットワークCLBはセキュリティグループのバインドをサポートしていません。プライベートネットワークCLBに[Anycast EIP](https://intl.cloud.tencent.com/document/product/214/32426)をバインドした場合、プライベートネットワークCLBにバインドしたセキュリティグループは有効になりません。
- 基幹ネットワークのCLBは、セキュリティグループのデフォルト許可機能をサポートしていません。

## 背景情報
セキュリティグループとは一種の仮想ファイアウォールであり、ステートフルなデータパケットフィルタリング機能を有し、インスタンスレベルでのアウトバウンドおよびインバウンドトラフィックを制御します。詳細については、[セキュリティグループの概要](https://intl.cloud.tencent.com/document/product/213/12452)をご参照ください。

CLBセキュリティグループはCLBインスタンスにバインドするセキュリティグループであり、CVMセキュリティグループはCVMにバインドするセキュリティグループです。両者は制限の対象が異なります。CLBのセキュリティグループの設定には主に次の2種類の方式があります。
- [セキュリティグループのデフォルト許可を有効にする](#open-security-group)
- [セキュリティグループのデフォルト許可を無効にする](#close-security-group)

>?
>- デフォルトの状態では、IPv4 CLB、NAT64セキュリティグループのデフォルト許可は無効になっています。コンソールで有効化/無効化を行うことができます。
>- デフォルトの状態では、IPv6 CLBセキュリティグループのデフォルト許可は有効になっており、無効化はできません。


### セキュリティグループのデフォルト許可を有効にする[](id:open-security-group)
![](https://main.qcloudimg.com/raw/0d2b50ca557d805ce5790fcdd3974b40.jpg)
セキュリティグループのデフォルト許可を有効にすると、次のようになります。
<ul ><li>固定のClient IPからのアクセスを指定したい場合、CLBセキュリティグループはClient IPとリスニングポートを<strong>許可する必要があり</strong>、バックエンドCVMのセキュリティグループはClient IPとサービスポートを<strong>許可する必要はありません</strong>。CLBからのアクセストラフィックはCLBのセキュリティグループのみを通過させればよく、バックエンドCVMはCLBからのトラフィックをデフォルトで許可します。バックエンドCVMはポートを外部に公開する必要はありません。</li>
<li>パブリックIP（一般的なパブリックIPとEIPを含む）からのトラフィックは、CVMのセキュリティグループを通過する必要があります。</li>
<li>CLBインスタンスにセキュリティグループを設定しない場合は、すべてのトラフィックが許可されます。CLBインスタンスのVIP上では、リスナーを設定したポートのみがアクセス可能なため、リスニングポートはすべてのIPのトラフィックを許可します。</li>
<li>あるClient IPからのトラフィックを拒否したい場合は、CLBのセキュリティグループでアクセスを拒否する必要があります。あるIPからのアクセスをCVMのセキュリティグループで拒否しても、CLBからのトラフィックに対しては<strong>有効にならず</strong>、パブリックIP（一般的なパブリックIPとEIPを含む）からのトラフィックに対してのみ有効になります。</li></ul>


### セキュリティグループのデフォルト許可を無効にする[](id:close-security-group)
![](https://main.qcloudimg.com/raw/9357f8d81a0027110bd6a977cda4aafc.jpg)
セキュリティグループのデフォルト許可を無効にすると、次のようになります。</p>

<ul ><li>固定のClient IPからのアクセスを指定したい場合、CLBセキュリティグループはClient IPとリスニングポートを<strong>許可する必要があり</strong>、バックエンドCVMのセキュリティグループもClient IPとサービスポートを<strong>許可する必要があります</strong>。すなわち、CLBを通過する業務トラフィックはCLBセキュリティグループとCVMセキュリティグループによる二重のチェックを受けることになります。</li>
<li>パブリックIP（一般的なパブリックIPとEIPを含む）からのトラフィックは、CVMのセキュリティグループを通過する必要があります。</li>
<li>CLBインスタンスにセキュリティグループを設定しない場合は、CVMセキュリティグループを通過したトラフィックのみを許可します。</li>
<li>あるClient IPからのトラフィックを拒否したい場合は、CLBかCVMのいずれかのセキュリティグループでアクセスを拒否することができます。</li></ul>
<p >セキュリティグループのデフォルト許可を無効にしている場合は、ヘルスチェック機能を保障するため、CVMセキュリティグループに次の設定を行う必要があります。</p>
<ol ><li>パブリックネットワークCLBの設定<br>バックエンドCVMのセキュリティグループでCLBのVIPを許可する必要がある場合、CLBはVIPを使用してバックエンドCVMのヘルスステータスをチェックします。</li>
<li>プライベートネットワークCLBの設定<ul><li>プライベートネットワークCLB（旧「アプリケーション型プライベートネットワークCLB」）については、CLBがVPCネットワークにある場合、 バックエンドCVMのセキュリティグループ上でCLBのVIP（ヘルスチェック用）を開放する必要があります。CLBが基幹ネットワークにある場合は、バックエンドCVMのセキュリティグループ上で設定を行う必要はなく、ヘルスチェックIPがデフォルトで開放されています。</li></ul></li></ol>

## 操作手順
パブリックネットワークCLBのセキュリティグループ設定の例を次に示します。CLBではあらかじめ80番ポートからのインバウンド業務トラフィックのみを許可し、CVMの8080番ポートからサービスを提供するようにし、なおかつClient IPは制限せず、任意のIPからのアクセスをサポートしています。
> !この例ではパブリックネットワークCLBを使用しており、バックエンドCVMのセキュリティグループでCLBのVIPを許可してヘルスチェックを行う必要があります。現在の`0.0.0.0/0`は任意のIPを意味し、CLBのVIPも含まれます。

### ステップ1：CLBおよびリスナーの作成とCVMのバインド

詳細については、[CLBクイックスタート](https://intl.cloud.tencent.com/document/product/214/8975)をご参照ください。今回はHTTP:80リスナーを作成し、バックエンドCVMにバインドします。バックエンドCVMのサービスポートは8080です。
<img alt="" src="https://main.qcloudimg.com/raw/9ec487d62b6092e6f5b14c1791ef5f4e.png" >

### ステップ2：CLBセキュリティグループの設定
1. CLBセキュリティグループルールの設定<br> <a rel="nofollow" href="https://console.cloud.tencent.com/cvm/securitygroup">セキュリティグループコンソール</a>上でセキュリティグループルールを設定します。インバウンドルールですべてのIP（すなわち`0.0.0.0/0`）の80番ポートを許可し、その他のポートからのトラフィックを拒否します。
> ?
> - セキュリティグループルールは上から下の順にフィルタリングされて有効になるため、以前に設定した許可ルールが適用されると、その他のルールはデフォルトで拒否されますので、設定の順序に注意してください。詳細については、<a rel="nofollow" href="https://intl.cloud.tencent.com/document/product/215/38750">セキュリティグループルールの説明</a>をご参照ください。
> - セキュリティグループにはインバウンドルールとアウトバウンドルールがあり、上記の設定によって制限されるのはインバウンドトラフィックです。このため、設定はすべて<strong>インバウンドルール</strong>の設定であり、アウトバウンドルールは特に設定する必要はありません。
>
  ![](https://main.qcloudimg.com/raw/65b035098c49c77f4a82eed799353bc4.png) 

2. セキュリティグループのCLBへのバインド
 1. [CLBコンソール](https://console.cloud.tencent.com/loadbalance)にログインします。
 2. 「インスタンス管理」ページで目的のCLBインスタンスを見つけ、インスタンスIDをクリックします。
 3. インスタンス詳細ページで、【セキュリティグループ】タブをクリックし、「バインド済みのセキュリティグループ」モジュールで【バインド】をクリックします。
 4. ポップアップした「セキュリティグループの設定」ウィンドウで、CLB上にバインドするセキュリティグループを選択し、【OK】をクリックします。
       ![](https://main.qcloudimg.com/raw/8a9701e700a94ba55a9a650eb87b4456.png) 
     CLBセキュリティグループの設定が完了しました。CLBにアクセスするトラフィックは、80番ポートからのアクセスのみ許可されます。
     <img alt="" src="https://main.qcloudimg.com/raw/a32cd86653185a5138006757aab38075.png" >

### ステップ3：セキュリティグループのデフォルト許可の設定
セキュリティグループのデフォルト許可は有効か無効かを選択することができます。それぞれを選択した場合の設定は次のようになります。
- 方法1：セキュリティグループのデフォルト許可を有効にした場合、バックエンドCVMはポートを外部に公開する必要はありません。
>?基幹ネットワークのCLBは、セキュリティグループのデフォルト許可機能をサポートしていません。
- 方法2：セキュリティグループのデフォルト許可を無効にした場合は、CVMのセキュリティグループでもClient IPを開放する必要があります（この例では0.0.0.0/0）。

#### 方法1：セキュリティグループのデフォルト許可を有効にする
1.  [CLBコンソール](https://console.cloud.tencent.com/loadbalance)にログインします。
2. 「インスタンス管理」ページで目的のCLBインスタンスを見つけ、インスタンスIDをクリックします。
3. インスタンス詳細ページで【セキュリティグループ】タブをクリックします。
2. 「セキュリティグループ」ページで<img style="margin:-3px 0px" src="https://main.qcloudimg.com/raw/5ba06490364505efc4d698e3adb1064e.png">をクリックし、デフォルト許可を有効化します。
3. デフォルト許可機能を有効化すると、次の<strong>ルールプレビュー</strong>にあるセキュリティグループルールのみを検証します。
    ![](https://main.qcloudimg.com/raw/6caa47138ecb97cc3c60cb38971792fd.png)

#### 方法2：セキュリティグループのデフォルト許可を無効にする
デフォルト許可を無効化する場合は、CVMのセキュリティグループ上でもClient IPを許可する必要があります。CLBを介してCVMにアクセスする業務トラフィックは、CLBの80番ポートからのインバウンドのみを許可し、サービスはCVMの8080番ポートから提供されます。
>?あるClient IPからのトラフィックを許可するには、CLBとCVMの両方のセキュリティグループで許可する必要があります。CLBにセキュリティグループを設定していない場合は、CVM上のセキュリティグループの許可だけが必要です。
>
1. CVMセキュリティグループルールの設定
   バックエンドCVMへのアクセストラフィックについて、CVMセキュリティグループを設定することで、サービスポートからのアクセスのみを許可するよう制限します。<br>[セキュリティグループコンソール](https://console.cloud.tencent.com/cvm/securitygroup)上でセキュリティグループポリシーを設定し、インバウンドルールですべてのIPの8080番ポートを許可します。リモートログインホストおよびPingサービスを保障するため、セキュリティグループでは22、3389およびICMPサービスを許可する必要があります。
   ![](https://console.cloud.tencent.com/cvm/instance/index?rid=1)
2. セキュリティグループのCVMへのバインド
 1. [CVMコンソール](https://console.intl.cloud.tencent.com/cvm/instance/index?rid=1)で、CLBにバインドされたCVMのIDをクリックし、詳細ページに進みます。
 2. 【セキュリティグループ】タブを選択し、「バインド済みのセキュリティグループ」モジュールで【バインド】をクリックします。
 3. ポップアップした「セキュリティグループの設定」ウィンドウで、CVM上にバインドするセキュリティグループを選択し、【OK】をクリックします。      <img alt="" src="https://main.qcloudimg.com/raw/6e0e1c2f834bb7425ef3ca010114165a.png" title="クリックして元の画像を見る">

