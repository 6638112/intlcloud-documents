[CLBタイプのWeb Application Firewall（WAF）](https://intl.cloud.tencent.com/document/product/627/17470)はドメイン名とCLBリスナーをバインドし、CLBリスナーを経由するHTTPまたはHTTPSトラフィックのチェックとブロックを実現するものです。ここではCLBタイプのWAFによって、CLBに追加されたドメイン名のWebセキュリティ保護を行う方法についてご説明します。

## 前提条件
- CLBタイプのWAFはカナリアリリース中です。ご利用を希望される場合は申請を行ってください。
- HTTPリスナーまたはHTTPSリスナーを作成済みであり、ドメイン名に正常にアクセスできること。操作の詳細については、[CLBクイックスタート](https://intl.cloud.tencent.com/document/product/214/8975)をご参照ください。
- CLBタイプのWAFを購入済みであること。購入方法については[購入方法](https://intl.cloud.tencent.com/document/product/627/11730)をご参照ください。

## 制限条件
現在CLBタイプのWAFをサポートしているのはIPv4バージョンのCLBのみです。IPv6およびIPv6 NAT64バージョンのCLBは現時点ではサポートしていません。

## 操作手順
<span id ="step1"></span>
### ステップ1：CLBドメイン名設定の確認
ここではドメイン名`www.example.com`を保護する場合を例にとります。
1. [CLBコンソール](https://console.cloud.tencent.com/clb)にログインし、左側のナビゲーションバーで【インスタンス管理】をクリックします。
2. 「インスタンス管理」ページで所在リージョンを選択し、インスタンスリストで目的のインスタンスの右側にある「操作」列の【リスナーの設定】をクリックします。
3. 「リスナー管理」タブの「HTTP/HTTPSリスナー」エリアで、目的のリスナーの左側にある【+】をクリックしてドメイン名の詳細を確認します。
![](https://main.qcloudimg.com/raw/1d546d69bc1d88faf15ef7acc9270468.png)
4. CLBドメイン名設定情報が次のようになっていることを確認します。CLBインスタンスのIDが「lb-f8lm****」、リスナー名が「http-test」、リスナー転送ルールでリスニングするドメイン名が`www.example.com`、ドメイン名の保護ステータスが「無効」（ID、名前、ドメイン名はすべて実際のものに準じてください）。

### ステップ2：WAFにドメイン名を追加し、CLBにバインド
CLBタイプのWAFが保護対象のドメイン名を認識できるようにするためには、CLBがリスニングするドメイン名をWAFに追加し、CLBリスナーにバインドする必要があります。
1. [WAFコンソール](https://console.cloud.tencent.com/guanjia/waf/config)にログインし、左側ナビゲーションバーで【Web Application Firewall】>【保護設定】を選択します。
2. 「保護設定」ページで、【CLBタイプ】タブをクリックします。
3. 「CLB」タブで、【ドメイン名の追加】をクリックします。
![](https://main.qcloudimg.com/raw/5dc4d9c0363a2fe2713f157606efce19.png)
4. 「ドメイン名の入力」タブで、保護対象のドメイン名を入力し、【次のステップ】をクリックします。
![](https://main.qcloudimg.com/raw/fadb7336503e5ee808fe8a02d9b12005.png)
5. 「リスナーの選択」タブで、CLBの対応するリージョンを選択し、<a href="#step1">ステップ1：CLBドメイン名設定の確認</a>で確認したCLBインスタンスを選択し、【リスナーの選択】をクリックします。
![](https://main.qcloudimg.com/raw/4b632c6769bbbe105027e8bdf0b3ba1a.png)
6. ポップアップした「リスナーの選択」ダイアログボックスで、<a href="#step1">ステップ1：CLBドメイン名設定の確認</a>で確認したCLBリスナーを選択し、【OK】をクリックします。
![](https://main.qcloudimg.com/raw/2793320edb9a79b0c46e4ea4e92e38f6.png)
7. 「リスナーの選択」タブに戻り、【完了】をクリックすると、WAFのドメイン名とCLBリスナーとのバインドが完了します。
8. 「ドメイン名リスト」ページに戻り、ドメイン名、リージョン、バインドしたCLBインスタンスIDおよびリスナーなどの情報が正しいかどうか確認します。

### ステップ3：結果の検証
1. <a href="#step1">ステップ1：CLBドメイン名設定の確認</a>の操作手順を参照し、「リスナー管理」タブで、表示されたドメイン名の保護ステータスが「有効」、トラフィックモードが「ミラーモード」になっていれば、ドメイン保護は有効化されています。
 -  ドメイン名にDNS解決を設定していない場合は、WAFクイックスタートの[ステップ2：ローカルテスト](https://intl.cloud.tencent.com/document/product/627/35652)を参照し、WAFによる保護が有効かどうかを検証することができます。
 -  ドメイン名がDNS解決済みであれば、WAFによる保護が有効かどうかの検証は次の手順に従って行うことができます。
2. ブラウザに、アドレス`http://www.example.com/?test=alert(123)`を入力してアクセスします。
3. [WAFコンソール](https://console.cloud.tencent.com/guanjia/waf/config)にログインし、左側ナビゲーションバーで【CLS】>【攻撃ログ】を選択します。
4. 「ログの照会」タグで、保護対象のドメイン名`www.example.com`を選択して追加し、【照会】をクリックします。ログリストの中に、攻撃タイプが「XSS攻撃」のログがあった場合は、WAFがCLBに設定したドメイン名保護が有効になっていることを表します。

