## 1. CLB機能の説明

Tencent Cloud CLBロードバランサは、プロトコルスタックおよびサーバーのハイレベルな最適化により、HTTPSパフォーマンスの大幅な向上を実現しました。またTencentは海外事業者との提携によって証明書にかかるコストを大きく削減しました。Tencent Cloud CLBは次のような点でお客様のビジネスに大きなメリットをもたらします。

1. HTTPSを使用してもClientのアクセス速度を低下させません。
2. クラスター内の単一サーバーのSSL暗号化復号パフォーマンスは65000cpsのフルハンドシェイクに達します。これはハイパフォーマンスCPUの少なくとも3.5倍アップに相当します。サーバーのコストを削減することで、業務運営およびトラフィック急増時のサービス機能を大幅に引き上げ、コンピューティング型の攻撃防御機能を増強します。
3. マルチプロトコルのオフロードと変換をサポートし、業務上でクライアントのさまざまなプロトコルに対応するための負荷を減らすことができます。業務バックエンドがHTTP1.1をサポートしていれば、 HTTP2、SPDY、SSL3.0、TLS1.2などの各バージョンのプロトコルを使用できます。
4. SSL証明書の申請、モニタリング、更新をワンストップで行えます。国際的な証明書認証局であるComodo、SecureSiteとの間で協議と提携を行い、証明書申請フローの大幅な短縮とコスト削減を実現しました。
5. CC攻撃防止およびWAF機能を有します。スロー攻撃、高頻度ターゲット攻撃、SQLインジェクション、トロイの木馬などのアプリケーション層攻撃を有効に排除します。

## 2. HTTP、HTTPSヘッダー識別子

CLBはHTTPSのプロキシとなります。リクエストがHTTPとHTTPSのどちらであっても、CLBに到達してバックエンドCVMに転送される時点ですべてHTTPリクエストとなります。このとき、開発者はフロントエンドのリクエストがHTTPとHTTPSのどちらかであるかを判断することはできません。

Tencent Cloud CLBはリクエストをバックエンドCVMに転送する際、headerにX-Client-Protoを埋め込みます。

X-Client-Proto: http（フロントエンドはHTTPリクエスト）
X-Client-Proto: https（フロントエンドはHTTPSリクエスト）

## 3. クイック設定


ユーザーがウェブサイト`https://example.com`を設定したいとします。開発者は、ユーザーがブラウザにURLを入力する際、`www.example.com`を直接入力するだけで、HTTPSプロトコルによってセキュアにアクセスできるようにしたいと考えています。

このとき、ユーザーが入力した`www.example.com`リクエストの転送フローは次のようになります。

1. このリクエストはHTTPプロトコルで伝送され、VIPを介してCLBリスナーの80番ポートにアクセスし、バックエンドCVMの8080番ポートに転送されます。

2. Tencent CloudバックエンドサーバーのNginx上でrewrite操作を設定することで、このリクエストは8080番ポートを経由し、`https://example.com`ページにリライトされます。

3. このとき、ブラウザは`https://example.com`リクエストを対応するHTTPSサイトに再度送信します。このリクエストはVIPを介してCLBリスナーの443番ポートにアクセスし、バックエンドCVMの80番ポートに転送されます。

これでリクエストの転送が完了しました。

この操作はブラウザのユーザーに感知されずに、ユーザーのHTTPリクエストをより安全なHTTPリクエストに書き換えるものです。上記のリクエスト転送操作を実現するために、ユーザーはバックエンドサーバーを次のように設定することができます。

```
server {

	listen 8080; 
	server_name example.qcloud.com;

	location / {

		#! customized_conf_begin;
		client_max_body_size 200m;
		rewrite ^/.(.*) https://$host/$1 redirect;

} 
}
```

もしくはNginxの新バージョンで、推奨される301リダイレクト設定メソッドを用いて、NginxのHTTPページをHTTPSページにリダイレクトします。

```
server { 	
  	listen	  80;
  	server_name    example.qcloud.com;
  	return	  301 https://$server_name$request_uri;
}

server {
  	listen	  443 ssl;
 	server_name    example.qcloud.com;
	[....]
}
```
