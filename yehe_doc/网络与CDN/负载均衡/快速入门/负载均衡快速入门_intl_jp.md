Tencent Cloud CLBはTCP、UDP、TCP SSL、HTTP、HTTPSプロトコルをサポートし、ドメイン名およびURLパスベースの柔軟な転送機能をご提供します。ここでは、Cloud Load Balancer（CLB）インスタンスをスピーディーに作成し、クライアントからのアクセスリクエストを2台のCloud Virtual Machine（CVM）上に転送できるようご案内します。

## 前提条件
1. 2つのCVMインスタンスを作成済みであること（ここでは`rs-1`と`rs-2`というインスタンスを例にとります）。CVMインスタンスの作成方法に関しては、[CVMインスタンスの購入と起動](https://intl.cloud.tencent.com/document/product/213/4855)をご参照ください。
2. CVM上でバックエンドサービスを構築済みであること。ここではHTTP転送を例にとります。2台のCVMにはNginxサーバーをデプロイ済みであり、`rs-1`と`rs-2`はそれぞれ“Hello nginx! This is rs-1!”と“Hello nginx! This is rs-2!”を含むHTMLを返します。詳細については、[CentOSにおけるNginxのデプロイ](https://intl.cloud.tencent.com/document/product/214/32390)をご参照ください。
>!
> - ここでは標準アカウントタイプ（旧「帯域幅シフトアカウント」）を例にとります。従来型アカウントタイプ（旧「非帯域幅シフトアカウント」）のCVMの場合は、現在の帯域幅の属性がCLBではなくCVM上にあるため、パブリックネットワーク帯域幅を購入する必要があります。アカウントタイプが確実ではない場合は、[アカウントタイプの判断](https://intl.cloud.tencent.com/document/product/684/15246)をご参照ください。
> - この例では、バックエンドサーバーにデプロイされたサービスによって戻り値が異なります。実際の状況では、ユーザー体験の一致性を維持するため、通常バックエンドサーバーには完全に同一のサービスをデプロイします。

## ステップ1：CLBインスタンスの購入
CLBインスタンスの購入に成功すると、システムはVIPを自動的に割り当て、このVIPはCLBがクライアントにサービスを提供するためのIPアドレスとなります。
1. Tencent Cloudの[CLBサービス購入ページ](https://buy.intl.cloud.tencent.com/lb)にログインします。
2. CLB購入ページで、リージョンはCVMと同一のリージョンを選択し、インスタンスタイプは**CLB**を、ネットワークタイプは**パブリックネットワーク**を選択します。その他のパラメータの詳細については、[製品属性の選択](https://intl.cloud.tencent.com/document/product/214/13629)をご参照ください。
3. **今すぐ購入**をクリックして支払いを完了します。
4. 「インスタンス管理」ページに戻り、対応するリージョンを選択すると、新規作成したインスタンスを確認できます。
![](https://main.qcloudimg.com/raw/2c2afd943a9f6a6d03f55c00e62da8b5.png)

## ステップ2：CLBリスナーの設定
CLBリスナーはプロトコルとポートを指定して実際の転送を行います。ここでは、CLBがクライアントのHTTPリクエストを転送する設定の例を挙げます。
### HTTPリスニングプロトコルおよびポートの設定
クライアントがリクエストを送信した際、CLBはリスニングしたフロントエンドプロトコルおよびポートに基づいてリクエストを受信し、バックエンドサーバーに転送します。
1. [CLBコンソール](https://console.cloud.tencent.com/clb/index?rid=1&type=2%2C3)にログインします。
2. 「インスタンス管理」ページで目的のCLBインスタンスを見つけ、**リスナーの設定**をクリックします。
3. 「リスナー管理」タブの「HTTP/HTTPSリスナー」エリアで、**新規作成**をクリックします。
![](https://main.qcloudimg.com/raw/782c60eeb4bf9aa334e4243cf4e068d5.png)
4. 「リスナーの作成」ダイアログボックスで以下の内容を設定し、完了後に**送信**をクリックします。
  - リスナー名。60文字まで入力でき、アルファベット、数字、中国語、「-」、「_」、「.」を使用できます。
  - リスニングプロトコルおよびポート。`HTTP：80`などです。

### リスナーの転送ルールの設定
クライアントリクエストの際、CLBは設定したリスナーの転送ルールに基づいてリクエストを転送します。
1. 「リスナー管理」タブで、先ほど新規作成したリスナーを選択し、**＋**をクリックしてルールを追加します。
![](https://main.qcloudimg.com/raw/f8ab76b69f8a0cfdd5b4332c8b80b1f2.png)
2. 「転送ルールの作成」ダイアログボックスの「基本設定」タブで、ドメイン名、URLパスおよびバランシング方式を設定します。設定が完了したら、**次へ**をクリックします。
  - ドメイン名：バックエンドサービスで使用するドメイン名です。この例では`www.example.com`を使用します。
  - デフォルトドメイン名：クライアントリクエストがそのリスナーのどのドメイン名にもマッチしなかった場合、CLBはリクエストをデフォルトドメイン名（default server）に転送します。1つのリスナーに設定できるデフォルトドメイン名は1つのみです。このリスナーにデフォルトドメイン名が設定されていない場合、CLBは最初のドメイン名にリクエストを転送します。この例では設定しません。
  - URLパス：バックエンドサービスのアクセスパスです。この例では`/image/`を使用します。
  - バランシング方式は「重み付けラウンドロビン」を選択します。詳細については[バランシング方式](https://intl.cloud.tencent.com/document/product/214/6153)をご参照ください。
![](https://main.qcloudimg.com/raw/263b2486f8a5734ea8aa643ea3b34387.png)
3. 「ヘルスチェック」タブでヘルスチェックを有効にします。チェックドメイン名およびチェックパスはデフォルトの転送ドメイン名および転送パスを使用します。完了後に**次へ**をクリックします。
![](https://main.qcloudimg.com/raw/9d8c9bbe1191340e452e9feeafb20e73.png)
4.「セッション維持」タブでセッション維持を無効にし、**送信**をクリックします。

CLBリスナーに関するその他の内容については、[CLBリスナーの概要](https://intl.cloud.tencent.com/document/product/214/6151)をご参照ください。
>?
>- 転送ルール：1つのリスナーには複数のドメイン名を設定することができ、1つのドメイン名には複数のURLパスを設定することができます。リスナーまたはドメイン名を選択し、**＋**をクリックすると、新しいルールが作成されます。
>- セッション維持：セッション維持機能を無効化し、ラウンドロビン方式を選択してスケジューリングを行うと、リクエストは順番に異なるバックエンドサーバーに分配されます。セッション維持機能を有効化するか、またはセッション維持機能を無効化してもip_hashのスケジューリング方式を選択した場合は、リクエストは引き続き同一のバックエンドサーバーに分配されます。
>

### リスナーへのバックエンドCVMのバインド
クライアントリクエストの際、CLBはリスナーにバインドされたCVMにリクエストを転送し、CVMはその処理を行います。
1. 「リスナー管理」ページで<b>+</b>をクリックし、先ほど作成したリスナーを表示し、URLパスを選択し、右側の「転送ルールの詳細」エリアで**バインド**をクリックします。
![](https://main.qcloudimg.com/raw/ad3bab63556a4340792b1d5dadcc1b19.png)
2. 「バックエンドサービスのバインド」ダイアログボックスで、バインドするインスタンスタイプに「CVM」を選択し、さらにCLBインスタンスと同一リージョンのCVMインスタンス`rs-1`と`rs-2`を選択します。CVMポートをどちらも「80」に設定し、CVMの重みをどちらもデフォルト値の「10」とし、**確定**をクリックします。
![](https://main.qcloudimg.com/raw/02a6cf1b63726a7133f97f5f56c10d74.png)
3. [](id:qrjkjc)「転送ルールの詳細」エリアに戻ると、バインドしたCVMとそのヘルスチェックステータスを確認できます。ポートのヘルスステータスが「正常」と表示されていれば、CVMはCLBの転送したリクエストを正常に処理できていることになります。
>!1つの転送ルール（リスニングプロトコル + ポート + ドメイン名 + URLパス）を同一のCVMの複数のポートにバインドすることができます。ユーザーが`rs-1`の`80`および`81`ポートに同じサービスをデプロイしている場合、CLBは例で示した転送ルールを`rs-1`の`80`および`81`ポートに同時にバインドすることができ、2つのポートの両方でCLBから転送されたリクエストを受信できます。

## ステップ3：セキュリティグループの設定
CLBの作成完了後、CLBのセキュリティグループを設定して、パブリックネットワークトラフィックを分離することができます。詳細については、[セキュリティグループの設定](https://intl.cloud.tencent.com/document/product/214/14733)をご参照ください。

セキュリティグループの設定完了後、セキュリティグループのデフォルト許可を有効にするか無効にするかを選択できます。それぞれを選択する場合の設定は次のようになります。
### 方法1：セキュリティグループのデフォルト許可を有効にする
具体的な操作については、[セキュリティグループのデフォルト許可の設定](https://intl.cloud.tencent.com/document/product/214/14733)をご参照ください。

### 方法2：CVMセキュリティグループ上でクライアントIPを許可する
具体的な操作については、[セキュリティグループのデフォルト許可の設定](https://intl.cloud.tencent.com/document/product/214/14733)をご参照ください。

## ステップ4：CLBサービスの検証
CLBの設定完了後に、CLBが有効かどうかを検証することができます。あるCLBインスタンス下の異なる**ドメイン名+URL**によって異なるバックエンドCVMにアクセスできるかを検証するか、もしくは**コンテンツベースルーティング（content-based routing）**の機能の検証を行うこともできます。

### 方法1：hostsを設定して、ドメイン名をCLBにマッピングする
1. Windowsシステムで`C:\Windows\System32\drivers\etc`ディレクトリに進み、hostsファイルを変更し、ドメイン名をCLBインスタンスのVIP上にマッピングします。
![](https://main.qcloudimg.com/raw/b12ee22250cb7c24d5e12ecb803e6355.png)
2. hostsの設定に成功したかどうかを検証するために、cmdコマンドラインツールを実行し、`ping`コマンドによって、このドメイン名がVIPに正常にバインドされているかどうかをチェックします。データパケットがあれば、バインドに成功していることが証明されます。
![](https://main.qcloudimg.com/raw/b11b20840cba86bedbaffaa424b4e021.png)
3. ブラウザにアクセスパス`http://www.example.com/image/`を入力し、CLBサービスのテストを行います。下の図のようになっていれば、そのリクエストがCLBによって「rs-1」CVMに転送され、CVMがリクエストを正常に処理してページを返したことを表します。
![](https://main.qcloudimg.com/raw/cf61264a9406d141650ed79da21c6859.png)
4. このリスナーのバランシング方式は「重み付けラウンドロビン」であり、2台のCVMの重みはどちらも「10」です。ブラウザを更新し、再度リクエストを送信した際、下の図のようになっていれば、そのリクエストがCLBによって「rs-2」CVMに転送されたことを表します。
![](https://main.qcloudimg.com/raw/ab7db7b5c3952739919ae6e271bb1348.png)
>!`image/`の後の`/`は必ず残しておいてください。これはimageがデフォルトのディレクトリであり、imageという名前のファイルではないことを表すものです。

### 方法2：DNS解決DNSPodを設定して、ドメイン名をCLBにマッピングする
1. ドメイン名の照会と登録を行います。この例では`example.com`を使用します。
2. [DNS解決DNSPodコンソール](https://console.cloud.tencent.com/cns)にログインし、「ドメイン名解決リスト」ページで、目的のドメイン名の右側にある「操作」列の**解決**をクリックします。
3. 「レコード管理」タブで**レコードの追加**をクリックして、ドメイン名をAレコードに追加し、レコード追加エリアで次のパラメータを入力します。
  - ホストレコード：ドメイン名のプレフィックスです。この例ではすべてのプレフィックスを解決するものとし、`*.example.com`と設定します。
  - レコードタイプ：`Aレコード`。
  - 回線タイプ：デフォルト。
  - レコード値：**クラウドリソースの関連付け**をクリックし、「クラウドリソースの関連付け」ダイアログボックスで、先ほど作成したCLBインスタンスにチェックを入れます。
  - TTL：デフォルト値の「600秒」に設定します。
    ![]()
4. 追加が完了したら、**保存**をクリックします。
5. 解決レコードの追加が完了してから約10分後に、ブラウザにバインドしたCNAMEドメイン名（この例ではwww.example.com）を入力し、正常にページが表示されれば、CLBは有効になっています。

## リダイレクト機能の設定（オプション）
リダイレクトの設定には手動リダイレクトと自動リダイレクトがあります。詳細については、[リダイレクト設定](https://intl.cloud.tencent.com/document/product/214/8839)をご参照ください。
- 自動リダイレクト（強制HTTPS）：PC端末、スマホブラウザなどがHTTPリクエストによってWebサービスにアクセスする場合に、CLBをプロキシとしてHTTPSレスポンスを返します。ブラウザがHTTPSによってページにアクセスするよう、デフォルトで強制します。
- 手動リダイレクト：Web業務を一時的にオフラインにする必要がある場合（ECでの完売、ページメンテナンス、更新・アップグレードなど）にリダイレクト機能が必要です。リダイレクトを行わなければ、ユーザーのお気に入りや検索エンジンデータベース内の古いアドレスにアクセスすると404または503エラーページが表示されるだけになり、ユーザー体験を低下させ、アクセス数が無駄に失われることになります。また、これらのページに蓄積された検索エンジンのスコアリングも無効になります。


## 関連操作
- [Linux（CentOS）におけるJava Webのデプロイ](https://intl.cloud.tencent.com/document/product/214/32391) 
- [WindowsにおけるPHPのインストールと設定](https://intl.cloud.tencent.com/document/product/213/10182)
