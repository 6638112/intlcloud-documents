## 設定シナリオ

オリジンサーバー設定モジュールで、ドメイン名オリジンサーバーの基本情報、back-to-originリクエストプロトコル、ホストヘッダーなどの情報を変更することができます。


## 設定ガイド

### プライマリオリジンサーバー設定

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のナビゲーションメニューバーで【ドメイン名管理】を選択して、ドメイン名の右側にある【管理】をクリックすると、ドメイン名設定画面に入ります。「基本情報」の下にオリジンサーバー設定モジュールがあります。
![img](https://main.qcloudimg.com/raw/524f3c9aa2f9f2017d53409ee610bb5b.png)
**オリジンサーバータイプ**
外部オリジンサーバー：すでにビジネスサーバー（オリジンサーバーなど）が安定して稼働している場合は、対応するIPアドレスリストまたはドメイン名をオリジンサーバーアドレスとして入力します。
+ [Cloud Object Storage（COS）](https://intl.cloud.tencent.com/product/cos)：：リソースがすでにCOSに保存されている場合は、バケットをオリジンサーバーとして選択できます。

**back-to-originプロトコル**
CDNキャッシュノードがback-to-origin要求をオリジンサーバーに転送するときに使用されるプロトコル（HTTPまたはHTTPS）です。

オリジンサーバーの設定で、ドメイン名のback-to-originプロトコルをHTTP、HTTPS、またはFollow protocolに調整できます。

+ **HTTP back-to-origin**：HTTPとHTTPSの両方を介したアクセス要求に使用されます。
+ **HTTPS  back-to-origin**：HTTPとHTTPSの両方を介したアクセス要求に使用されます。
+ **Follow protocol**：HTTPリクエストはHTTP back-to-originを使用し、HTTPSリクエストはHTTPS back-to-originを使用します。

> !
> - HTTPS back-to-originを選択する場合は、オリジンサーバーがHTTPSアクセスをサポートしていることを確認してください。そうでない場合、back-to-originが失敗します。
> - 現在、証明書管理ページでこの設定アイテムを変更でき、今後移行する予定です。



**オリジンサーバーアドレス**
<table>
<thead>
<tr>
<td style="width:80px">外部オリジンサーバー</td>
<td style="padding-bottom:0px;padding-top:15px"><ul><li>オリジンサーバーとして、1つのドメイン名または複数のIP（1行に1つのエントリ）を入力できます：
  <br><strong>マルチIPポーリングback-to-origin：</strong>複数のIPオリジンサーバーの入力をサポートし（1行に1つのエントリ）、back-to-origin中にポーリングされます。CDNサービスは、デフォルトでオリジンサーバーの検出機能を有効にします。back-to-origin中にIPの失敗回数がしきい値を超えると、要求はこのIPアドレスに転送されなくなり、一定期間ブロックされた後、自動的に再開されます。<br>IPv6オリジンサーバーの内部テスト資格を取得している場合、ドメイン名を追加するときにIPv6オリジンサーバーを有効にすると、一つのIPv6オリジンサーバーを入力できます。<br><strong>ドメイン名back-to-origin：</strong>単一のドメイン名をオリジンサーバーとして設定できます。 このドメイン名は、サービスのアクセラレーションドメイン名と異なる必要があります。（ここではIPv6ドメイン名を使用できません）。<br><li> ポート（0 - 65535）と重み（1 - 100）の設定をサポート：フォーマットはオリジンサーバー:ポート:重み（ポートは省略可能、フォーマット：オリジンサーバー::重み）。<br><strong>注：</strong>back-to-originプロトコルとして「HTTPS」または「Follow Protocol」が選択されている場合、ポートは443にするか、空のままにする必要があります。<br><li>オリジンサーバーの入力ボックスには最大511文字を入力できます。</td></ul>
</tr>
</thead>
<tbody><tr>
<td>COS オリジン</td>
<td>オリジンサーバーとしてCOSバケットを選択できます。プライベートバケットアクセスを有効にできます。</td>
</tr>
</tbody></table>




**Origin domain**
Origin domainとは、back-to-origin中にCDNノードがオリジンサーバーのIPアドレスでアクセスするWebサイトのドメイン名を指します。デフォルトでは、現在のアクセラレーションドメイン名です。ワイルドカードドメイン名が接続されている場合はワイルドカードドメイン名になり、実際のOrigin domainはアクセスドメイン名になります。COSオリジンを使用する場合を除いて、必要に応じて変更できます。詳細については、 [オリジンサーバー設定](https://intl.cloud.tencent.com/document/product/228/6289)をご参照ください。

> ?オリジンサーバーアドレスとOrigin domainの違いは次のとおりです。
> - オリジンサーバーアドレスは、back-to-originリクエストの送信先IPアドレスを指定します。
> - Origin domainはback-to-originリクエストの送信先IPアドレスに対応するWebサイトを指定します。 

### ホットバックアップオリジンサーバーの設定

プライマリオリジンサーバーが外部サーバーの場合、ホットバックアップオリジンサーバーを追加できます。すべてのback-to-originリクエストは、最初にプライマリオリジンサーバーに転送されます。4XXまたは5XXエラーコードが返された場合、または接続タイムアウト、プロトコルの非互換性などの例外が発生した場合、リクエストがホットバックアップオリジンサーバーに転送され、リソースを取り出して、back-to-originの高可用性に確保します。

ホットバックアップオリジンサーバーは独自のオリジンサーバーアドレスとOrigin domainを設定できます。
![img](https://main.qcloudimg.com/raw/4d2ba172412182eb87ba40149775689f.png)

>!プライマリオリジンサーバーでIPv6オリジンサーバーが有効化されている場合、ホットバックアップオリジンサーバーを追加できません。

### リージョンの特別な設定

ご利用のアクセラレーションドメイン名がグローバルアクセラレーション用に設定されている場合、国際トラフィックの発生を防ぐために、下部にある【特別な設定の追加】をクリックして、ドメイン名の異なるサービスエリアに異なるオリジンサーバーを設定できます。
![img](https://main.qcloudimg.com/raw/d4a7a61ed28daa2c3eb0febf02ca931c.png)
異なるback-to-originポリシーが必要なリージョンを選択し、対応するオリジンサーバー情報を入力します。

>!
> - リージョンの特別な設定を追加した後、現在では、直接削除することはできません。
> +リージョンの特殊設定が基本設定と完全に一致する場合は、自動的にマージされます。それらが一致するように設定することで、リージョンの特殊設定を削除できます。

## 設定例
[](id:exp)
### back-to-originドメイン名の設定

CDNオリジンサーバーとアクセラレーションドメイン名`www.test.com`が次のように設定されているとします。
![img](https://main.qcloudimg.com/raw/ec2e007bb32723f7dd12aac17524c8af.png)
ユーザーのアクセスパスは次のとおりです。
ユーザーがCDNノードにキャッシュされていないリソース`http://www.test.com/test.txt`にアクセスすると、ノードはドメイン名`www.abc.com`を解決して、オリジンサーバーアドレスを取得します。例えばアドレスが`1.1.1.1`の場合、CDNノードはサーバー`1.1.1.1`にアクセスし、ウェブサイトパス`www.def.com`でtest.txtファイルを見つけて、ユーザーに返します。

### リージョンの特別な設定

CDNオリジンサーバーとアクセラレーションドメイン名`www.test.com`が次のように設定されているとします。
![img](https://main.qcloudimg.com/raw/e9104ca2b0e38c62bdffb022a933b2b9.png)
実際のback-to-originシナリオは次のとおりです。

1. 中国本土のユーザーが`http://www.test.com/test.txt`ファイルにアクセスし、中国本土のノードがこのリソースをキャッシュしていない場合、back-to-originリクエストがサーバー`1.1.1.1`に到達し、Webサイト`1.test.com`の下にあるtest.txt ファイルを見つけて、当該リソースが存在する場合は、ノードはファイルをユーザーに直接返します。そうでない場合は、ステップ2に進みます。
2. 中国本土のCDNノードはリクエストをプライマリオリジンサーバーに転送できず、リソースを見つけることができないため、リクエストをサーバー`2.2.2.2`に転送し、Webサイト`1.test.com`の下にあるtest.txtファイルを見つけて、ユーザーに返してキャッシュします。
3. この時点で、中国本土以外のユーザーも`http://www.test.com/test.txt`ファイルにアクセスし、中国本土以外のノードはこのリソースをキャッシュしていないため、back-to-originリクエストをサーバー`3.3.3.3`に転送し、Webサイト`3.test.com`の下にあるtest.txt ファイルを見つけて、当該リソースが存在する場合、ノードはファイルをユーザーに直接返します。そうでない場合は、ステップ4に進みます。
4. 中国本土以外のCDNノードはリクエストを中国本土以外のプライマリオリジンサーバーに転送できず、リソースを見つけることができないため、リクエストをサーバー`4.4.4.4`に転送し、Webサイト`4.test.com`の下にあるtest.txtファイルを見つけて、中国本土以外のユーザーに返してキャッシュします。　
