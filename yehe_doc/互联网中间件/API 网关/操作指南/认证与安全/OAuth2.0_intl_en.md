## OAuth 2.0 Overview
OAuth 2.0 is an open authorization standard that enables you to allow **third-party applications** to access your **specific private resources** in a service without **providing the account and password** to the applications.
>OAuth 2.0 is an authorization protocol rather than an authentication protocol.

### OAuth 2.0 role description
OAuth 2.0 has the following four roles: 
- Resource owner: owner of resource.
- Resource server: server where resource is stored.
- Client: third-party application client, which can be any third-party application that can consume the resource server.
- Authorization server: intermediate layer that manages the above three roles.

### Authorization process
![](https://main.qcloudimg.com/raw/27814a835f31fd1511ef3247764ee1c7.png)
(A). The client initiates a request to the resource owner for authorization.
(B). The resource owner approves authorization.
(C). The client applies to the authorization server for an authorization token after getting the resource owner's authorization.
(D). The authorization server grants the authorization token after authenticating the client.
(E). The client requests the resource server to send the user information after getting the authorization token.
(F). The resource server sends the user information to the client after verifying that the token is correct.

### Authorization grant
- Authorization grant is a credential representing the resource owner's authorization on access to protected resources, which can be used by the client to get the access token.
- Authorization code: the client needs to provide the authorization code to the server for processing (this is the authorization method used by API Gateway). 

![](https://main.qcloudimg.com/raw/640b58465144331573827f22d997f2af.png)
(A). The client uses a browser (user agent) to access the authorization server.
(B). The authorization server verifies the parameter information passed in by the client in step (A) and will provide a page for the resource owner to log in if the information is correct.
(C). An authorization code will be returned to the client if the information is correct in step (B).
(D). The client uses information such as the authorization code obtained in step (C), client identifier, and redirect URL as the parameters to request at the URL provided by the authorization server for getting the access token.
(E). The authorization server returns information such as the access token, optional refresh token, and token validity period to the client.
- Implicit: implicit grant omits the authorization code and returns the token directly, which is applicable to third-party applications that have no servers to receive and process authorization codes.
- Resource owner password credentials: the owner account and password are directly used to request the token.
- Client credentials: the client provides its identity parameters to directly get the token.

### OIDC description
- OpenID Connect (OIDC) is an identity layer constructed on OAuth 2.0 as well as a standard authentication protocol based on the OAuth 2.0 protocol.
- OAuth 2.0 defines some mechanisms to get and use an access token to access protected resources but does not define standard methods for providing identity information. 
- OIDC provides end user information in the form of `id_token`, verifies user identities, and provides basic configuration file information related to users.

#### id_token
- The most important extension made by OIDC to OAuth 2.0 is ID token (`id_token`).
- An ID token is a security token provided by an authorization server. It is a data structure in JWT format containing user information (consisting of a set of claims and other auxiliary claims).
- JSON Web Token (JWT) is a compact, self-contained, and standard data delivery protocol featuring anti-tampering mechanism. **API Gateway verifies the `id_token` generated by the JWT standard.**


| Parameter | Name | Required | Description | Value | 
|---------|---------|---------|---------|---------|
| iss | Issuer Identifier | Yes | Unique identifier of authentication information provider. | It is generally an HTTPS URL (excluding `querystring` and `fragment`).
| ѕub | Ѕubjесt Identifier | Yes | End user identifier provided by `iss`, which is unique within the `iss`. It is used by the relying party (RP) to uniquely identify a user. | It can contain up to 255 ASCII characters. |
| aud | Audience(s) | Yes | Identifier of ID token audience. | It must contain the `client_id` of OAuth 2.0. |
| exp | Expiration time | Yes | Expiration time. After this time expires, the ID token will become obsolete and cannot be authenticated. | - |
| iat | Issued At Time | Yes | Time when JWT is constructed. | - |
| auth_ time | AuthenticationTime | No | Time taken for end user to complete authentication. If the `max_age` parameter is carried when the RP sends an `AuthN` request, this claim will be required. | - |
| nоnсе | - | No | Random string provided when the RP sends a request, which is used to alleviate replay attacks or associate with the ID token and RP's session information. | - |
| асr | Аuthеntісаtіоn Соntехt Сlаѕѕ Rеfеrеnсе | No | Authentication context reference value, which is used to identify the authentication context class. | - |
| amr | Authentication Methods References | No | One set of authentication methods. |- |
| azp | Authorized party | No | It is used together with `aud` and used only if the authenticated party is different from the audience (`aud`). it is rarely used. | - |


## API Gateway OAuth 2.0 Operations
API Gateway provides the OAuth features. To run an OAuth demo, a client and an authorization server (AS) are required, and a resource server (RS) may be needed. 
There are two needs to be implemented:
- Authorization API call: request token and refresh token
- Business API call (an RS demo is required) with direct use of mock: client for request sending and receipt and postman for mocking


#### AS service
Spring Boot is used for fast development.
Key features: process authorization API requests, generate `token_id`, and refresh `token_id`

#### Generating RSA public and private keys
- Public key: stored on API Gateway for JWT signature verification.
- Private key: stored on AS.
![](https://main.qcloudimg.com/raw/55c9153f2d7a0f585a9bc0251d9d55a8.png)

The JWT is output in JSON format, and its header consists of the following two parts:
- kty: token type, which is RSA here.
- alg: used hash algorithm, which is RS256 here.

```
{"kty":"RSA","alg":"RS256","e":"","n":"public key content"}
```


#### Generating `id_token`
![](https://main.qcloudimg.com/raw/878ca3fca403fff80f319da3f98b1464.png)
- When a token is generated, you need to set the claims (`iss`, `aud`, `iat`, `exp`, and `sub`) in the payload of JWT defined by the OIDC protocol, among which the `iat` and `exp` are required, and other claims are optional.

#### Processing request token
![](https://main.qcloudimg.com/raw/c409e2dc368de85df7f0214addf4354c.png)


#### Refreshing `id_token`
![](https://main.qcloudimg.com/raw/2d22db82e25c6f961d016fd4e914947a.png)
The following content will be displayed if the authorization succeeds:
![](https://main.qcloudimg.com/raw/8f91cc6bf488f8a319f46973208713e3.png)


#### Demo
Deploy the AS service on the backend server and run it. Note that if the service is deployed on a CVM instance, you need to open the port in the security group.
- Create an authorization API in the API Gateway Console
![](https://main.qcloudimg.com/raw/4c84a7cb40d9878c2020f4011ded148c.png)
- Enter the OAuth information such as the public key
![](https://main.qcloudimg.com/raw/a9c0d2ff616c005466a66b9a79e99a2d.png)
- Create a business API in the API Gateway Console and associate it with the authorization API
![](https://main.qcloudimg.com/raw/40bde382b2b56c9bdcee812c6aa2848d.png)
- Publish the API
![](https://main.qcloudimg.com/raw/9dc65429e6bbba8096d21826eedebd49.png)
- Call the authorization API to get the `id_token`
![](https://main.qcloudimg.com/raw/85d98d401e6120297eda0f460e3f0eba.png)
- Use the `id_token` to access the business API
![](https://main.qcloudimg.com/raw/5c8f2a2d901e79e16e8588ffa5519d75.png)

