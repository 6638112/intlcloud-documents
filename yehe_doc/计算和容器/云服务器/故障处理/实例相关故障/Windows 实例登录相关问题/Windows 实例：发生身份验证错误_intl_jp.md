## 問題の説明

リモートデスクトップ接続を介してWindowsインスタンスにログインする際に、下記のエラーが発生します：
- 「認証エラーが発生しました。この関数に提供されたトークンは無効です」というメッセージが表示されます。
- 「認証エラーが発生しました。要求された関数はサポートされていません」というメッセージが表示されます。

## 問題の分析

2018年3月にMicrosoftによりセキュリティ更新プログラムを公開しました。この更新プログラムはセキュリティサポートプロトコル(CredSSP)が認証プロセス中にリクエストを検証する方法を修正することにより、 CredSSPのリモートでコードが実行される脆弱性を修復します。クライアントやサーバーの両方で、この更新プログラムをインストールする必要があります。インストールしないと、上記のエラーが発生する可能性があります。

すように、次の3つのシナリオによるリモート接続の失敗を引き起こします：
- シナリオ1：クライアントが修復されていない、サーバーがセキュリティ更新プログラムをインストールしました。それにポリシーの設定は「更新済みクライアントの強制」になっています。
- シナリオ2：サーバーが修復されていない、クライアントがセキュリティ更新プログラムをインストールしました。それにポリシーの設定は「更新済みクライアントの強制」になっています。
- シナリオ3: サーバーが修復されていない、クライアントがセキュリティ更新プログラムをインストールしました。それにポリシーの設定は「緩和」になっています。

## ソリューション

>? クライアントをローカルで更新する場合、[ソリューション1：セキュリティ更新プログラムのインストール(推奨)](#step4)を直接に実行してください。
>
### VNCを使用してCVMにログインする

1. [CVMコンソール](https://console.cloud.tencent.com/cvm/index)にログインします。
2. 「インスタンス」画面で、対象のCVMインスタンスを見つけて、【ログイン】をクリックします。下図に示すように：
![CVMリスト画面](https://main.qcloudimg.com/raw/d9ccf04da21f4ac86d624742c87d5628.png)
3. 「Windowsインスタンスにログインする」ウィンドウで、【その他の方式(VNC）】を選択し、【今すぐログイン】をクリックして、CVMにログインします。
4. ポップアップしたログインウィンドウで、左上隅の「リモートコマンドの送信」を選択し、**Ctrl-Alt-Delete**をクリックすると、システムログインインターフェースに入ります。下図に示すように：
![](https://main.qcloudimg.com/raw/5064251ea86085326e86884a1c13ef6b.png)

<span id="step4"></span>
### ソリューション1： セキュリティ更新プログラムのインストール(推奨)

セキュリティ更新プログラムをインストールすると、修復されていないクライアント/サーバーを更新できます。異なるシステムの更新については、[CVE-2018-0886|CredSSPのリモートでコードが実行される脆弱性](https://portal.msrc.microsoft.com/zh-cn/security-guidance/advisory/CVE-2018-0886)をご参照ください。今回の解決案はWindows Server 2016を例として説明します。
他のOSは下記の操作を参考して【Windows Update】にアクセスできます：
- Windows Server 2012：<img src="https://main.qcloudimg.com/raw/87d894e564b7e837d9f478298cf2e292.png" style="margin: 0;width: 22px;"></img> >【コントロールパネル】>【システムとセキュリティ】>【Windows Update】
- Windows Server 2008: 【スタート】>【コントロールパネル】>【システムとセキュリティ】>【Windows Update】
- Windows10：<img src="https://main.qcloudimg.com/raw/6e36af2ceb4604b81de13cb42f30e859.png" style="margin: 0;"></img> >【設定】>【更新とセキュリティ】
- Windows 7：<img src="https://main.qcloudimg.com/raw/370daffec54024ee262d1e5dbcd4bde2.png" style="margin: 0;width: 28px;"></img> >【コントロールパネル】>【システムとセキュリティ】>【Windows Update】


1. OSインターフェースで、 <img src="https://main.qcloudimg.com/raw/6e36af2ceb4604b81de13cb42f30e859.png" style="margin: 0;"></img>をクリックし、【設定】を選択します。
2. 開いた「設定」ウィンドウに、【更新とセキュリティ】を選択します。
3. 「更新とセキュリティ」ページで、【Windows update】を選択し、【更新プログラムのチェック】をクリックします。
4. インターフェースの提示に従って、【インストールを開始する】をクリックします。
5. インストールが完了したら、インスタンスを再起動して更新を完了します。

### ソリューション2:ポリシー設定の変更

セキュリティ更新プログラムがインストールされたCVMで、【暗号化オラクルの修復】ポリシーを「脆弱」に設定します。この解決案はWindows Server 2016を例として説明します。詳細な手順は以下の通りです：
>!  windows 10 homeのOSでは、グループポリシーエディターがない場合には、レジストリを変更することにより、ポリシー設定を変更できます。詳細については、[ソリューション3: レジストリの変更](#Plan3)をご参照ください。
>
1. OSインターフェースで、<img src="https://main.qcloudimg.com/raw/330624bafb194914948c8ebd9e47334d.png" style="margin: 0;"></img>をクリックして、**gpedit.msc**を入力し、**Enter**キーを押して「ローカルグループポリシーエディター」を開きます。
>? 「Win+R」のショートカットを使用して、実行インターフェースを開くこともできます。
>
3. 左側のナビゲーションツリーで、【コンピュータの構成】>【管理用テンプレート】>【システム】>【資格情報の委任】を選択し、【暗号化オラクルの修復】をダブルクリックします。
3. 開いた「暗号化オラクルの修復」ウィンドウで、【有効】を選択し、【保護レベル】を【脆弱】に設定します。
4.【OK】をクリックし、設定を完了させます。

<span id="Plan3"></span>
### ソリューション3：レジストリの変更

1. OSインターフェースで、 <img src="https://main.qcloudimg.com/raw/330624bafb194914948c8ebd9e47334d.png" style="margin: 0;"></img>をクリックし、**regedit**を入力し、 **Enter**キーを押してレジストリエディターを開きます。
>?  「Win+R」のショートカットを使用して、実行インターフェースを開くこともできます。
> 
2. 左側ナビゲーションツリーから、【コンピュータ】>【HKEY_LOCAL_MACHINE】>【SOFTWARE】>【Microsoft】>【Windows】>【CurrentVersion】>【Policies】>【System】>【CredSSP】>【Parameters】の順にディレクトリを開きます。
>? ディレクトリパスが存在しない場合は、手動で作成してください。
>

4. 【Parameters】を右クリックし、【新規】>【DWORD(32ビット)値】を選択して、ファイルに「AllowEncryptionOracle」という名前を付けます。
5. 新規作成した「AllowEncryptionOracle」ファイルをダブルクリックし、「値のデータ」を「2」に設定して、【OK】をクリックします。
6. インスタンスを再起動します。

## 関連資料

- [CVE-2018-0886 | CredSSPのリモートでコードが実行される脆弱性](https://portal.msrc.microsoft.com/zh-cn/security-guidance/advisory/CVE-2018-0886)
- [CVE-2018-0886のCredSSP更新](https://support.microsoft.com/zh-cn/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018)
