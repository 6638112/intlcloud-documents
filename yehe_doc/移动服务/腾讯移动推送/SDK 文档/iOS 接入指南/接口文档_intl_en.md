## Description

This document contains such information as the push, tag and user attribute features that is applicable to **SDK 1.2.8.0 or later**. For SDK **1.2.7.2** or earlier, please see [here](https://intl.cloud.tencent.com/document/product/1024/30727).



## Activating TPNS Service

#### API description

This API is used to activate TPNS by using the information of the application registered on the TPNS console.
(This is new in SDK 1.2.7.2 or later. For legacy versions, use the `startXGWithAppID` API in the XGPush.h file of the SDK package).

```objective-c
/// @note TPNS SDK1.2.7.2+
- (void)startXGWithAccessID:(uint32_t)accessID accessKey:(nonnull NSString *)accessKey delegate:(nullable id<XGPushDelegate>)delegate;
```

#### Parameter description

- accessID: the `AccessID` obtained by registering the application on the console.
- accessKey: the `AccessKey` obtained by registering the application on the console.
- Delegate: the callback object. 

> ! The required API parameters must be entered correctly to use the TPNS service for message push to the application.

#### Sample code

```Objective-C
 [[XGPush defaultManager] startXGWithAccessID:<your AccessID> accessKey:<your AccessKey> delegate:self];
```

## Ending TPNS Service

#### API description

After the TPNS service is stopped, TPNS no longer pushes messages to devices. To receive the push messages again, please use the `startXGWithAccessID:accessKey:delegate:` method again to restart the TPNS service.

```objective-c
- (void)stopXGNotification;
```

#### Sample code

```Objective-C
[[XGPush defaultManager] stopXGNotification];
```



## TPNS Token and Registration

### Querying TPNS token

#### API description

This API is used to query the token string generated by the current application on the TPNS server.

```objective-c
@property (copy, nonatomic, nullable, readonly) NSString *xgTokenString;
```

#### Sample code

```objective-c
NSString *token = [[XGPushTokenManager defaultTokenManager] xgTokenString];
```

### Registration result callback

#### API description

After the SDK is enabled, use this callback method to return the registration result and token.

```objective-c
- (void)xgPushDidRegisteredDeviceToken:(nullable NSString *)deviceToken xgToken:(nullable NSString *)xgToken error:(nullable NSError *)error
```

#### Response parameters

- deviceToken: the `Device Token` generated by APNs.
- xgToken: the `Token` generated on TPNS, which needs to be used during message push. TPNS maintains the mapping relationship between this value and the `Device Token` of APNs.
- error: the error message. If `error` is `nil`, it indicates that the push service has been successfully registered.

### Registration failure callback

#### API description

This callback is new in SDK 1.2.7.2 and used for TPNS registration failures.

```objective-c
/// @note TPNS SDK1.2.7.2+
- (void)xgPushDidFailToRegisterDeviceTokenWithError:(nullable NSError *)error
```

## Account Feature

### Creating accounts

#### API description

This API is used to clear all accounts and batch add accounts.

> ?
> 1. This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.
> 2. If you need to bind multiple accounts, use the `appendAccounts:` API in the XGPush.h file of the SDK package to add accounts.

```Objective-C
- (void)clearAndAppendAccounts:(nonnull NSArray<NSDictionary *> *)accounts;
```

#### Parameter description 

- accounts: the array of accounts.

> ?
>- One account supports binding up to 100 tokens. 
>- Use a dictionary in key-value pairs for account operations and fixed account for `key`.
>- Syntax for Objective-C: @[@{@"accountType":@(0),@"account":identifier}];
>- Syntax for Swift: [["accountType":NSNumber(0),"account":identifier]]
>- For more `accountType` values, see the enumerated values of `XGPushTokenAccountType`.

#### Sample code

```Objective-C
//Set an account:
[[XGPushTokenManager defaultTokenManager] clearAndAppendAccounts:@[@{@"accountType":@(0),@"account":identifier}]];
```

### Deleting accounts

#### API description

This API is used to delete all existing accounts.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)clearAccounts;
```

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] clearAccounts];
```

## Tag Feature

### Binding/unbinding a tag

#### API description

This API is used to bind a tag to different users for the tag push.

> ?
>- This API will add and bind tags.
>- This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.
>- One application can have up to 10,000 custom tags. One device token can be bound to a maximum of 100 custom tags (if you want to increase this limit, please [submit a ticket](https://console.cloud.tencent.com/workorder/category)). One custom tag can be bound to an unlimited number of device tokens.

#### Operation APIs 

```Objective-C
- (void)appendTags:(nonnull NSArray<NSString *> *)tags
- (void)delTags:(nonnull NSArray<NSString *> *)tags
```

#### Parameter description

- tags: the array of tags.

>?The `tags` is a tag string array, which cannot contain spaces or tabs.

#### Sample code

```Objective-C
// Bind a tag:
[[XGPushTokenManager defaultTokenManager] appendTags:@[ tagStr ]];

// Unbind a tag
[[XGPushTokenManager defaultTokenManager] delTags:@[ tagStr ]];
```



### Updating a tag

#### API description

This API is used to clear all tags and batch add tags.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)clearAndAppendTags:(nonnull NSArray<NSString *> *)tags
```

#### Parameter description 

- tags: the array of tags.

> ?The `tags` is a tag string array, which cannot contain spaces or tabs.

- This API will delete old tags bound to the current token and bind new tags.

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] clearAndAppendTags:@[ tagStr ]];
```

### Deleting all tags

#### API description

This API is used to delete all existing tags.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)clearTags
```

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] clearTags];
```

## User Attribute Feature

### New user attributes

#### API description

This API is used to create or update existing key-value pairs for the user attribute.

> ?-This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)upsertAttributes:(nonnull NSDictionary<NSString *,NSString *> *)attributes
```

#### Parameter description 

- attributes: a dictionary in key-value pairs for user attribute strings, which cannot contain spaces or tabs.

> ? 
>- The keys must be first configured on the console. This feature will be supported soon.
>- Use a dictionary in key-value pairs for user attributes and fixed account for `key`.
>- Syntax for Objective-C: @{@"gender": @"Female", @"age": @"29"};
>- Syntax for Swift: ["gender":"Female", "age": "29"]

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] upsertAttributes:attributes];
```

### Deleting a user attribute

#### API description

The API is used to delete a user attribute.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)delAttributes:(nonnull NSSet<NSString *> *)attributeKeys
```

#### Parameter description 

- attributeKeys: a set of keys for user attributes. The string cannot contain spaces or tabs.

> ?Use a data set and fixed account for `key`.

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] delAttributes:attributeKeys];
```

### Clearing user attributes

#### API description

This API is used to clear all user attributes.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)clearAttributes;
```

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] clearAttributes];
```

### Updating user attributes

#### API description

This API is used to clear all user attributes and batch add new ones.

> ?This API should be called after `xgPushDidRegisteredDeviceToken:error:` returns a success.

```Objective-C
- (void)clearAndAppendAttributes:(nonnull NSDictionary<NSString *,NSString *> *)attributes
```

#### Sample code

```Objective-C
[[XGPushTokenManager defaultTokenManager] clearAndAppendAttributes:attributes];
```

## Badge Feature

### Syncing badge

#### API description

This API is used to sync the modified local badge value of the application to the TPNS server for the next push. You can go to **Create Push**-> **Advanced Settings** -> **Badge Number** on the console to configure badge number.

```objective-c
- (void)setBadge:(NSInteger)badgeNumber;
```

#### Parameter description

badgeNumber: the badge number of the application.

> ! After the local badge number is set for the application, call this API to sync it to the TPNS server, which will take effect in the next push. This API must be called after successful TPNS registration (xgPushDidRegisteredDeviceToken).

#### Sample code

```Objective-C
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    /// The badge number will be reset to zero every time the application is started (you should set the local badge number for the application in the main thread)
    if ([XGPush defaultManager].xgApplicationBadgeNumber > 0) {
        [XGPush defaultManager].xgApplicationBadgeNumber = 0;
    }
    return YES;
}

- (void)xgPushDidRegisteredDeviceToken:(nullable NSString *)deviceToken xgToken:(nullable NSString *)xgToken error:(nullable NSError *)error {
    /// Sync the badge number to TPNS after registration
    if (!error) {
        [[XGPush defaultManager] setBadge:0];
    }
}
```



## Querying Device Notification Permission

#### API description

Check whether the notification is enabled on the device. 

```objective-c
- (void)deviceNotificationIsAllowed:(nonnull void (^)(BOOL isAllowed))handler;
```

#### Parameter description

handler: the result return method.

#### Sample code

```objective-c
[[XGPush defaultManager] deviceNotificationIsAllowed:^(BOOL isAllowed) {
        <#code#>
    }];
```

## Querying SDK Version

#### API description

This API is used to query the current SDK version.

```objective-c
- (nonnull NSString *)sdkVersion;
```

#### Sample code

```objective-c
[[XGPush defaultManager] sdkVersion];
```

## Log Reporting APIs

#### API description

This API is used to report local logs if a push error occurs. Please provide the file address in [a ticket](https://console.cloud.tencent.com/workorder/category) submitted for the troubleshooting.

```
/// @note TPNS SDK1.2.4.1+
- (void)uploadLogCompletionHandler:(nullable void(^)(BOOL result,  NSString * _Nullable errorMessage))handler;
```

#### Parameter description

- @brief: report log information (SDK 1.2.4.1+).
- @param handler: report callback.

#### Sample code

```
[[XGPush defaultManager] uploadLogCompletionHandler:nil];
```

## Unregistering XG Platform Service

#### API description

Background: if the application push service is migrated from the XG platform (https://xg.qq.com) to the TPNS platform, duplicate messages may be pushed if both platforms are used. Therefore, please call the API of `TPNS SDK (1.2.5.3+)` to unregister the device information on the XG platform.
Import the header file `XGForFreeVersion.h` and call before `startXGWithAccessID`:

```
@property uint32_t freeAccessId;
```

#### Parameter description

- @freeAccessId: the `AccessID` obtained by registering the application on the XG platform (SDK 1.2.5.3+).

#### Sample code

```
[XGForFreeVersion defaultForFreeVersion].freeAccessId = 2200262432;
```

## TPNS Log Hosting

#### API description

This method is used to get TPNS logs, which is irrelevant to the `XGPush > enableDebug` method.

#### Parameter description

- logInfo: the log information.

#### Sample code

```
- (void)xgPushLog:(nullable NSString *)logInfo;
```

## Customizing Notification Bar Message Action

### Creating a message action

#### API description

This API is used to create a click event action in the notification.

```objective-c
+ (nullable id)actionWithIdentifier:(nonnull NSString *)identifier title:(nonnull NSString *)title options:(XGNotificationActionOptions)options;
```

#### Parameter description

- identifier: the unique action ID. 
- title: the action name. 
- options: the action content.

#### Sample code

```objective-c
XGNotificationAction *action1 = [XGNotificationAction actionWithIdentifier:@"xgaction001" title:@"xgAction1" options:XGNotificationActionOptionNone];
```

> ! The notification bar has the event click feature, which is only supported in iOS 8.0 or later. For iOS 7.x or earlier, this method will return null.

### Creating a category object

#### API description

This API is used to create a category object to manage the action object of the notification bar.

```objective-c
+ (nullable id)categoryWithIdentifier:(nonnull NSString *)identifier actions:(nullable NSArray<id> *)actions intentIdentifiers:(nullable NSArray<NSString *> *)intentIdentifiers options:(XGNotificationCategoryOptions)options
```

#### Parameter description

- identifier: the category object ID.
- actions: the action object group included in the current category.
- intentIdentifiers: identifiers that can be recognized by Siri.
- options: category characteristics.

> !The notification bar has the event click feature, which is only supported in iOS 8.0 or later. For versions earlier than iOS 8, this method will return null.

#### Sample code

```Objective-C
XGNotificationCategory *category = [XGNotificationCategory categoryWithIdentifier:@"xgCategory" actions:@[action1, action2] intentIdentifiers:@[] options:XGNotificationCategoryOptionNone];
```

### Creating a configuration class

#### API description

This API is used to manage the style and characteristics of the push message notification bar.

```objective-c
+ (nullable instancetype)configureNotificationWithCategories:(nullable NSSet<id> *)categories types:(XGUserNotificationTypes)types;
```

#### Parameter description

- categories: a collection of categories supported by the notification bar. 
- types: the style of the device registration notification.

#### Sample code

```objective-c
XGNotificationConfigure *configure = [XGNotificationConfigure configureNotificationWithCategories:[NSSet setWithObject:category] types:XGUserNotificationTypeAlert|XGUserNotificationTypeBadge|XGUserNotificationTypeSound];
```

## Local Push

For more information about the local push feature, please click [here](https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/SchedulingandHandlingLocalNotifications.html#//apple_ref/doc/uid/TP40008194-CH5-SW1).

