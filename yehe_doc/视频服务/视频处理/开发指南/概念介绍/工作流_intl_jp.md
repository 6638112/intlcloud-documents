ワークフローは、1つのソースファイル（オーディオビデオファイル）で開始された一連のジョブタスクの集合を表します。これらのタスクはパイプライン形式で順に実行されるため、「ワークフロー」と呼ばれます。ワークフロー内のジョブタスクは、並列または直列にすることができます。ジョブタスクは通常、MPSでは「タスク」と略称されます。ワークフローの概略図は次のとおりです。
<img src="https://main.qcloudimg.com/raw/f327643bd24f9aaa1dec7b9a158fbe60.gif" width = "650px">

| 記号 | 意味 |
|---------|---------|
| 円形 | タスクの開始と終了を表します |
| 菱形 | タスクの分解を表します |
| 角丸長方形 | 具体的なタスクの実行ユニットを表します |
| ドット | タスクの組み合わせまたは合成を表します |
| 矢印 | 異なるタスクや同一タスクの異なるフェーズの実行パスを表します |

MPSを例に取った場合、ワークフローには、トランスコーディング、スクリーンキャプチャのサンプリング、ポイントインタイムキャプチャ、アニメーション画像、スプライトイメージおよびウォーターマークなどのジョブタスクがあります。典型的なMPSタスクのワークフローの例は次のとおりです。
<img src="https://main.qcloudimg.com/raw/1fee8264c4804a2fa8d69423156ac870.jpg" width = "750px">
トランスコーディングが開始された後、SDやHDトランスコーディングおよび複数サイズのスクリーンキャプチャなど、トランスコーディングタスクの仕様が複数ある場合、これらのタスクは分解された上で並行して実行されます。各トランスコーディングのサブタスクが完了して結果がマージされてから、最終的にタスクが終了します。

## ワークフロー原理

MPSを例に取ると、ワークフローには主に、ワークフローの設定、トランスコーディングのトリガー、トランスコーディングタスクの処理およびイベント通知の送信などがあります。ワークフローの原理図は次のとおりです。
<img src="https://main.qcloudimg.com/raw/6ece0c923755b349e470a02df3c1d683.jpg" width = "900px">

1. [**ワークフローの設定**](#p1)：管理者はコンソールからワークフローを設定します。事前作業には、CMQと[COS Bucket](https://intl.cloud.tencent.com/document/product/436/32955)の申請と、それに応じたMPSサービスロールに対する権限付与があります。
2. [**トランスコーディングのトリガー**](#p2)：アップロード者は、SDKまたはコンソールを介して申請したCOS Bucketにオーディビデオファイルをアップロードします。この時点で、このBucketにバインドされたワークフロータスク、すなわちトランスコーディングタスクがトリガーされます。開発者はAPI [ProcessMedia](https://intl.cloud.tencent.com/document/product/1041/33640)を介して単一のファイルに対するトランスコーディングタスクを開始することもできます。
3. [**トランスコーディングタスクの処理**](#p3)：ワークフロー処理タスクのプロセスでは、ソースファイルのダウンロードやトランスコーディングされたファイルのアップロードなど、COSファイルに対する読み取りと書き込みの操作が行われます。
4. [**イベント通知の送信**](#p4)：ワークフロー処理が終了すると、MPSはタスク完了メッセージを上記のCMQに送信し、開発者はCMQインターフェースを介してこのイベントメッセージを受信することができます。
>?
>- ワークフローの概要については、[ワークフロー](https://intl.cloud.tencent.com/document/product/1041/33475)をご参照ください。ワークフローの設定については、[ワークフローの設定](https://intl.cloud.tencent.com/document/product/1041/33492)をご参照ください。 
>- ファイルのトランスコーディングが成功したことを確認したら、CDNを介してトランスコーディングされたビデオを配信するなど、後続のビジネスロジックを続行することができます。

[](id:p1)
### ワークフローの設定
ファイルのアップロード時にトランスコーディングタスクの自動トリガーを実装する場合は、事前にワークフローを設定する必要があります。ワークフローは、指定されたCOS Bucketにアップロードされたファイルに対して特定のトランスコーディングタスクを自動的に開始し、トランスコーディング結果ファイルを指定された同じまたは異なるCOS Bucketにアップロードします。

アップロード時にトランスコーディングタスクを自動トリガーする必要がない場合は、APIを呼び出すことで、単一ファイルのトランスコーディングタスクを手動でトリガーできます。この場合、ワークフローを設定する必要はありません。

[](id:p2)
### トランスコーディングのトリガー
トランスコーディングのトリガータスクには、自動トリガーと手動トリガーという2種類の方法があります。
- **自動トリガー**：ワークフローを設定することにより、ファイルがアップロードされたときにトランスコーディングタスクが自動的にトリガーされます。
<img src="https://main.qcloudimg.com/raw/31c0ac50ecc4a53b4eae6026b3fab6ec.jpg" width = "900px">
- **手動トリガー**：APIを呼び出してトランスコーディングタスクを開始した上で、CMQを介して完了イベント通知を受信するか、TaskIdを介してタスクの完了ステータスを手動で照会します。 詳細については、[トランスコーディングの手動開始](https://intl.cloud.tencent.com/document/product/1041/33493)をご参照ください。<br>
<img src="https://main.qcloudimg.com/raw/e727f9a2703c6bde77e93945133b267f.jpg" width = "900px">

>?
>- 図のステップ5は、開発者がAPIを呼び出すことでタスクのステータスを照会できることを示しています。パラメータは、開始されたタスクによって返されるTaskIdです。
>- 図の赤いボックスエリアはオプションを示します。このエリアでは、トランスコーディングを手動でトリガーする場合、開発者はCMQを介してイベント通知を受信するか、図のステップ5のように、APIを介してタスクステータス情報を照会するかを選択できます。

[](id:p3)
### トランスコーディングタスクの処理
トランスコーディングタスクの処理には、トランスコーディング、スクリーンキャプチャ、ウォーターマークなどのタスク処理およびトランスコーディング結果ファイルのアップロードがあります。タスクの実際の実行プロセスでは、タスクは複数のサブタスクに分解され、それらは並列または直列に処理されるため、処理が高速化します。

タスク処理が完了すると、MPSサービスはトランスコーディング結果ファイルを、お客様が指定したCOS Bucketにアップロードします。トランスコーディング結果ファイルのアップロードが失敗した場合、タスクの最終ステータスは失敗になります。

[](id:p4)
### イベント通知の送信

トランスコーディングタスクの処理が完了（成功または失敗）すると、MPSサービスはこのファイルのトランスコーディング結果情報を返します。お客様はこのメッセージの通知を受信して​​適切な処理を行う必要があります。

