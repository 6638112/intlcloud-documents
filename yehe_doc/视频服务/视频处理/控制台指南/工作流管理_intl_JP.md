## 操作シナリオ
ワークフローの設定後、指定BucketおよびディレクトリにアップロードしたビデオによってMPSが自動的にトリガーされ、出力ファイルが指定Bucketおよびディレクトリに書き込まれます。ワークフローの中でトランスコードタスク、スクリーンキャプチャタスク、アニメーション画像生成タスク、審査タスク、コンテンツ認識タスク、コンテンツ分析タスクおよびウォーターマーク追加の設定を行うことができます。



## ワークフロー作成手順
1. [MPSコンソール](https://console.cloud.tencent.com/mps)にログインし、【ワークフロー管理】をクリックして、「ワークフロー管理」ページに進みます。
2. 【ワークフローの作成】をクリックして、ワークフロー作成ページに進み、ここでワークフロー名、トリガーBucket、トリガーディレクトリ、出力Bucket、出力ディレクトリ、設定項目およびイベント通知を設定する必要があります。具体的な設定方法については、[ワークフロー設定の説明](#workflow)をご参照ください。
![](https://main.qcloudimg.com/raw/314b57f24a325fc3f4a3f4da16594006.png)
ワークフロー作成ページでは、以下の情報を設定する必要があります。
<table>
<tr><th>設定項目<a id="workflow"></a></th><th>入力必須かどうか</th><th>設定説明</th></tr>
<tr>
<td>ワークフロー</td>
<td>はい</td>
<td>128文字以内の中国語、英語、数字、アンダーバーとハイフン<code>（_-）</code>を組み合わせて入力できます（例：「MPS」）。</td>
</tr><tr>
<td>トリガーBucket</td>
<td>はい</td>
<td>当該APPIDで作成したBucketの中から1つを選択し、トリガーBucketとすることができます。ワークフローを有効化した後、このBucketにビデオファイルをアップロードすると、ワークフローの実行が自動的にトリガーされます。</td>
</tr><tr>
<td>トリガーディレクトリ</td>
<td>いいえ</td>
<td>スラッシュ<code>（/）</code>を末尾につけます。入力しない場合は、トリガーBucketのすべてのディレクトリが有効になります。</td>
</tr><tr>
<td>出力Bucket</td>
<td>はい</td>
<td>デフォルトはトリガーBucketと同じですが、当該APPIDのトリガーBucketと同じリージョンのBucketから1つを選択し、出力Bucketとすることができます。ワークフローの処理が完了した後、新しく生成されたビデオファイルはこのBucketに保存されます。</td>
</tr><tr>
<td>出力ディレクトリ</td>
<td>いいえ</td>
<td>スラッシュ<code>（/）</code>を末尾につけます。入力しない場合、出力ディレクトリはトリガーディレクトリとの一致を維持します。</td>
</tr><tr>
<td>イベント通知の有効化</td>
<td>いいえ</td>
<td><ul style="margin:0"><li>デフォルトでは無効になっています。イベント通知を有効にした場合の具体的な設定方式については、<a href="#recall">コールバック方式によるタイプ設定</a>をご参照ください。</li><li>CMQイベント通知を有効化したい場合は、<a href="https://console.cloud.tencent.com/cmq">メッセージキュー（CMQ）</a>に移動してサービスをアクティブ化し、モデルを作成してください。イベント通知を有効化すると、指定したCMQがMPSのイベント通知を受信するようになります。</li></ul></td>
</tr><tr>
<td>設定項目</td>
<td>はい</td>
<td>トランスコードタスク、スクリーンキャプチャタスク、アニメーション画像生成タスク、審査タスク、コンテンツ認識タスク、コンテンツ分析タスクのうち、少なくとも1項目を選択して設定します。詳細については、<a href="#p1">タスク設定の説明</a>をご参照ください。</td>
</tr></table>
<table>
<tr><th>コールバック方式のタイプ<a id="recall"></a></th><th>設定説明</th></tr>
<tr>
<td>CMQコールバック</td>
<td><ul style="margin:0"><li>CMQモデル：デフォルトではキューモデルが選択されています。</li><li>CMQエリア：広州、上海、背景、上海金融、深圳金融、中国香港、成都、北米エリアまたはアメリカ西部を選択可能です。</li><li>キュー名：カスタマイズ。</li></ul></td>
</tr><tr>
<td>SCFコールバック</td>
<td>【SCF操作に進む】をクリックすると設定の操作が行えます。具体的な設定方法については、<a href="https://intl.cloud.tencent.com/document/product/1041/40337">ビデオタスクコールバック通知</a>をご参照ください。<br>SCFコールバック設定はすべてのワークフローが対象となり、現在ワークフローでは設定状態を保存しません。</td>
</tr></table>

## イベント通知
### 1. Cloud Message Queue（CMQ）によるイベント通知の完了
- イベント通知を有効化した後（イベント通知はデフォルトでは無効）、ユーザーはCloud Message Queue（CMQ）モデルの中からキューモデルまたはトピックモデルを選択し、選択したモデルの名前とリージョンを入力することができます。設定が完了すると、指定したCMQがMPSのイベント通知を受信するようになります。

- CMQイベント通知は、ユーザーがCMQサービスをアクティブ化し、キューモデルまたはトピックモデルを作成した後にご利用いただくことができます。詳細は [Cloud Message Queue](https://intl.cloud.tencent.com/document/product/406/8435)をご参照ください。

### 2. Serverless Cloud Function（SCF）によるイベント通知の完了
関数処理サービスにより、MPSが生成したコールバックイベントに対する処理および操作を迅速に完了することができます。全体的なデータ処理フローチャートは次のとおりです。
![](https://main.qcloudimg.com/raw/02656fefa8e2f61f71252727747b7a02.png)
MPSトリガーによりイベントをSCF関数側にプッシュし、さらにserverlessアーキテクチャの関数計算によりコールバックイベントの処理およびレスポンスを提供します。

#### 関数処理シーンの実践
Cloud Log Serviceは、ログトピックの中のデータをMPSログトリガーによりServerless Cloud Functionへ配信して処理を行うことができ、ビデオに対してイベント通知、状態監視、アラーム処理などを行うユースケースの機能を満たします。

| 関数処理シーン | 説明 |
|---------|---------|
| ビデオタスクのコールバックをCOSにバックアップ | MPSが生成したコールバックタスクをSCFによってCOSに速やかにバックアップします。 |
| ビデオタスクのコールバック通知	 | MPSのデータメッセージをリアルタイムに受信し、メッセージをメールなどにプッシュします。 |

>!データをServerless Cloud Function側に配信する場合、発生する対応課金額の詳細については、 [SCF課金概要](https://intl.cloud.tencent.com/document/product/583/17299)をご参照ください。


[](id:p1)**タスク設定の説明**

タスクのタイプ|テンプレートはプリセットまたはカスタマイズをサポートしているか|サポートしているテンプレート設定
-|-|-
 トランスコードタスク|トランスコードテンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|<li>トランスコードテンプレート：作成済みテンプレートのリストの中から選択します。それぞれのタスク設定につき、1つまたは複数のトランスコードテンプレートの追加をサポートしています。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - トランスコードテンプレート](https://console.cloud.tencent.com/mps/templates?tab=video)の中で新しいテンプレートを再作成することができます。<br><li>ウォーターマークテンプレート：それぞれのトランスコードテンプレートにつき、最大4つのウォーターマーク追加をサポートしています。既存のウォーターマークが使用上のニーズに適さない場合は、[テンプレート設定 - ウォーターマークテンプレート](https://console.cloud.tencent.com/mps/templates?tab=watermark)の中で新しいテンプレートを再作成することができます。
 スクリーンキャプチャタスク|スクリーンキャプチャテンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|<li>スクリーンキャプチャテンプレート：タイムポイントスクリーンキャプチャ、サンプリングスクリーンキャプチャ、スプライトイメージスクリーンキャプチャの方式が含まれ、それぞれのスクリーンキャプチャ方式では、該当する方式ですでに設定したテンプレートのみを選択できます。タイムポイントスクリーンキャプチャはタイムポイントの選択を行う必要があります。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - スクリーンキャプチャテンプレート](https://console.cloud.tencent.com/mps/templates?tab=snapshot)の中で新しいテンプレートを再作成することができます。<br><li>ウォーターマークテンプレート：それぞれのトランスコードテンプレートにつき、最大4つのウォーターマーク追加をサポートしています。既存のウォーターマークが使用上のニーズに適さない場合は、[テンプレート設定 - ウォーターマークテンプレート](https://console.cloud.tencent.com/mps/templates?tab=watermark)の中で新しいテンプレートを再作成することができます。
アニメーション画像生成タスク|アニメーション画像生成テンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|アニメーション画像生成テンプレート：複数のアニメーション画像生成テンプレートの追加およびアニメーション画像生成時間範囲の再設定をサポートしています。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - アニメーション画像生成テンプレート](https://console.cloud.tencent.com/mps/templates?tab=gif)の中で新しいテンプレートを再作成することができます。
審査タスク|審査テンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|審査テンプレート：審査テンプレートを1つのみ追加できます。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - 審査テンプレート](https://console.cloud.tencent.com/mps/templates?tab=audit)の中で新しいテンプレートを再作成することができます。
コンテンツ認識タスク|コンテンツ認識テンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|コンテンツ認識テンプレート：コンテンツ認識テンプレートを1つのみ追加できます。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - コンテンツ認識テンプレート](https://console.cloud.tencent.com/mps/templates?tab=recognization)の中で新しいテンプレートを再作成することができます。
コンテンツ分析タスク|コンテンツ分析テンプレート：<li>プリセットテンプレートをサポートしています。<br><li>カスタムテンプレートをサポートしています。|コンテンツ分析テンプレート：コンテンツ分析テンプレートを1つのみ追加できます。既存のテンプレートが使用上のニーズに適さない場合は、[テンプレート設定 - コンテンツ分析テンプレート](https://console.cloud.tencent.com/mps/templates?tab=analysis)の中で新しいテンプレートを再作成することができます。



## ワークフロー管理手順

1. [MPSコンソール](https://console.cloud.tencent.com/mps)にログインし、左側ナビゲーションバーの【ワークフロー管理】をクリックして、「ワークフロー管理」画面に入ります。
2. ワークフローリストにはワークフロー名、トリガーBucket、リージョン、ディレクトリ、作成時間、有効化の状態などの情報が表示されます。作成時間の順序やタスクフロー名による検索および指定ワークフローに対する詳細表示、編集、削除の操作をサポートしています。
	-  **ワークフローの有効化**
		- ワークフローはデフォルトでは無効状態です。このワークフローに対応する状態ボタンをクリックすると、ワークフローを有効化できます。
		- ワークフローを有効化することで、トリガーBucket内にアップロードしたビデオファイルを自動実行できます。
	- **ワークフローの使用停止**
		- このワークフローに対応する状態ボタンをクリックすると、ワークフローを使用停止にできます。
		- ワークフローを使用停止にすると、トリガーBucketにアップロードしたビデオファイルはMPSタスクを実行することができなくなります。
	- **ワークフローの編集**
		-対象のワークフロー操作バーの【編集】をクリックし、「ワークフローの編集」画面に入ります。この画面でワークフロー名、トリガーBucket、トリガーディレクトリ、出力Bucket、出力ディレクトリ、イベント通知、および設定項目などの変更を行うことができます。
		- ワークフローが有効状態の時は、それに対する編集と削除操作を行うことができません。
	- **ワークフローの削除**
		- 対象のワークフロー操作バーの【削除】をクリックすると、このワークフローを削除できます。
		- ワークフローを削除すると、トリガーBucketにアップロードしたビデオファイルはMPSタスクを実行することができなくなります。
		- ワークフローが有効状態の時は、それに対する編集と削除操作を行うことができません。

