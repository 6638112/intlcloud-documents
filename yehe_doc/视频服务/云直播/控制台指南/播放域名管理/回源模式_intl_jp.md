自社構築のオリジンサーバーと自社で制作したライブストリーミングソースコンテンツがあり、Tencent Cloudを介してライブストリーミング再生を行いたい場合は、CSSの再生ドメイン名にオリジンサーバーの情報を設定すれば、back-to-originし、ライブストリーミングコンテンツをプルすることができます。設定完了後は、CSSのback-to-originによってプルを行い、ライブストリーミングコンテンツを配信できます。ここでは、オリジンサーバー情報の設定方法をご説明します。

## 注意事項
-  関連情報の設定後、オリジンサーバー設定は機能設定が完了してから約1時間で有効になります。
- オリジンサーバー設定機能が有効になると、当該再生ドメイン名は、StreamNameによるその他プッシュドメイン名とのマッチングでプルを行うことができなくなります。また当該ドメイン名でのウォーターマーク、トランスコーディング、レコーディング、スクリーンキャプチャ、ポルノ検出などの機能も利用できなくなります。 

##  前提条件
- [CSSコンソール](https://console.cloud.tencent.com/live)にログインしました。
- ライブストリーミングのオリジンサーバーを構築済みであること。
- **再生ドメイン名**を追加済みであること。

## back to originの設定
ドメイン名オリジンサーバーの基本情報、back to originリクエストプロトコル、back to originホストヘッダーなどの基本情報を変更する場合は、back to origin設定で関連操作を実行できます。
1. [**ドメイン名管理**](https://console.cloud.tencent.com/live/domainmanage)に進み、設定したい**再生ドメイン名**または右側の**管理**をクリックしてドメイン名詳細ページに進みます。
2. ドメイン名管理/ドメイン名の横で、**back to originモード**をオン/オフにすることができます。
3.　back to originモードがオンになっている場合は、back to origin設定で編集できます。
![](https://qcloudimg.tencent-cloud.cn/raw/a5132b116946971febbefc1334c8fdaa.png)

## 設定についての説明
###　オリジンサーバー情報
| オリジンサーバー情報   | 説明                                                         |
| ---------- | ------------------------------------------------------------ |
| back to originプロトコル   | RTMP、HTTP-FLV、HLSプロトコルに対応します。                          |
| HTTPS　back to origin  | back to originプロトコルがFLVとHLSの場合、HTTPS back to originを有効にすることができます。<br>HTTPS　back to originをオンにすると、オリジンサーバーアドレスの設定は443ポートに固定されます。デフォルトでは、リダイレクト後のHTTPS　back to originがサポートされています。リダイレクト後のHTTPS　back to originではポートは制限されません。|
| プライマリオリジンサーバーアドレス | プライマリ・バックアップオリジンサーバーとBack-to-Originのポーリングをサポートします。オリジンサーバーアドレスは、IPまたはドメイン名の形式をサポートしています。         |
| バックアップオリジンサーバーアドレス | バックアップオリジンサーバーはオプション項目として入力できます。                                         |

![](https://qcloudimg.tencent-cloud.cn/raw/0302a3257d93f247dd6ff9a70f779296.png)

###　オリジンサーバーのホストヘッダー
back to originプロトコルがFLVまたはHLSの場合は、Back-to-OriginのHTTPホストヘッダー（back to originのドメイン名）を設定できます。Tencent Cloudのノードがback to originする際、アクセスしたオリジンサーバーのIPアドレスの下にある具体的なサイトのドメイン名。

#### 設定について
オリジンサーバーアドレスとback to originのホストトヘッダーの違いは以下のとおりです。
 -　オリジンサーバーアドレス：back to origin時にリクエストされるIPアドレスを決定します。
 -　Back-to-Originのホストヘッダー：back to originのリクエストによってこのIPアドレスにアクセスするための特定のサイトをを決定します。
 
####　インスタンスの設定
1.　オリジンサーバーと再生ドメイン名`xx001.elementtest.org`は以下のように設定されている場合、
![](https://qcloudimg.tencent-cloud.cn/raw/c5d4785c9d45d0bdda3b60ea23519a4c.png)
2.　ユーザーアクセスパスは次のとおりです。
ユーザはリソース`http://xx001.elementtest.org/index.m3u8`にアクセスして、この時点でTencent Cloudノードにはまだこのリソースをキャッシュしていない場合、Tencent Cloudノードのback to originは`test001.com`ドメイン名を解決し、オリジンサーバーアドレス（`1.1.1.1`とします）を取得すると、`1.1.1.1`サーバーにアクセスし、その上のWebサーバー`test002.com`パスの下で、index.m3u8ファイルを見つけて、ユーザに返します。

###　再カプセル化の設定
Back-to-OriginプロトコルがRTMPまたはHTTP-FLVの場合、HLS再カプセル化を有効にすることができます。HLS再生アドレスとRTMPおよびHTTP-FLV再生アドレスの対応関係：
- RTMP形式：`rtmp://再生ドメイン名/AppName/StreamName`
- FLV形式：`http://播放域名/AppName/StreamName.flv`
- M3U8形式：`http://播放域名/AppName/StreamName.m3u8`

#### 設定について
-　M3U8ファイルにはシャード数が含まれます。デフォルトは3個ですが、3～10個を設定できます。
-　HLSのシャード時間：デフォルトは3秒ですが、3～10秒を設定できます。実際に生成されるシャード時間はGOP長を下回ることはありません。

<img src="https://qcloudimg.tencent-cloud.cn/raw/5230d04d0b13d1ce0e83dae55cbfe8b7.png" width=600>

### HTTP関連の設定
back to originプロトコルがHLSの場合は、詳細設定でHTTP関連の設定を行います。

| HTTP関連の設定     | 説明                                                         |
| ---------------- | ------------------------------------------------------------ |
| back to originのリダイレクト       | Tencent Cloudノードは301/302のステータスコードをキャッシュしません。オリジンサーバーから301/302のステータスコードが返されると、デフォルトでTencent Cloudノードは必要なリソースを取得するまで自主的にジャンプに（最大10回まで）追従し、実際のリソースをユーザー側に返し、ユーザー側はジャンプする必要がありません。<br>back to originのリダイレクトをオフにすると、ノードは、back to origin時の301/302のステータスコードを受信すると、応答をユーザー側に返し、ユーザー側はそのリソースにリダイレクトしてアクセスします。|
| back to originのURLパラメータのパススルー  | back to originはデフォルトでURLパラメータをpass-throughでリクエストしません。パラメータのパススルーをオンにするとURLのBack-to-Originで、Tencent Cloud内部のURLパラメータが増加する場合があります。|
| back to originのHTTPヘッダのパススルー | back to originはデフォルトでHTTPヘッダーをpass-throughでリクエストしません。HTTPヘッダのパススルーの再リクエストはサポートされていません。また大文字と小文字は区別されません。|
| HTTPヘッダーのパススルーのレスポンス | オリジンサーバーのHTTPヘッダーのレスポンスはデフォルトでクライアントにパススルーしません。HTTPヘッダーのパススルーの再レスポンスがサポートされますが、大文字と小文字は区別されます。|

![](https://qcloudimg.tencent-cloud.cn/raw/4255b6cb743039ca7f38e8472ce0f87f.png)

### キャッシュ設定
Back-to-OriginプロトコルがHLSの場合は、詳細設定でキャッシュの設定を行います。通常、Tencent Cloudノードがリクエストされたリソース（200のステータスコード）をオリジンサーバーからプルする場合、インデックスキャッシュ時間とシャードキャッシュ時間の設定によりキャッシュ処理が行われます。
<table id="setmess">
<tr><th width="14%">キャッシュ設定</th><th>について</th>
</tr><tr>
<td>索引キャッシュ時間</td>
<td>オリジンサーバーが200のステータスコードを返したときのm3u8インデックス・ファイルのキャッシュ時間です。デフォルトでは1000ms、最大は60000msまでです。
</ul></td>
</tr><tr>
<td>シャードキャッシュ時間</td>
<td>オリジンサーバーが200のステータスコードを返したときのts/m4s/mp4のシャードファイルのキャッシュ時間です。デフォルトでは1000ms、最大は60000msまでです。
</ul></td>
</tr><tr>
<td>ステータスコードキャッシュ時間</td>
<td>オリジンサーバーが200以外のステータスコードに迅速に応答できず、かつ全てのリクエストをオリジンサーバーに渡すことを望まない場合は、ステータスコードのキャッシュ有効期限時間を設定することで、Tencent Cloudノードは200以外のステータスコードに直接応答し、オリジンサーバーの負荷を引き下げることができます。
<br>ファイルタイプは区別されません。現在、次のステータスコードがサポートされます。
<li>4XX：400、403、404、405。</li>
<li>5XX：500、503、504。</li>
</ul></td>
</tr></table>

![](https://qcloudimg.tencent-cloud.cn/raw/bce1ada7c00c5af0ec74bdd9a1bdd826.png)

### back to origin　URLのリライト設定
Back-to-OriginプロトコルがHLSの場合は、詳細設定でback to originのURLリライト設定を行います。
Tencent Cloudでは、実際のback to originのURLをオリジンサーバーと一致するURLに変更する場合、back to originのURLリライト設定機能を提供しています。現在、back to originのURLパスの書き換えのみがサポートされています。

#### 設定について
-*　*リライトするback to originのURL**：接頭辞と一致するものがマッチされます。例えば、リライトするback to originのURLが/test01の場合、/test01の下のパスにあるすべてのリクエストがマッチされます。正規表現のマッチングは現在サポートされていません。
-　**送信元となるback to originのURL**：接頭辞と一致するものがマッチされます。例えば、送信元となるback to originのURLが/test01/test02の場合、/testの下のパスにあるすべてのリクエストは/test01/test02に上書きされます。正規表現のマッチングは現在サポートされていません。

![](https://qcloudimg.tencent-cloud.cn/raw/8251d53d1ef9a1ba170b161b730372f7.png)

#### 設定の制約
- 1つの再生ドメイン名に最大10個のリライトルールを追加できます。
- リライトルールでは、「 」、「<」、「>」、「"」、「#」、「{」、「}」、「|」、「\」、「^」、「~」、「[」、「]」、「&#96」の14個の特殊文字がサポートされていません。
- 複数件のルールは優先順位を変更できます。最上位ルールの優先順位が最下位のものよりも高くなります。

### その他の設定
| その他の設定     | 説明                                                         |
| ------------ | ------------------------------------------------------------ |
| タイムアウト時間     | TCP確立接続のタイムアウト時間。デフォルトでは10000msで、2000ms～60000msを設定できます。back to originのタイムアウト時間が短い場合は、偶発的なネットワーク上の理由でback to origin失敗が発生し、頻繁にオリジンサーバーが切り替わることがあります。back to originのタイムアウト時間が長く設定されていると、オリジンサーバーの切り替えが適切に行われず、クライアントの再生が異常になることがあります。オリジンサーバーのデータ処理とネットワーク状況を考慮し、back to originのTCP接続のタイムアウト時間を調整して、正常なback to originを確保することをお勧めします。|
| 最大再試行回数 | back to originが失敗する再試行の最大回数です。複数のオリジンサーバーアドレスが設定されている場合は、Back-to-Originが失敗するとオリジンサーバーアドレスが切り替えられて再試行されます。|
| タイムスタンプの補正   | back to originプロトコルがRTMPとFLVの場合は、詳細設定でタイムスタンプ補正の設定を行います。<Br>デフォルトではタイムスタンプをパススルーします。タイムスタンプ補正をオンにすると前のオーディオビデオフレームのタイムスタンプを比較し、大きなタイムスタンプのジャンプ発生を防ぐため、前または後に250ms以上ジャンプした場合は前のオーディオビデオフレームのタイムスタンプに10ms加算した時間に変更します。|

![](https://qcloudimg.tencent-cloud.cn/raw/040fe72429056474df265bdcb44560ee.png)

