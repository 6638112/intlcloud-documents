CSSは、ライブストリーミングの画面をレコーディングし、レコーディングファイルをVODまたはCOSに保存する機能を提供します。本書では、レコーディングファイルをCOSに保存する方法を説明します。

## 注意事項

1.レコーディングしたビデオをCOSコンソールに保存するには、COSサービスをアクティブ化しておくこと、また、ストレージ業務が支払い延滞によって停止することを防ぐために、ストレージ容量パックを事前に購入することをお勧めします。詳しくは、[COSクイックスタート](https://intl.cloud.tencent.com/document/product/436/32955)をご参照ください。
2.レコーディング機能を有効にした後、COSサービスが正常な使用状態にあることを確認してください。COSサービスの非アクティブ状態またはアカウントの支払い延滞によりサービス停止になるなどが起きた場合、ライブストリーミングに影響し、レコーディングができなくなります。この間はレコーディングファイルとレコーディング料金は発生しません。
3.ライブストリーミング中に、レコーディングが終了して約5分後に該当する時間帯のファイルを取得できます。例えば、あるライブストリーミングに対して12:00からレコーディングを開始し、12:30にレコーディングを終了とした場合、約12:35に12:00～12:30の映像を取得できます。
4.レコーディングテンプレートを正常に作成した後、プッシュドメイン名でバインドすることができます。関連するドキュメントはレコーディング設定をご参照ください。バインドが完了して約5分～10分後に反映されます。
5.ミクスストリーミングのレコーディングは、レコーディングファイルエラーが発生し、視聴とプレイバックに支障が出るため、中国大陸とグローバル/中国香港・マカオ・台湾のライブミクスストリーミングをサポートしません。
6.レコーディング後にストレージ機能を使用するには、COSのAPI権限が必要なので、レコーディングファイルの保存に失敗しないように、ストレージ機能を使用する前にCSSへ権限を付与していることを確認してください。権限回収によって保存に失敗した場合、ビデオを復元できません。権限については、CSSにCOSへのアクセス権限を付与しレコーディングの保存を実装することをご参照ください。
7.レコーディングタスクをリクエストする時、レコーディングテンプレートを指定しなかった場合、レコーティングファイルはデフォルトではVODに保存されます。
8.国家『オンライン実演営業活動の管理に関する措置』及び『オンライン取引の監督及び管理に関する措置』の最新規定により、運用組織は、インターネットライブストリーミングのビデオコンテンツを記録しバックアップを保存する必要があり、ライブストリーミングのタイプによって60日～3年間保存することをお勧めします。

##  前提条件

- Tencent CSSサービスをアクティブ化し、[プッシュドメイン名](https://intl.cloud.tencent.com/document/product/267/35970)を追加していること。
- [COSサービス](https://intl.cloud.tencent.com/document/product/436/32955)をアクティブ化していること。

## レコーディングテンプレートの作成

1. CSSコンソールにログインし、**機能設定**>[**ライブブロードキャストレコーディング**](https://console.cloud.tencent.com/live/config/record)に進みます。
2. ライブブロードキャストレコーディングで「レコーディングファイルをCOSに保存」を選択します。
3. **レコーディングテンプレート作成**をクリックし、以下のようにテンプレートの情報を設定します。


<table>
   <thead><tr><th width="20%" colspan=2>設定項目</th><th>設定の説明</th></tr></thead>
   <tbody><tr>
   <tr>
   <td colspan=2>テンプレート名</td>
   <td>ライブブロードキャストレコーディングテンプレート名。カスタマイズ可能です（中国語、英語、数字、「_」、「-」のみ対応）。</td>
   </tr><tr>
   <td colspan=2>テンプレートの説明</td>
   <td>ライブブロードキャストレコーディングテンプレートの説明。カスタマイズ可能です（中国語、英語、数字、「_」、「-」のみ対応）。</td>
   </tr><tr>   
   <td rowspan=3 width="10%">コンテンツのレコーディング</td>
   <td width="30%">オリジナルストリームのレコーディング</td> 
   <td>この設定を選択すると、CSSストリームをトランスコーディング（トランスコーディング、ウォーターマーク追加、ミックスストリーミングを含む）する前にレコーディングを行います。レコーディングされたビデオにはトランスコーディング、ウォーターマーク、ミクスストリーミングのエフェクトがありません。WebRTCを介してオリジナルストリームをレコーディングすると、オーディオが失われますので、他のレコーディングコンテンツを選択することをお勧めします。</ul></td>
   </tr><tr>
   <td>ウォーターマーク付きレコーディング</td>
   <td>この設定を選択すると、ウォーターマークテンプレートに設定されたウォーターマークがライブストリーミングに追加された後にレコーディングされます。</td>
   </tr><tr>
   <td>指定されたトランスコードストリームのレコーディング</td>
   <td>指定されたトランスコードストリームのレコーディングをクリックすると、設定済みのトランスコーディングテンプレートを選択するか、テンプレート名をクリックしてトランスコーディングテンプレートの設定を変更できます。この設定を選択すると、ストリーミングプッシュ後にトランスコーディングテンプレートidで自動的にトランスコーディングをリクエストしてレコーディングを行います。トランスコーディングテンプレートが誤って削除された場合、ウォーターマークを付けてレコーディングします。</td>
   </tr><tr>
   <td colspan=2>レコーディング形式</td>
   <td>ビデオレコーディングの出力形式にはHLS、MP4、FLV、AACの4種類があります。そのうち、AACはオーディオのみのレコーディングです。</td>
   </tr>
   </tbody></table>

>! 
>- WebRTCストリーミングプッシュでオリジナルストリームをレコーディングするとき、オーディオが失われるため、他のレコーディングコンテンツを選択することを推奨します。
>- タイムシフトの運用シーンでは、トランスコードストリーミングのレコーディング機能は使用できません。レコーディングテンプレートにタイムシフトの設定が関連付けられている場合、オリジナルストリームでレコーディングされます。
>- 指定されたトランスコードストリームのレコーディングにおいて、オーディオのみのトランスコードテンプレートを選択した場合、レコーディング形式はオーディオ形式のみ選択できます。
>- トランスコーディングストリームをレコーディングするには、トランスコーディングタスクをリクエストしておく必要がありますので、トランスコーディング料金が発生します。同一のトランスコーディングテンプレートを使用して再生する場合、重複して課金されません。

3. レコーディングコンテンツを選択し、必要なレコーディング形式にチェックを入れると、選択した形式の設定画面が表示され、1つまたは複数のレコーディング形式を同時に選択できます。以下のように設定してください：


<table>
   <thead><tr><th width="27%" colspan=2>設定項目</th><th>設定の説明</th></tr></thead>
   <tbody><tr>
      <tr>
      <td colspan=2>レコーディングファイルあたりの長さ（分）</td>
      <td><ul style="margin-bottom:0px">
          <li>HLS形式でレコーディングするファイル１つあたりのレコーディング時間は無制限です。レコーディング継続の待機時間を超えた場合、ファイルを新規作成し、レコーディングを継続します。</li>
          <li>FLV形式でレコーディングするファイル1つあたりの長さは1分～720分です。</li>
          <li>MP4またはAAC形式でレコーディングするファイル1つあたりの長さは1分～120分です。</li>
          </ul></td>
      </tr><tr>
      <td colspan=2>レコーディング継続の待機時間（秒）</td>
      <td>HLS形式のファイルのみ、プッシュ中断のレコーディング継続をサポートし、レコーディング継続の待機時間の設定範囲は1s～1800sです。</td>
      </tr><tr>
      <td colspan=2>保存時間（日）</td>
      <td><b>永続保存</b>または<b>期間指定</b>を選択できます。レコーディングファイル1つあたりの最大保存時間は1500日で、ファイル保存時間が0の場合は永久保存です。</td>
      </tr><tr>
      <td colspan=2>ストレージパス</td>
       <td><li>Bucketで<b>COS</b>に作成し権限を付与したCOS bucketを選択できます。</li>
       <li>Regionは前述したBucketが所属するリージョンの情報で、変更不可です。</li>
       </td>
       </tr><tr>      
       <td colspan=2>ディザーストリカバリーストレージパス</td>      
       <td>ディザーストリカバリーストレージパスを有効にできます。ネットワークジッターによってレコーディングファイルをメインストレージパスに保存できない場合、ファイルの紛失を防ぐために、ファイルはディザスタリカバリ用ストレージパスに保存されます。メインストレージパスが復元した後、ディザスタリカバリ用ストレージパス配下のレコーディングファイルは自動的にメインストレージパスに同期されます。マスタ/スレーブは同じRegionを選択することができません。</td>
       </tr><tr>      
       <td colspan=2>ストレージフォルダ</td>      
       <td><li>レコーディングストレージフォルダはデフォルトで{RecordSource}/{Domain}/{AppName}/{StreamID}/{RecordId}/{StartYear}-{StartMonth}-{StartDay}-{StartHour}-{StartMinute}-{StartSecond}で保存されます。そのうちの変数は以下の通りです。</li>
     <li>{RecordSource}：レコーディング内容。オリジナルストリームの場合はoriginで、トランスコーディングストリームの場合はトランスコーディングテンプレートidです</li>  
     <li>{StartYear}：開始時間-年</li> 
     <li>{StartMonth}：開始時間-月</li>
     <li>{StartDay}：開始時間-日</li>
     <li>{StartMinute}：開始時間-分</li>
     <li>{StartSecond}：開始時間-秒</li>
     <li>{Domain}：プッシュドメイン名</li>
     <li>{AppName}：プッシュパス</li>
     <li>{StreamID}：ストリームID</li>
     <li>{RecordId}：レコーディングid。レコーディングルールとレコーディングタスクを区別します。レコーディングタスクの場合、タスクid（すなわち、CreateRecordの実行で返されたID）になります</li>
     <li>「/」は階層関係を示し、「-」は一般的な文字です</li>
     </td>
      </tr>
      </tbody></table>

4. **保存**をクリックして完了します。
>? ファイルのレコーディングはレコーディングしながら転送するため、アップロード前に終了時間を取得できず、さらにファイル名に終了時間を追加できません。

[](id:conect)

## ドメイン名のバインド

1. CSSコンソールにログインし、**機能設定**>[**ライブブロードキャストレコーディング**](https://console.cloud.tencent.com/live/config/record)>レコーティングファイルをCOS保存」に進みます。
   - **ドメイン名と直接バインド：**左上にある**ドメイン名のバインド**をクリックします。
   - **レコーディングテンプレート新規作成完了後にドメイン名とバインド：**[レコーディングテンプレートの作成](#C_record)が完了した後、プロンプトボックスの中の**ドメイン名のバインドへ**をクリックします。
   
2. ドメイン名バインドウィンドウで、バインドする**レコーディングテンプレート**および**プッシュドメイン名**を選択し、**OK**をクリックすればバインドが完了します。
   

>? **追加**をクリックして現在のテンプレートに複数のプッシュドメイン名をバインドする機能をサポートしています。

[](id:unite)

## バインド解除

1. CSSコンソールにログインし、**機能設定**>[**ライブブロードキャストレコーディング**](https://console.cloud.tencent.com/live/config/record)>レコーティングファイルをCOS保存」に進みます。
2. すでにドメイン名にバインドされているレコーディングテンプレートを選択し、バインドを解除するドメイン名を選択して右側の**バインド解除**をクリックします。
3. 現在バインドされているドメイン名のバインドを解除するかを確認し、**OK**をクリックすればバインドが解除されます。
   

>? 
>- レコーディングテンプレートのバインド解除は、ライブストリーミング中のストリームには影響しません。
>- バインド解除を反映させるには、バインド解除後にストリームを切断しもう一度プッシュする必要があります。新しいライブストリーミングはレコーディングファイルが生成されなくなります。

## テンプレートの変更

1. CSSコンソールにログインし、**機能設定**>[**ライブブロードキャストレコーディング**](https://console.cloud.tencent.com/live/config/record)>レコーティングファイルをCOS保存」に進みます。
2. 作成済みのレコーディングテンプレートを選択し、右側の**編集**をクリックして、テンプレートの情報を変更します。
3. **保存**をクリックして完了します。


## テンプレートの削除

1. CSSコンソールにログインし、**機能設定**>[**ライブブロードキャストレコーディング**](https://console.cloud.tencent.com/live/config/record)>レコーティングファイルをCOS保存」に進みます。

2. 作成済みのレコーディングテンプレートを選択し、右上の**削除**をクリックします。

3. 現在のレコーディングテンプレートを削除するかを確認し、**OK**をクリックすれば削除が完了します。


>! 
>- テンプレートがすでにバインドされている場合、[バインドの解除](#unite)を行ってから、削除を行ってください。
>- コンソールでドメイン名を使用しレコーディングテンプレートを管理しますので、バインドされたインターフェースで作成したルールを削除することはできません。レコーディング管理インターフェースのバインドによってストリームを指定している場合は、[レコーディングルールの削除](https://intl.cloud.tencent.com/document/product/267/30843)を呼び出して、バインドを解除する必要があります。 

## 関連操作

レコーディングテンプレートを**ドメイン名でバインド**と**バインド解除**する方法については、レコーディング設定をご参照ください。