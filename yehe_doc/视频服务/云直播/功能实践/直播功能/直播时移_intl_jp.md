ライブストリーミングのタイムシフトは、CSSレコーディング機能に基づいて、TS (Transport Stream)セグメントアドレスとTSファイルを個別にVODシステムに保存します。クライアントは、タイムシフトの再生ドメイン名を使用して時間パラメータを渡すことで、以前の面白いビデオコンテンツを再生することが可能になります。



## タイムシフトの原理
一般的なHLSビデオライブストリーミングでは、プッシュビデオコンテンツは複数のTSセグメントに分割されます。ユーザーは視聴時に、m3u8ファイルをリクエストすることによって、TSセグメントアドレスにアクセスし、TSファイルを取得することで、ライブストリーミングコンテンツを視聴します。
>!TSファイルコンテンツは永続的に保存されないため、ユーザーは現時刻より前のライブストリーミングビデオコンテンツを遡って再生することはできません。


## 注意事項
現在、タイムシフト機能の内部テスト期間中には個別に課金しませんが、ライブストリーミングのタイムシフト機能は、**2022年06月01日00:00**に内部テストを終了し、これ以降の使用に際して課金が発生します。詳細については、[お知らせ](https://intl.cloud.tencent.com/document/product/267/46847)をご覧ください。タイムシフト機能をオンにするには、ライブブロードキャストのレコーディング機能が必要であり、[ライブブロードキャストのレコーディング費用](https://intl.cloud.tencent.com/document/product/267/39605)、[VOD保存費用とビデオ再生費用](https://intl.cloud.tencent.com/document/product/266/2838)が別途発生します。

## タイムシフトの使用

### 前提条件

- [Tencent Cloudの登録](https://intl.cloud.tencent.com/document/product/378/17985)によりアカウントを登録している。 
- Tencent CSSサービスを有効化し、[プッシュドメイン名](https://intl.cloud.tencent.com/document/product/267/35970)を追加済みであること。 

[](id:step1)
### 手順1：VODサービスの有効化

1. [VODコンソール](https://console.cloud.tencent.com/vod/overview)に移動し、**今すぐ有効にする**をクリックします。
2. サービスプロトコルの有効化にチェックを入れ、**OK**をクリックすると、VODサービスが正常に有効になり、VODコンソールにアクセスできるようにになります。

[](id:step2)
### 手順2：タイムシフト再生ドメイン名の追加

タイムシフト再生に使用するVODドメイン名を追加してください。具体的な操作は次のとおりです：

1. **VODコンソール>配信と再生の管理>ドメイン名の管理**に移動します。
2. **ドメイン名の追加**をクリックし、登録済みのVODドメイン名を入力します。操作の詳細については、 [配信と再生の設定](https://intl.cloud.tencent.com/document/product/266/35572)をご参照ください。
3. 新規追加ドメイン名のCNAME設定操作の完了。

[](id:step3)
### 手順3：レコーディングテンプレートとの関連付け

1. **CSSコンソール>機能設定>[ライブブロードキャストのレコーディング](https://console.cloud.tencent.com/live/config/record)**に移動します。
2. **レコーディングテンプレートの作成**をクリックします。操作の詳細については、[レコーディングテンプレートの設定](https://intl.cloud.tencent.com/document/product/267/34223)をご参照ください。
> ! 
> - レコーディングファイルタイプは **HLS** 形式を選択して、HLSレコーディングを開始します。
> - ファイル保存時間をカスタマイズします。この時間を[タイムシフト時間](#step4)より短くすることはできません。
3. レコーディングテンプレートをプッシュドメイン名に関連付けて設定します。具体的な操作については、 [レコーディング設定](https://intl.cloud.tencent.com/document/product/267/34224)をご参照ください。

[](id:step4)
### 手順4：タイムシフトサービスの有効化

[チケットの提出](https://console.cloud.tencent.com/workorder/category?step=0&source=0)を選択し、問題の製品を「クラウドストリーミングサービス、CSS」として選択し、タイムシフトサービスを有効化するためのリクエストを提出し、以下のパラメータを提供します。

- [手順2](#step2) の追加済みのVOD**タイムシフト再生ドメイン名**。
- [手順3](#step3) のレコーディングテンプレートID。
- カスタマイズしたタイムシフト時間 `timeshift_dur`。単位：秒。
> ? 
> - タイムシフト時間：タイムシフトでコンテンツを視聴できる時間（現在、タイムシフトで最長で7日以内のコンテンツを設定できます）。
> - この項目は絶対的な精度を保証するものではありませんので、ニーズに応じて設定することを前提とし、時間に余裕を持たせることをお勧めします。
> - 7200（2時間）に設定する場合：2時間前から現在までに生成されたコンテンツをリクエストできます（つまり、delayの相対的なタイムシフト時間を90秒～2時間とすることができます）。2時間より前に生成されたコンテンツは、ライブストリーミングコンテンツが存在しても、`HTTP 404`が返されます。 



## 再生リクエスト

### リクエストURL形式

```
http://[Domain]/timeshift/[AppName]/[StreamName]/timeshift.m3u8?delay=xxx
```

### パラメータの説明

| パラメータ           | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| [Domain]       | 登録したタイムシフトサービスアクセスドメイン名、つまり、VODコンソールで追加した [タイムシフトの再生ドメイン名](#step2)     |
| timeshift      | 固定フィールド。修正不要                                           |
| [AppName]      | アプリケーション名。アプリケーション名が `live`であれば、 `live`と入力してください           |
| [StreamName]   | ストリーム名。リクエストに対応するストリーム名を入力してください                                |
| timeshift.m3u8 | 固定フィールド。修正不要                                           |
| delay          | 相対的なタイムシフト時間を示します。単位：秒。現在の値が90未満の場合、バックエンドは自動的に値を90（最小値）に調整します|

### 事例

現在のタイムシフトドメイン名を `testtimeshift.com`、タイムシフトアプリケーション名を `live`、ストリーム名を `SLPUrIFzGPE`とした場合、このアドレスの5分前のライブストリーミングコンテンツをタイムシフトしたい場合は、次のURLをリクエストします。

```
http://testtimeshift.com/timeshift/live/SLPUrIFzGPE/timeshift.m3u8?delay=300
```
