## 1. なぜラグが発生するのか
![](https://main.qcloudimg.com/raw/c38bbed25d2953aea75f76764522e25d.png)
ラグの原因は次の3つの状況に限定されます。

- **原因 1：フレームレートが低すぎる**
キャスターのスマートフォンのパフォーマンスが低い場合、またはバックグラウンドでCPU使用率の高いプログラムを実行中の場合は、ビデオのフレームレートを著しく低下させてしまうことがあります。通常、スムーズな表示を保証するためには、毎秒15FPS以上のビデオストリームが必要です。フレームレートが10FPS未満の場合は、**フレームレートが低すぎる**と判断できます。このことによって、**すべての視聴者**の視聴体験に大幅なラグが生じます。
- **原因 2：アップロードの渋滞**
プッシュ時に、キャスターのスマートフォンは、オーディオおよびビデオデータが継続的に生成されますが、スマートフォンのアップロードスピードが遅すぎると、生成されたオーディオおよびビデオデータがキャスターのスマートフォンに蓄積され送信できなくなります。アップロード時の渋滞によって、**すべての視聴者**の視聴体験に大幅なラグが生じます。
 **国内キャリア** で提供されるブロードバンドパッケージでは、ダウンロード速度は10Mbps、20Mbps、さらには100Mbpsに達していますが、アップロード速度は制限されています。多くの小都市での最速上り速度は512Kbpsです（つまり、毎秒、64KBを上限とするデータしかアップロードできません）。
 **Wi-Fi** は、IEEE 802.11が規定する搬送波感知多重アクセス／衝突回避方式（CSMA/CA）に準拠します。つまり、1つのWi-Fiホットスポットは1台のスマートフォンとしか同時に通信できず、スマートフォンはホットスポットと通信する前にまず通信できるかどうかを確認または照会する必要があるため、1つのWi-Fiホットスポットを使用する人数が多いほど速度が遅くなります。またWi-Fi信号は建物の壁によって著しく遮断されますが、通常、中国の平均的な家庭では内装時にWi-Fiルーターの位置と各部屋の信号の強度の問題をほとんど考慮していないため、キャスター自身もライブストリーミングを実行する部屋が屋内のルーターからいくつの壁を隔てているか、よくわかっていない可能性があります。
- **原因 3：下り接続の不良**
これは視聴者のダウンロード帯域幅が不足しているか、ネットワーク状態が非常に不安定であることを意味します。例えばCSSのビットレートが1Mbps、つまり毎秒1Mビットのデータストリームをダウンロードする必要があるにもかかわらず、視聴者の帯域幅が不足していれば、視聴者の体験に著しいラグが生じることとなります。下り接続の不良は現在のネットワーク環境下の視聴者にしか影響を及ぼしません。

## 2. 問題を発見する“目”
プッシュSDKは、1-2秒間隔で内部の各ステータスパラメータをフィードバックするステータスフィードバックメカニズムを提供します。**TXLivePushListener**を登録することで、これらのステータスを取得できます。
![](https://main.qcloudimg.com/raw/533391ae5c188ed87b748f78d8168591.png)

|  プッシュ状態                   |  定義と説明                    |
| :------------------------  |  :------------------------ |
| NET_STATUS_CPU_USAGE     |現在のプロセスのCPU使用率とマシン全体のCPU使用率|
|NET_STATUS_VIDEO_FPS     | 現在のビデオフレームレート、つまりビデオエンコーダーによって作成されるフレーム数|
|NET_STATUS_NET_SPEED     | 現在の送信速度（単位：kbps）|
|NET_STATUS_VIDEO_BITRATE | 現在のビデオエンコーダーによって出力されるビットレート、つまりエンコーダーが毎秒作成するビデオデータ数。単位： kbps|
|NET_STATUS_AUDIO_BITRATE | 現在のオーディオエンコーダーによって出力されるビットレート、つまりエンコーダーが毎秒作成するオーディオデータ数。単位： kbps|
|NET_STATUS_CACHE_SIZE    | 蓄積されたオーディオおよびビデオデータのサイズ、この数字が10以上の場合、現在の上り帯域幅では生成されたオーディオおよびビデオデータを消費するには不充分であることを意味します|
|NET_STATUS_CODEC_DROP_CNT  |グローバルパケットロス回数、ディレイの継続的かつ悪質な蓄積を回避するため、データのバックログが警告ラインを超えた場合に、SDKは自動的にパケットロスを発生させます。パケットロス回数が多いほど、ネットワークの問題が深刻であることを意味します。|
| NET_STATUS_SERVER_IP     | 接続されたプッシュサーバーのIP、通常、クライアントからのホップ数が少ない最寄りのサーバーである必要があります |

## 3. フレームレートが低すぎる
### 3.1 フレームレートが低すぎるかどうかの判断
TXLivePushListener の **VIDEO_FPS** のステータスデータを介して、現在プッシュされるビデオのフレームレートを取得できます。通常、スムーズな視聴を保証するためには、15FPS以上のビデオストリームが必要です。FPSが10フレーム以下の場合、視聴者は明らかに画面のラグを感じます。

### 3.2 的を絞った最適化計画
- **3.2.1 CPU_USAGEのサイズを観察**
TXLivePushListenerの **CPU_USAGE**のステータスデータを介して、**現在のプッシュSDKのCPU使用状況**と**現在のシステムのCPU使用状況**を取得できます。現在のシステム全体のCPU使用率が80%を超えると、ビデオキャプチャとエンコードがいずれも影響を受け、正常に機能しなくなります。CPU利用率が100%に達すると、キャスター自体の動作が極めて遅くなり、視聴者のスムーズな視聴体験は不可能となります。
- **3.2.2 CPUを消費しているものを確認**
CSSのAppでCPUを使用するのは、RTMP SDKだけではなく、弾幕、キラキラエフェクト、テキストメッセージのやり取りなども一定量のCPUを消費する可能性があり、これらはいずれも避けようがありません。プッシュSDKのCPU利用状況を測定したいだけの場合は、当社の[簡易版DEMO](https://cloud.tencent.com/document/product/454/6555) を使用して観察と評価を行うことができます。
- **3.2.3 高解像度を盲目的に追及しない**
ビデオ解像度が高すぎても、必ずしも鮮明な画質が得られるとは限りません。まず高解像度の効果を発揮させるためには、高ビットレートと整合させる必要があります。低ビットレート高解像度のシャープネスは、高ビットレート低解像度に及ばないことがままあります。次に、約5インチの平均的なスマートフォン画面で1280 x 720の解像度にメリットを見出すことはできません。960 x 540の解像度との違いを明確に感じ得るのは、PCのフルスクリーンで表示した場合だけです。しかし、高解像度は、SDKのCPU利用率を著しく上昇させるため、通常、TXLivePushの [setVideoQuality](https://cloud.tencent.com/document/product/454/7885#step-4.3A-.E8.AE.BE.E5.AE.9A.E6.B8.85.E6.99.B0.E5.BA.A6) を使用して **HD** レベルに設定してください。高解像度を盲目的に追跡しても意図する目標に到達しない場合があります。
- **3.3.4 ハードウェアアクセラレーションの適切な使用**
現在のスマートフォンは、すべてビデオエンコーディングのCPUへの依存を低減するため、ハードウェアエンコーディングをサポートしています。AppのCPU使用率が高すぎる場合は、ハードウェアエンコーディングを有効にしてCPU使用率を低減することができます。TXLivePushのsetVideoQualityの**高解像度レベル**はデフォルトでソフトウェアエンコーディングを使用します（ハードウェアエンコーディングは一部のAndroidスマートフォンではうまく機能せず、モザイク感の強いことが欠点です）。ハードウェアエンコーディングを使用したい場合は、TXLivePushConfigの [enableHWAcceleration](https://cloud.tencent.com/document/product/454/7885#step-8.3A-.E7.A1.AC.E4.BB.B6.E7.BC.96.E7.A0.81) オプションを使用して有効化することができます。

## 4. アップロードの渋滞
統計によると、ビデオクラウド顧客グループのライブストリーミングルームにおけるラグトラブルの80％以上は、キャスターのアップロードの渋滞が原因です。

### 4.1 アップロードの渋滞の判断
- **4.1.1：BITRATEとNET_SPEEDの関係**
 BITRATE( = VIDEO_BITRATE + AUDIO_BITRATE ) は、エンコーダーが毎秒生成してプッシュするオーディオおよびビデオデータの量を表示し、NET_SPEEDは、毎秒、実際にプッシュされるデータの量を表示します。したがって常にBITRATE == NET_SPEEDの状況であれば、プッシュ品質は非常に良好となります。一方、BITRATE >= NET_SPEEDの状況が長時間継続する場合は、プッシュ品質を保証することは困難です。
- **4.1.2：CACHE_SIZEとDROP_CNTの数値**
BITRATE >= NET_SPEEDの状況が発生すると、エンコーダーによって生成されたオーディオおよびビデオデータがキャスターのスマートフォンにバックログされます。バックログの重大度はCACHE_SIZEの状態値で表示され、CACHE_SIZEが警告ラインを超えると、SDKは一部のオーディオおよびビデオデータを自動的にドロップさせ、DROP_CNT の増加がトリガーされます。下図は代表的な上り渋滞を表示するものであり、途中の CACHE_SIZEは一貫して**赤い警告ライン**以上となっています。これは上りネットワークがデータの伝送ニーズを満たすには不充分であること、つまり上りの渋滞が深刻であることを意味しています。
![](//mc.qcloudimg.com/static/img/319d6197da603ca15ffc6e2afd778e48/image.png)
 > ! [【CSSコンソール】](https://console.cloud.tencent.com/live/livestat)>【品質モニタリング】で上図のような図を見ることができます。

### 4.2 的を絞った最適化計画
- **4.2.1 キャスターへの自発的な促し**
シャープネスが重要なシナリオでは、適切なUIを介してキャスターに **“現在のネットワーク品質が非常に不良であるため、ルーターの近くに移動し、Wi-Fi信号を壁で隔てないことをお勧めする”** のが最良の選択であるというプロンプトを表示します。
 RTMP SDKのプッシュ機能ドキュメントには**イベント処理**の説明が含まれており、これを利用して実行することができます。推奨されるアプローチは、次のとおりです。Appが短時間に複数のRTMP SDKの **PUSH_WARNING_NET_BUSY** イベントを継続的に受信する場合は、ホストネットワークに現在のネットワーク品質に注意を払うよう、プロンプトを表示します。これは、上りの渋滞について、キャスターは、ビデオのパフォーマンスを通じて上りの渋滞を認識できず、視聴者のリマインダーまたはAppのリマインダーを介してしか気づけないためです。
- **4.2.2 合理的なエンコードの設定**
推奨されるエンコード設定は次のとおりです（ビューティーショーに最適です。TXLivePushのsetVideoQualityインターフェイスを介して対応するレベルを設定できます。

| グレード   | 解像度| FPS| ビットレート | ユースケース |
|:-------:|---------|---------|:-------:|---------|
| **SD** | 360\*640 | 15 | 400kbps - 800kbps | 帯域幅コストを重視する場合は、このレベルを選択することをお勧めします。画質は不明瞭ですが、帯域幅コストはHDより60%低く抑えられます。 |
| **HD**<br>**（推奨）** | 540*960 | 15 | 1200kbps | 画質を重視する場合は、このレベルを選択することをお勧めします。大多数のスマートフォンで非常にクリアな画像を表示できることを確実に保証します。 |
| **FHD** | 720*1280 | 15 | 1800kbps | 慎重に使用：シーンの大部分を小画面で視聴する場合はお勧めしません。大画面で視聴し、かつキャスターネットワークの品質が極めて良好な場合に検討することができます。|


## 5. 再生端末の最適化
![](https://main.qcloudimg.com/raw/1f221c3ecba79a706014154531a02bbd.png)

### 5.1 ラグ & ディレイ
上図に示すとおり、下りネットワークが不安定である場合、または下り帯域幅が滞る場合は、いずれも再生中に**飢餓時間**が出現します——App はこの期間中は再生可能なオーディオおよびビデオデータを取得できません。視聴端末でのビデオラグを最小限に抑制し、この「飢餓時間」を無事にやり過ごすためには、Appにできるだけ多くのビデオデータをキャッシュさせる必要があります。しかし、Appにオーディオおよびビデオデータを多くキャッシュさせ過ぎると、新たな問題—— **高ディレイ**が生じるおそれがあります。これはインタラクティブ性の要件が高いシナリオにとって非常に悪いニュースです。またディレイが修正、制御されない場合、ラグによって引き起こされたディレイには**累積効果**があり、再生時間が長くなればなるほど、ディレイも大きくなります。ディレイの修正が適切に行われるかどうかがプレーヤーの優劣を判断する重要な指標となります。したがって、**ディレイとスムーズさはバランスが重要**であり、低ディレイを強調しすぎると、軽微なネットワークの不安定性を引き起こし、顕著な再生端末のラグを発生させてしまいます。反対に、スムーズさを強調しすぎると、多くのディレイ（典型的なケースでは、HLS（m3u8）が10秒から30秒のディレイを導入することにより、スムーズな再生体験を実現します）が導入されてしまうことになります。

### 5.2 的を絞った最適化計画
トラフィックコントロール処理の知識が充分になくても、より良い再生体験を最適化できるように、Tencent Cloud RTMP SDKは、複数バージョンの改良を経て、一連の自動調節技術の最適化を実現し、これを元に3種類の優れた[ディレイ制御方法](https://intl.cloud.tencent.com/zh/document/product/1071/39888)をリリースしました。

- **自動モード**：主たるシナリオが確定していない場合は、このモードを直接選択できます。
>自動モードにするには、TXLivePlayConfig の setAutoAdjustCache スイッチをオンにします。このモードでプレーヤーは現在のネットワーク状況に応じて、ディレイを自動的に調節（デフォルトの状況では、プレーヤーは1s-5sの間隔でディレイを自動的に調整します。なおsetMinCacheTimeとsetMaxCacheTimeを介してデフォルト値を修正できます）することによって充分にスムーズな状況で視聴者とキャスターとの間のディレイを可能な限り低減することを保証し、良好なインタラクティブ体験を確保します。

- **超高速モード**：**ライブショーストリーミング**などのインタラクティブ性が高く、ディレイ要件が厳しいシナリオに最適です。
> 超高速モードの設定方法は、**setMinCacheTime = setMaxCacheTime = 1s** であり、自動モードと超高速モードの違いはMaxCacheTimeがやや異なるだけです（超高速モードのMaxCacheTimeは、通常、やや低く、自動モードの MaxCacheTimeは、やや高くなっています）。この柔軟性は主にSDK内部の自動調節技術によるもので、ラグの原因とならずにディレイサイズを自動的に修正できます。MaxCacheTimeは調節速度を反映し、MaxCacheTimeの値が大きいほど、調節速度も保守的となり、ラグの確率も低くなります。

- **スムーズモード**：主に**ゲームCSS** などの高ビットレート高解像度CSSシナリオに最適です。
> スムーズモードにするには、プレーヤーの setAutoAdjustCacheスイッチをオフにします。このモードでプレーヤーが採用する処理ポリシーはAdobe Flashカーネルのキャッシュアウトポリシーと同じです。ビデオにラグが出現したら、バッファが一杯になるまでloading状態となり、その後、次に抑止できないネットワークの不安定さが生じるまでplaying状態となります。デフォルトではバッファサイズは5sですが、setCacheTimeを介して変更できます。
ディレイ要件が高くないシナリオでは、この一見シンプルなモードの方が信頼性は高くなります。このモードが本質的にわずかなディレイを犠牲にしてラグ率を低下させるためです。





