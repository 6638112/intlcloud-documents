## 1. 랙이 발생하는 이유
![](https://main.qcloudimg.com/raw/c38bbed25d2953aea75f76764522e25d.png)
랙의 원인은 세 가지가 있습니다.
- **원인 1: 너무 낮은 프레임 레이트**
호스트의 휴대폰 성능이 너무 떨어지거나 CPU를 점유하는 백그라운드 프로세스가 실행 중일 경우 비디오의 프레임 레이트가 낮아질 수 있습니다. 일반적으로 스트리밍이 15FPS 이상이어야 원활하다고 볼 수 있으며, FPS가 10프레임 이하일 경우 **너무 낮은 프레임 레이트**로 판단되어 **모든 관중**이 시청할 때 랙이 발생합니다.
- **원인 2: 업로드 정체**
호스트의 휴대폰은 푸시 스트리밍 시 계속해서 멀티미디어 데이터를 생성합니다. 하지만 휴대폰의 네트워크 업로드 속도가 너무 낮을 경우에는 생성된 멀티미디어 데이터가 호스트의 휴대폰에 쌓여 업로드 되지 않으며, 업로드 정체 시 **모든 관중**에게 랙이 발생하게 됩니다.
 **중국 내 통신사**가 제공하는 대역폭에서 다운로드 속도는 이미 10Mbps, 20Mbps 또는 100Mbps까지 도달했습니다. 하지만 업로드 속도는 비교적 낮게 제한되어 있어 많은 도시의 업스트림 속도가 최대 512Kbps입니다. 초당 최대 64KB 데이터를 업로드할 수 있습니다.
 **Wi-Fi 접속**은 IEEE 802.11에 규정된 반송파 감지 다중 접근과 충돌 방지 표준을 따릅니다. 즉, 하나의 Wi-Fi 핫스팟은 동시에 하나의 휴대폰과만 통신할 수 있으며, 다른 휴대폰이 핫스팟과 통신하려면 먼저 통신이 가능할지 탐지하거나 문의해야 합니다. 따라서 한 Wi-Fi 핫스팟은 사용자가 많아질수록 느려집니다. 동시에 Wi-Fi 신호는 건축물의 벽면에 막히고 간섭을 받습니다. 그러나 중국의 일반 가정에서 공사를 할 때 각 방에서 Wi-Fi 신호가 약해지는 문제를 고려하는 경우가 매우 드물고, 호스트 본인도 자신이 라이브 방송을 하는 방이 라우터에서부터 몇 개의 벽 너머에 있는지 알 수 없습니다.
- **원인 3: 다운스트림 문제**
관중의 다운로드 대역폭이 따라오지 못하거나 네트워크 변동이 잦은 경우, 예를 들면 라이브 방송 스트림의 비트레이트가 1Mbps일 때 초당 1M 비트의 데이터 스트림으로 다운로드됩니다. 하지만 관중의 대역폭이 부족할 경우에는 랙이 발생할 수 있습니다. 다운스트림 문제는 현재 네트워크에 있는 관중에게만 영향을 미칩니다.

## 2. 문제를 발견하는 '눈'
푸시 스트리밍 SDK에서는 상태 피드백 메커니즘을 제공해 1~2초마다 내부의 각종 매개변수를 피드백합니다. **TXLivePushListener** 리스너에 등록해 상태를 확인할 수 있습니다.
![](https://main.qcloudimg.com/raw/533391ae5c188ed87b748f78d8168591.png)

|  푸시 스트리밍 상태                   |  의미 설명                    |   
| :------------------------  |  :------------------------ | 
| NET_STATUS_CPU_USAGE     |현재 프로세스의 CPU 사용률과 기기 전체의 CPU 사용률|
|	NET_STATUS_VIDEO_FPS     | 현재 비디오 프레임 레이트. 각 비디오 인코더가 생성한 프레임 수|
|	NET_STATUS_NET_SPEED     | 현재 발송 속도(단위: kbps)|
|	NET_STATUS_VIDEO_BITRATE | 현재 비디오 인코더의 출력 비트레이트. 인코더가 초당 생성하는 여러 비디오 데이터(단위: kbps)|
|	NET_STATUS_AUDIO_BITRATE | 현재 오디오 인코딩 출력 비트레이트. 인코더가 초당 생성하는 여러 오디오 데이터(단위: kbps)|
|	NET_STATUS_CACHE_SIZE    | 멀티미디어 데이터가 쌓인 상태에서 이 숫자가 자릿수를 초과하면 현재 업스트림 대역폭이 부족해 멀티미디어가 데이터가 생성되었음을 의미합니다.|
|	NET_STATUS_CODEC_DROP_CNT  |전역 패킷 손실 횟수. 딜레이로 악성 힙이 지속되는 것을 막기 위해 SDK는 데이터가 한도 이상으로 축적되면 자동으로 패킷을 손실시킵니다. 패킷 손실 횟수가 많을수록 네크워크 문제가 심각하다는 것을 의미합니다.|
| NET_STATUS_SERVER_IP     | 연결한 푸시 스트리밍 서버의 IP. 일반적으로는 클라이언트 수가 비교적 적은 근방의 서버 |

## 3. 너무 낮은 프레임 레이트
### 3.1 너무 낮은 프레임 레이트인지 판단
TXLivePushListener의 **VIDEO_FPS**의 상태 데이터를 통해 현재 푸시 스트리밍의 비디오 프레임 레이트를 확인할 수 있습니다. 일반적으로는 15FPS 이상의 비디오만 원활함을 보장할 수 있으며, FPS가 10프레임 이하이면 관중이 화면 랙을 분명히 느낄 수 있습니다.

### 3.2 타겟팅 최적화 방안
- **3.2.1 CPU_USAGE의 크기 모니터링**
TXLivePushListener의 **CPU_USAGE** 상태 데이터를 통해 **현재 푸시 스트리밍 SDK의 CPU 점유 상황**과 **현재 시스템의 CPU 점유 상황**을 알 수 있습니다. 현재 시스템의 전체 CPU 사용률이 80%를 초과하면 비디오의 수집과 인코딩 모두 영향을 받으며, 정상 작용을 할 수 없습니다. CPU 사용률이 100%에 도달하면 호스트부터 랙이 걸리기 때문에 관중들은 원활한 시청을 할 수 없습니다.
- **3.2.2 누가 CPU를 소모하는지 확인**
한 라이브 방송 App에서 CPU를 사용하는 것은 RTMP SDK뿐이 아닙니다. 댓글 자막, 이모티콘, 텍스트 메시지 인터랙션 등에서도 불가피하게 CPU를 소모할 수 있습니다. 푸시 스트리밍 SDK의 CPU 점유 상황을 테스트하려면 [간단한 버전 DEMO](https://cloud.tencent.com/document/product/454/6555)를 사용해 모니터링하고 평가하십시오.
- **3.2.3 과도한 고해상도 설정 지양**
비디오 해상도가 높다고 해서 항상 화질이 선명한 것은 아닙니다. 우선 높은 해상도는 높은 비트레이트가 있어야 효과를 발휘합니다. 비트레이트는 낮고 해상도는 높은 것보다 비트레이트가 높고 해상도가 낮은 쪽이 화질이 더 좋은 경우가 많습니다. 1280 x 720 해상도는 평균 5인치 정도의 휴대폰 화면에서는 장점을 느낄 수 없으며, 960 x 540 해상도와의 차이는 PC에서 풀스크린으로 봐야 뚜렷하게 느낄 수 있습니다. 하지만 해상도가 높을 경우에는 SDK의 CPU 사용률이 현저히 증가하기 때문에 일반적인 상황에서는 TXLivePush의 [setVideoQuality](https://cloud.tencent.com/document/product/454/7885#step-4.3A-.E8.AE.BE.E5.AE.9A.E6.B8.85.E6.99.B0.E5.BA.A6) 설정의 **고화질**을 사용하는 것을 권장합니다. 무조건 높은 해상도를 지정하면 원하는 결과를 얻지 못할 수도 있습니다.
- **3.3.4 적절한 하드웨어 가속 사용**
최신 스마트폰은 모두 하드웨어 인코딩을 지원해 비디오 인코딩 CPU에 대한 의존도를 낮췄습니다. 현재 App의 CPU 사용률이 지나치게 높다면 하드웨어 인코딩을 사용해 CPU 사용률을 낮출 수 있습니다. TXLivePush의 setVideoQuality의 **고화질**은 기본적으로 소프트웨어 인코딩을 사용합니다. Android 휴대폰에서는 하드웨어 인코딩 효과가 좋지 않아 모자이크 느낌이 강한 것이 단점입니다. 하드웨어 인코딩을 사용하려면 TXLivePushConfig의 [enableHWAcceleration](https://cloud.tencent.com/document/product/454/7885#step-8.3A-.E7.A1.AC.E4.BB.B6.E7.BC.96.E7.A0.81) 옵션을 활성화하십시오.

## 4. 업로드 정체
통계에 따르면 비디오 클라우드 고객층 80% 이상의 라이브 룸 랙 문제는 호스트의 업로드 정체로 인한 것입니다.

### 4.1 업로드 정체에 대한 판단
- **4.1.1: BITRATE와 NET_SPEED의 관계**
 BITRATE( = VIDEO_BITRATE + AUDIO_BITRATE )는 인코더가 초당 멀티미디어를 얼마나 생성해서 출력하는지 의미하고, NET_SPEED는 초당 실제로 데이터를 얼마나 출력하는지 의미합니다. 이에 만약 BITRATE == NET_SPEED가 정상 상태라면 푸시 스트리밍의 품질도 좋아지며, BITRATE >= NET_SPEED의 상황이 오래 지속되면 푸시 스트리밍의 품질을 보장하기 어렵습니다.
- **4.1.2: CACHE_SIZE와 DROP_CNT의 값**
BITRATE >= NET_SPEED 상황에서는 인코더에서 생성하는 멀티미디어 데이터가 호스트의 휴대폰에 쌓이게 되며, 심각도는 CACHE_SIZE 상태로 나타납니다. CACHE_SIZE가 경계선을 초과할 경우 SDK에서 자동으로 일부 멀티미디어 데이터를 삭제해 DROP_CNT이 증가합니다. 다음 그림은 전형적인 업스트림 정체로, CACHE_SIZE가 계속 **붉은색 경계선**을 웃돌고 있어 업스트림 네트워크 속도가 데이터 전송 요구사항을 충족하지 못했거나 업스트림 정체가 심각하다는 의미입니다.
![](https://main.qcloudimg.com/raw/ea350eb13c5bde411529b8e9914f705c.png)
 > ! [라이브 방송 콘솔](https://console.cloud.tencent.com/live/livestat)>[품질 모니터링]에서 다음 이미지와 비슷한 차트를 볼 수 있습니다.
 
### 4.2 타겟팅 최적화 방안
- **4.2.1 호스트에게 자동 알림**
선명도를 중시하는 시나리오에서는 적합한 UI 인터랙티브로 호스트에게 **“네트워크 상태가 좋지 않습니다. Wi-Fi가 벽을 통과하지 않도록 라우터에 가까이 가십시오.”**를 표시하는 것이 가장 좋습니다.
 RTMP SDK의 푸시 스트리밍 기능 문서의 **이벤트 처리**에 관한 소개를 참고하여 수행할 수 있습니다. 권장하는 방법은 App이 단시간 내에 연속으로 RTMP SDK의 여러 **PUSH_WARNING_NET_BUSY** 이벤트를 받을 경우 네트워크에 현재 네트워크 상태 확인을 알립니다. 호스트 본인은 업스트림 정체 상황을 비디오에서 느낄 수 없으며, 관중의 말이나 App의 알림으로만 알 수 있기 때문입니다.
- **4.2.2 합리적인 인코딩 설정**
권장하는 인코딩 설정은 다음과 같습니다. 를 참조하십시오. TXLivePush의 setVideoQuality 인터페이스에서 해당 설정을 할 수 있습니다.  

| 레벨   | 해상도| FPS| 비트레이트 | 사용 시나리오 | 
|:-------:|---------|---------|:-------:|---------|
| **표준 화질** | 360\*640 | 15 | 400kbps - 800kbps | 대역폭 원가를 중시하는 경우에는 이 레벨 선택을 권장합니다. 화질은 낮아지지만 대역폭 비용은 고화질보다 60% 낮습니다. |
| **고화질**<br>**(추천)** | 540*960 | 15 | 1200kbps | 화질을 중시하는 경우에는 이 레벨 선택을 권장합니다. 대다수의 일반 휴대폰은 선명한 화질을 제공할 수 있습니다. |
| **초고화질** | 720*1280 | 15 | 1800kbps | 사용: 작은 화면으로 시청하는 경우가 많을 경우에는 권장하지 않습니다. 큰 화면으로 시청하고 호스트 네트워크 상태가 좋은 경우 고려해볼 수 있습니다.|


## 5. 재생 최적화
![](https://main.qcloudimg.com/raw/1f221c3ecba79a706014154531a02bbd.png)

### 5.1 랙과 딜레이
위 이미지와 같이 다운스트림 네트워크에 변동이 있거나 다운스트림 대역폭의 연결이 끊길 경우 재생 중 **데이터 공백기**가 발생합니다. 그 기간 동안 App은 재생할 수 있는 멀티미디어 데이터를 획득할 수 없습니다. 시청자의 비디오 랙을 최소화하기 위해서는 App이 충분한 비디오 데이터를 캐시해 이 '공백기'를 무사히 넘겨야 합니다. 하지만 App 캐시가 너무 많은 멀티미디어 데이터는 **긴 딜레이**라는 새로운 문제를 만듭니다. 이는 상호 소통에 대한 요구사항이 높은 시나리오에는 최악의 상황으로, 딜레이를 수정하고 컨트롤하지 않으면 랙으로 인한 딜레이로 **누적 효과**가 발생합니다. 재생 시간이 길수록 딜레이 시간이 길어지며, 딜레이 수정이 잘 되었는지 여부는 플레이어의 주요 지표가 충분한지로 판단합니다. 그렇기 때문에 **딜레이와 원활함의 균형**을 잘 잡아야 합니다. 낮은 딜레이에 너무 치중하면 미약한 네트워크 변동에도 재생 시 뚜렷한 랙이 발생할 수 있습니다. 반대로 원활함에 너무 치중하면 큰 딜레이가 발생할 수 있습니다. 전형적인 예를 들면 HLS(m3u8)가 10~30초의 딜레이로 원활한 재생을 실현한 것입니다.

### 5.2 타겟팅 최적화 방안
트래픽 제어 프로세스에 관한 지식이 많지 않아도 재생을 최적화할 수 있도록 Tencent Cloud RTMP SDK는 여러 버전을 개선해 자동 조절 기술을 최적화했으며, 이를 기초로 세 가지 [딜레이 제어 방안](https://cloud.tencent.com/document/product/454/7886#Delay)을 출시했습니다.

- **자동 모드**: 주요 시나리오에 대해 잘 모를 경우 이 모드를 선택하십시오.
>TXLivePlayConfig의 setAutoAdjustCache를 활성화하면 자동 모드가 됩니다. 해당 모드에서 플레이어는 현재 네트워크 상황에 따라 딜레이를 자동으로 조절합니다. 플레이어는 기본적으로 1s~5s 구간 내에서 자동으로 딜레이 길이를 조절하며, setMinCacheTime과 setMaxCacheTime에서 기본 수치를 수정할 수 있습니다. 원활한 상황에서 최대한 관중과 호스트의 딜레이를 줄여 양질의 상호 교류 체험을 제공합니다.

- **고속 모드**: 주로 **쇼 라이브 방송** 등 양방향성이 높아 딜레이에 대한 요구가 높은 시나리오에 적합합니다.
> 고속 모드 설정 방법은 **setMinCacheTime = setMaxCacheTime = 1s**이며, 자동 모드와 고속 모드의 차이는 MaxCacheTime에 있습니다. 고속 모드는 MaxCacheTime이 낮으며, 자동 모드는 비교적 MaxCacheTime이 높습니다. 이런 효율성은 SDK 내부의 자동 관리 기술을 활용한 것으로, 랙이 걸리지 않은 상황에서 자동으로 딜레이 길이를 수정할 수 있으며, MaxCacheTime 응답 속도를 조절해 MaxCacheTime의 최대치와 관리 속도를 보수적으로 설정할수록 랙 발생 확률이 감소합니다.
 
- **원활 모드**: **게임 라이브 방송** 등 비트레이트가 높은 고화질 시나리오에 주로 사용됩니다.
> 플레이어의 setAutoAdjustCache를 비활성화하면 원활 모드가 됩니다. 해당 모드의 비활성화 처리 정책은 Adobe Flash 커널의 캐시 정책과 유사합니다. 비디오에 랙 발생 시 버퍼링이 끝날 때까지 loading 상태에 진입하며, 다음 번 방어할 수 없는 네트워크 변동이 발생할 때까지 playing 상태를 유지합니다. 기본적으로 버퍼 시간은 5s이며, setCacheTime에서 수정할 수 있습니다.
> 딜레이에 대한 요구가 높지 않은 시나리오에서는 이와 같이 단순한 모드가 더 신뢰할 수 있습니다. 이 모드는 딜레이를 늘림으로써 랙 발생 확률을 줄입니다.





