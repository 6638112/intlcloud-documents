![](https://main.qcloudimg.com/raw/c38bbed25d2953aea75f76764522e25d.png)
재생 시 랙을 발생시키는 주된 요인은 다음과 같이 세 가지가 있습니다.

- **원인1: 너무 낮은 푸시 스트리밍 프레임 레이트**
호스트의 휴대폰 성능이 떨어지거나 CPU 점유율이 높은 백그라운드 프로그램이 실행중인 경우, 비디오 프레임 레이트가 크게 저하될 수 있습니다. 일반적으로 비디오 스트리밍의 FPS가 15프레임/초 이상이어야 원활한 시청이 가능합니다. FPS가 10프레임 이하일 경우, **너무 낮은 프레임 레이트**라고 볼 수 있으며 **모든 시청자**에게 랙이 발생하게 됩니다. 단, 호스트의 화면 자체가 거의 변화가 없거나, 정적인 화면 또는 PPT 재생 등의 시나리오인 경우에는 프레임 레이트의 영향을 받지 않습니다.
- **원인2: 업로드 정체**
호스트의 휴대폰은 푸시 스트리밍 시 계속해서 멀티미디어 데이터를 생성합니다. 하지만 휴대폰의 네트워크 업로드 속도가 너무 느릴 경우에는 생성된 멀티미디어 데이터가 호스트의 휴대폰에 쌓여 업로드되지 않으며, 업로드 정체가 발생해 **모든 시청자**에게 랙이 발생하게 됩니다.

 **중국 내 ISP**가 제공하는 광대역 인터넷 패키지의 다운로드 속도는 이미 10Mbps, 20Mbps을 넘어 100Mbps, 200Mbps까지 도달했습니다. 하지만 업로드 속도는 비교적 낮게 제한되어 있어 많은 소도시들의 경우 업스트림 속도가 최대 512Kbps에 불과합니다(초당 최대 64KB 데이터 업로드 가능).
 **Wi-Fi 접속**은 IEEE 802.11에 규정된 반송파 감지 다중 접속/충돌 예방(CSMA/CA) 표준을 따릅니다. 즉, 하나의 Wi-Fi 핫스팟은 동시에 오직 하나의 휴대폰과 통신할 수 있으며, 다른 휴대폰이 핫스팟과 통신하려면 먼저 통신이 가능할지 탐지하거나 문의해야 합니다. 따라서 하나의 Wi-Fi 핫스팟을 사용하는 사람이 많아질수록 속도는 느려집니다. 동시에 Wi-Fi 신호는 건축물의 벽면에 막히고 간섭을 받습니다. 그러나 중국의 일반 가정에서 공사를 할 때 각 방에서 Wi-Fi 신호가 약해지는 문제를 고려하는 경우가 매우 드물고, 호스트 본인도 자신이 라이브 방송을 하는 방이 공유기로부터 몇 개의 벽 너머에 있는지 알 수 없습니다.
- **원인3: 다운스트림 문제**
시청자의 다운로드 대역폭이 충분하지 못하거나 네트워크 변동이 큰 경우입니다. 예를 들어 라이브 방송 스트림의 비트 레이트가 2Mbps일 때 초당 2M 비트의 데이터 스트림이 다운로드되는데 시청자의 대역폭이 부족할 경우에는 재생 시 랙이 발생할 수 있습니다. 다운스트림 문제는 현재 네트워크에 있는 시청자에게만 영향을 미칩니다.

## SDK 상태 알림 정보 조회
Tencent Cloud의 V-cube·MLVB SDK를 사용해 스트림을 푸시하는 경우, 해당 SDK에서 1 ~ 2초마다 내부의 각종 매개변수를 피드백하는 상태 피드백 메커니즘을 제공하며, TXLivePushListener 리스너를 등록해 상태를 확인할 수 있습니다. 관련 상태에 관한 설명은 다음과 같습니다.
![](https://main.qcloudimg.com/raw/533391ae5c188ed87b748f78d8168591.png)

|  푸시 스트리밍 상태                   |  의미 설명                    |
| :------------------------  |  :------------------------ |
| NET_STATUS_CPU_USAGE     |현재 프로세스의 CPU 사용률과 기기 전체의 CPU 사용률. |
|	NET_STATUS_VIDEO_FPS     | 현재 비디오 프레임 레이트. 즉, 각 비디오 인코더가 생성한 프레임 수. |
|	NET_STATUS_NET_SPEED     | 현재 전송 속도(단위:kbps). |
|	NET_STATUS_VIDEO_BITRATE | 현재 비디오 인코더의 출력 비트 레이트. 즉, 인코더가 초당 생성하는 비디오 데이터의 양. 단위: kbps. |
|	NET_STATUS_AUDIO_BITRATE | 현재 오디오 인코딩 출력 비트 레이트. 즉, 인코더가 초당 생성하는 오디오 데이터의 양(단위: kbps). |
|	NET_STATUS_CACHE_SIZE    | 멀티미디어 데이터의 누적 상태로, 해당값이 한 자리 수 이상이면 현재 업스트림 대역폭이 이미 생성된 멀티미디어 데이터를 소비하기에 충분하지 않음을 나타냄. |
|NET_STATUS_CODEC_DROP_CNT  |전역 패킷 손실 횟수. 딜레이로 악성 힙이 지속되는 것을 막기 위해 SDK는 데이터가 한도 이상으로 축적되면 자동으로 패킷을 손실시키며, 패킷 손실 횟수가 많을수록 네크워크 문제가 심각하다는 것을 의미함. |
| NET_STATUS_SERVER_IP     | 연결한 푸시 스트리밍 서버의 IP. 일반적으로는 클라이언트에서 가까워 홉 수가 비교적 적은 서버. |

##  너무 낮은 프레임 레이트 문제 해결
### 1. 너무 낮은 프레임 레이트인지 판단
MLVB SDK의 TXLivePushListener의 **VIDEO_FPS** 상태 데이터를 통해 현재 푸시 스트리밍의 비디오 프레임 레이트를 확인할 수 있습니다. 일반적으로 비디오 스트리밍이 초당 15프레임 이상이어야 원활한 시청이 가능하며, FPS가 10프레임 이하일 경우 시청자가 화면의 랙을 확연히 느낄 수 있습니다.

### 2. 맞춤형 최적화 솔루션
- **2.1 CPU_USAGE 크기 모니터링**
MLVB SDK의 TXLivePushListener의 **CPU_USAGE** 상태 데이터를 통해 **현재 푸시 스트리밍 SDK의 CPU 점유율**과 **현재 시스템의 CPU 점유율**을 확인할 수 있습니다. 현재 시스템의 전체 CPU 사용률이 80%를 초과하면 비디오의 수집과 인코딩 모두 영향을 받아 정상적인 작동이 불가능합니다. CPU 사용률이 100%에 도달하면 호스트 자체에 랙이 걸리기 때문에 시청자들이 원활한 시청을 할 수 없습니다.

- **2.2 CPU 사용자 확인**
한 라이브 방송 App에서 CPU를 사용하는 것은 스트리밍 SDK뿐만이 아닙니다. 댓글 자막, 이모티콘, 텍스트 메시지 인터랙션 등에서도 불가피하게 CPU를 소모할 수 있습니다. 푸시 스트리밍 SDK의 CPU 점유 상황만을 테스트하려면 [라이트 버전 DEMO](https://intl.cloud.tencent.com/document/product/1071/38147)를 사용해 모니터링하고 평가하십시오.

- **2.3 과도한 고해상도 설정 지양**
해상도가 높을수록 반드시 화질이 선명한 것은 아닙니다. 먼저, 높은 해상도에는 높은 비트 레이트가 필요하며, 낮은 비트 레이트와 높은 해상도의 화질이 높은 비트 레이트와 낮은 해상도의 화질보다 못한 경우가 많습니다. 그리고 평균 5인치 정도의 휴대폰 화면에서는 1280 x 720와 960 x 540의 해상도 차이를 뚜렷하게 느끼기 어렵고 PC에서 풀 스크린으로 시청해야만 명확한 차이를 느낄 수 있습니다. 그러나 해상도를 높게 설정하면 SDK의 CPU 사용률이 눈에 띄게 증가하며, 원하는 만큼의 고화질을 얻지 못할 수도 있습니다. 일반적인 경우에는 MLVB SDK에서 TXLivePusher의 setVideoQuality를 사용해 **HD**로 설정하는 것을 권장합니다.

- **2.4 적절한 하드웨어 가속 사용**
최신 스마트폰은 모두 하드웨어 인코딩을 지원해 비디오 인코딩 CPU에 대한 의존도를 낮췄습니다. 현재 App의 CPU 사용률이 지나치게 높다면 하드웨어 인코딩을 사용해 CPU 사용률을 낮출 수 있습니다. TXLivePusher의 setVideoQuality의 **HD**는 기본적으로 소프트웨어 인코딩(하드웨어 인코딩은 일부 Android 휴대폰에서는 효과가 좋지 않아 모자이크 느낌이 강함)을 사용합니다. 하드웨어 인코딩을 사용해야 하는 경우, TXLivePushConfig의 enableHWAcceleration 옵션을 활성화하십시오.

## 업로드 정체 문제 해결
통계에 따르면 비디오 클라우드 고객의 라이브 룸 랙 문제의 80% 이상은 호스트의 업로드 정체로 인한 것입니다.

### 1. 업로드 정체에 대한 판단
- **1.1: BITRATE와 NET_SPEED의 관계**
 BITRATE( = VIDEO_BITRATE + AUDIO_BITRATE )는 인코더가 초당 멀티미디어를 얼마나 생성해서 출력하는지 의미하고, NET_SPEED는 초당 실제로 데이터를 얼마나 출력하는지 의미합니다. 이에 만약 BITRATE == NET_SPEED가 정상 상태라면 푸시 스트리밍의 품질도 좋아지며, BITRATE >= NET_SPEED의 상황이 오래 지속되면 푸시 스트리밍의 품질을 보장하기 어렵습니다.
  
- **1.2: CACHE_SIZE와 DROP_CNT의 값**
BITRATE >= NET_SPEED 상황이 발생하면 인코더에서 생성하는 멀티미디어 데이터가 호스트의 휴대폰에 쌓이게 되며, 그 심각도는 CACHE_SIZE 상태값으로 표시됩니다. CACHE_SIZE가 경계선을 초과할 경우 SDK에서 자동으로 일부 멀티미디어 데이터를 삭제해 DROP_CNT를 증가시킵니다. 다음은 전형적인 업스트림 정체를 나타낸 이미지로, CACHE_SIZE가 계속 **붉은색 경계선**을 웃돌고 있는 것은 업스트림 네트워크 속도가 데이터 전송 요구사항을 충족하지 못해 업스트림 정체가 심각하다는 것을 의미합니다.
![](https://main.qcloudimg.com/raw/c894db6a9745543a349683745c4ba491.png)


 >? [[라이브 방송 콘솔]](https://console.cloud.tencent.com/live/livestat)>[통계 분석]에서 위의 이미지와 비슷한 차트를 볼 수 있습니다.

### 2. 맞춤형 최적화 솔루션
- **2.1 호스트에게 자동 알림**
해상도가 중요한 시나리오에서는 적합한 UI 인터랙티브를 통해 호스트에게 **“네트워크 상태가 좋지 않습니다. Wi-Fi 벽 통과로 인한 수신율 감도가 저하될 수 있으니 공유기에 가까이 가십시오.”**와 같은 알림을 표시해 주는 것이 가장 좋습니다.
MLVB SDK의 푸시 스트리밍 기능 문서의 **이벤트 처리**에 관한 소개를 참고하여 실행할 수 있습니다. App이 단시간 내에 연속으로 MLVB SDK의 여러 [ **PUSH_WARNING_NET_BUSY**](https://intl.cloud.tencent.com/document/product/1071/41678)이벤트를 받을 경우 호스트에게 현재 네트워크 상태를 확인하라고 알려주는 방법을 권장합니다. 호스트 본인은 비디오를 통해 업스트림 정체 상황을 감지할 수 없기 때문에 시청자나 App의 알림을 통해 상황을 알 수 밖에 없습니다.

- **2.2 합리적인 인코딩 설정**
권장하는 인코딩 설정은 다음과 같습니다. (이는 뷰티쇼에 적합하며 자세한 내용은 [더 나은 화질을 얻는 방법](https://intl.cloud.tencent.com/document/product/1071/41932)을 참고하십시오.) TXLivePusher의 setVideoQuality 인터페이스에서 해당 설정을 할 수 있습니다.  
<table>
<tr><th width="15%">화질 수준</th>
<th width="15%">해상도</th>
<th width="5%">FPS</th>
<th width="20%">비트 레이트</th>
<th width="45%">사용 시나리오</th>
</tr><tr>
<td><b>SD</td>
<td>360 * 640</td>
<td>15</td>
<td>400kbps - 800kbps</td>
<td>대역폭 비용을 중요시하는 경우에 적합합니다. 화질은 낮아지지만 대역폭 비용은 HD보다 60% 저렴합니다.</td>
</tr><tr>
<td><b>HD(권장)</td>
<td>540 * 960</td>
<td>15</td>
<td>1200kbps</td>
<td>화질을 중요시하는 경우에 적합합니다. 대다수의 일반 휴대폰에서 선명한 화질을 제공할 수 있습니다.</td>
</tr><tr>
<td><b>HD+</td>
<td>720 * 1280</td>
<td>15</td>
<td>1800kbps</td>
<td>신중히 사용: 해당 설정은 상황에 유의하여 사용하십시오. 주로 작은 화면으로 시청하는 경우에는 적합하지 않으며, 호스트 네트워크 상태가 매우 양호하고 큰 화면으로 시청하는 경우 사용을 고려해볼 수 있습니다.</td>
</tr></table>


## 플레이어 최적화
![](https://main.qcloudimg.com/raw/1f221c3ecba79a706014154531a02bbd.png)

### 1. 랙과 딜레이
위 이미지와 같이 다운스트림 네트워크에 변동이 있거나 다운스트림 대역폭의 연결이 끊길 경우 재생 중 **데이터 공백기**(이 기간 동안 App은 재생할 수 있는 멀티미디어 데이터를 획득할 수 없음)가 발생합니다. 시청자의 비디오 랙을 최소화하기 위해서는 App이 충분한 비디오 데이터를 캐싱해 이 '공백기'를 무사히 넘겨야 합니다. 하지만 App 캐시가 너무 많은 멀티미디어 데이터는 **긴 딜레이**라는 새로운 문제를 만듭니다. 이는 인터랙션에 대한 요구치가 높은 시나리오에는 최악의 상황으로, 딜레이를 수정하고 컨트롤하지 않으면 랙으로 인한 딜레이로 재생 시간이 길수록 딜레이 시간이 길어지는 **누적 효과**가 발생합니다. 이 때, 딜레이 수정이 잘 되었는지 여부는 플레이어의 성능을 판단하는 주요 지표입니다. 그렇기 때문에 **딜레이와 원활한 재생의 균형**을 잘 잡아야 합니다. 저지연성에 너무 치중하면 미약한 네트워크 변동에도 재생 시 뚜렷한 랙이 발생할 수 있습니다. 반대로 원활한 재생에 너무 치중하면 긴 딜레이가 발생할 수 있습니다. (전형적인 사례: HLS(m3u8)가 20~30초의 딜레이로 원활한 재생을 구현)

### 2. 맞춤형 최적화 솔루션
Tencent Cloud MLVB SDK는 사용자가 트래픽 제어 프로세스에 관한 많은 지식 없이도 재생을 최적화할 수 있도록 여러 버전을 개선해 자동 조절 기술을 최적화했으며, 이를 바탕으로 세 가지 딜레이 제어 솔루션을 제공합니다.

- **자동 모드**: 주요 시나리오에 대해 잘 모를 경우 이 모드를 선택하십시오.
>?TXLivePlayConfig의 setAutoAdjustCache를 활성화하면 자동 모드로 설정됩니다. 해당 모드에서 플레이어는 현재 네트워크 상황에 따라 딜레이를 자동으로 조절(플레이어는 기본적으로 1 ~ 5초 내에서 자동으로 딜레이 길이를 조절하며, setMinCacheTime과 setMaxCacheTime에서 기본값을 수정 가능)함으로써 원활한 상황에서 시청자와 호스트의 딜레이를 최대한 줄여 뛰어난 인터랙션을 구현합니다.

- **고속 모드**: 주로 **라이브 쇼** 등 양방향성이 높고 딜레이에 대한 요구가 높은 시나리오에 적합합니다.
>? **setMinCacheTime = setMaxCacheTime = 1s**로 설정하여 고속 모드로 전환할 수 있으며, 자동 모드와 고속 모드의 차이는 MaxCacheTime에 있습니다(고속 모드는 MaxCacheTime이 낮고, 자동 모드는 MaxCacheTime이 상대적으로 높음). 이렇게 유연한 SDK의 자동 조절 기술을 활용하여, 랙이 걸리지 않은 상황에서 자동으로 딜레이 길이를 수정할 수 있습니다. 또한 MaxCacheTime 조절 속도를 반영하는데, MaxCacheTime의 값이 클수록 속도를 보수적으로 조절하여 랙이 걸릴 확률도 낮아집니다.

- **원활 모드**: **게임 라이브 방송** 등 비트 레이트가 높은 고화질 시나리오에 주로 사용됩니다.
>? 
>- 플레이어의 setAutoAdjustCache를 비활성화하면 원활 모드가 됩니다. 해당 모드의 비활성화 처리 정책은 Adobe Flash 커널의 캐시 정책과 유사합니다. 비디오에 랙 발생 시 버퍼링이 끝날 때까지 loading 상태에 진입하며, 이후 방어할 수 없는 네트워크 변동이 발생할 때까지 playing 상태를 유지합니다. 기본적으로 버퍼 시간은 5초이며, setCacheTime에서 수정할 수 있습니다.
>- 딜레이에 대한 요구가 높지 않은 시나리오에서는 이와 같이 약간의 딜레이를 허용함으로써 랙 발생 확률을 줄이는 단순한 모드가 더 안정적입니다.

