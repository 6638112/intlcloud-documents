![](https://main.qcloudimg.com/raw/c38bbed25d2953aea75f76764522e25d.png)
再生側にラグが発生する主な原因は以下の3種類です。

- **原因1：プッシュフレームレートが低すぎる**
キャスターのスマートフォンのパフォーマンスが低い場合、またはバックグラウンドでCPU使用率の高いプログラムを実行中の場合は、ビデオのフレームレートを著しく低下させてしまうことがあります。通常、スムーズな表示を保証するためには、FPSが毎秒15フレーム以上のビデオストリームが必要です。FPSが10フレーム未満の場合は、**フレームレートが低すぎる**と判断できます。このことによって、**すべての視聴者**の視聴体験に大幅なラグが生じます。もちろん、静的画面またはPPT再生等のケースのように、キャスター側の画面自体の変化が非常に少ない場合は、この原因の影響を受けません。
- **原因2: アップロードの渋滞**
プッシュ時に、キャスターのスマートフォンは、オーディオおよびビデオデータが継続的に生成されますが、スマートフォンのアップロードスピードが遅すぎると、生成されたオーディオおよびビデオデータがキャスターのスマートフォンに蓄積され送信できなくなります。アップロード時の渋滞によって、**すべての視聴者**の視聴体験に大幅なラグが生じます。

 **中国本土キャリア**で提供されるブロードバンドパッケージでは、ダウンロード速度は10Mbps、20Mbps、さらには100Mbps、200Mbpsに達していますが、アップロード速度は制限されています。多くの小都市での最大上り速度は512Kbpsです（つまり、毎秒、64KBを上限とするデータしかアップロードできません）。
 **Wi-Fi**は、IEEE 802.11が規定する搬送波感知多重アクセス／衝突回避方式（CSMA/CA）に準拠します。つまり、1つのWi-Fiホットスポットは1台のスマートフォンとしか同時に通信できず、スマートフォンはホットスポットと通信する前にまず通信できるかどうかを確認または照会する必要があるため、1つのWi-Fiホットスポットを使用する人数が多いほど速度が遅くなります。またWi-Fi信号は建物の壁によって著しく遮断されますが、通常、中国の平均的な家庭では内装時にWi-Fiルーターの位置と各部屋の信号の強度の問題をほとんど考慮していないため、キャスター自身もライブストリーミングを実行する部屋が屋内のルーターからいくつの壁を隔てているか、よくわかっていない可能性があります。
- **原因3： 下り接続の不良**
例えばCSSストリームのビットレートが2Mbps、つまり毎秒2Mビットのデータストリームのダウンロードで、視聴者の帯域幅が不足している場合のように、視聴者のダウンロード帯域幅が不足またはネットワーク状態が不安定なときは、視聴者側の再生体験に著しいラグが生じることとなります。下り接続の不良は現在のネットワーク環境下の視聴者にのみ影響を及ぼします。

## SDKステータスプロンプト情報を確認
Tencent Cloud View Cube・MLVB SDKを使用してプッシュする場合、そのSDKは一種のステータスフィードバックメカニズムを提供しており、1～2秒間隔で内部の各ステータスパラメータをフィードバックします。TXLivePushListenerリスナーを登録することで、これらのステータスを取得できます。関連するステータスは以下で説明いたします。
![](https://main.qcloudimg.com/raw/533391ae5c188ed87b748f78d8168591.png)

|  プッシュ状態                   |  定義と説明                    |
| :------------------------  |  :------------------------ |
| NET_STATUS_CPU_USAGE     |現在のプロセスのCPU使用率とマシン全体のCPU使用率|
|NET_STATUS_VIDEO_FPS     | 現在のビデオフレームレート、つまりビデオエンコーダーによって作成されるフレーム数|
|	NET_STATUS_NET_SPEED     | 現在の送信速度。単位：kbps。|
|NET_STATUS_VIDEO_BITRATE | 現在のビデオエンコーダーによって出力されるビットレート、つまりエンコーダーが毎秒作成するビデオデータ数。単位： kbps|
|	NET_STATUS_AUDIO_BITRATE | 現在のオーディオコーデックによって出力されるビットレート、つまりエンコーダーが毎秒作成するオーディオデータ数。単位：kbps。|
|NET_STATUS_CACHE_SIZE    | 蓄積されたオーディオおよびビデオデータのサイズ、この数字が10以上の場合、現在の上り帯域幅では生成されたオーディオおよびビデオデータを消費するには不充分であることを意味します|
|NET_STATUS_CODEC_DROP_CNT  |グローバルパケットロス回数、ディレイの継続的かつ悪質な蓄積を回避するため、データのバックログが警告ラインを超えた場合に、SDKは自動的にパケットロスを発生させます。パケットロス回数が多いほど、ネットワークの問題が深刻であることを意味します。|
| NET_STATUS_SERVER_IP     | 接続されたプッシュサーバーのIP、通常、クライアントからのホップ数が少ない最寄りのサーバーである必要があります。 |

##  フレームレートが低すぎる問題を解決
### 1. フレームレートが低すぎるかどうかの判断
モバイルライブストリーミングSDKのTXLivePushListenerの**VIDEO_FPS**ステータスデータを介して、現在プッシュされるビデオフレームレートを取得できます。通常、スムーズな視聴を保証するためには、毎秒15フレーム以上のビデオストリームが必要です。FPSが10フレーム以下の場合、視聴者は明らかに画面のラグを感じます。

### 2. 的を絞った最適化計画
- **2.1 CPU_USAGEのサイズを観察**
モバイルライブストリーミングSDKのTXLivePushListenerの**CPU_USAGE**ステータスデータを介して、**現在のプッシュSDKのCPU使用状況**と**現在のシステムのCPU使用状況**を取得できます。現在のシステム全体のCPU使用率が80%を超えると、ビデオキャプチャとエンコードがいずれも影響を受け、正常に機能しなくなります。CPU利用率が100%に達すると、キャスター自体の動作が極めて遅くなり、視聴者のスムーズな視聴体験は不可能となります。

- **2.2 CPUを消費しているものを確認**
ライブストリーミングのAppでCPUを使用するのは、プッシュSDKだけではなく、弾幕、キラキラエフェクト、テキストメッセージのやり取りなども一定量のCPUを消費する可能性があり、これらはいずれも避けようがありません。プッシュSDKのCPU利用状況を測定したいだけの場合は、当社の[簡易版DEMO](https://intl.cloud.tencent.com/document/product/1071/38147)を使用して観察と評価を行うことができます。

- **2.3 高解像度を盲目的に追及しない**
ビデオ解像度が高すぎても、必ずしも鮮明な画質が得られるとは限りません。まず高解像度は、高ビットレートと組み合わせて効果を発揮させる必要があります。多くの場合、低ビットレートで高解像度であるより、高ビットレートで低解像度の方が解像度が良くなります。次に、1280×720の解像度の場合、平均約5インチのスマートフォン画面では優位性が感じられません。960×540の解像度との違いを明かに感じるのは、PCのフルスクリーンで表示した場合だけです。ただし解像度を高くすると、SDKのCPU使用率が大幅に上昇するため、通常はMLVB SDKのTXLivePusherのsetVideoQualityを使用して**HD**レベルに設定することをお勧めします。やみくもに高解像度を追い求めても、所期の目的を達成できない場合があります。

- **2.4 ハードウェアアクセラレーションの適切な使用**
現在のスマートフォンでは、ビデオコーデックのCPUへの依存を低減するためのハードウェアエンコーディングをサポートしています。AppのCPU使用率が高すぎる場合は、ハードウェアエンコーディングを有効にしてCPU使用率を低減することができます。TXLivePusherのsetVideoQualityの**HD度レベル**はデフォルトでソフトウェアエンコーディングを使用します（ハードウェアエンコーディングは一部のAndroidスマートフォンではうまく機能せず、モザイク感が非常に強くなります）。ハードウェアエンコーディングを使用したい場合は、TXLivePushConfigのenableHWAccelerationオプションを使用して有効化することができます。

## アップロードの渋滞問題の解決
統計によると、ビデオクラウド顧客グループのライブストリーミングルームにおけるラグトラブルの80％以上は、キャスターのアップロードの渋滞が原因です。

### 1. アップロードの渋滞の判断
- **1.1： BITRATEとNET_SPEEDの関係**
 BITRATE( = VIDEO_BITRATE + AUDIO_BITRATE ) は、エンコーダーが毎秒生成してプッシュするオーディオおよびビデオデータの量を表示し、NET_SPEEDは、毎秒、実際にプッシュされるデータの量を表示します。したがって常にBITRATE == NET_SPEEDの状況であれば、プッシュ品質は非常に良好となります。一方、BITRATE >= NET_SPEEDの状況が長時間継続する場合は、プッシュ品質を保証することは困難です。
  
- **1.2 ： CACHE_SIZEとDROP_CNTの数値**
BITRATE >= NET_SPEEDの状況が発生すると、エンコーダーによって生成されたオーディオおよびビデオデータがキャスターのスマートフォンにバックログされます。バックログの重大度はCACHE_SIZEの状態値で表示され、CACHE_SIZEが警告ラインを超えると、SDKは一部のオーディオおよびビデオデータを自動的にドロップさせ、DROP_CNT の増加がトリガーされます。下図は代表的な上り渋滞を表示するものであり、途中の CACHE_SIZEは一貫して**赤い警告ライン**以上となっています。これは上りネットワークがデータの伝送ニーズを満たすには不充分であること、つまり上りの渋滞が深刻であることを意味しています。
![](https://main.qcloudimg.com/raw/c894db6a9745543a349683745c4ba491.png)


 >? [【CSSコンソール】](https://console.cloud.tencent.com/live/livestat)>【統計分析】で上図のようなチャートを見ることができます。

### 2. 的を絞った最適化計画
- **2.1 キャスターへの自発的な促し**
解像度が重要なシーンでは、**「現在のネットワーク品質が非常に不良であるため、ルーターの近くに移動し、Wi-Fi信号を壁で隔てないことをお勧めする」**のが最良の選択であるというプロンプトを、適切なUIを介してキャスターに表示します。
MLVB SDKのプッシュ機能ドキュメントには**イベント処理**の説明が含まれており、これを利用して実行することができます。推奨される方法は次のとおりです。Appが短時間にMLVB SDKの複数の[**PUSH_WARNING_NET_BUSY**](https://intl.cloud.tencent.com/document/product/1071/41678)イベントを継続的に受信する場合は、現在のネットワーク品質に注意を払うようキャスターのネットワークにプロンプトを表示します。これは、上りの輻輳については、キャスター本人がビデオのパフォーマンスから認識できず、視聴者やAppの注意喚起によってのみ認識できるからです。

- **2.2 合理的なエンコードの設定**
推奨されるエンコード設定は次のとおりです（ビューティーショーライブ配信に最適です。詳細については、[画質を良くする方法](https://intl.cloud.tencent.com/document/product/1071/41932)をご参照ください）。TXLivePusherのsetVideoQualityインターフェースを介して対応するレベルを設定できます。
<table>
<tr><th width="15%">レベル</th>
<th width="15%">解像度</th>
<th width="5%">FPS</th>
<th width="20%">ビットレート</th>
<th width="45%">ユースケース</th>
</tr><tr>
<td><b>SD</td>
<td>360 * 640</td>
<td>15</td>
<td>400kbps - 800kbps</td>
<td>帯域幅コストを重視する場合は、このレベルを選択することをお勧めします。画質は不明瞭ですが、帯域幅コストはHDより60%低く抑えられます。</td>
</tr><tr>
<td><b>HD（推奨）</td>
<td>540 * 960</td>
<td>15</td>
<td>1200kbps</td>
<td>画質を重視する場合は、このレベルを選択することをお勧めします。大多数のスマートフォンで非常にクリアな画像を表示できます。</td>
</tr><tr>
<td><b>FHD</td>
<td>720 * 1280</td>
<td>15</td>
<td>1800kbps</td>
<td>慎重に使用：シーンの大部分を小画面で視聴する場合はお勧めしません。大画面で視聴し、かつキャスターネットワークの品質が極めて良好な場合に検討することができます。</td>
</tr></table>


## 再生端末の最適化
![](https://main.qcloudimg.com/raw/1f221c3ecba79a706014154531a02bbd.png)

### 1. ラグ&ディレイ
上図に示すとおり、下りネットワークが不安定である場合、または下り帯域幅が滞る場合は、いずれも再生中に**飢餓時間**が出現します（App はこの期間中は再生可能なオーディオおよびビデオデータを取得できません）。視聴端末でのビデオラグを最小限に抑制し、この「飢餓時間」を無事にやり過ごすためには、Appにできるだけ多くのビデオデータをキャッシュさせる必要があります。しかし、Appにオーディオおよびビデオデータを多くキャッシュさせ過ぎると、新たな問題 **高ディレイ**が生じるおそれがあります。これはインタラクティブ性の要件が高いシナリオにとって非常に悪いニュースです。またディレイが修正、制御されない場合、ラグによって引き起こされたディレイには**累積効果**があり、再生時間が長くなればなるほど、ディレイも大きくなります。ディレイの修正が適切に行われるかどうかがプレーヤーの優劣を判断する重要な指標となります。したがって、**ディレイとスムーズさはバランスが重要**であり、低ディレイを強調しすぎると、軽微なネットワークの不安定性を引き起こし、顕著な再生端末のラグを発生させてしまいます。反対に、スムーズさを強調しすぎると、多くのディレイ（典型的なケースでは、HLS（m3u8）が20秒から30秒のディレイの発生により、スムーズな再生体験を実現します）が発生してしまうことになります。

### 2. 的を絞った最適化計画
トラフィック制御処理について詳しくなくても、より良いビデオ再生エクスペリエンスを最適化できるように、Tencent Cloud MLVB SDKは複数のバージョンの改良により、一連の自動調節技術を最適化し、3種類の優れたディレイ制御方式をリリースしました。

- **自動モード**：主たるシナリオが確定していない場合は、このモードを直接選択できます。
>? 自動モードにするには、TXLivePlayConfig のsetAutoAdjustCacheスイッチをオンにします。このモードでプレーヤーは現在のネットワーク状況に応じて、ディレイを自動的に調節し（デフォルトの状況では、プレーヤーは1秒～5秒間隔でディレイを自動調整します。なおsetMinCacheTimeとsetMaxCacheTimeでデフォルト値を修正できます）、充分スムーズな状況で、視聴者とキャスターと間のディレイを可能な限り低減することができ、良好なインタラクティブ体験を実現します。

- **超高速モード**：**ショーのライブストリーミング**などのインタラクティブ性が高く、ディレイ要件が厳しいシーンに最適です。
>? 超高速モードの設定方法は、**setMinCacheTime = setMaxCacheTime = 1s**であり、自動モードと超高速モードの違いはMaxCacheTimeがやや異なるだけです（超高速モードのMaxCacheTimeは通常やや低く、自動モードのMaxCacheTimeはやや高くなっています）。この柔軟性は主にSDK内部の自動調節技術によるもので、ラグの原因とならずにディレイサイズを自動的に修正できます。MaxCacheTimeは調節速度を反映し、MaxCacheTimeの値が大きいほど、調節速度も保守的となり、ラグの確率も低くなります。

- **スムーズモード**：主に**ゲームライブストリーミング**などの高ビットレートHDライブストリーミングシーンに最適です。
>? 
>- プレーヤーのsetAutoAdjustCacheスイッチをオフにすると、スムーズモードになります。プレーヤーはこのモードで、Adobe Flashカーネルのキャッシュポリシーと同じ処理ポリシーを採用します。ビデオにラグが発生すると、バッファがいっぱいになるまでloadingステータスとなり、その後、次にネットワークが制御出来ないほど不安定になるまでplayingステータスとなります。デフォルトのバッファサイズは5秒ですが、setCacheTimeにより変更できます。
>- ディレイ要件が高くないシーンでは、この一見シンプルなモードの方が信頼性は高くなります。このモードが本質的にわずかなディレイを犠牲にしてラグ率を低下させるためです。

