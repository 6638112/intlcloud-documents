>!MPSの「ワークフロー管理」は「サービスオーケストレーション管理」にアップグレードされました。サービスオーケストレーション管理によって、より柔軟で便利なサービスフロー設定が可能になります。MPS製品をさらに活用するために、サービスオーケストレーション管理ページでサービスフローの設定を行ってください。


## 操作シナリオ
ワークフロー設定後、指定されたBucketとディレクトリ下にアップロードされたビデオは自動的にメディア処理がトリガーされ、出力ファイルは指定されたBucketとディレクトリに書き込まれます。ワークフローにはトランスコードタスク、スクリーンキャプチャタスク、アニメーション画像生成タスク、審査タスク、コンテンツ認識タスク、コンテンツ分析タスク、およびウォーターマーク追加が設定できます。

## ワークフローの作成[](id:create)
1. [MPSコンソール](https://console.cloud.tencent.com/mps)にログインし、**ワークフロー管理**をクリックして、「ワークフロー管理」ページに進みます。
2. **ワークフローの作成**をクリックして、ワークフロー作成ページに進み、ここでワークフロー名、トリガーBucket、トリガーディレクトリ、出力Bucket、出力ディレクトリ、設定項目およびイベント通知を設定する必要があります。具体的な設定方法については、[ワークフロー設定の説明](#workflow)をご参照ください。
![](https://qcloudimg.tencent-cloud.cn/raw/e46b738c267c5b34715abd01cc577b2d.png)

ワークフロー作成ページでは、以下の情報を設定する必要があります。
<table>
<tr><th width=15%>設定項目<a id="workflow"></a></th><th>入力必須かどうか</th><th>設定説明</th></tr>
<tr>
<td>ワークフロー</td>
<td>はい</td>
<td>128文字以内の中国語、英語、数字、アンダーバーとハイフン<code>（_-）</code>を組み合わせて入力できます（例：「MPS」）。</td>
</tr><tr>
<td>トリガーBucket</td>
<td>はい</td>
<td>このAPPID下に作成したBucketから1つを選択し、トリガーBucketとすることができます。ワークフローの開始後、ビデオファイルをこのBucketにアップロードすると、ワークフローの実行を自動的にトリガーすることができます。</td>
</tr><tr>
<td>トリガーディレクトリ</td>
<td>いいえ</td>
<td>スラッシュ<code>（/）</code>を末尾につけます。入力しない場合は、トリガーBucketのすべてのディレクトリが有効になります。</td>
</tr><tr>
<td>出力Bucket</td>
<td>はい</td>
<td>デフォルトはトリガーBucketと同じですが、当該APPIDのトリガーBucketと同じリージョンのBucketから1つを選択し、出力Bucketとすることができます。ワークフローの処理が完了した後、新しく生成されたビデオファイルはこのBucketに保存されます。</td>
</tr><tr>
<td>出力ディレクトリ</td>
<td>いいえ</td>
<td>スラッシュ<code>（/）</code>を末尾につけます。入力しない場合、出力ディレクトリはトリガーディレクトリとの一致を維持します。</td>
</tr><tr>
<td>イベント通知の有効化</td>
<td>いいえ</td>
<td>
<ul style="margin:0"><li>デフォルトでは無効になっています。イベント通知を有効化する場合、具体的な設定方法については<a href="#recall">コールバック方式のタイプ設定</a>をご参照ください。</li><li>TDMQ-CMQイベント通知を有効化したい場合は、<a href="https://console.cloud.tencent.com/tdmq/cmq-queue?rid=1">メッセージキューTDMQ</a> に移動してサービスをアクティブ化し、モデルを作成してください。イベント通知を有効化すると、指定したCMQがMPSのイベント通知を受信します。</li></ul></td>
</tr><tr>
<td>設定項目</td>
<td>はい</td>
<td>トランスコードタスク、スクリーンキャプチャタスク、アニメーション画像生成タスク、審査タスク、コンテンツ認識タスク、コンテンツ分析タスクのうち、少なくとも1項目を選択して設定します。詳細については、<a href="#p1">タスク設定の説明</a>をご参照ください。</td>
</tr></table>
<table>
<tr><th>コールバック方式のタイプ<a id="recall"></a></th><th>設定説明</th></tr>
<tr>
<td>TDMQ-CMQコールバック</td>
<td>
<ul style="margin:0">
<li>TDMQ-CMQモデル：キューモデルまたはトピックモデルを選択できます。デフォルトではキューモデルが選択されています。</li>
<li>TDMQ-CMQエリア：広州、上海、北京、上海金融、深圳金融、中国香港、成都、北アメリカエリアまたはアメリカ西部を選択可能です。</li>
<li>キュー名/トピック名：カスタマイズできます。</li>
</ul>
</td>
</tr>
<tr>
<td>HTTPコールバック</td>
<td>タスクのイベント通知設定インターフェース<a href="https://intl.cloud.tencent.com/document/product/1041/33690#TaskNotifyConfig">TaskNotifyConfig</a>を呼び出す際、NotifyTypeパラメータにはURLを指定し、NotifyUrlパラメータにHTTPコールバックアドレスを入力する必要があります。
</td>
</tr>
<tr>
<td>SCFコールバック</td>
<td><a href="https://console.cloud.tencent.com/scf/list-create?rid=1&ns=default&keyword=mps">SCF操作に進む</a>をクリックし、設定操作を行うことができます。具体的な設定方法については、<a href="https://intl.cloud.tencent.com/document/product/1041/40337">ビデオタスクコールバック通知</a>をご参照ください。<br>SCFコールバック設定はすべてのワークフローが対象となります。現在、ワークフローでは設定状態を保存しません。</td>
</tr>
</table>


## イベント通知[](id:event)
### Cloud Message Queue（CMQ）によるイベント通知の完了
- イベント通知をオンにした後（イベント通知はデフォルトではオフ）、ユーザーはCloud Message Queueモデルの中からキューモデルまたはトピックモデルを選択し、選択したモデルの名前とリージョンを入力することができます。設定完了後、指定されたCMQはMPSのイベント通知を受信します。
- CMQイベント通知は、ユーザーがCMQサービスをアクティブ化し、キューモデルまたはトピックモデルを作成した後にご利用いただくことができます。詳細は [Cloud Message Queue](https://intl.cloud.tencent.com/document/product/406/8435)をご参照ください。

### Serverless Cloud Function（SCF）によるイベント通知の完了
関数処理サービスにより、MPSが生成したコールバックイベントに対する処理および操作を迅速に完了することができます。全体的なデータ処理フローチャートは次のとおりです。
<img src="https://main.qcloudimg.com/raw/02656fefa8e2f61f71252727747b7a02.png" style="zoom: 67%;" />
MPSトリガーによりイベントをSCF関数側にプッシュし、さらにserverlessアーキテクチャの関数計算によりコールバックイベントの処理およびレスポンスを提供します。

#### 関数処理シーンの実践
Cloud Log Serviceは、ログトピックの中のデータをMPSログトリガーによりServerless Cloud Functionへ配信して処理を行うことができ、ビデオに対してイベント通知、状態監視、アラート処理などを行うユースケースの機能を満たします。

| 関数処理シーン         | 説明                                                |
| -------------------- | ------------------------------------------------------- |
| ビデオタスクのコールバックをCOSにバックアップ | MPSが生成したコールバックタスクをSCFによってCOSに速やかにバックアップします。          |
| ビデオタスクのコールバック通知     | MPSのデータメッセージをリアルタイムに受信し、メッセージをWeCom、メールなどにプッシュします。 |

>!データをServerless Cloud Function側に配信する場合、発生する対応課金額の詳細については、 [SCF課金概要](https://intl.cloud.tencent.com/document/product/583/17299)をご参照ください。

## ワークフローの管理[](id:manage)
1. [MPSコンソール](https://console.cloud.tencent.com/mps)にログインし、左側ナビゲーションバーの**ワークフロー管理**をクリックして、「ワークフロー管理」インターフェースに進みます。
2. ワークフローリストにはワークフロー名、トリガーBucket、リージョン、ディレクトリ、作成時間、有効状態などの情報が表示されます。作成時間によるソート、タスクフロー名検索、および指定されたワークフローに対する詳細の確認・編集・削除操作をサポートします。
	-  **ワークフローの有効化**
		- ワークフローはデフォルトでは無効状態です。このワークフローに対応する状態ボタンをクリックすると、ワークフローを有効化できます。
		- ワークフローを有効化することで、トリガーBucket内にアップロードしたビデオファイルを自動実行できます。
	- **ワークフローの使用停止**
		- このワークフローに対応する状態ボタンをクリックすると、ワークフローを使用停止にできます。
		- ワークフローを無効化すると、トリガーBucketにビデオファイルをアップロードしてもメディア処理タスクが実行されなくなります。
	- **ワークフローの編集**
		- 対象のワークフロー操作バーの**編集**をクリックし、「ワークフローの編集」画面に入ります。この画面でワークフロー名、トリガーBucket、トリガーディレクトリ、出力Bucket、出力ディレクトリ、イベント通知、および設定項目などの変更を行うことができます。
		- ワークフローが有効状態の時は、それに対する編集と削除操作を行うことができません。
	- **ワークフローの削除**
		- 対象のワークフロー操作バーの**削除**をクリックすると、このワークフローを削除できます。
		- ワークフローを削除すると、トリガーBucketにビデオファイルをアップロードしてもメディア処理タスクが実行されなくなります。
		- ワークフローが有効状態の時は、それに対する編集と削除操作を行うことができません。
