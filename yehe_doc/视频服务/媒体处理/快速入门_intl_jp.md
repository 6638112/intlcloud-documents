## 操作シナリオ

このドキュメントは、MPSのサービスを素早く理解し、アクセスできるようにするためのものです。MPSのサービスを使用するための主な手順は次のとおりです。

## 操作手順

### ステップ1：登録とログイン

1. [Tencent Cloudアカウントの登録](https://intl.cloud.tencent.com/document/product/378/17985) を行い、実名認証を完了させます。
2. Tencent Cloudの公式ウェブサイトにログインし、**クラウド製品** > **Video Service**>[**MPS**](https://console.cloud.tencent.com/mps)を選択して、MPSコンソールに進みます。

### ステップ2：権限承認管理

MPSは、COSバケットにアップロードしたファイルに対して、ダウンロード、トランスコード、アップロードなどの読み書き操作を行う必要があるため、サービスのロールを作成し、MPSにCOSの関連する操作権限を与える必要があります。

[MPSコンソール](https://console.cloud.tencent.com/mps)に進み、権限承認を行っていない場合は、**Cloud Access Managementに進む**をクリックして、コンソール共通の権限管理ページに移動し、権限承認操作を行う必要があります。
![img](https://qcloudimg.tencent-cloud.cn/raw/29d478d02a8cfcc701ef9ab67daaea38.png)

>? 権限承認が完了していない場合、MPSコンソールで他の操作を行うことはできません。

### ステップ3：テンプレートの設定

メディア処理の過程では、オーディオとビデオに対するオーディオビデオトランスコーディング、ウォーターマーク追加、スクリーンキャプチャなどの操作が必要です。様々なテンプレートを設定することで、様々な操作出力および操作方法をコントロールすることができます。コンソールのテンプレート管理で設定できます。

### ステップ4：サービスオーケストレーションの作成

サービスオーケストレーションは、新たにbucketにアップロードされたメディアファイルを、あらかじめ設定したフローおよび手順に従って自動的に処理するものです。オーケストレーションではトランスコードルール、スクリーンキャプチャルール、処理フロー、コールバック通知などの内容を設定することができます。

1. [MPSコンソール](https://console.cloud.tencent.com/mps)にログインし、**ワークフロー-サービスオーケストレーション管理**ページに進みます。

2. **サービスオーケストレーションの作成**ボタンをクリックして、サービスオーケストレーション作成ページに進みます。このページでサービスオーケストレーション名、トリガーBucket、トリガーディレクトリ、出力Bucket、出力ディレクトリ、設定項目およびイベント通知を設定する必要があります。具体的な設定方法については、[サービスオーケストレーション設定の説明](https://intl.cloud.tencent.com/document/product/1041/48780)をご参照ください。
![](https://qcloudimg.tencent-cloud.cn/raw/984a8ce5935f4e0263abcf1d10b55227.png)

ワークフロー作成ページでは、以下の情報を設定する必要があります。

| 設定項目       | 入力必須かどうか | 設定説明                                                     |
| :----------- | :------- | :----------------------------------------------------------- |
| サービスオーケストレーション名 | はい       | 128文字以内の中国語、英語、数字、アンダーバーとハイフン`（_-）`を組み合わせて入力できます（例：「MPS」）。 |
| トリガーBucket  | はい       | このAPPID下に作成したBucketから1つを選択し、トリガーBucketとすることができます。ワークフローの開始後、ビデオファイルをこのBucketにアップロードすると、ワークフローの実行を自動的にトリガーすることができます。 |
| トリガーディレクトリ     | いいえ       | スラッシュ`（/）`を末尾につけます。入力しない場合は、トリガーBucketのすべてのディレクトリが有効になります。 |
| 出力Bucket  | はい       | デフォルトはトリガーBucketと同じですが、当該APPIDのトリガーBucketと同じリージョンのBucketから1つを選択し、出力Bucketとすることができます。ワークフローの処理が完了した後、新しく生成されたビデオファイルはこのBucketに保存されます。 |
| 出力ディレクトリ     | いいえ       | スラッシュ`（/）`を末尾につけます。入力しない場合、出力ディレクトリはトリガーディレクトリとの一致を維持します。 |
| イベント通知の有効化 | いいえ       | デフォルトでは無効になっています。イベント通知を有効化する場合、具体的な設定方法については[コールバック方式のタイプ設定](https://intl.cloud.tencent.com/document/product/1041/33482#recall)をご参照ください。TDMQ-CMQイベント通知を有効化したい場合は、[メッセージキューTDMQ](https://console.cloud.tencent.com/tdmq/cmq-queue?rid=1)に移動してサービスをアクティブ化し、モデルを作成してください。イベント通知を有効化すると、指定したCMQがメディア処理のイベント通知を受信します。 |
| 設定項目       | はい       | トランスコードタスク、スクリーンキャプチャタスク、アニメーション画像生成タスク、審査タスク、コンテンツ認識タスク、コンテンツ分析タスクのうち、少なくとも1項目を選択してサービスオーケストレーションの設定を行います。 |

| コールバック方式タイプ  | 設定説明                                                     |
| :------------ | :----------------------------------------------------------- |
| TDMQ-CMQコールバック | TDMQ-CMQモデル：キューモデルまたはトピックモデルを選択できます。デフォルトではキューモデルが選択されています。TDMQ-CMQエリア：広州、上海、北京、上海金融、深圳金融、中国香港、成都、北アメリカエリアまたはアメリカ西部を選択可能です。キュー名/トピック名：カスタマイズできます。 |
| HTTPコールバック     | タスクのイベント通知設定インターフェース[TaskNotifyConfig](https://intl.cloud.tencent.com/document/product/1041/33690#TaskNotifyConfig)を呼び出す際、NotifyTypeパラメータにはURLを指定し、NotifyUrlパラメータにHTTPコールバックアドレスを入力する必要があります。 |
| SCFコールバック      | [SCF操作に進む](https://console.cloud.tencent.com/scf/list-create?rid=1&ns=default&keyword=mps)をクリックし、設定操作を行うことができます。具体的な設定方法については、[ビデオタスクコールバック通知](https://intl.cloud.tencent.com/document/product/1041/40337)をご参照ください。 SCFコールバック設定はすべてのワークフローが対象となります。現在、ワークフローでは設定状態を保存しません。 |

### ステップ5：サービスオーケストレーションの有効化

1. サービスオーケストレーションの作成が完了すると、「サービスオーケストレーションの作成に成功しました」というメッセージが表示され、サービスオーケストレーション管理リストページに自動的に移動します。サービスオーケストレーションリストで、作成したサービスオーケストレーションの管理を行うことができます。
2. サービスオーケストレーションはデフォルトでは無効状態です。サービスオーケストレーションの行にあるステータスボタンをクリックすると、ワークフローを有効化できます。サービスオーケストレーションを有効化している場合のみ、トリガーBucket内にビデオをアップロードするとサービスオーケストレーションの自動実行がトリガーされます。

### ステップ6：タスクの開始

現在サポートしているタスクの開始方法には次の3種類があります。APIによるタスク開始インターフェースの呼び出し、サービスオーケストレーションをバインドしたCOSディレクトリへのビデオファイルのアップロード、**タスク管理** > [**タスクの作成**](https://console.cloud.tencent.com/mps/tasks/create)による手動でのタスク作成です。

- **手動でのタスク作成：**
  1. [タスク管理](https://console.cloud.tencent.com/mps/tasks)ページに進みます。
  2. [タスクの作成](https://console.cloud.tencent.com/mps/tasks/create)をクリックし、タスク作成ページに進みます。
  3. 処理したいビデオファイル、出力パス、トランスコードテンプレートなどの情報を選択し、タスクを開始します。
- **COSビデオ自動トリガー：**
  1. ワークフローを有効化した後、[COSコンソール](https://console.cloud.tencent.com/cos5)に進み、左側ナビゲーションバーの**バケットリスト**をクリックして、「バケットリスト」ページに進みます。
  2. ワークフローの中から設定したトリガーBucketを探し出し、対応するバケット名をクリックすると、デフォルトでは「ファイルリスト」ページに進みます。処理が必要なビデオファイルをアップロードすると、MPSサービスが自動でワークフローの設定に基づいて新しくアップロードしたビデオを処理します。

>? ワークフローの自動実行は、ワークフローを有効化した後、トリガーBucketに新しくアップロードされたビデオファイルに対してのみ有効となり、それ以前にトリガーBucketに保存されたファイルが処理されることはありません。

### ステップ7：タスクの管理

1. [タスク管理](https://console.cloud.tencent.com/mps/tasks)ページに進むと、開始したすべてのタスクのリストを見ることができます。
2. タスクステータス、タスクIDなどによって、処理したいタスクをフィルタリングし、「詳細を見る」をクリックするとサブタスクの情報を確認できます。また、再起動ボタンをクリックすると、キューイング中のタスクの再起動、ソースファイルの再生などの操作を行うことができます。
3. サブタスクリストを開くと、サブタスクの関連情報を確認できます。サブタスクファイルの再生/確認、サブタスク出力ファイルのダウンロード、サブタスク詳細情報の確認などの操作を行うことができます。
![img](https://qcloudimg.tencent-cloud.cn/raw/74e5076bc92486b61de0cce1283d6d58.png)