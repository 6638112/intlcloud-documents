
VODは、著作権保護に対するビデオ業界のニーズに応え、HLSの共通AES暗号化技術を使用してビデオコンテンツを暗号化し、コンテンツを安全に保護する基本的なDRM（デジタル著作権管理）スキームをリリースしています。[VODファイル暗号化DEMO](http://demo.vod.qcloud.com/encryption/index.html)  からDRMスキームについてご確認いただけます。ログインユーザー名はtest、パスワードは111111です。

##  HLS共通暗号化スキーム

#### 暗号化アルゴリズム
VODシステムは現在、[HLS](https://tools.ietf.org/html/draft-pantos-http-live-streaming-23)で定義される暗号化スキームをサポートしています。AES-128を使用してビデオコンテンツを暗号化します。

#### プレーヤーの適合性
VODビデオ暗号化スキームは、すべてのHLSプレーヤーをサポートできます。

#### 制限事項

- 2017バージョンのインターフェースのみをサポートしています。 [ProcessFile](https://intl.cloud.tencent.com/document/product/266/34125)を使用して暗号化タスクを開始し、[GetTaskInfo](https://intl.cloud.tencent.com/document/product/266/34129)を使用して暗号化結果をクエリーできます。
- 新しいバージョンのインターフェース[ProcessMedia](https://intl.cloud.tencent.com/document/product/266/34125)と[DescribeTaskDetail](https://intl.cloud.tencent.com/document/product/266/34129)は、HLS共通暗号化をサポートしていません。

### 用語の説明

#### キー管理サービス（Key Management Service、略称KMS）
主にデータキーの生成、暗号化および復号を行うセキュリティ管理サービスです。例としては、Tencent Cloudの[Key Management Service](https://intl.cloud.tencent.com/product/kms)が挙げられます。

#### データキー（Data Key、略称DK）
KMSシステムによって生成され、対称暗号化と復号に使用されるキーです。

#### 暗号化されたデータキー（Encrypted Data Key、略称EDK）
KMSシステムで暗号化されたDKは、公開配布に使用できます。DKをEDKに交換するには、KMSの復号インターフェースを呼び出す必要があります。

### 全体的なアーキテクチャ
![](https://main.qcloudimg.com/raw/53a2bbfe7d920e636c57574d266dc4ec.png)
ビデオ暗号化プロセスはトランスコードによって実装され、新しいfileIdは生成されません。一般的なトランスコードのシナリオとビデオ暗号化トランスコードを比較した場合の主な相違点は次のとおりです。
- 暗号化はトランスコード中に実行されます。つまり出力ビデオは暗号化されます。
- 暗号化とトランスコーディングが完了した後、ビデオがVODプレーヤーで再生される場合、ソースファイルの再生アドレスは取得されません。

### 準備作業

#### Key Management Service(KMS)の構築
KMSは、主にビデオキーの管理に使用されます。ビデオ暗号化プロセスにおいて、KMSシステムと相互作業する必要がある手順は次のとおりです。

1. アーキテクチャ図に示すように、ビデオ暗号化用の暗号鍵を生成するのはステップIIです。このステップでDKとEDKが返されます。その後の段階で、DKにコンタクトできるロールには、VODトランスコードサービス、Appバックエンド、承認済みのエンドユーザーが含まれます。EDKは任意のユーザーに配布できますが、EDKを介してDKを取得するステップでは、必ずAppのバックエンドで認証を実行する必要があります。
2. アーキテクチャ図に示すように、ビデオ再生のためにEDKからDKを取得するのはステップ4です。AppバックエンドによってユーザーのID検証が認証された後、KMS関連のインターフェースを呼び出し、EDKを使用してDKを取得する必要があります。それはアーキテクチャ図のステップ5です。

VODは、開発者のアクセスコストを最小限に抑えるために、KMSサービスを内部統合し、最もシンプルな呼び出しインターフェースを提供します。ビデオ暗号化スキーム全体で、AppバックエンドとKMSサービスが相互作用する必要があるのは、復号キーの取得だけです（アーキテクチャ図のステップ5）。

#### 認証およびキー配布サービスの構築

暗号化されたビデオの場合、Appバックエンドによって認証されたクライアントのみがDKを取得することができます。従って、エンドクライアントがキーを取得するには、必ずAppバックエンドによる認証を実行する必要があります。このサービスの主なビジネスロジックは、次のとおりです。
1. クライアントが保持するEDKをDKと交換するリクエストする場合（アーキテクチャ図のステップ4）、リクエストした当事者を認証します。
2. 認証にパスすると、KMSシステムに移動して対応するDKを取得し（アーキテクチャ図のステップ5）、それをクライアントに返します。

#### 提案
- DKは常に特定のEDKに対応するため、EDKとDKの間の対応関係をAppバックエンドにキャッシュ（または永久保存）して、KMSシステムへの呼び出し回数を減らします（つまり、アーキテクチャ図のステップ5の呼び出し回数を減らします）。
- Appバックエンドからクライアントへの応答の場合、HTTPキャッシュ制御パラメータ（Cache-Controlなど）を追加して、クライアントがAppバックエンドからDKを取得する回数を減らことができます（つまり、アーキテクチャ図のステップ4の呼び出し回数を減らします）。
- ブラウザの再生をサポートする必要がある場合は、クロスドメインの問題を回避するために、「認証およびキー配布サービス」と「ビデオ再生ページ」に使用されるドメイン名を確実に同じものにしてください（例えば、ビデオ再生ページのドメイン名が`v.myvideo.com`の場合、キー配布サービスのドメイン名も`v.myvideo.com`である必要があります）。

#### ビデオ暗号化テンプレートの設定
VODバックエンドが正しい暗号化操作を確実に実行できるようにするため、ビデオ暗号化テンプレートを設定する必要があります。詳細については、 [HLS共通暗号化テンプレート](https://intl.cloud.tencent.com/document/product/266/33969)をご参照ください。

### 業務フロー

#### ビデオのアップロード
サーバーからのアップロード、クライアントからのアップロード、コンソールからのアップロード、レコーディングアップロード、URLプルアップロードによって、既存のビデオファイルをVODプラットフォームにアップロードすることができます。

#### ビデオの暗号化

ビデオ暗号化の主な手順は、次のとおりです。

#### 1. Appバックエンドがビデオ暗号化を開始します

[ProcessFile](https://intl.cloud.tencent.com/document/product/266/34125)インターフェースを介してビデオ暗号化を開始します。現在、HLSファイルの暗号化のみをサポートしています。

次の例は以下のことを示しています。

- ビデオファイルをトランスコードします。トランスコードのターゲット出力テンプレートは210、220、230、240です。低いビットレートから高いビットレートへ切り替えることは禁止されています。
- トランスコーディングプロセスは、暗号化テンプレート10を使用して暗号化します。
- イベント通知モード：イベント全体の実行が完了した後に開始されます。

<pre>
https://vod.api.qcloud.com/v2/index.php?Action=ProcessFile
&transcode.definition.0=210
&transcode.definition.1=220
&transcode.definition.3=230
&transcode.definition.4=240
&transcode.drm.definition=10
&amp;notifyMode=Finish
&COMMON_PARAMS
</pre>

#### 2. VODプラットフォームは暗号化キーを取得します
VODプラットフォームは、呼び出し元が指定した暗号化パラメータテンプレートに基づいて、キーの取得方法を読み取ります。エンドユーザーは復号キーのURL（`https://getkey.example.com`など）を取得し、指定されたKMSシステムからビデオ暗号化キーDKおよびEDKを取得します。

#### 3. VODプラットフォームが暗号化されたビデオトランスコードを開始します

VODトランスコードプラットフォームは、ビデオ暗号化を実行するときに、指定された暗号化アルゴリズムとキーに基づいてターゲット出力ファイルを暗号化するだけでなく、復号キーを取得するためのURLをビデオファイルに書き込みます。例えばHLSの場合、URLはM3U8ファイルの`EXT-X-KEY`タグに書き込みますが、書き込む前に、トランスコードプラットフォームはこのURLのQueryStringに3つのパラメータを追加します。

- fileId：暗号化されたファイルのIDです。
2. keySource：VodBuildInKMSと定められています。Tencent CloudのVODにKMSが組み込まれていることを意味します。
3. edk：DKに対応するEDKのことです。

上記のパラメータを追加した後、トランスコードのターゲットビデオファイルに書き込まれるURLは、恐らく次のようになります。

<pre>
https://getkey.example.com?fileId=123456&keySource=VodBuildInKMS&edk=abcdef
</pre>


このURLは、クライアントがビデオの再生中に復号キーを最終的に取得するときにアクセスするURLでもあります。

#### 4. VODプラットフォームが暗号化を開始しコールバックを完了します。
暗号化操作を含むタスクフローの状態が変更されると（または実行が完了すると）、VODプラットフォームは[タスクフロー状態の変更通知] (https://intl.cloud.tencent.com/document/product/266/33953) をトリガーします。

### メディア資産管理
ビデオ暗号化操作が完了すると、GetVideoInfoインターフェースを介して、ビデオ暗号化情報を取得することができます。
- GetVideoInfoインターフェースは、ソースファイルの再生アドレスを含む、ビデオIDのすべてのトランスコード仕様でビデオ再生アドレスを返します。ソースファイルは暗号化されていないため、Appサーバーはソースファイルの再生アドレスのみをフィルターで除外でき、暗号化されたビデオ再生アドレスをクライアントに提供します。
- GetVideoInfoによって取得するソースファイルのdefinitionパラメータは0です。この値に基づいて、ソースファイルのビデオ再生アドレスをフィルタリングすることができます。

## ビデオ再生の概要

認証されたクライアントのみが、ビデオ復号キーを取得する必要があります。従って、再生中にユーザーのID情報をどのように検証するかが重要な要素になります。

再生中、プレーヤーはM3U8ファイルの`EXT-X-KEY`タグで識別されるURLにアクセスしてキーを取得します。このステップではプレーヤーは視聴者の認証情報を保持する必要があります。この情報をApp認証サービスに渡すには、次の2つの方法があります。

1. ユーザーのID情報は、パラメータの形式でURLに追加され、Appの認証サービスに渡されます。このスキームは、すべてのHLSプレーヤーに使用できます。具体的なスキームについては、[ビデオ再生スキーム1](#p1)： QueryStringを介した認証情報の受け渡しをご参照ください。
2. ユーザーのID情報は、Cookieを介してAppの認証サービスに提供されます。このスキームはより安全性が高くなりますが、`EXT-X-KEY`タグで識別されるURLにアクセスするときにCookieを保持するプレーヤーにのみ使用できます。具体的なスキームについては、 [ビデオ再生スキーム2](#p2)：Cookieを介した認証情報の受け渡しをご参照ください。

### <span id="p1"></span>ビデオ再生スキーム1

ビデオ再生スキーム1：QueryStringを介して認証情報を渡します。このスキームは、すべてのHLS対応プレーヤーに使用できます。

#### 1. ログインして認証に使用するTokenを配布します
ID認証にパスしたクライアントのみが、ビデオ復号キーを取得する必要があります。従ってビデオを再生する前に、クライアントはログインする必要があり、AppサーバーはTokenと呼ばれる認証情報を含む署名をクライアントに配布します。

#### 2. KeyKeyホットリンク防止署名を含むマルチビットレート再生アドレスを取得します
暗号化トランスコードAPI ProcessFileまたはGetVideoInfo APIのコールバック通知は、暗号化されたビデオのマルチビットレート再生アドレスを取得することができます。
マルチビットレートの再生アドレスを取得した後、クライアントはユーザーのID情報をアドレスに追加する必要があります。再生URLの場合、ユーザーのID情報を追加する方法は次のとおりです。URLの**ファイル名**の前に`voddrm.token.<Token>`を追加します。

例えば、ユーザーのID情報がABC123と識別された場合、特定のビットレートの再生アドレスは次のとおりです。
<pre>
http://example.vod2.myqcloud.com/path/to/a/video.m3u8
</pre>

その場合、最終的なURLは次のようになります。
<pre>
http://example.vod2.myqcloud.com/path/to/a/voddrm.token.ABC123.video.m3u8
</pre>


#### 3. ビデオコンテンツ（暗号化済み）を取得します

プレーヤーが前の手順で説明したプロセスに従って、ユーザーのID情報を含むURLにアクセスすると、VODバックエンドは、オリジナルのM3U8ファイルの`EXT-X-KEY`タグで識別されるURLに、QueryStringとしてトークン情報を自動的に追加します。

例えば、いずれかのビットレートの暗号化されたビデオURLは次のとおりです。
<pre>
http://example.vod2.myqcloud.com/path/to/a/video.m3u8
</pre>

このファイルでは、 `EXT-X-KEY`タグで識別されるビデオ復号キーを取得するためのURLは次のとおりです。
<pre>
https://getkey.example.com?fileId=123456&keySource=VodBuildInKMS&edk=abcdef
</pre>

次に、プレーヤーがToken情報を保持している再生アドレスにアクセスすると、次のようになります。
<pre>
http://example.vod2.myqcloud.com/path/to/a/voddrm.token.ABC123.video.m3u8
</pre>

その中で、`EXT-X-KEY`タグで識別されるビデオ復号キーを取得するためのURLは、次のように置き換えられます。
<pre>
https://getkey.example.com?fileId=123456&keySource=VodBuildInKMS&edk=abcdef&token=ABC123
</pre>

このとき、プレーヤーが復号キーDKを取得すると、ステップ1で配布されたTokenが含まれます。

#### 4. ビデオ復号キーを取得します（ID認証Cookieを保持）

プレーヤーがビデオインデックスファイル（M3U8ファイル）を取得すると、ビデオファイルを再生する前にステップ4が自動的に開始されます。Appバックエンドはクライアントのリクエストを受信した後、まずQueryStringのTokenを確認します。ユーザーのIDが無効である場合、リクエストは直接拒否されます。ユーザーのIDが有効である場合、URLに含まれるfileId、keySource、edkなどのパラメータに基づいて、KMSシステムからDKを取得し、クライアントに返します。
上記の手順が完了すると、クライアントはビデオ復号化キーを取得し、通常のビデオ復号と再生を実行することができます。

### <span id="p2"></span>ビデオ再生スキーム2
ビデオ再生スキーム2：Cookieを介して認証情報を渡します。このスキームは、iOSまたはPCプラットフォームのH5/Flashプレーヤーにのみ使用できます。このプラットフォームでは、プレーヤーは`EXT-X-KEY` タグで識別されるURLにアクセスするときにCookieを保持します。

>実際のテストでは、AndroidプラットフォームのH5プレーヤーは、`EXT-X-KEY`タグで識別されるURLにアクセスする際はCookieを保持しないため、Androidプラットフォームは現在**スキーム1**しか使用できないことがわかりました。

#### 1. ログインして、ID認証のためのCookieを配布します
ID認証にパスしたクライアントのみが、ビデオ復号キーを取得する必要があります。従ってビデオを再生する前に、クライアントはログインする必要があり、Appサーバーからクライアントに署名を配布します。例えば、クライアントは、`login.example.com`でアカウントとパスワードを使用してログインします。Appバックエンドで認証にパスすると、`example.com`ドメインのCookieがクライアントに配布されユーザーが識別されます。

#### 2. 指定されたビデオのマルチビットレート再生アドレスを取得します
VOD Webビデオプレーヤーは、マルチビットレート再生機能を提供します。fileIdに基づいて、1つのビデオに対応するマルチビットレートの再生アドレスを取得することができます。他のプレーヤーを使用する場合は、マルチビットレートの再生アドレスをご自身で取得する必要があります。

#### 3. ビデオコンテンツ（暗号化済み）を取得します
ビデオの再生を開始すると、ビデオプレーヤーは自動的にこのステップを開始します。
ビデオプレーヤーがビデオの再生を開始すると、VOD CDNエッジノードからビデオデータファイルがリクエストされます。HLS形式のビデオの場合、プレーヤーはM3U8ファイルの `EXT-X-KEY`タグに基づいてビデオ復号キーを取得します。例えば、`EXT-X-KEY`タグのビデオ復号キーを取得するためのURLは次のとおりです。
<pre>
https://getkey.example.com?fileId=123456&keySource=VodBuildInKMS&edk=abcdef
</pre>

プレーヤーが復号キーDKを取得すると、ステップ1でAppバックエンドによって配布された`example.com`ドメインのCookieが保持されます。

#### 4. ビデオ復号キーを取得します（ID認証Cookieを保持）

プレーヤーがビデオインデックスファイル（M3U8ファイル）を取得すると、ビデオファイルを再生する前にステップ4が自動的に開始されます。

Appバックエンドはクライアントのリクエストを受信した後、最初にCookie内の識別子の検証を行います。ユーザーのIDが無効である場合、リクエストは直接拒否されます。ユーザーのIDが有効である場合、URLに含まれるfileId、keySource、edkなどのパラメータに基づいて、KMSシステムからDKを取得し、クライアントに返します。
上記の手順が完了すると、クライアントはビデオ復号化キーを取得し、通常のビデオ復号と再生を実行することができます。

## FAQ

####  1. 暗号化されたHLSと共通HLSの違いとは？
HLS仕様によると、HLS暗号化はメディアファイル（TSファイル）を暗号化することであり、M3U8ファイルはプレーヤーがTSファイルを復号する方法を記述します。暗号化されたHLSのM3U8ファイルには、`EXT-X-KEY`タグが含まれています。このパラメータには、`METHOD`属性と`URI`属性が含まれます。`METHOD`属性には、`AES-128`などの暗号化アルゴリズムが記述されます。`URI`属性には、復号キーを取得するためのアドレスが記述され、URIが次のような場合には、プレーヤーはこのURIにアクセスすることで復号に使用されるキーデータを取得することができます。
<pre>
http://www.test.com/getdk?fileId=123&edk=14cf
</pre>

プレーヤーがM3U8ファイルを解析すると、このURIへのHTTPリクエストが開始され、リターンパケットからキーデータが取得されます。

####  2. VOD暗号化機能をアクティブにするには、どのような情報を提供する必要がありますか？
VODの暗号化機能をアクティブにするには、`EXT-X-KEY`タグの`URI`属性であるgetkeyurlを指定する必要があります。
Appサーバーは、クライアントが暗号化されたビデオを再生するときにキーデータを取得するHTTPサービスをデプロイする必要があります。VODサービスがビデオを暗号化すると、暗号化されたビデオのM3U8ファイルの`EXT-X-KEY`タグの`URI`属性がgetkeyurlに設定されます。キーの取得と管理の利便性を確保するために、getkeyurlの後に3つのパラメータfileId、edk、keySourceを追加します。
>fileIdはビデオID、edkは暗号化されたキー、keySourceはキーのソースです。VODに組み込まれたKMSシステムで暗号化されたファイルの場合、keySourceはVodBuildInKMSです。プレーヤーが復号キーを取得するリクエストを開始すると、Appサーバーが受信したHTTPリクエストのQueryStringには、fileIdやedkなどのパラメータが含まれ、Appサーバーは、これに基づいて、対応するDKをプレーヤーに返すことができます。

####  3. 暗号化されたビデオを再生するとき、プレーヤーはどこから復号キーを取得するのですか？
プレーヤーが暗号化されたビデオを再生すると、M3U8ファイルの`EXT-X-KEY`タグのURIに基づいて、キーを取得するためのリクエストが開始されます。これはすなわち、AppがVODに提供するgetkeyurlアドレスです。
プレーヤーは、VODサーバーにキーの取得をリクエストしません。Appサーバーは暗号化のためにVODのProcessFile APIを呼び出す場合、暗号化が完了すると、ビデオ復号キーAPIを呼び出してキーを取得した後、キーを保存する必要があります。プレーヤーがキーをリクエストすると、プレーヤーがリクエストしたパラメータに基づいて対応するキーが返されます。

####  4. Appサーバーはどのようにしてキーをプレーヤーに返すのですか？
プレーヤーがAppサーバーにキー取得をリクエストすると、Appサーバーは16バイトのバイナリーデータをプレーヤーに返す必要があります。ビデオ復号キーAPIから取得されるキーはBase64でエンコードされた文字列です。そのため文字列はプレーヤーに返される前にバイナリーデータに変換される必要があります。
例えば、dkDataはBase64でエンコードされたキーデータです。

Java
```java
  import java.util.Base64;
  byte[] dkBin = Base64.getDecoder().decode(dkData);
```  

PHP
```php
$dkBin = base64_decode($dkData);
```
