
## ソリューションの背景
お客様からのアクセスを容易にするため、TRTCはRTMP標準プロトコルのプッシュをサポートします。実際の状況に応じて、[OBS](https://obsproject.com/download)またはFFmpegを選択してインストールし、プッシュを行うことができます。OBSは、オープンソースプログラムのサードパーティ製ライブストリーミングメディアコンテンツ制作ソフトウェアで、使いやすく、ユーザーに無償で提供されています。OS X、Windows、LinuxなどのOSをサポートし、多様なライブストリーミングのシナリオに適応でき、ライブストリーミングのほとんどのオペレーションニーズに応えることが可能です。最新版のソフトウェアは、[OBS公式サイト](https://obsproject.com/download?spm=a2c4g.11186623.2.15.6aac1445JPlKR8)でダウンロードできます。OBSを使用してプッシュを行う際は、プラグインをインストールする必要はありません。

この機能は現在無償でオープンベータテスト中です（今後有償となる場合は事前に通知します）。ただし、アクセスしたRTMPストリームがルーム内の仮想ユーザーとして正規の通話料金を発生させる場合があります。より詳細な説明をご覧になる場合は、[課金概要](https://intl.cloud.tencent.com/document/product/647/34610)をご参照ください。必要があれば、ご購入前にxunchenliu@tencent.comまでお問い合わせいただき、ホワイトリストへの追加を申請してご利用ください（SdkAppIdの提供が必要です）。

>! RTMPのTRTCからのプルはサポートしていません。CDNのライブストリーミングが必要な場合は、[CDN relayed live streamingの実装](https://intl.cloud.tencent.com/document/product/647/35242)をご参照ください。

## ユースケース
<table>
<thead><tr><th width=22%>シーンのタイプ</th><th>説明</th></tr></thead>
<tbody><tr>
<td>eラーニングシーン</td>
<td>教師がビデオ教材を表示してビデオ授業を行う際、PC端末のOBSまたはFFmpegにより、大多数のメディア形式をRTMPでTRTCルームにプッシュすることができます。ルーム内の学生はTRTC SDKでプルすることで、同一の箇所まで進行したビデオを視聴することが保証され、教材の再生とスキップの進み具合、スピードの調整、次の章への切り替えなどをすべて教師側で制御することが可能です。各学生側では秩序立った授業を一斉に視聴することができるため、教育の質がさらに安定します。</td>
</tr><tr>
<td>スポーツイベント同時視聴シーン</td>
<td>スポーツイベントのストリーミングメディアは、スポーツイベントの主催者が常にRTMP形式のストリーミング方式で試合映像を提供し、RTMPプロトコルによってTRTCルームにプッシュするもので、TRTCルーム内で超低遅延のスポーツイベントライブストリーミングの同時視聴が実現します。TRTCのリアルタイムインタラクション機能と組み合わせることで、フレンドと音声/ビデオで話をしたり、一緒に応援したりすることもでき、どのような素晴らしい瞬間も逃さず共有することができます。</td>
</tr><tr>
<td>その他のシーン</td>
<td>メディアストリーミングをベースにしたリアルタイムインタラクションのあらゆる楽しみ方を、RTMPプロトコルプッシュですべて実現できます。ぜひいろいろな楽しみ方を見つけてください 。</td>
</tr></tbody></table>


## OBSプッシュの設定
### 準備作業[](id:ready)
[OBS](https://obsproject.com/download?spm=a2c4g.11186623.2.15.6aac1445JPlKR8)ツールをインストールして開き、次の操作を行います。

### 入力ソースの選択[](id:step1)
下部のツールバーの**ソース**タグを確認し、**+**ボタンをクリックし、業務ニーズに応じて入力ソースを選択します。よく用いられる入力ソースには次のものがあります。

| 入力ソース         | 説明                                                         |
| :------------- | :----------------------------------------------------------- |
| 画像           | 単一画像のライブストリーミングに適用します                                         |
| 画像スライド放映 | 複数の画像をループまたは順番に再生できます                                 |
| シーン           | 各種の大きなライブストリーミング効果を実現します。この時、別のシーンをソース元として現在のシーンに追加すれば、シーン全体の挿入を実現できます |
| メディアソース         | ローカルのビデオをアップロードできます。またローカルのオンデマンドのビデオファイルに対し、ライブストリーミング化の処理を行うことができます           |
| テキスト           | ライブストリーミングのウィンドウの中にリアルタイムにテキストを追加します                                   |
| ウィンドウキャプチャ       | 選択したウィンドウに応じてリアルタイムにキャプチャを行うことができます。ライブストリーミングは現在のウィンドウのコンテンツのみを表示し、その他ウィンドウはライブストリーミングのキャプチャを行いません |
| ビデオキャプチャデバイス   | リアルタイムな動的キャプチャの撮影デバイス。撮影した画面をライブストリーミングすることができます             |
| 音声入力キャプチャ   | 音声ライブストリーミングのアクティビティ（音声入力デバイス）に利用します                           |
| 音声出力キャプチャ   | 音声ライブストリーミングのアクティビティ（音声出力デバイス）に利用します                           |


![](https://qcloudimg.tencent-cloud.cn/raw/cd227431216391302e50a3ed4e794de2.png)


### プッシュパラメータの設定[](id:step2)
1. 下部のツールバーの**コントロール>設定**ボタンから設定画面に入ることができます。
![img](https://qcloudimg.tencent-cloud.cn/raw/26404eda70b80a654f3119683ae3ca46.png)
2. **プッシュ**をクリックしてプッシュ設定タブに進み、サービスタイプに**カスタム**を選択します。
3. サーバーは`rtmp://rtmp.rtc.qq.com/push/`と入力します。
4. ストリームキーの入力形式は次のようにします。
```
ルームナンバー?sdkappid=アプリケーション&userid=ユーザー名&usersig=署名
```
このうち、ルームナンバー、アプリケーション、ユーザー名、署名は業務に変換する必要があります。例えば次のとおりです。
```
22998?sdkappid=140*****66&userid=******rtmp2&usersig=eJw1jdE***************ZLgi5UAgOzoMhrayt*cjbmiCJ699T09juc833IMT94Ld7I0iHZqVDzvVAqkZsG-IKlzLiXOnEhswHu1iUyTc9pv*****D8MQwoA496Ke6U1ip4EAH4UMc5H9pSmv6MeTBWLamhwFnWRBZ8qKGRj8Yp-wVbv*mGMVZqS7w-mMDQL
```
	- パラメータ簡略化のため、64文字以内の文字列のルームナンバーのみサポートしており、文字は数字、アルファベット、アンダーバーのみ使用できます。TRTCのその他の端末でRTMPストリーミングを視聴したい場合は、**文字列のルームナンバーを使用して入室**する必要があります。
	- usersigの発行ルールについては、[UserSig関連](https://intl.cloud.tencent.com/document/product/647/35166)をご参照ください（**署名が有効期間内でなければならないことにご注意ください**）。
	- 上記のサーバーアドレス + ストリームキーを組み合わせたRTMPプッシュアドレスは、FFmpegまたはその他のRTMPライブラリプッシュにも使用できます。
![](https://qcloudimg.tencent-cloud.cn/raw/c3b309db1312f19abb3ca147c1ecea32.png)

### 出力の設定[](id:step3)
RTMPバックエンドはBフレームの伝送をサポートしていません。ユーザーは次の設定によってプッシュ端末ソフトウェアのビデオコーデックパラメータを調整し、Bフレームを削除することができます。
1. **設定**の**出力**タブをクリックして設定を行います。
2. **出力モード**で**アドバンス**を選択します。**キーフレームの間隔は1または2と入力することをお勧めします**。**OK**をクリックし、設定を保存します。

![](https://qcloudimg.tencent-cloud.cn/raw/072b2fbaf9a3bf6674a48943223de22c.png)   


### ビデオオプションの設定[](id:step4)
**設定**の**ビデオ**タブをクリックし、解像度とフレームレートを設定します。解像度は視聴者が見る画面の精細度を決定し、解像度が高いほど画面は鮮明になります。FPSはビデオのフレームレートで、ビデオ視聴のなめらかさを制御します。スタンダードのビデオフレームレートとしては24フレーム - 30フレームがあり、16フレーム未満の画面は見るとラグ感があります。またゲームはフレームレートに対する要求が高いため、通常は、30フレーム未満のゲームでは画面の連続性が明らかに損なわれます。
![](https://qcloudimg.tencent-cloud.cn/raw/81e9e716bf76a8a1a20a1badcf7dfcd9.png)


### 高度なオプション[](id:step5)
- エンドツーエンド遅延を減少させるため、**ストリームディレイ**をオンにしないことをお勧めします。
- **自動再接続**をオンにする場合は、**再試行の遅延**時間をできるだけ短く設定し、ネットワークジッターの発生時に接続が切断されても可能な限り速やかに再接続できるようにすることをお勧めします。
![](https://qcloudimg.tencent-cloud.cn/raw/7a25a1cb3e2a6daf07508bcb2fdabeb6.png)


### プッシュをクリック[](id:step6)
1. OBSの下部ツールバーの**コントロール**を確認し、**プッシュを開始**をクリックします。
![](https://qcloudimg.tencent-cloud.cn/raw/968dad5d34ba029726f3e07b0ef78720.png)
2. プッシュ成功後、正常であれば画面下部にプッシュステータスが表示されます。TRTCコンソールのダッシュボードにそのユーザーの入室記録が表示されます。
![](https://qcloudimg.tencent-cloud.cn/raw/15c0d1b5df33c4a738050f1f532a990c.png)

### その他の端末での視聴[](id:step7)
[プッシュパラメータの設定](#step2)で述べたとおり、TRTCのその他の端末では入室に文字列のルームナンバーを使用する必要があります。Web端末でRTMPストリーミングを視聴する効果は次のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/787178aa5dc550a592f5455d9f2ffb8e.png)

## FFmpegの設定[](id:FFmpeg)
コマンド行またはその他のRTMPライブラリプッシュを使用する必要がある場合は、[プッシュパラメータの設定](#step2)のサーバーアドレス + ストリームキーを組み合わせた標準RTMPプッシュアドレスをご参照ください。これはFFmpegまたはその他のRTMPライブラリプッシュに使用できます。ビデオコーデックはH.264、オーディオコーデックはAAC、コンテナフォーマットはFLVをそれぞれ使用します。GOPは2sまたは1sに設定することをお勧めします。
FFmpegはシーンによってコマンド設定パラメータが異なるため、ある程度のFFmpeg使用経験が必要です。FFmpegでよく使用するコマンド行オプションを次に列記します。その他のFFmpegオプションについては[FFmpeg公式サイト](https://ffmpeg.org/ffmpeg.html)をご参照ください。

### FFmpegコマンド行[](id:order)
```
ffmpeg [global_options] {[input_file_options] -i input_url} ... {[output_file_options] output_url} 
```

### 一般的なFFmpegオプション[](id:set)
<table>
<thead><tr><th>オプション</th><th>説明</th></tr></thead>
<tbody><tr>
<td>-re</td><td>nativeフレームレートで読み取り入力します。通常はローカルファイルの読み取りにのみ使用します</td>
</tr></tr></tbody></table>

このうち**output_file_options**には、次を含むオプションを設定可能です。

<table>
<thead><tr><th>オプション</th><th>説明</th></tr></thead>
<tbody><tr>
<td>-c:v</td><td>ビデオコーデック。<code>libx264</code>の使用をお勧めします</td>
</tr><tr>
<td>-b:v</td><td>ビデオビットレート。例えば1500kは1500kbpsを表します</td>
</tr><tr>
<td>-r</td><td>ビデオフレームレート</td>
</tr><tr>
<td>-profile:v</td><td>ビデオprofile。baselineを指定するとBフレームをエンコードしません。TRTCバックエンドはBフレームをサポートしていません</td>
</tr><tr>
<td>-g</td><td>GOPフレーム数間隔</td>
</tr><tr>
<td>-c:a</td><td>オーディオコーデック。<code>libfdk_aac</code>の使用をお勧めします</td>
</tr><tr>
<td>-ac</td><td>サウンドチャンネル。2または1を入力します</td>
</tr><tr>
<td>-b:a</td><td>オーディオビットレート</td>
</tr><tr>
<td>-f</td><td>フォーマットの指定は、常に<code>flv</code>を入力します。TRTCに送信し、FLVコンテナを使用してパッケージ化します</td>
</tr></tbody></table>
以下は、ファイルを読みとってTRTCにプッシュする場合のサンプルです。

```
ffmpeg -loglevel info -re -i sample.flv -c:v libx264 -preset fast -profile:v baseline -g 30 -sc_threshold 0 -b:v 1500k -c:a libfdk_aac -ac 2 -b:a 128k -f flv 'rtmp://rtmp.rtc.qq.com/push/hello-string-room?userid=rtmpForFfmpeg&sdkappid=140xxxxxx&usersig=xxxxxxxxxx'
```

### Web端末視聴効果[](id:view)
![](https://qcloudimg.tencent-cloud.cn/raw/3ba672af6154d1998b4e5ede78296d9d.png)


