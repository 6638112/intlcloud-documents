## キャッシュ期限切れコンフィグレーションとは？
-キャッシュ期限切れコンフィグレーションとは、CDN加速ノードがユーザーの業務内容をキャッシュするように構成する時に準拠する一連の期限切れルールのセットです。CDNノードにキャッシュされているユーザーリソースは、いずれも「期限切れ」の問題に直面しています。
 -リソースが期限切れではない状態になっている場合、ユーザーリクエストがノードに到達すると、ノードは該当のリソースをユーザーに直接に返し、取得スピードを向上させます。
 -リソースが期限切れ状態になっている場合（即ち、構成された有効時間を超えた場合）、ユーザーリクエストはノードにオリジンサーバーに発送され、内容を再取得してノードにキャッシュする同時に、ユーザーに返します。
-Tencent Cloud CDNは、各次元の内容のキャッシュ時間構成、優先度のカスタマイズ、cache引継ポリシー（高度なキャッシュ構成）、404状態コードキャッシュ期限切れ構成およびHTTP Response headerキャッシュポリシー構成をサポートします。キャッシュ時間を適切に構成することは、命中率を効果的に向上させ、オリジンプル率を低下させ、ユーザーの帯域幅を節約することができます。

## 内容のキャッシュ
### 構成ガイド
1.[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューの【ドメイン名管理】をクリックし、編集するドメイン名の右側の【管理】をクリックします。
2.【キャッシュ構成】をクリックし、**キャッシュ期限切れコンフィグレーション**モジュールが表示されます。
3.ドメイン名の追加に際して、デフォルトの構成は次の通りです。
 -ユーザーオリジンのドメイン名の追加：すべてのファイルはデフォルトで30日のキャッシュ有効期限ですが、通常の動的ファイル（例えば、.php .jsp .asp .aspxなど）のキャッシュ有効期限はデフォルトで0であるため、このような動的ファイルリクエストに対しては直接にオリジンプルします。
 -COSオリジンのドメイン名の追加：すべてのファイルは30日のキャッシュ有効期限とデフォルト構成されています。
 -高度なキャッシュ期限切れコンフィグレーションがデフォルトでオフになっています。

### 構成の変更
【キャッシュ構成の追加】をクリックしてキャッシュ構成を追加できます。ユーザーは、自分の業務ニーズに応じてデフォルトの構成にキャッシュ時間構成を追加できます。CDNは下記のようなキャッシュの期限切れコンフィグレーションをサポートします。
 -**ファイルのタイプごとにキャッシュの期限切れを構成します。**
次に示すように、ファイルタイプのサフィックスを記入し、タイプに基づいてキャッシュ時間を構成できます。
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、中身では大文字と小文字の区分が必要です。また、「.png」など、冒頭が「.」である文書のサフィックスである必要があります。更新時間が0に構成されている場合、キャッシュしなく、すべてのリクエストはユーザーオリジンサーバーに転送されます。キャッシュ時間構成の最大値は365日を超えてはいけません。
 -**フォルダーごとにキャッシュの期限切れを構成します。**
次に示すように、フォルダーパスを記入し、フォルダーに基づいてキャッシュ時間を構成できます。
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、中身では大文字と小文字の区分が必要です。また、冒頭が「/」であるフォルダーでなければなりません。更新時間が0に構成されている場合、キャッシュしなく、すべてのリクエストはユーザーのオリジンサーバーに転送されます。キャッシュ時間構成の最大値は365日を超えてはいけません。
 -**フルパスファイルのためにキャッシュの期限切れを構成します。 **
特定のファイルのためにキャッシュ時間を次のように構成できます。
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、中身では大文字と小文字の区分が必要です。「*」が特定のタイプのファイル、たとえば、「/test/abc/*.jpg」などにマッチングすることをサポートします。
-**トップページのためにキャッシュの期限切れを構成します。 **
トップページを指定してキャッシュ時間を次のように構成できます。

### 優先度
1.複数のキャッシュポリシーが構成されている場合、互いに重複することがあります。
>！構成項目の優先順位はリストの上から下へ優先度がしだいに増えます。

 あるドメイン名は下記のようにキャッシュが構成されていると仮定します。
 -すべてのファイル30日
 - .php .jsp .aspx 0秒
 - .jpg .png .gif 300秒
 - /test/*.jpg 400秒
 - /test/abc.jpg 200秒

2.ドメイン名が「www.test.com」であり、リソースが「www.test.com/test/abc.jpg」であると仮定すると、そのマッチングモードは次の通りです。
 -一番目のすべてのファイルにマッチングし、命中しました。この時、キャッシュ時間は30日です。
 -2番目にマッチングし、命中していません。
 -三番目にマッチングし、命中しました。この時、キャッシュ時間は300秒です。
 -四番目にマッチングし、命中しました。この時、キャッシュ時間は400秒です。
 -五番目にマッチングし、命中しました。この時、キャッシュ時間は200秒です。

だから、最終のキャッシュ時間が200秒で、最後のマッチングで有効となります。

3.【優先度の調整】をクリックしてキャッシュ構成を追加できます。ユーザーは、業務状況に応じて追加されたキャッシュの期限切れコンフィグレーションの順序をカスタマイズで調整できます。
4.右側の上矢印と下矢印を使用してキャッシュの期限切れコンフィグレーションの順序を調整し、[保存]をクリックして調整を完了します。

### キャッシュ引継
お客様があるサービスリソースをリクエストすると、オリジンサーバーに対応するResponse HTTP HeaderにCache-Controlフィールドが存在します。この時、デフォルトのポリシーは次の通りです。
-Cache-Controlフィールドはmax-ageであり、このリソースに対するキャッシュ時間は構成されているキャッシュ時間に準じ、max-ageの指定時間の引継しません。
- Cache - Controlフィールドはno - cacheまたはno - storeである場合、CDNノードはこのリソースをキャッシュしません。
- Cache - Controlフィールドがない場合、CDNはデフォルトで「Cache - Control: max - age = 600」ヘッダーを追加します。

### 高度なキャッシュ構成
1.キャッシュの期限切れコンフィグレーションモジュールで**高度なキャッシュ期限切れコンフィグレーション**スイッチがあります。このスイッチをクリックして開きます。

2.高度なキャッシュ期限切れコンフィグレーションスイッチをオンにすると、ユーザーがオリジンサーバーのあるリソースをリクエストする時、Response HTTP Header にCache-Controlフィールドが付き、値が「max-age=xxxx」です。この時、ノードは構成されている有効期限時間とmax-ageの中の最小値を該当リソースのキャッシュ時間として取ります。
  -ユーザーのオリジンサーバーで「/index.html」のmax-ageが200秒、CDNに対応するキャッシュ時間が600秒に構成されると、ファイルの実際の期限切れ時間は200秒となります。
 -ユーザーのオリジンサーバーで「/index.html」のmax-ageが800秒、CDNに対応するキャッシュ時間が600秒に構成されると、ファイルの実際の期限切れ時間は600秒となります。

## ヘッダーキャッシュ
リソースがノードでキャッシュに命中すると、CDNはデフォルトで下記のオリジンサーバーヘッダーからのものをキャッシュし、ユーザーに返します。
- Access - Control - Allow - Origin
- Timing - Allow - Origin
- Content - Disposition
- Accept - Ranges 

[ドメイン名管理]の[キャッシュ構成]モジュールに移動し、[オリジンサーバーのすべてのヘッダーをキャッシュする]機能を手動で有効にすると、CDNはすべてのオリジンサーバーをキャッシュしてヘッダー情報を返します。


## ステータスコードのキャッシュ
1.ノードがオリジンサーバーのリソースをリクエストする場合、上記のキャッシュポリシー以外に、ステータスコードに基づいて下記のデフォルトキャッシュポリシーに従って行います。
 - 2XX：通常のキャッシュポリシーに従って行います。
 - 3XX：デフォルトでキャッシュしません。
 - 4XX：404が10sキャッシュし、ほかのはデフォルトでキャッシュしません。
 - 5XX：デフォルトでキャッシュしません。
2. [キャッシュ構成]の[ステータスコードキャッシュ]モジュールで404のキャッシュ時間を調整できます。

404の状態コードキャッシュ時間を0～3600秒に調整できます。
>！ファイルに対応するキャッシュの有効期限が0である場合、404が生成されても、キャッシュレスの原則に準拠し、直接にパススルーします。
