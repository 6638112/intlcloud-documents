## Feature Description
- This API enables admins to query the message history of a one-to-one conversation based on a specified time range.
- The one-to-one conversation to be queried is specified by From_Account and to_Account in the request. The query result contains the messages sent between both sides. The specific sender and recipient of each message are specified by From_Account and to_Account, respectively.
- If you exchange the values of From_Account and to_Account in the request, the query result will remain unchanged.
- The query result contains recalled messages, marked by the MsgFlagBits field.
- If you want to recall a message using the [RESTful API for recalling one-to-one messages](https://intl.cloud.tencent.com/document/product/1047/35015), you can first use this API to query the MsgKey of the message and then call the recall API to recall the message.
- The time range of message records that can be queried depends on the roaming message storage period, which is 7 days by default. Modification of the message roaming period on the console is supported. Extending the message roaming period is a value-added service. For details, see [Roaming Message Storage](https://intl.cloud.tencent.com/document/product/1047/33524#.E6.BC.AB.E6.B8.B8.E6.B6.88.E6.81.AF.E5.AD.98.E5.82.A8).
- For first-time queries, we recommend that MaxCnt be set to 20. In the response, the Complete field indicates whether all messages within the time range have been pulled.

## API Calling Description
### Sample request URL
```
https://console.tim.qq.com/v4/openim/admin_getroammsg?sdkappid=88888888&identifier=admin&usersig=xxx&random=99999999&contenttype=json
```

### Request parameters

The following is a list of the parameters commonly used when calling this API and their descriptions. For more parameters, see the [RESTful API Overview](https://intl.cloud.tencent.com/document/product/1047/34620).

| Parameter | Description |
| ------------------ | ------------------------------------ |
| v4/openim/admin_getroammsg  | Request API |
| sdkappid | The SDKAppID is assigned by the IM console when the app is created. |
| identifier | The value must be the admin account of the app. For more information, see [App Admin](https://intl.cloud.tencent.com/document/product/1047/33517#app-.E7.AE.A1.E7.90.86.E5.91.98). |
| usersig | The signature generated by the app admin account. For details on the operation, see [Generating UserSig](https://intl.cloud.tencent.com/document/product/1047/34385). |
| random | A random 32-bit unsigned integer ranging from 0 to 4294967295. |

### Maximum calling frequency

200 times/second

### Sample requests and responses

#### Return all data for a single request (no need for continued pulling)
For example, assume there were two messages sent between user1 and user2 in the conversation period of 2020-03-20 10:00:00 - 2020-03-20 11:00:00. Now, we want to query the chat record of the conversation in this time range.

##### Sample request
```
{
    "From_Account":"user2",
    "To_Account":"user1",
    "MaxCnt":2,
    "MinTime":1584669600,
    "MaxTime":1584673200
}
```
##### Sample response
```
{
    "ActionStatus": "OK",
    "ErrorInfo": "",
    "ErrorCode": 0,
    "Complete": 1,
    "MsgCnt": 2,
    "LastMsgTime": 1584669680,
    "LastMsgKey": "549396494_2578554_1584669680",
    "MsgList": [
        {
            "From_Account": "user1",
            "To_Account": "user2",
            "MsgSeq": 549396494,
            "MsgRandom": 2578554,
            "MsgTimeStamp": 1584669680,
            "MsgFlagBits": 0,
            "MsgKey": "549396494_2578554_1584669680",
            "MsgBody": [
                {
                    "MsgType": "TIMTextElem",
                    "MsgContent": {
                        "Text": "1"
                    }
                }
            ]
        },
        {
            "From_Account": "user2",
            "To_Account": "user1",
            "MsgSeq": 1054803289,
            "MsgRandom": 7201,
            "MsgTimeStamp": 1584669689,
            "MsgFlagBits": 0,
            "MsgKey": "1054803289_7201_1584669689",
            "MsgBody": [
                {
                    "MsgType": "TIMTextElem",
                    "MsgContent": {
                        "Text": "2"
                    }
                }
            ]
        }
    ]
}
```

#### Return all data after multiple requests (continued pulling is needed)
For example, assume there were 100 messages sent between user1 and user2 in the conversation period of 2020-03-20 10:00:00 - 2020-03-20 11:00:00. Now, we want to query the chat record of the conversation in this time range.
##### Sample of the first request
```
{
    "From_Account":"user2",
    "To_Account":"user1",
    "MaxCnt":100,
    "MinTime":1584669600,
    "MaxTime":1584673200
}
```

##### Sample response
```
{
    "ActionStatus": "OK",
    "ErrorInfo": "",
    "ErrorCode": 0,
    "Complete": 0,
    "MsgCnt": 17,
    "LastMsgTime": 1584672269,
    "LastMsgKey": "1259_93754093_1584672269",
    "MsgList": [ ... ] //To indicate an ongoing pulling process, the result of MsgList is not listed.
}
```

In the response, `"Complete": 0` indicates that not all messages within the time range have been pulled, so continued pulling is needed.
In continued pulling requests, the value of MaxTime should be changed to the value of the LastMsgTime field in the response, and the LastMsgKey field in the response should be entered, as shown below:

<span id="example"></span>
##### Continued pulling request
```
{
    "From_Account":"user2",
    "To_Account":"user1",
    "MaxCnt":100,
    "MinTime":1584669600,
    "MaxTime":1584672269,
    "LastMsgKey": "1259_93754093_1584672269"
}
```

### Request packet fields

| Field | Type | Attribute | Description |
|---------|---------|----|---------|
| From_Account | String | Required | UserID of either party in the conversation |
| To_Account | String | Required | UserID of either party in the conversation |
| MaxCnt | Integer | Required | Number of messages requested |
| MinTime | Integer | Required | Min value of the time range of the requested messages |
| MaxTime | Integer | Required | Max value of the time range of the requested messages |
| LastMsgKey | String | Optional | MsgKey of the last message that pulled message history. Enter this field during continued pulling. For details, see the above [Sample](#example).  |

### Sample response packets
- Normal response
```
{
    "ActionStatus": "OK",
    "ErrorInfo": "",
    "ErrorCode": 0,
    "Complete": 1,
    "MsgCnt": 1,
    "LastMsgTime": 1584669680,
    "LastMsgKey": "549396494_2578554_1584669680",
    "MsgList": [
        {
            "From_Account": "user1",
            "To_Account": "user2",
            "MsgSeq": 549396494,
            "MsgRandom": 2578554,
            "MsgTimeStamp": 1584669680,
            "MsgFlagBits": 0,
            "MsgKey": "549396494_2578554_1584669680",
            "MsgBody": [
                {
                    "MsgType": "TIMTextElem",
                    "MsgContent": {
                        "Text": "1"
                    }
                }
            ]
        }
    ]
}
```

- Exceptional response
```
{
    "ActionStatus": "FAIL", 
    "ErrorInfo": "Fail to Parse json data of body, Please check it", 
    "ErrorCode": 90001
}
```

### Response packet fields

| Field | Type | Description |
|---------|---------|---------|
| ActionStatus | String | The request processing result. OK: succeeded. FAIL: failed.  |
| ErrorCode | Integer | The error code. 0: succeeded. Other values: failed. |
| ErrorInfo | String | Error information. |
| Complete | Integer | Indicates whether all messages have been pulled. 0: no, continued pulling is needed. 1: yes. |
| MsgCnt | Integer | Number of messages pulled this time |
| LastMsgTime | Integer | Time of the last message pulled this time |
| LastMsgKey | Integer | Identifier of the last message pulled this time |
| MsgList | Array | List of returned messages |
| MsgFlagBits | Integer | Attribute of the message. 0: normal message. 8: recalled message. |
| MsgBody | Object | Message body. For details on the format, see [Message Format Description](https://intl.cloud.tencent.com/document/product/1047/33527) (note: a message can contain multiple message elements, with MsgBody being of the Array type). |
| MsgKey | String | Message identifier, used by the [RESTful API for recalling one-to-one messages](https://intl.cloud.tencent.com/document/product/1047/35015). |

## Error Codes

Unless a network error (such as error 502) occurs, the HTTP return code for this API is always 200. ErrorCode and ErrorInfo in the response packet represent the actual error code and error information.
For public error codes (60000 to 79999), see [Error Codes](https://intl.cloud.tencent.com/document/product/1047/34348).
The following are error codes specific to this API:

| Error Code | Description |
| ------------- | ------------------------------------------------------------ |
| 90001 | Failed to parse the JSON format. Check whether the JSON request packet meets JSON specifications. |
| 90003 | The JSON request packet does not contain the To_Account field or the To_Account field is not of the String type. |
| 90008 | The JSON request packet does not contain the From_Account field or the account it specifies does not exist. |
| 90009 | The request requires app admin permissions. |
| 91000 | Internal server error. Please try again. |

## API Debugging Tool

Use the [RESTful API online debugging tool] (https://avc.cloud.tencent.com/im/APITester/APITester.html#v4/openim/admin_getroammsg) to debug this API.

## References
- Sending a one-to-one message ([v4/openim/sendmsg](https://intl.cloud.tencent.com/document/product/1047/34919))
- Batch sending one-to-one messages ([v4/openim/batchsendmsg](https://intl.cloud.tencent.com/document/product/1047/34920))
- Recalling one-to-one messages ([v4/openim/admin_msgwithdraw](https://intl.cloud.tencent.com/document/product/1047/35015))
